{
  "project": "Store App - Mango Pad Integration",
  "branchName": "ralph/mango-pad-integration",
  "description": "Complete MQTT integration between Store App and Mango Pad for checkout, signature capture, tip selection, and payment flow.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Align MQTT Topic Patterns with Mango Pad",
      "description": "As a developer, I need Store App and Mango Pad to use the same MQTT topic patterns so they can communicate.",
      "acceptanceCriteria": [
        "Add new topic patterns to src/services/mqtt/topics.ts matching Mango Pad format",
        "Add PAD_READY_TO_PAY: 'salon/{storeId}/pad/ready_to_pay'",
        "Add PAD_PAYMENT_RESULT: 'salon/{storeId}/pad/payment_result'",
        "Add PAD_CANCEL: 'salon/{storeId}/pad/cancel'",
        "Add PAD_TIP_SELECTED: 'salon/{storeId}/pad/tip_selected' (for receiving)",
        "Add PAD_SIGNATURE_CAPTURED: 'salon/{storeId}/pad/signature' (for receiving)",
        "Add PAD_RECEIPT_PREFERENCE: 'salon/{storeId}/pad/receipt_preference' (for receiving)",
        "Add PAD_TRANSACTION_COMPLETE: 'salon/{storeId}/pad/transaction_complete' (for receiving)",
        "Add PAD_HELP_REQUESTED: 'salon/{storeId}/pad/help_requested' (for receiving)",
        "Update topic types in src/services/mqtt/types.ts",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation - must match Mango Pad topics exactly. Mango Pad uses 'salon/{salonId}/pad/*' pattern."
    },
    {
      "id": "US-002",
      "title": "Create Mango Pad Service Layer",
      "description": "As a developer, I need a dedicated service to manage communication with Mango Pad devices.",
      "acceptanceCriteria": [
        "Create src/services/mangoPadService.ts",
        "Implement sendReadyToPay(transaction: PadTransaction) method",
        "Implement sendPaymentResult(result: PaymentResult) method",
        "Implement sendCancel(transactionId: string) method",
        "Define PadTransaction interface with: transactionId, clientId, clientName, clientEmail, clientPhone, staffName, items, subtotal, tax, discount, total, suggestedTips",
        "Define PaymentResult interface with: transactionId, success, cardLast4, authCode, errorMessage",
        "Service publishes to correct MQTT topics",
        "Export service as singleton",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Service layer abstracts MQTT publishing for Pad communication."
    },
    {
      "id": "US-003",
      "title": "Create Mango Pad Event Handlers",
      "description": "As a developer, I need to handle incoming MQTT messages from Mango Pad.",
      "acceptanceCriteria": [
        "Create src/services/mangoPadHandlers.ts",
        "Implement handleTipSelected(payload) - updates ticket with tip amount",
        "Implement handleSignatureCaptured(payload) - stores signature base64",
        "Implement handleReceiptPreference(payload) - triggers email/sms/print receipt",
        "Implement handleTransactionComplete(payload) - marks ticket as paid",
        "Implement handleHelpRequested(payload) - shows notification to staff",
        "Handlers dispatch Redux actions appropriately",
        "Add unit tests for each handler",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Event handlers process incoming Pad messages and update app state."
    },
    {
      "id": "US-004",
      "title": "Add Pad Device Registry and Status Tracking",
      "description": "As a salon owner, I want to see which Mango Pad devices are connected so I know the system is working.",
      "acceptanceCriteria": [
        "Create src/store/slices/padDevicesSlice.ts",
        "Track connected Pad devices with: id, name, status (online/offline), lastSeen",
        "Subscribe to salon/{storeId}/pad/heartbeat topic for device presence",
        "Implement addDevice, removeDevice, updateDeviceStatus reducers",
        "Device goes offline after 30 seconds without heartbeat",
        "Add selector getConnectedPads()",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Device registry enables showing connection status in UI."
    },
    {
      "id": "US-005",
      "title": "Add Pad Connection Status Indicator to Header",
      "description": "As a salon staff, I want to see if Mango Pad is connected in the header so I know when I can use it for checkout.",
      "acceptanceCriteria": [
        "Add PadConnectionIndicator component to header area",
        "Show green dot + 'Pad Connected' when at least one Pad is online",
        "Show gray dot + 'No Pad' when no Pads connected",
        "Clicking indicator shows dropdown with list of connected Pads",
        "Each Pad shows name, status, and last seen time",
        "Use existing design system tokens for styling",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Visual indicator helps staff know system status."
    },
    {
      "id": "US-006",
      "title": "Add Send to Pad Button in Checkout",
      "description": "As a salon staff, I want a button to send the current ticket to Mango Pad for customer signature and tip.",
      "acceptanceCriteria": [
        "Add 'Send to Pad' button in checkout/payment section",
        "Button only enabled when at least one Pad is connected",
        "Button disabled with tooltip 'No Pad connected' when offline",
        "Clicking button calls mangoPadService.sendReadyToPay()",
        "Button shows loading state while sending",
        "Show success toast 'Sent to Mango Pad' on success",
        "Show error toast on failure",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Primary action to initiate Pad checkout flow."
    },
    {
      "id": "US-007",
      "title": "Show Pad Transaction Status in Checkout",
      "description": "As a salon staff, I want to see what's happening on the Pad so I know when payment is complete.",
      "acceptanceCriteria": [
        "Add PadTransactionStatus component to checkout",
        "Show 'Waiting for customer...' when sent to Pad",
        "Show 'Tip: $X.XX selected' when tip received",
        "Show 'Signature captured' when signature received",
        "Show 'Processing payment...' during payment",
        "Show 'Payment complete' on success with checkmark",
        "Show 'Payment failed: [reason]' on failure with retry option",
        "Auto-update ticket status when transaction complete",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Real-time feedback shows Pad progress to staff."
    },
    {
      "id": "US-008",
      "title": "Add Cancel Transaction on Pad Feature",
      "description": "As a salon staff, I want to cancel a transaction on the Pad if the customer changes their mind.",
      "acceptanceCriteria": [
        "Add 'Cancel on Pad' button when transaction is active on Pad",
        "Button sends cancel message via mangoPadService.sendCancel()",
        "Pad returns to idle screen on cancel",
        "Checkout UI returns to normal state",
        "Show confirmation dialog before canceling",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Allows staff to recover from customer cancellations."
    },
    {
      "id": "US-009",
      "title": "Store Signature with Transaction",
      "description": "As a salon owner, I want customer signatures stored with transactions for records.",
      "acceptanceCriteria": [
        "Add signature_base64 column to transactions table (or update existing)",
        "When signature received from Pad, store in transaction record",
        "Signature viewable in transaction details",
        "Add SignatureDisplay component showing signature image",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Signatures provide legal record of customer authorization."
    },
    {
      "id": "US-010",
      "title": "Handle Help Requested from Pad",
      "description": "As a salon staff, I want to be notified when a customer needs help at the Pad.",
      "acceptanceCriteria": [
        "When help_requested message received, show prominent notification",
        "Notification shows which Pad and customer name",
        "Notification has acknowledge button",
        "Play notification sound (if available)",
        "Notification persists until acknowledged",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Ensures staff responds to customer assistance requests."
    },
    {
      "id": "US-011",
      "title": "Add Mango Pad Heartbeat Publishing",
      "description": "As a developer, I need Store App to publish heartbeats so Mango Pad knows it's connected.",
      "acceptanceCriteria": [
        "Publish heartbeat to salon/{storeId}/pos/heartbeat every 15 seconds",
        "Heartbeat includes: storeId, storeName, timestamp, version",
        "Mango Pad can subscribe to know POS is online",
        "Stop publishing when app closes/disconnects",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Bidirectional heartbeat ensures both devices know connection status."
    },
    {
      "id": "US-012",
      "title": "Add Mango Pad Settings Page",
      "description": "As a salon owner, I want to configure Mango Pad connection settings.",
      "acceptanceCriteria": [
        "Add 'Mango Pad' section in Settings",
        "Show current MQTT broker URL",
        "Show current Salon/Store ID used for topics",
        "Show list of connected Pads with status",
        "Option to change broker URL (requires restart)",
        "Test Connection button that publishes test message",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Configuration UI for managing Pad connections."
    },
    {
      "id": "US-013",
      "title": "Update Mango Pad to Add Heartbeat",
      "description": "As a developer, Mango Pad needs to send heartbeats so Store App knows it's connected.",
      "acceptanceCriteria": [
        "Add heartbeat publishing in Mango Pad (apps/mango-pad)",
        "Publish to salon/{salonId}/pad/heartbeat every 15 seconds",
        "Heartbeat includes: deviceId, deviceName, salonId, timestamp, screen (current screen)",
        "Subscribe to salon/{salonId}/pos/heartbeat to detect POS connection",
        "Show 'POS Connected' indicator when receiving POS heartbeats",
        "Show 'POS Offline' after 30 seconds without heartbeat",
        "pnpm build succeeds in apps/mango-pad",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "This story modifies Mango Pad app to complete bidirectional awareness."
    },
    {
      "id": "US-014",
      "title": "Integration Test - Full Checkout Flow",
      "description": "As a developer, I want to verify the complete Store App → Mango Pad → Store App flow works.",
      "acceptanceCriteria": [
        "Create e2e test or integration test for pad checkout flow",
        "Test: Send to Pad → Tip Selected → Signature → Payment Complete",
        "Test: Send to Pad → Cancel flow",
        "Test: Help Requested notification",
        "Mock MQTT messages for testing",
        "All tests pass",
        "pnpm build succeeds",
        "pnpm exec tsc --noEmit passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Ensures end-to-end flow works correctly."
    }
  ]
}

# Ralph Progress Log
Started: Sat Jan 10 2026
Branch: ralph/mango-pad-integration
Stories: 14 (MQTT Integration, Device Status, Checkout UI, Settings)

## Codebase Patterns

> Reusable patterns discovered during implementation. Add general learnings here.

- MQTT topics are defined in src/services/mqtt/topics.ts
- Use buildTopic() helper to create topics with storeId substitution
- MQTT feature flag: isMqttEnabled() from featureFlags.ts
- Redux slices go in src/store/slices/
- Checkout components are in src/components/checkout/
- Use design-system tokens for all styling
- MQTT broker URL configured via VITE_MQTT_CLOUD_URL env var
- PAD topics use 'salon' prefix (not 'mango') to match Mango Pad app
- New Pad topic patterns: PAD_READY_TO_PAY, PAD_PAYMENT_RESULT, PAD_CANCEL, PAD_TIP_SELECTED, PAD_SIGNATURE_CAPTURED, PAD_RECEIPT_PREFERENCE, PAD_TRANSACTION_COMPLETE, PAD_HELP_REQUESTED, PAD_HEARTBEAT, POS_HEARTBEAT
- Heartbeat topics use QoS 0, all other Pad topics use QoS 1
- Pad event handlers are in src/services/mangoPadHandlers.ts
- PadTransactionState stores Pad-specific data (signature, receipt preference) that doesn't fit in Ticket type
- Use uiSlice addNotification for user notifications (type: 'success' | 'error' | 'warning' | 'info')
- Mock store module in tests: vi.mock('../../store', () => ({ store: { dispatch: vi.fn() } }))

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba84c-308e-7658-b070-c048c2d9147e
- Added new MQTT topic patterns aligned with Mango Pad format
- Updated from 'mango/{storeId}/pad/*' to 'salon/{storeId}/pad/*' for Pad topics
- Added payload types: PadReadyToPayPayload, PadPaymentResultPayload, PadCancelPayload, PadTipPayload, PadSignaturePayload, PadReceiptPreferencePayload, PadTransactionCompletePayload, PadHelpRequestedPayload, PadHeartbeatPayload, PosHeartbeatPayload
- Updated QOS_BY_TOPIC with new Pad topics
- Updated exports in index.ts
- Fixed test file to use new topic names
- **Files changed:** src/services/mqtt/topics.ts, src/services/mqtt/types.ts, src/services/mqtt/index.ts, src/services/mqtt/topics.test.ts
- **Learnings:**
  - Pad topics use 'salon' prefix to match Mango Pad app convention
  - Heartbeats should use QoS 0 for performance

---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba852-14f5-7273-9f27-203dfeba677f
- Created dedicated Mango Pad service layer at src/services/mangoPadService.ts
- Implemented sendReadyToPay(transaction: PadTransaction) method
- Implemented sendPaymentResult(result: PaymentResult) method
- Implemented sendCancel(cancel: CancelTransaction) method
- Defined PadTransaction, PaymentResult, and CancelTransaction interfaces
- Service uses getMqttClient() singleton and buildTopic() helper
- Service validates MQTT enabled state and connection before publishing
- Exported as singleton via getMangoPadService()
- **Files changed:** src/services/mangoPadService.ts (new)
- **Learnings:**
  - MangoPadService requires storeId to be set via setStoreId() before use
  - CancelTransaction uses ticketId and transactionId (not just transactionId)
  - Re-export PadTransactionItem type for consumers of the service

---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba854-f8fe-769a-b9c0-5f013e36a23c
- Created src/services/mangoPadHandlers.ts with all event handlers
- Implemented handleTipSelected - dispatches setTip to checkoutSlice
- Implemented handleSignatureCaptured - stores signature in PadTransactionState
- Implemented handleReceiptPreference - stores receipt preference in PadTransactionState
- Implemented handleTransactionComplete - updates ticket status to 'paid', dispatches setCheckoutStep('complete')
- Implemented handleHelpRequested - dispatches warning notification to staff
- Created PadTransactionState interface for storing Pad-specific data (signature, receipt preference)
- Added padMessageHandlers dispatch table for topic routing
- Created unit tests in src/services/__tests__/mangoPadHandlers.test.ts
- **Files changed:** src/services/mangoPadHandlers.ts (new), src/services/__tests__/mangoPadHandlers.test.ts (new)
- **Learnings:**
  - Ticket type doesn't have signatureData/receiptPreference fields - use separate PadTransactionState store
  - Handlers use uiSlice addNotification for user feedback
  - Store dispatches use setTip, setCheckoutStep from checkoutSlice, updateTicketInSupabase from ticketsSlice
  - Test environment has pre-existing @testing-library/jest-dom missing dependency issue

---

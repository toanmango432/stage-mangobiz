# Ralph Progress Log
Started: Sat Jan 10 2026
Branch: ralph/mango-pad-integration
Stories: 14 (MQTT Integration, Device Status, Checkout UI, Settings)

## Codebase Patterns

> Reusable patterns discovered during implementation. Add general learnings here.

- MQTT topics are defined in src/services/mqtt/topics.ts
- Use buildTopic() helper to create topics with storeId substitution
- MQTT feature flag: isMqttEnabled() from featureFlags.ts
- Redux slices go in src/store/slices/
- Checkout components are in src/components/checkout/
- Use design-system tokens for all styling
- MQTT broker URL configured via VITE_MQTT_CLOUD_URL env var
- PAD topics use 'salon' prefix (not 'mango') to match Mango Pad app
- New Pad topic patterns: PAD_READY_TO_PAY, PAD_PAYMENT_RESULT, PAD_CANCEL, PAD_TIP_SELECTED, PAD_SIGNATURE_CAPTURED, PAD_RECEIPT_PREFERENCE, PAD_TRANSACTION_COMPLETE, PAD_HELP_REQUESTED, PAD_HEARTBEAT, POS_HEARTBEAT
- Heartbeat topics use QoS 0, all other Pad topics use QoS 1
- Pad event handlers are in src/services/mangoPadHandlers.ts
- PadTransactionState stores Pad-specific data (signature, receipt preference) that doesn't fit in Ticket type
- Use uiSlice addNotification for user notifications (type: 'success' | 'error' | 'warning' | 'info')
- Mock store module in tests: vi.mock('../../store', () => ({ store: { dispatch: vi.fn() } }))
- Pad device registry uses padDevicesSlice with handleHeartbeat action for incoming heartbeats
- usePadHeartbeat hook subscribes to salon/{storeId}/pad/heartbeat and runs checkOfflineDevices every 10s
- selectStoreId from authSlice provides current store ID for topic building
- Header status indicators use Popover from @/components/ui/popover for dropdowns
- PadConnectionIndicator displays device status using getConnectedPads, selectHasConnectedPad selectors
- padTransactionSlice tracks active Pad transaction status (waiting, tip_selected, signature, receipt, processing, complete, failed, cancelled)
- usePadTransactionEvents hook subscribes to all Pad event topics and updates padTransactionSlice
- PadTransactionStatus component shows real-time progress with visual step indicators
- Signature data stored in Ticket type via signatureBase64 and signatureTimestamp fields
- SignatureDisplay component in src/components/common/ for displaying signature images
- When adding fields to Ticket, also update UITicket, PendingTicket, DBTicket and their converter functions

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba84c-308e-7658-b070-c048c2d9147e
- Added new MQTT topic patterns aligned with Mango Pad format
- Updated from 'mango/{storeId}/pad/*' to 'salon/{storeId}/pad/*' for Pad topics
- Added payload types: PadReadyToPayPayload, PadPaymentResultPayload, PadCancelPayload, PadTipPayload, PadSignaturePayload, PadReceiptPreferencePayload, PadTransactionCompletePayload, PadHelpRequestedPayload, PadHeartbeatPayload, PosHeartbeatPayload
- Updated QOS_BY_TOPIC with new Pad topics
- Updated exports in index.ts
- Fixed test file to use new topic names
- **Files changed:** src/services/mqtt/topics.ts, src/services/mqtt/types.ts, src/services/mqtt/index.ts, src/services/mqtt/topics.test.ts
- **Learnings:**
  - Pad topics use 'salon' prefix to match Mango Pad app convention
  - Heartbeats should use QoS 0 for performance

---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba852-14f5-7273-9f27-203dfeba677f
- Created dedicated Mango Pad service layer at src/services/mangoPadService.ts
- Implemented sendReadyToPay(transaction: PadTransaction) method
- Implemented sendPaymentResult(result: PaymentResult) method
- Implemented sendCancel(cancel: CancelTransaction) method
- Defined PadTransaction, PaymentResult, and CancelTransaction interfaces
- Service uses getMqttClient() singleton and buildTopic() helper
- Service validates MQTT enabled state and connection before publishing
- Exported as singleton via getMangoPadService()
- **Files changed:** src/services/mangoPadService.ts (new)
- **Learnings:**
  - MangoPadService requires storeId to be set via setStoreId() before use
  - CancelTransaction uses ticketId and transactionId (not just transactionId)
  - Re-export PadTransactionItem type for consumers of the service

---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba854-f8fe-769a-b9c0-5f013e36a23c
- Created src/services/mangoPadHandlers.ts with all event handlers
- Implemented handleTipSelected - dispatches setTip to checkoutSlice
- Implemented handleSignatureCaptured - stores signature in PadTransactionState
- Implemented handleReceiptPreference - stores receipt preference in PadTransactionState
- Implemented handleTransactionComplete - updates ticket status to 'paid', dispatches setCheckoutStep('complete')
- Implemented handleHelpRequested - dispatches warning notification to staff
- Created PadTransactionState interface for storing Pad-specific data (signature, receipt preference)
- Added padMessageHandlers dispatch table for topic routing
- Created unit tests in src/services/__tests__/mangoPadHandlers.test.ts
- **Files changed:** src/services/mangoPadHandlers.ts (new), src/services/__tests__/mangoPadHandlers.test.ts (new)
- **Learnings:**
  - Ticket type doesn't have signatureData/receiptPreference fields - use separate PadTransactionState store
  - Handlers use uiSlice addNotification for user feedback
  - Store dispatches use setTip, setCheckoutStep from checkoutSlice, updateTicketInSupabase from ticketsSlice
  - Test environment has pre-existing @testing-library/jest-dom missing dependency issue

---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba85c-388b-7514-ac47-7cca94cc81c9
- Created src/store/slices/padDevicesSlice.ts for Pad device registry
- Implemented PadDevice interface with: id, name, status (online/offline), lastSeen, screen, salonId
- Added reducers: addDevice, removeDevice, updateDeviceStatus, handleHeartbeat, checkOfflineDevices
- Device marked offline after 30 seconds without heartbeat (OFFLINE_TIMEOUT_MS = 30000)
- Added selectors: selectAllPadDevices, getConnectedPads, selectHasConnectedPad, selectOfflinePads
- Created usePadHeartbeat hook for subscribing to salon/{storeId}/pad/heartbeat
- Hook runs checkOfflineDevices every 10 seconds to detect stale connections
- Registered padDevicesSlice in store/index.ts with serializable check ignore
- **Files changed:** src/store/slices/padDevicesSlice.ts (new), src/services/mqtt/hooks/usePadHeartbeat.ts (new), src/services/mqtt/hooks/index.ts, src/store/index.ts
- **Learnings:**
  - Use selectStoreId from authSlice for current store ID
  - handleHeartbeat action handles both new device creation and updates
  - checkOfflineDevices is called via setInterval, not on each heartbeat

---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba860-cbfe-75cd-bd8d-8aaa172f180d
- Created PadConnectionIndicator component in src/components/layout/PadConnectionIndicator.tsx
- Shows green dot + 'Pad Connected' when connected, gray dot + 'No Pad' when disconnected
- Uses Popover from Radix UI for dropdown showing list of all Pad devices
- Dropdown shows: device name, online/offline status, screen state, and last seen time
- Uses usePadHeartbeat hook to subscribe to heartbeat messages
- Uses date-fns formatDistanceToNow for human-readable last seen times
- Integrated into TopHeaderBar between notifications and store profile buttons
- Uses design-system tokens for styling (green-50, green-600 for connected state)
- **Files changed:** src/components/layout/PadConnectionIndicator.tsx (new), src/components/layout/TopHeaderBar.tsx
- **Learnings:**
  - Use Popover from @/components/ui/popover for dropdown menus in header
  - Use formatDistanceToNow from date-fns with addSuffix: true for "X ago" format
  - Component forces re-render every 10s via setTick state to update relative times

---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba866-026d-76da-a483-5e9c227e2108
- Created SendToPadButton component in src/components/checkout/SendToPadButton.tsx
- Button sends checkout transaction to Mango Pad via mangoPadService.sendReadyToPay()
- Uses selectHasConnectedPad selector to enable/disable based on Pad connection
- Shows Tooltip with "No Pad connected" when disabled
- Displays loading spinner while sending (isSending state)
- Dispatches success/error notifications via addNotification from uiSlice
- Integrated into PaymentModal in step 2 (payment section) as "Customer-facing checkout" option
- Added new props to PaymentModal: subtotal, tax, discount, clientId, clientName, clientEmail, clientPhone, items, onSentToPad
- Button uses green accent color to distinguish from regular payment methods
- **Files changed:** src/components/checkout/SendToPadButton.tsx (new), src/components/checkout/PaymentModal.tsx
- **Learnings:**
  - PadTransactionItem type requires 'id' and 'price' fields (not unitPrice/total)
  - Use TooltipProvider wrapper for Radix Tooltip components
  - Export TicketItem interface from PaymentModal for consumers to use
  - sendToPadTransactionId state tracks if transaction was sent to avoid duplicate sends

---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba86c-5d56-7512-8c08-d89ed7b67f9c
- Created padTransactionSlice for tracking active Pad transaction status
- Created PadTransactionStatus component showing real-time checkout progress
- Created usePadTransactionEvents hook subscribing to tip_selected, signature, receipt_preference, transaction_complete topics
- Status states: idle, waiting, tip_selected, signature, receipt, processing, complete, failed, cancelled
- Progress step indicator shows: Sent → Tip → Signature → Complete
- Component displays appropriate message for each state with icons and colors
- Retry button on failed state allows resending to Pad
- Integrated into PaymentModal step 2 when sentToPadTransactionId is set
- Updated SendToPadButton to dispatch startPadTransaction action on success
- **Files changed:** src/store/slices/padTransactionSlice.ts (new), src/components/checkout/PadTransactionStatus.tsx (new), src/services/mqtt/hooks/usePadTransactionEvents.ts (new), src/components/checkout/PaymentModal.tsx, src/components/checkout/SendToPadButton.tsx, src/store/index.ts, src/services/mqtt/hooks/index.ts
- **Learnings:**
  - padTransactionSlice is separate from checkoutSlice to cleanly track Pad-specific state
  - usePadTransactionEvents dispatches both padTransactionSlice actions AND checkoutSlice/ticketsSlice actions
  - PadTransactionStatus uses cn() utility for conditional className logic
  - Progress step indicators use getProgressSteps() helper to determine completed/active states

---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba873-319a-7343-b744-c5e9d215d712
- Created CancelOnPadButton component with AlertDialog confirmation
- Button only shown during active Pad transactions (not complete/failed/cancelled)
- Uses mangoPadService.sendCancel() to send cancel message to Pad
- Dispatches setTransactionCancelled to update padTransactionSlice
- Shows info notification on successful cancel, error on failure
- Integrated into PadTransactionStatus component via onCancelled prop
- PaymentModal clears sentToPadTransactionId when cancelled
- **Files changed:** src/components/checkout/CancelOnPadButton.tsx (new), src/components/checkout/PadTransactionStatus.tsx, src/components/checkout/PaymentModal.tsx
- **Learnings:**
  - AlertDialog from @radix-ui/react-alert-dialog is already available in ui/alert-dialog.tsx
  - Use e.preventDefault() in AlertDialogAction onClick to prevent dialog closing before async action completes
  - padTransactionSlice already has setTransactionCancelled action ready to use
  - CancelOnPadButton hides itself when transaction is complete/failed/cancelled

---

## 2026-01-10 - US-009
Thread: https://ampcode.com/threads/T-019ba877-9a1a-7223-b46f-df60fb3c0396
- Added signatureBase64 and signatureTimestamp fields to Ticket type
- Updated handleSignatureCaptured to persist signature to ticket via updateTicketInSupabase
- Updated handleTransactionComplete to include signature data if present in payload
- Created SignatureDisplay component with configurable sizes (sm/md/lg)
- Component validates base64 image data and displays with formatted timestamp
- Integrated SignatureDisplay into TicketDetailsModal (shows after notes section)
- Added signature fields to UITicket, PendingTicket, and DBTicket interfaces
- Updated convertToUITicket and convertToPendingTicket to include signature fields
- **Files changed:** src/types/Ticket.ts, src/services/mangoPadHandlers.ts, src/components/common/SignatureDisplay.tsx (new), src/components/common/index.ts, src/components/tickets/TicketDetailsModal.tsx, src/store/slices/uiTicketsSlice.ts
- **Learnings:**
  - Signature display requires updating multiple interfaces: Ticket, UITicket, PendingTicket, DBTicket
  - SignatureDisplay handles both data:image/... prefix and raw base64 formats
  - TicketDetailsModal uses useTickets hook which provides UITicket objects - need to pass signature through converter functions

---

# Ralph Progress Log
Started: 2025-01-11
Branch: ralph/mango-pad-integration
Stories: 17 (Device Pairing System)

## Codebase Patterns

> Reusable patterns discovered during implementation.

**From Previous Work (Checkout Integration):**
- MQTT topics are defined in src/services/mqtt/topics.ts
- Use buildTopic() helper to create topics with storeId substitution
- MQTT feature flag: isMqttEnabled() from featureFlags.ts
- Redux slices go in src/store/slices/
- Settings pages are in src/components/modules/settings/categories/
- PAD topics use 'salon' prefix (not 'mango') to match Mango Pad app
- Heartbeat topics use QoS 0, all other Pad topics use QoS 1
- Device goes offline after 30 seconds without heartbeat
- Use design-system tokens for all styling
- Use Popover from @/components/ui/popover for dropdown menus
- Use formatDistanceToNow from date-fns with addSuffix: true for "X ago" format
- Mango Pad deviceId persisted in localStorage as 'mango_pad_device_id'
- Mango Pad salonId from VITE_SALON_ID env var

**Device Pairing Patterns (to be discovered):**
- [TBD as we implement]

---

## Previous Work (Archived)

The checkout integration (US-001 through US-014) was completed in a previous Ralph run.
Archived to: `archive/2025-01-10-checkout-integration/`

---

## 2025-01-11 - US-001: Create salon_devices table in Supabase

**Summary:**
- Created migration `028_add_device_pairing_columns.sql` to extend salon_devices table
- Added `device_role` column with CHECK constraint for 'store-app', 'mango-pad', 'check-in', 'display'
- Added `station_name`, `pairing_code`, `paired_to_device_id` columns
- Created indexes on pairing_code and paired_to_device_id
- Added RLS policies for authenticated insert/update

**Files changed:**
- `supabase/migrations/028_add_device_pairing_columns.sql` (new)
- `apps/store-app/src/services/supabase/types.ts` (updated SalonDeviceRow with new columns, added SalonDeviceRole type)
- `apps/mango-pad/src/types/index.ts` (added SalonDevice, SalonDeviceRole, PairingInfo, PairingQRPayload types)

**Learnings:**
- Existing salon_devices table uses `store_id` and `device_fingerprint` (not `salon_id` and `device_id`)
- `device_type` is for platform (ios/android/web/desktop), `device_role` is for app role (store-app/mango-pad/etc)
- Use ALTER TABLE ADD COLUMN IF NOT EXISTS for safe migrations
- TypeScript types in mango-pad use simple interfaces (not Database type pattern) for simplicity

---



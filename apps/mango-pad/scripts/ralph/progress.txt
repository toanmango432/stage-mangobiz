# Ralph Progress Log
Started: Fri Jan 10 2026
Branch: ralph/mango-pad-full
Stories: 19 (Phase 1-5: Foundation, Core Flow, Post-Payment, Split/Config, Quality)

## Codebase Patterns

> Reusable patterns discovered during implementation. Add general learnings here.

- MQTT client is initialized in MqttProvider context
- All screens are in src/pages/ directory
- Redux slices are in src/store/slices/
- Use padSlice for screen navigation state
- Use transactionSlice for current transaction data
- Use configSlice for settings (persisted to localStorage)
- MQTT topics are defined in src/constants/mqttTopics.ts
- Tip calculations go in src/utils/tipCalculations.ts
- Split payment math goes in src/utils/splitCalculations.ts
- Use Framer Motion v11 for page transitions (v12 has TS type issues)
- App uses Redux screen state + AnimatePresence for smooth transitions (no react-router)
- Import framer-motion from 'framer-motion' not 'motion/react'
- Touch targets must be minimum 48x48px
- Fonts must be minimum 18px body, 24px+ headers
- Local mqttClient.ts is used instead of @mango/mqtt (shared package has broken dependencies)
- mqttService singleton handles connection state, subscriptions, and publishing
- PadMqttProvider wraps app and auto-subscribes to ready_to_pay, payment_result, and cancel topics
- NumericKeypadModal pattern for custom amount entry (see TipPage.tsx)
- formatCurrency helper using Intl.NumberFormat for currency display
- For split payments: check isSplitPayment, splitPayments, currentSplitIndex from transactionSlice
- SplitCard component pattern for displaying payment status cards with icons
- Use adjustLastSplit() to handle rounding in custom split amounts
- Settings accessed via 4-finger long press on IdlePage (2 second hold)
- SettingsPage has tab-based navigation: connection, payment, idle, display, split, advanced
- Export/Import JSON settings for multi-device setup
- syncQueueService handles offline message queuing and replay with localStorage persistence
- mqttService.publish() auto-queues when disconnected (use skipQueue option to bypass)
- ReconnectingOverlay shows overlay during disconnection with duration and queue info
- 30-second offline threshold triggers offlineAlertCallback for staff notification
- uiSlice tracks: offlineSince, offlineAlertTriggered, queuedMessageCount
- Accessibility CSS in src/styles/accessibility.css with high-contrast and large-text modes
- AccessibilityProvider in App.tsx applies html class based on config settings
- All buttons should have aria-label, icons should have aria-hidden="true"
- Use role="main" id="main-content" on main content wrapper, role="banner" on headers
- @import must come before @tailwind directives in CSS
- Responsive design: useResponsive hook in src/hooks/useResponsive.ts provides device info
- Use responsive Tailwind classes: text-base sm:text-lg md:text-xl for scaling
- Use min-h-[100dvh] for mobile browser viewport (dynamic vh)
- safe-area-all class handles iOS notch/home indicator spacing
- Landscape orientation detected via useOrientation hook or data-orientation attribute
- Responsive breakpoints in tailwind.config.ts: tablet-sm (600px), tablet (768px), tablet-lg (1024px)

---

## [2026-01-10] - US-001
Thread: https://ampcode.com/threads/T-019ba7bb-e559-76ea-9418-be8413fc73dc
- Implemented Redux Toolkit store with padSlice, transactionSlice, configSlice, uiSlice
- Created TypeScript types for all MQTT payloads and app state
- Created local MQTT client service using mqtt.js library
- Created PadMqttProvider that subscribes to ready_to_pay, payment_result, cancel topics
- Added publish functions for tip_selected, signature, receipt_preference, transaction_complete, help_requested, split_payment
- Connection status tracked in Redux (connected/disconnected/reconnecting)
- Files changed:
  - src/store/index.ts, src/store/hooks.ts
  - src/store/slices/padSlice.ts, transactionSlice.ts, configSlice.ts, uiSlice.ts
  - src/types/index.ts
  - src/services/mqttClient.ts
  - src/providers/PadMqttProvider.tsx
  - src/constants/mqttTopics.ts
  - src/main.tsx, src/App.tsx
  - package.json (added redux, mqtt, uuid dependencies)
- **Learnings for future iterations:**
  - The shared @mango/mqtt package has broken dependencies; use local mqttClient.ts instead
  - configSlice auto-persists to localStorage on every change
  - mqtt.js requires `pnpm add mqtt uuid @types/uuid`
---

## [2026-01-10] - US-002
Thread: https://ampcode.com/threads/T-019ba7c2-dba7-760b-b981-57b0ff28c81c
- Implemented IdlePage with digital signage features
- Full-screen display with configurable salon logo
- Live date/time that updates every minute
- Promotional carousel with multiple slide types (promotion, announcement, staff-spotlight, testimonial, social-qr)
- Configurable slide duration from config store (default 8 seconds)
- Smooth fade/slide transitions using Framer Motion
- Animated gradient background using Framer Motion
- MQTT connection status indicator in bottom-right corner
- Updated App.tsx to use Redux-based screen navigation with AnimatePresence
- Files changed:
  - src/pages/IdlePage.tsx (new)
  - src/App.tsx (rewrote to use ScreenRouter pattern)
  - package.json (added framer-motion v11)
- **Learnings for future iterations:**
  - Framer Motion v12 has TypeScript type issues; use v11 instead
  - App uses ScreenRouter component with AnimatePresence for smooth transitions
  - PromoSlide types already defined in configSlice; use them directly
  - ConnectionStatusIndicator pattern can be reused across screens
---

## [2026-01-10] - US-003
Thread: https://ampcode.com/threads/T-019ba7c8-33e8-76af-bf42-dce8420b1ff2
- Implemented OrderReviewPage with complete transaction display
- Header shows client name prominently with staff name
- Services and products listed separately with icons (Scissors for services, ShoppingBag for products)
- Summary shows subtotal, tax, discount (if applicable), and total
- "Looks Good" button proceeds to next screen (tip, signature, or payment based on config)
- Split Payment button when enabled in settings
- Need Help button publishes help_requested via MQTT
- Files changed:
  - src/pages/OrderReviewPage.tsx (new)
  - src/App.tsx (added OrderReviewPage import and case)
- **Learnings for future iterations:**
  - Use usePadMqtt() hook from PadMqttProvider to publish MQTT messages
  - config.tipEnabled and config.signatureRequired control screen flow
  - formatCurrency helper using Intl.NumberFormat for consistent currency display
  - lucide-react icons: Scissors (services), ShoppingBag (products), HelpCircle (help)
---

## [2026-01-10] - US-004
Thread: https://ampcode.com/threads/T-019ba7cc-2c83-76a8-9053-b1506aceedf9
- Implemented TipPage with full tip selection functionality
- Supports configurable tip type: percentage-based OR dollar-based from config
- Suggested tip buttons display calculated amounts clearly
- NumericKeypadModal component for custom tip entry with full numeric keypad
- No Tip option as smaller button
- Running total updates dynamically as tip is selected
- Selected tip visually highlighted with distinct indigo style
- Continue button proceeds to signature or payment based on config.signatureRequired
- Publishes tip to MQTT salon/{id}/pad/tip_selected via usePadMqtt hook
- Files changed:
  - src/pages/TipPage.tsx (complete rewrite - removed react-router, now uses Redux)
- **Learnings for future iterations:**
  - NumericKeypadModal is reusable - can be extracted to components/ if needed elsewhere
  - TipButton component pattern reusable for grid selection UIs
  - formatCurrency helper duplicated from OrderReviewPage - consider extracting to utils/
---

## [2026-01-10] - US-005
Thread: https://ampcode.com/threads/T-019ba7d0-1068-7398-a929-ea4d536a4552
- Implemented SignaturePage with react-signature-canvas library
- Full-width signature canvas that works with finger touch and stylus
- Clear button resets the signature canvas
- Shows agreement text: "By signing above, I agree to pay the total shown and authorize this transaction"
- Shows final total including tip prominently in header
- Done button to proceed (disabled when signature is empty)
- Signature captured as base64 PNG via toDataURL('image/png')
- Minimum validation: button disabled when canvas isEmpty()
- Publishes signature to MQTT salon/{id}/pad/signature via usePadMqtt hook
- Files changed:
  - src/pages/SignaturePage.tsx (complete rewrite)
  - package.json (added react-signature-canvas, @types/react-signature-canvas)
- **Learnings for future iterations:**
  - react-signature-canvas provides onBegin/onEnd callbacks to track if signature is empty
  - SignatureCanvas ref has isEmpty() and toDataURL() methods
  - penColor, dotSize, minWidth, maxWidth control signature appearance
  - Use pointer-events-none on overlay elements to not interfere with canvas
---

## [2026-01-10] - US-006
Thread: https://ampcode.com/threads/T-019ba7d3-5ca2-7148-910f-05f5ab04cf1e
- Implemented PaymentPage for payment instruction display
- Large clear "Please Insert or Tap Card" text with animated card visual
- CardAnimation component with NFC wave effects and bouncing card icon
- TerminalIcon component shows terminal-specific icons (PAX, Dejavoo, Clover, generic)
- PulsingLoader for processing indicator
- Amount to charge displayed prominently including tip
- Cancel/Help button publishes help_requested via MQTT
- Timeout handling: after configurable paymentTimeout seconds, shows timeout message with retry option
- Listens for payment_result via Redux/MQTT and auto-navigates to result screen
- Connection status indicator in footer
- Files changed:
  - src/pages/PaymentPage.tsx (new)
  - src/App.tsx (added PaymentPage import and case)
- **Learnings for future iterations:**
  - Use useRef for timeout management to properly clean up on unmount
  - config.paymentTimeout (in seconds) controls timeout duration
  - Payment result is received via PadMqttProvider which dispatches to transactionSlice
  - Terminal type icons can be customized per brand (PAX, Dejavoo, Clover, or generic)
---

## [2026-01-10] - US-007
Thread: https://ampcode.com/threads/T-019ba7e3-2550-74b8-ac5f-d823fb120019
- Implemented ResultPage for payment success/failure display
- Large green checkmark with "Payment Successful!" for success state
- Red X icon with "Payment Failed" and failure reason for failure state
- Shows card last 4 digits and authorization code on success
- Try Again button on failure returns to payment screen
- Auto-proceeds to receipt or thank-you after configurable delay
- Animated progress bar shows countdown to auto-advance
- Files changed:
  - src/pages/ResultPage.tsx (new)
  - src/App.tsx (added ResultPage import and case)
- **Learnings for future iterations:**
  - Config is accessed via state.config.config (nested structure)
  - Use ?? for nullish coalescing instead of || for numbers (thankYouDelay)
  - setPaymentResult(null as never) to clear payment result (type workaround)
---

## [2026-01-10] - US-008
Thread: https://ampcode.com/threads/T-019ba7e5-db98-75c1-8606-234aab602242
- Implemented ReceiptPage for receipt preference selection
- Four options: Email, Text/SMS, Print, No Receipt
- Email option shows client email with edit button (modal input)
- SMS option shows client phone with edit button (modal input)
- EditModal component for inline email/phone editing
- ReceiptOption component for consistent option button styling
- Publishes receipt preference to MQTT via usePadMqtt().publishReceiptPreference
- Stores selection in Redux via setReceiptSelection
- Continue button disabled until preference is selected
- Files changed:
  - src/pages/ReceiptPage.tsx (complete rewrite from old react-router version)
- **Learnings for future iterations:**
  - Old ReceiptPage used react-router - all pages now use Redux screen state
  - EditModal pattern reusable for inline edits (email, phone, etc.)
  - ReceiptOption component pattern for selection button grids
  - transaction.clientEmail and transaction.clientPhone may be undefined
---

## [2026-01-10] - US-009
Thread: https://ampcode.com/threads/T-019ba7e8-285c-73d1-bfe2-d58afc03d488
- Implemented ThankYouPage component for pleasant transaction closing experience
- Displays "Thank You, [Client Name]!" with animated heart icon
- Shows loyalty points earned prominently if applicable (amber/yellow card)
- Shows promotional message from first promo slide if configured
- Auto-returns to idle after configurable thankYouDelay (default 5 seconds)
- Animated progress bar shows countdown to auto-return
- Manual "Done" button for immediate return
- Publishes transaction_complete to MQTT via usePadMqtt hook (once only using useRef)
- Decorative floating elements (Sparkles, Star, Heart, Gift) for visual appeal
- Files changed:
  - src/pages/ThankYouPage.tsx (new)
  - src/App.tsx (added ThankYouPage import and case)
- **Learnings for future iterations:**
  - PromoSlide type uses 'title' and 'subtitle' properties, not 'content'
  - Use useRef to track if MQTT publish has already happened (avoid double-publish)
  - thankYouDelay is in seconds, multiply by 1000 for setTimeout
  - clearTransaction and resetToIdle should both be called when returning to idle
---

## [2026-01-10] - US-010
Thread: https://ampcode.com/threads/T-019ba7ea-911e-765e-a65e-7b831cd8ba3b
- Implemented complete Split Payment Flow
- Created SplitSelectionPage with Equal (2/3/4-way) and Custom amount modes
- Created SplitStatusPage showing payment progress with visual indicators
- Created src/utils/splitCalculations.ts utility for split math
- Updated TipPage, SignaturePage, PaymentPage, ResultPage to show split info in headers
- All screens display "Payment X of Y" badge when in split mode
- Split amounts properly calculated with rounding handled for first split
- Custom amounts have real-time validation (amounts must equal total)
- Progress bar shows completed/pending payments
- Cancel split option returns to Order Review
- After each successful split, returns to split-status screen
- When all splits complete, auto-redirects to receipt/thank-you
- Publishes split_payment to MQTT via usePadMqtt hook
- Files changed:
  - src/pages/SplitSelectionPage.tsx (new)
  - src/pages/SplitStatusPage.tsx (new)
  - src/utils/splitCalculations.ts (new)
  - src/App.tsx (added split screen imports and routes)
  - src/pages/TipPage.tsx (split mode awareness)
  - src/pages/SignaturePage.tsx (split mode awareness)
  - src/pages/PaymentPage.tsx (split mode awareness)
  - src/pages/ResultPage.tsx (split mode navigation)
- **Learnings for future iterations:**
  - transactionSlice already has initializeSplitPayment, updateSplitPayment actions ready
  - currentSplitIndex tracks which split is being processed
  - isSplitPayment flag determines flow routing
  - Use adjustLastSplit() to handle rounding when custom amounts don't quite equal total
  - config.maxSplits controls max splits (default 4)
  - SplitCard component reusable for displaying split payment status
---

## [2026-01-10] - US-011
Thread: https://ampcode.com/threads/T-019ba7f0-cd5a-77bc-aff8-1b68591b80b9
- Implemented comprehensive SettingsPage with 6 configuration tabs
- Connection Settings: salon ID, MQTT broker URL, test connection button
- Payment Flow Settings: tip toggle, tip type (% or $), tip values editor, signature toggle, receipt options toggle, payment timeout
- Idle Screen Settings: logo URL, slide duration, brand colors (primary/secondary with color pickers), promo slide editor
- Display Settings: thank you delay, high contrast mode, large text mode
- Split Payment Settings: enable/disable, max splits (2-4)
- Advanced Settings: Export/Import settings as JSON, Reset to defaults with confirmation
- Added hidden gesture (4-finger long press for 2 seconds) on IdlePage to access settings
- Visual progress indicator during settings access gesture
- All settings persisted to localStorage via configSlice
- Files changed:
  - src/pages/SettingsPage.tsx (new - comprehensive settings UI with 900+ lines)
  - src/pages/IdlePage.tsx (added 4-finger long press gesture detection)
  - src/App.tsx (integrated SettingsPage into router)
- **Learnings for future iterations:**
  - Settings tabs pattern: sidebar navigation with animated content switching
  - ToggleSwitch, NumberInput, TextInput, ColorPicker components are reusable
  - TipValuesEditor pattern for editing arrays of values inline
  - SlideEditor pattern for managing array items with add/remove
  - 4-finger long press detection using touchStart/touchEnd with timer
  - SVG circular progress indicator for hold-to-activate gestures
  - Export JSON via data URI + temporary anchor element download
  - Import JSON via hidden file input + FileReader API
---

## [2026-01-10] - US-012
Thread: https://ampcode.com/threads/T-019ba7f6-90fe-70f8-8d54-5e0a69d91a60
- Implemented complete Offline Mode and Sync Queue functionality
- Created syncQueueService with message queuing, replay, and localStorage persistence
- Updated mqttService to auto-queue messages when disconnected
- Added offline tracking with 30-second threshold for staff alerts
- Created ReconnectingOverlay component showing connection status
- Different overlay messages for brief disconnection vs extended offline
- Shows "Please wait, reconnecting..." during active transactions
- Queue size and offline duration displayed in overlay
- Auto-replay queued messages in order when reconnected
- Updated uiSlice with offline-related state (offlineSince, offlineAlertTriggered, queuedMessageCount)
- Updated PadMqttProvider to handle offline state tracking and alert callbacks
- Files changed:
  - src/services/syncQueue.ts (new)
  - src/services/mqttClient.ts (added queue support)
  - src/components/ReconnectingOverlay.tsx (new)
  - src/store/slices/uiSlice.ts (added offline state)
  - src/providers/PadMqttProvider.tsx (added offline tracking)
  - src/App.tsx (added ReconnectingOverlay)
- **Learnings for future iterations:**
  - syncQueueService handles offline message queuing and replay
  - mqttService.publish() auto-queues when disconnected (queueEnabled flag)
  - ReconnectingOverlay shows different UI based on offline duration and active transaction
  - 30-second offline threshold triggers staff alert callback
  - uiSlice has offlineSince, offlineAlertTriggered, queuedMessageCount state
  - QueuedMessage persists to localStorage so queued messages survive page reload
---

## [2026-01-10] - US-013
Thread: https://ampcode.com/threads/T-019ba7fb-11bf-740b-b354-e48dddbeef23
- Verified Cancel/Abort Flow already fully implemented
- MQTT cancel subscription in PadMqttProvider lines 180-183
- Cancel handler calls clearTransaction() and resetToIdle()
- Need Help button present on all required screens:
  - OrderReviewPage (line 203-209)
  - TipPage (line 410-416)
  - SignaturePage (line 226-233)
  - PaymentPage (line 378-385)
- All publishHelpRequested calls include current screen name
- No code changes needed - all acceptance criteria already met
- **Learnings for future iterations:**
  - Cancel/Abort flow was implemented as part of US-001 MQTT foundation
  - Need Help buttons were added with each screen implementation
  - Always check if features already exist before implementing
---

## [2026-01-10] - US-014
Thread: https://ampcode.com/threads/T-019ba7fc-a31b-75bf-a65d-7696d5792f59
- Implemented WCAG 2.1 AA accessibility compliance across all screens
- Created src/styles/accessibility.css with focus indicators, high-contrast mode, and large-text mode
- Updated index.css with minimum 18px body font size
- Created AccessibilityProvider in App.tsx that applies high-contrast and large-text classes based on config
- Added skip-to-content link for screen reader users
- Added role="main" and id="main-content" to all page wrappers
- Added role="banner" to all header sections
- Added aria-label to all interactive buttons across all pages
- Added aria-hidden="true" to decorative icons
- Added aria-pressed to toggle buttons (tip selection, no tip)
- Added aria-live regions for dynamic content (payment result, connection status)
- Added role="dialog" and aria-modal to NumericKeypadModal
- Added role="group" and aria-label to button groups
- Touch targets already minimum 48x48px (min-h-[56px], min-h-[64px])
- High contrast mode: black backgrounds, yellow accents, white text
- Large text mode: scales all text sizes by 1.25x
- Reduced motion support via prefers-reduced-motion media query
- Files changed:
  - src/styles/accessibility.css (new)
  - src/index.css (import and body font)
  - src/App.tsx (AccessibilityProvider, skip-link)
  - src/pages/OrderReviewPage.tsx (ARIA labels)
  - src/pages/TipPage.tsx (ARIA labels, dialog)
  - src/pages/SignaturePage.tsx (ARIA labels)
  - src/pages/PaymentPage.tsx (ARIA labels, live regions)
  - src/pages/ResultPage.tsx (ARIA labels, live regions)
- **Learnings for future iterations:**
  - @import statements must come before @tailwind directives in CSS
  - AccessibilityProvider pattern uses useEffect to add/remove classes on html element
  - Config already has highContrastMode and largeTextMode - just needed to apply them
  - Use aria-live="polite" for non-urgent status updates
---

## [2026-01-10] - US-015
Thread: https://ampcode.com/threads/T-019ba803-7a7c-75be-82b5-653c42eb6280
- Implemented comprehensive responsive design for all device sizes
- Updated tailwind.config.ts with tablet breakpoints: xs (320px), tablet-sm (600px), ipad (834px), ipad-pro (1024px)
- Added orientation media queries: portrait, landscape, touch, tall, short
- Created src/styles/responsive.css with safe-area support, touch-friendly spacing, orientation utilities
- Created src/hooks/useResponsive.ts hook for device detection (type, orientation, touch, screen size)
- Updated index.html with iOS/Android web app meta tags, viewport-fit=cover, touch handling
- Updated index.css with responsive base font sizing using clamp() and 100dvh support
- Updated App.tsx with useOrientation hook and safe-area-all class on screen container
- Updated IdlePage with responsive text sizing (text-2xl to text-6xl based on screen)
- Updated OrderReviewPage with landscape side-by-side layout and responsive padding
- All interactive elements scale appropriately for 7-inch to 12.9-inch screens
- Typecheck passes, pnpm build succeeds
- Files changed:
  - tailwind.config.ts (tablet breakpoints, safe-area spacing, responsive font sizes)
  - src/styles/responsive.css (new - orientation, touch, and device utilities)
  - src/hooks/useResponsive.ts (new - device detection hook)
  - index.html (viewport meta, web app capability)
  - src/index.css (responsive base styles)
  - src/App.tsx (orientation, safe-area support)
  - src/pages/IdlePage.tsx (responsive classes)
  - src/pages/OrderReviewPage.tsx (responsive layout, landscape mode)
- **Learnings for future iterations:**
  - Use min-h-[100dvh] instead of min-h-screen for proper mobile browser height
  - safe-area-all class handles iOS notch/home indicator padding
  - Use clamp(min, preferred, max) for fluid font sizing
  - Landscape mode can use side-by-side layouts for better space usage
  - useResponsive hook provides isShortScreen for compact layouts on small Android tablets
  - data-orientation attribute on containers helps CSS-only orientation styling
---

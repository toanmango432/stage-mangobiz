# Ralph Progress Log
Started: Fri Jan 10 2026
Branch: ralph/mango-pad-full
Stories: 19 (Phase 1-5: Foundation, Core Flow, Post-Payment, Split/Config, Quality)

## Codebase Patterns

> Reusable patterns discovered during implementation. Add general learnings here.

- MQTT client is initialized in MqttProvider context
- All screens are in src/pages/ directory
- Redux slices are in src/store/slices/
- Use padSlice for screen navigation state
- Use transactionSlice for current transaction data
- Use configSlice for settings (persisted to localStorage)
- MQTT topics are defined in src/constants/mqttTopics.ts
- Tip calculations go in src/utils/tipCalculations.ts
- Split payment math goes in src/utils/splitCalculations.ts
- Use Framer Motion v11 for page transitions (v12 has TS type issues)
- App uses Redux screen state + AnimatePresence for smooth transitions (no react-router)
- Import framer-motion from 'framer-motion' not 'motion/react'
- Touch targets must be minimum 48x48px
- Fonts must be minimum 18px body, 24px+ headers
- Local mqttClient.ts is used instead of @mango/mqtt (shared package has broken dependencies)
- mqttService singleton handles connection state, subscriptions, and publishing
- PadMqttProvider wraps app and auto-subscribes to ready_to_pay, payment_result, and cancel topics
- NumericKeypadModal pattern for custom amount entry (see TipPage.tsx)
- formatCurrency helper using Intl.NumberFormat for currency display

---

## [2026-01-10] - US-001
Thread: https://ampcode.com/threads/T-019ba7bb-e559-76ea-9418-be8413fc73dc
- Implemented Redux Toolkit store with padSlice, transactionSlice, configSlice, uiSlice
- Created TypeScript types for all MQTT payloads and app state
- Created local MQTT client service using mqtt.js library
- Created PadMqttProvider that subscribes to ready_to_pay, payment_result, cancel topics
- Added publish functions for tip_selected, signature, receipt_preference, transaction_complete, help_requested, split_payment
- Connection status tracked in Redux (connected/disconnected/reconnecting)
- Files changed:
  - src/store/index.ts, src/store/hooks.ts
  - src/store/slices/padSlice.ts, transactionSlice.ts, configSlice.ts, uiSlice.ts
  - src/types/index.ts
  - src/services/mqttClient.ts
  - src/providers/PadMqttProvider.tsx
  - src/constants/mqttTopics.ts
  - src/main.tsx, src/App.tsx
  - package.json (added redux, mqtt, uuid dependencies)
- **Learnings for future iterations:**
  - The shared @mango/mqtt package has broken dependencies; use local mqttClient.ts instead
  - configSlice auto-persists to localStorage on every change
  - mqtt.js requires `pnpm add mqtt uuid @types/uuid`
---

## [2026-01-10] - US-002
Thread: https://ampcode.com/threads/T-019ba7c2-dba7-760b-b981-57b0ff28c81c
- Implemented IdlePage with digital signage features
- Full-screen display with configurable salon logo
- Live date/time that updates every minute
- Promotional carousel with multiple slide types (promotion, announcement, staff-spotlight, testimonial, social-qr)
- Configurable slide duration from config store (default 8 seconds)
- Smooth fade/slide transitions using Framer Motion
- Animated gradient background using Framer Motion
- MQTT connection status indicator in bottom-right corner
- Updated App.tsx to use Redux-based screen navigation with AnimatePresence
- Files changed:
  - src/pages/IdlePage.tsx (new)
  - src/App.tsx (rewrote to use ScreenRouter pattern)
  - package.json (added framer-motion v11)
- **Learnings for future iterations:**
  - Framer Motion v12 has TypeScript type issues; use v11 instead
  - App uses ScreenRouter component with AnimatePresence for smooth transitions
  - PromoSlide types already defined in configSlice; use them directly
  - ConnectionStatusIndicator pattern can be reused across screens
---

## [2026-01-10] - US-003
Thread: https://ampcode.com/threads/T-019ba7c8-33e8-76af-bf42-dce8420b1ff2
- Implemented OrderReviewPage with complete transaction display
- Header shows client name prominently with staff name
- Services and products listed separately with icons (Scissors for services, ShoppingBag for products)
- Summary shows subtotal, tax, discount (if applicable), and total
- "Looks Good" button proceeds to next screen (tip, signature, or payment based on config)
- Split Payment button when enabled in settings
- Need Help button publishes help_requested via MQTT
- Files changed:
  - src/pages/OrderReviewPage.tsx (new)
  - src/App.tsx (added OrderReviewPage import and case)
- **Learnings for future iterations:**
  - Use usePadMqtt() hook from PadMqttProvider to publish MQTT messages
  - config.tipEnabled and config.signatureRequired control screen flow
  - formatCurrency helper using Intl.NumberFormat for consistent currency display
  - lucide-react icons: Scissors (services), ShoppingBag (products), HelpCircle (help)
---

## [2026-01-10] - US-004
Thread: https://ampcode.com/threads/T-019ba7cc-2c83-76a8-9053-b1506aceedf9
- Implemented TipPage with full tip selection functionality
- Supports configurable tip type: percentage-based OR dollar-based from config
- Suggested tip buttons display calculated amounts clearly
- NumericKeypadModal component for custom tip entry with full numeric keypad
- No Tip option as smaller button
- Running total updates dynamically as tip is selected
- Selected tip visually highlighted with distinct indigo style
- Continue button proceeds to signature or payment based on config.signatureRequired
- Publishes tip to MQTT salon/{id}/pad/tip_selected via usePadMqtt hook
- Files changed:
  - src/pages/TipPage.tsx (complete rewrite - removed react-router, now uses Redux)
- **Learnings for future iterations:**
  - NumericKeypadModal is reusable - can be extracted to components/ if needed elsewhere
  - TipButton component pattern reusable for grid selection UIs
  - formatCurrency helper duplicated from OrderReviewPage - consider extracting to utils/
---

## [2026-01-10] - US-005
Thread: https://ampcode.com/threads/T-019ba7d0-1068-7398-a929-ea4d536a4552
- Implemented SignaturePage with react-signature-canvas library
- Full-width signature canvas that works with finger touch and stylus
- Clear button resets the signature canvas
- Shows agreement text: "By signing above, I agree to pay the total shown and authorize this transaction"
- Shows final total including tip prominently in header
- Done button to proceed (disabled when signature is empty)
- Signature captured as base64 PNG via toDataURL('image/png')
- Minimum validation: button disabled when canvas isEmpty()
- Publishes signature to MQTT salon/{id}/pad/signature via usePadMqtt hook
- Files changed:
  - src/pages/SignaturePage.tsx (complete rewrite)
  - package.json (added react-signature-canvas, @types/react-signature-canvas)
- **Learnings for future iterations:**
  - react-signature-canvas provides onBegin/onEnd callbacks to track if signature is empty
  - SignatureCanvas ref has isEmpty() and toDataURL() methods
  - penColor, dotSize, minWidth, maxWidth control signature appearance
  - Use pointer-events-none on overlay elements to not interfere with canvas
---

## [2026-01-10] - US-006
Thread: https://ampcode.com/threads/T-019ba7d3-5ca2-7148-910f-05f5ab04cf1e
- Implemented PaymentPage for payment instruction display
- Large clear "Please Insert or Tap Card" text with animated card visual
- CardAnimation component with NFC wave effects and bouncing card icon
- TerminalIcon component shows terminal-specific icons (PAX, Dejavoo, Clover, generic)
- PulsingLoader for processing indicator
- Amount to charge displayed prominently including tip
- Cancel/Help button publishes help_requested via MQTT
- Timeout handling: after configurable paymentTimeout seconds, shows timeout message with retry option
- Listens for payment_result via Redux/MQTT and auto-navigates to result screen
- Connection status indicator in footer
- Files changed:
  - src/pages/PaymentPage.tsx (new)
  - src/App.tsx (added PaymentPage import and case)
- **Learnings for future iterations:**
  - Use useRef for timeout management to properly clean up on unmount
  - config.paymentTimeout (in seconds) controls timeout duration
  - Payment result is received via PadMqttProvider which dispatches to transactionSlice
  - Terminal type icons can be customized per brand (PAX, Dejavoo, Clover, or generic)
---

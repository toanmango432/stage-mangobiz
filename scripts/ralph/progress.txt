## Codebase Patterns

See patterns.md for accumulated patterns from previous runs.

---

# Ralph Progress Log
Started: Mon Jan 13 2026
Branch: ralph/mango-pad-integration

<!-- Ralph appends entries below -->

## 2026-01-13 - US-001: Add subscription confirmation callbacks to mqttClient
Commit: 6e0f945
- Added callback parameter to `subscribe()` method with success/error logging
- Added callback parameter to `resubscribeAll()` method for reconnection handling
- Console shows `[MqttClient] Subscription SUCCESS for {topic}` on success
- Console shows `[MqttClient] Subscription FAILED for {topic}` with error on failure
- Files changed: `apps/mango-pad/src/services/mqttClient.ts`
- **Learnings for future iterations:**
  - The `resubscribeAll()` method is called from `onConnect` handler (line 132) to restore subscriptions after reconnection
  - MQTT subscription callback follows pattern: `(err) => { if(err) error else success }`
  - ESLint may not be available in all environments - TypeScript check is sufficient for validation
---

## 2026-01-13 - US-002: Fix PadMqttProvider subscription timing
Commit: 9a3daa2
- Added console log confirming subscription setup: '[PadMqttProvider] Setting up subscriptions for station: {stationId}'
- Verified that all subscription useEffects already check `connectionStatus !== 'connected'` before subscribing
- useEffect dependency arrays already include `connectionStatus`
- Files changed: `apps/mango-pad/src/providers/PadMqttProvider.tsx`
- **Learnings for future iterations:**
  - The code already had proper guards - just needed the explicit log message for verification
  - mango-pad uses `npx tsc --noEmit` for typecheck since it doesn't have its own `typecheck` script
  - Pre-existing typecheck errors in `@mango/api-client` and store-app test files don't block mango-pad work
---

## 2026-01-13 - US-003: Fix ReconnectingOverlay blocking pairing flow
Commit: b469af4
- Modified ReconnectingOverlay to only show when all conditions are met:
  1. Device is paired (has pairing info in localStorage)
  2. NOT on /welcome or /pair routes
  3. Device was previously connected and connection dropped
- Added `checkIsPaired()` function to verify pairing status from localStorage
- Added `EXCLUDED_ROUTES` constant for routes where overlay should not appear
- Added `wasConnected` state with useRef to track if device was previously connected
- Changed rendering condition from `showReconnecting` to `shouldShow` with all conditions
- Files changed: `apps/mango-pad/src/components/ReconnectingOverlay.tsx`
- **Learnings for future iterations:**
  - The ReconnectingOverlay component is a global component rendered in App.tsx
  - The `showReconnecting` state is set in PadMqttProvider when connection status changes
  - Pairing info is stored in localStorage as `mango_pad_pairing` with `stationId` and `salonId`
  - `useLocation` from react-router-dom can be used to check current route
---

## 2026-01-13 - US-004: Remove redundant PosHeartbeatProvider from Store App
Commit: 9473bc7
- Removed PosHeartbeatProvider import and usage from App.tsx
- Deleted apps/store-app/src/providers/PosHeartbeatProvider.tsx completely
- Store App now publishes only ONE heartbeat via usePosHeartbeat in PadConnectionIndicator
- Uses correct station-specific topic: salon/{storeId}/station/{stationId}/heartbeat
- Files changed: `apps/store-app/src/App.tsx`, `apps/store-app/src/providers/PosHeartbeatProvider.tsx` (deleted)
- **Learnings for future iterations:**
  - There were TWO heartbeat mechanisms: PosHeartbeatProvider (wrong topic) and usePosHeartbeat (correct topic)
  - PosHeartbeatProvider was publishing to `salon/{storeId}/pos/heartbeat` (generic store-level)
  - usePosHeartbeat publishes to `salon/{storeId}/station/{stationId}/heartbeat` (device-to-device)
  - The correct approach is device-to-device heartbeats for Mango Pad integration
  - usePosHeartbeat is called in PadConnectionIndicator component (apps/store-app/src/components/layout/PadConnectionIndicator.tsx)
  - Pre-existing typecheck errors in test files don't block production code changes
---

## 2026-01-13 - US-005: Fix message parse errors in usePadHeartbeat
Commit: 5a9b3a8
- Modified `usePadHeartbeat.ts` to handle both wrapped MqttMessage format and direct payload
- Added detection for wrapped format: checks if `parsed.payload` exists and is an object
- Added detection for direct format: checks if `parsed.deviceId` exists at root level
- Added console warnings for unknown message formats instead of failing silently
- Files changed: `apps/store-app/src/services/mqtt/hooks/usePadHeartbeat.ts`
- **Learnings for future iterations:**
  - Mango Pad wraps all MQTT messages in `{ id, timestamp, payload }` format via `mqttClient.ts` publish()
  - Store App components receiving Mango Pad messages must unwrap the payload
  - Always check for `payload` property first, then fall back to direct format for backwards compatibility
  - The `PadHeartbeatPayload` type has `deviceId` as a required field, useful for format detection
---

## 2026-01-13 - US-006: Add transaction types to Mango Pad
Commit: 509d0a4
- Added `PadFlowStep` type with all 9 flow states: waiting, receipt, tip, signature, receipt_preference, waiting_payment, complete, failed, cancelled
- Updated `TransactionItem` interface to include required `id` field and optional `staffName` field
- Created `ActiveTransaction` interface with all required fields for customer checkout flow:
  - Core IDs: transactionId, ticketId
  - Client info: clientName, clientEmail?, clientPhone?
  - Staff: staffName
  - Items and totals: items[], subtotal, tax, discount, total
  - Tips: suggestedTips[], tipAmount, tipPercent
  - Customer selections: signatureData?, receiptPreference?
  - Flow state: step, startedAt
  - Payment result: paymentResult? with success, cardLast4, cardBrand, errorMessage
- Updated test files to include `id` field in TransactionItem mock data
- Files changed: `apps/mango-pad/src/types/index.ts`, `apps/mango-pad/src/store/index.test.ts`, `apps/mango-pad/src/store/slices/transactionSlice.test.ts`
- **Learnings for future iterations:**
  - When changing a type that's used in test files, those tests need to be updated too
  - The `TransactionItem` is used by both `TransactionPayload` and the new `ActiveTransaction`
  - `ReceiptPreference` type already exists and is reused in `ActiveTransaction`
---

## 2026-01-13 - US-007: Add transaction state to PadMqttProvider
Commit: de2c81b
- Added `activeTransaction: ActiveTransaction | null` to PadMqttContextValue computed from Redux state
- Added `setActiveTransaction()` function that converts ActiveTransaction to TransactionPayload and dispatches to Redux
- Added `clearTransaction()` function that clears Redux transaction state and resets screen to idle
- Added `updateTransactionStep(step: PadFlowStep)` function that navigates to appropriate screen
- Added helper functions: `flowStepToScreen()` and `screenToFlowStep()` for mapping between PadFlowStep and PadScreen
- Files changed: `apps/mango-pad/src/providers/PadMqttProvider.tsx`
- **Learnings for future iterations:**
  - Transaction state is managed via Redux (transactionSlice + padSlice) not local state
  - The existing codebase already has TransactionPayload type for Redux, ActiveTransaction is a computed view
  - PadFlowStep ('waiting', 'receipt', 'tip', etc.) maps to PadScreen ('idle', 'order-review', 'tip', etc.)
  - When adding context functions, use `useCallback` for memoization with proper dependency arrays
---

## 2026-01-13 - US-008: Subscribe to transaction topics in Mango Pad
Marked as ALREADY COMPLETE
- PadMqttProvider already subscribes to ready_to_pay, payment_result, and cancel topics (lines 288-361)
- Handlers dispatch Redux actions and navigate to appropriate screens
- Files: `apps/mango-pad/src/providers/PadMqttProvider.tsx`
- **Learnings for future iterations:**
  - Check existing code before implementing - US-008 was already done
  - Transaction subscriptions use PAD_TOPICS constants from mqttTopics.ts
---

## 2026-01-13 - US-009: Add publish functions for transaction events
Marked as ALREADY COMPLETE
- PadMqttProvider already has publishTipSelected, publishSignature, publishReceiptPreference, publishTransactionComplete
- All functions include transactionId in payload (lines 515-550)
- Files: `apps/mango-pad/src/providers/PadMqttProvider.tsx`
- **Learnings for future iterations:**
  - Publish functions are defined with useCallback and proper dependencies
  - They use buildPadTopic() with PAD_TOPICS constants
---

## 2026-01-13 - US-010: Create transaction navigation hook
Commit: af0ddd1
- Created `useTransactionNavigation` hook at `apps/mango-pad/src/hooks/useTransactionNavigation.ts`
- Implements STEP_TO_ROUTE mapping for all 9 PadFlowStep values
- Uses react-router's useNavigate for URL-based navigation
- Watches activeTransaction.step changes and navigates automatically
- Added skipInitialNavigation option for flexible usage patterns
- Added helper functions: getRouteForStep() and getStepForRoute()
- Files changed: `apps/mango-pad/src/hooks/useTransactionNavigation.ts`
- **Learnings for future iterations:**
  - The app uses both Redux screen state (PadScreen) AND react-router for navigation
  - PadFlowStep is the user-facing step, PadScreen is the internal screen state
  - URL route mapping: waiting->/, receipt->/receipt, tip->/tip, etc.
  - Use useRef for tracking previous values to detect changes
---

## 2026-01-13 - US-011: Update WaitingPage to use transaction context
Commit: 6ccfcd0
- Added `useTransactionNavigation` hook with `skipInitialNavigation: true` for auto-navigation on incoming transactions
- Created `DEMO_TRANSACTION` constant with mock data:
  - 3 items (Haircut, Beard Trim, Hair Product) with staffName and prices
  - Calculated subtotal ($89.99), tax ($7.20), total ($97.19)
  - suggestedTips array [15, 18, 20, 25] for percentage-based tips
- Updated `handleStartDemo` to use `setActiveTransaction` from PadMqttProvider
- Demo creates fresh transaction with dynamic ID (`demo-${Date.now()}`) and timestamp
- Files changed: `apps/mango-pad/src/pages/WaitingPage.tsx`
- **Learnings for future iterations:**
  - `setActiveTransaction` dispatches to Redux and navigates to appropriate screen via `flowStepToScreen`
  - Demo mode detected via `isDemoMode()` from DemoBanner component
  - useCallback used for handleStartDemo to avoid unnecessary re-renders
  - The hook `skipInitialNavigation: true` prevents navigation on initial mount while still watching for step changes
---

## 2026-01-13 - US-012: Update ReceiptPage to use real transaction data
Commit: b49dcaa
- Updated `OrderReviewPage` (receipt step) to use `activeTransaction` from PadMqttProvider context
- Added `DEMO_TRANSACTION` constant with mock data for demo mode:
  - 3 items: Haircut & Style ($45), Deep Conditioning ($25), Premium Shampoo ($18.99)
  - Client: Sarah Johnson, Staff: Mike Chen
  - Calculated subtotal ($88.99), tax ($7.12), total ($96.11)
- Added `useTransactionNavigation` hook with `skipInitialNavigation: true`
- Removed early return for missing transaction - now always displays demo or real data
- Files changed: `apps/mango-pad/src/pages/OrderReviewPage.tsx`
- **Learnings for future iterations:**
  - The "receipt" PadFlowStep maps to `order-review` PadScreen (OrderReviewPage)
  - The "receipt_preference" PadFlowStep maps to `receipt` PadScreen (ReceiptPage)
  - Use `activeTransaction` from context instead of `state.transaction.current` from Redux
  - Demo fallback pattern: `const transaction = activeTransaction ?? { ...DEMO_DATA, step, startedAt }`
---

## 2026-01-13 - US-013: Update TipPage to publish tip selection
Commit: 1248604
- Updated TipPage to use `activeTransaction` from `usePadMqtt()` context instead of Redux directly
- Added `DEMO_TRANSACTION` constant with mock data for demo mode fallback (same pattern as OrderReviewPage)
- Uses `transaction.suggestedTips` when available, falls back to `config.tipSuggestions`
- Added `useTransactionNavigation` hook with `skipInitialNavigation: true` for auto-navigation
- Tip calculations now use `activeTransaction.total` for percentage calculations via `baseAmount`
- `handleContinue` already dispatches `setTip` to Redux and calls `publishTipSelected()`
- Files changed: `apps/mango-pad/src/pages/TipPage.tsx`
- **Learnings for future iterations:**
  - The pattern for demo mode fallback is: `const transaction = activeTransaction ?? { ...DEMO_DATA, step, startedAt }`
  - `suggestedTips` can come from either transaction or config - prefer transaction for real data
  - The `baseAmount` variable handles split payment cases, using split amount when applicable
  - Hook call must be before any conditional returns (moved useTransactionNavigation after useState calls)
---

## 2026-01-13 - US-014: Update SignaturePage to publish signature
Commit: 0ac9e8b
- Updated SignaturePage to use `activeTransaction` from PadMqttProvider context
- Added `DEMO_TRANSACTION` constant for demo mode fallback (same pattern as TipPage/OrderReviewPage)
- Added `useTransactionNavigation` hook with `skipInitialNavigation: true` for auto-navigation
- Changed navigation target from 'payment' screen to 'receipt_preference' step via `updateTransactionStep()`
- Updated tipAmount calculation to use `activeTransaction.tipAmount` when available
- Files changed: `apps/mango-pad/src/pages/SignaturePage.tsx`
- **Learnings for future iterations:**
  - The `updateTransactionStep('receipt_preference')` function navigates via Redux screen state
  - 'receipt_preference' PadFlowStep maps to 'receipt' PadScreen (ReceiptPage)
  - Always import `ActiveTransaction` type for demo fallback pattern
  - Use useCallback for async handlers that reference context functions to ensure proper memoization
---

## 2026-01-13 - US-015: Create ReceiptPreferencePage
Commit: b81362a
- Created new `ReceiptPreferencePage.tsx` at `apps/mango-pad/src/pages/ReceiptPreferencePage.tsx`
- Implemented 4 receipt options: Email, SMS/Text, Print, No Receipt
- Pre-fills email/phone from `activeTransaction.clientEmail` and `activeTransaction.clientPhone`
- Edit modal for modifying email/phone on the fly (reusable EditModal component)
- On complete, calls `publishReceiptPreference()` with preference and optional email/phone
- Then calls `publishTransactionComplete()` to signal completion to Store App
- Updates step to `waiting_payment` via `updateTransactionStep()` which navigates to /processing
- Added route `/receipt-preference` in App.tsx with PairingGuard wrapper
- Follows established demo fallback pattern with `DEMO_TRANSACTION` constant
- Files changed: `apps/mango-pad/src/pages/ReceiptPreferencePage.tsx` (new), `apps/mango-pad/src/App.tsx`
- **Learnings for future iterations:**
  - The app uses explicit URL routes for new pages (not just ScreenRouter) for deep linking
  - Route must be added BEFORE the `/*` wildcard route in App.tsx
  - All routes in transaction flow need PairingGuard wrapper
  - The existing `ReceiptPage.tsx` handles old receipt selection flow via Redux screen state
  - New pages should follow the URL-based routing pattern for consistency with useTransactionNavigation
---

## 2026-01-13 - US-016: Create ProcessingPage
Commit: b53dc30
- Created new `ProcessingPage.tsx` at `apps/mango-pad/src/pages/ProcessingPage.tsx`
- Shows "Processing Payment" message with animated credit card icon
- Spinner animation using Framer Motion with pulsing rings and rotating progress arc
- Displays total amount including tip breakdown
- Uses `useTransactionNavigation({ skipInitialNavigation: true })` for auto-navigation to /complete or /failed
- Added animated bouncing dots for visual feedback
- Screen reader announcements for accessibility
- Added `/processing` route in App.tsx with PairingGuard wrapper
- Follows established demo fallback pattern with `DEMO_TRANSACTION` constant
- Files changed: `apps/mango-pad/src/pages/ProcessingPage.tsx` (new), `apps/mango-pad/src/App.tsx`
- **Learnings for future iterations:**
  - Processing pages should have visual animations to indicate activity (spinners, pulsing effects)
  - Include screen reader status announcements for accessibility compliance
  - The `useTransactionNavigation` hook will auto-navigate when Store App sends payment_result
  - Keep the design centered and minimal to avoid distracting the user during payment processing
---

## 2026-01-13 - US-017: Create CompletePage
Commit: d7f8467
- Created new `CompletePage.tsx` at `apps/mango-pad/src/pages/CompletePage.tsx`
- Shows success checkmark icon (CheckCircle from lucide-react) with animated pulsing gradient circle
- Displays "Payment Complete" heading with personalized "Thank you, {clientName}!" message
- Shows total amount charged with tip breakdown (amount and percentage)
- Shows card info (last 4 digits and brand) if available from paymentResult
- Shows receipt preference confirmation (email/SMS/print/none)
- Auto-returns to WaitingPage after 5 seconds using setTimeout and animated progress bar
- Clears activeTransaction via useRef hasCleared guard:
  - On handleReturnToWaiting (before navigation)
  - On component unmount (cleanup effect)
- Added `/complete` route in App.tsx with PairingGuard wrapper
- Follows established demo fallback pattern with DEMO_TRANSACTION constant
- Decorative floating Sparkles and Star icons for visual appeal
- Files changed: `apps/mango-pad/src/pages/CompletePage.tsx` (new), `apps/mango-pad/src/App.tsx`
- **Learnings for future iterations:**
  - Use useRef to track if cleanup has already been performed to avoid double-clearing
  - The CompletePage does NOT use useTransactionNavigation - it navigates manually on timeout
  - Green gradient theme (from-green-50 to-emerald-50) differentiates success from processing (indigo)
  - Include receipt preference confirmation to reassure customer about their selection
  - Card info (cardLast4, cardBrand) comes from transaction.paymentResult if available
---

## 2026-01-13 - US-018: Create FailedPage
Commit: cba962d
- Created new `FailedPage.tsx` at `apps/mango-pad/src/pages/FailedPage.tsx`
- Shows error icon (XCircle from lucide-react) with red gradient circle
- Displays "Payment Failed" heading with personalized "We're sorry, {clientName}" message
- Error details card shows `paymentResult.errorMessage` or default message
- Shows attempted amount (total + tip) that was NOT charged, styled in red
- Help text suggests trying again or contacting staff
- Return to Waiting button clears transaction via `clearTransaction()` and navigates to `/`
- Uses useRef `hasCleared` guard pattern from CompletePage to avoid double-clearing
- Cleanup effect clears transaction on unmount
- Added `/failed` route in App.tsx with PairingGuard wrapper
- Red/rose gradient theme (from-red-50 to-rose-50) differentiates failure from success
- Decorative floating AlertTriangle icons for visual consistency
- Files changed: `apps/mango-pad/src/pages/FailedPage.tsx` (new), `apps/mango-pad/src/App.tsx`
- **Learnings for future iterations:**
  - FailedPage does NOT use useTransactionNavigation - user must manually click button to retry
  - Error message comes from `transaction.paymentResult?.errorMessage`
  - Red gradient theme (from-red-50 to-rose-50) mirrors CompletePage green pattern
  - Include helpful suggestions for user (retry, different payment method, contact staff)
  - No auto-timeout for failure page - let user read error and decide when to proceed
---

## 2026-01-13 - US-019: Add new routes to App.tsx
Marked as ALREADY COMPLETE
- All routes were added in previous iterations:
  - `/receipt-preference` added in US-015 (commit b81362a)
  - `/processing` added in US-016 (commit b53dc30)
  - `/complete` added in US-017 (commit d7f8467)
  - `/failed` added in US-018 (commit cba962d)
- All routes wrapped in PairingGuard component
- Files: `apps/mango-pad/src/App.tsx`
- **Learnings for future iterations:**
  - Routes are added incrementally as pages are created
  - Check if a story's acceptance criteria are already satisfied by prior work
---

## 2026-01-13 - US-020: Fix sendPaymentResult in Store App
Commit: 02be8ce
- Verified implementation already exists in `useTicketPayment.ts`:
  - Success case (lines 216-234): Sends success result with cardLast4, cardBrand, authCode
  - Failure case (lines 246-258): Sends failure result with errorMessage
- Created comprehensive unit tests in `mangoPadService.test.ts`:
  - 13 tests covering success/failure payload structure
  - Tests verify transactionId, ticketId, success, cardLast4, cardBrand, authCode fields
  - Tests verify errorMessage for failure cases
  - Tests verify correct topic pattern: `salon/{storeId}/station/{stationId}/pad/payment_result`
  - Tests verify QoS 1 for reliability
  - Tests verify error handling for MQTT disabled and not connected states
- Installed missing test dependencies: @testing-library/jest-dom, @testing-library/react
- Files changed: `apps/store-app/src/services/__tests__/mangoPadService.test.ts` (new), `apps/store-app/package.json`
- **Learnings for future iterations:**
  - Pre-existing typecheck errors in store-app test files don't block new test additions
  - Use `vi.clearAllMocks()` and re-mock return values in `beforeEach` to ensure mocks reset between tests
  - The `getMangoPadService()` singleton pattern requires `destroyMangoPadService()` between tests
  - Payment flow in Store App uses `padTransactionId` in PaymentData to track Mango Pad transactions
---

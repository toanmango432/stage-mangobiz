## Codebase Patterns

See patterns.md for accumulated patterns from previous runs.

**Front Desk Module Patterns:**
- StaffCardVertical is the shared component for mobile/desktop staff display
- frontDeskSettingsSlice controls all Front Desk settings (view modes, sorting, drag-drop)
- urgencyUtils.ts contains threshold configs and color mappings
- Use design tokens from @/design-system for all colors
- Ticket cards use ServiceTicketCard and variants (WaitListTicketCard, PendingTicketCard)
- Section headers use CollapsibleSection pattern with count badges

---

# Ralph Progress Log
Started: 2026-01-13
Branch: ralph/frontdesk-update

<!-- Ralph appends entries below -->

## 2026-01-13 22:59 - US-001: Connect StaffCard displayConfig to FrontDeskSettings
Commit: ae9347b
- Added imports for useAppSelector and selectFrontDeskSettings from Redux
- StaffSidebar now reads settings from Redux frontDeskSettingsSlice
- Connected displayConfig to FrontDeskSettings: showTurnCount, showNextAppointment, showServicedAmount, showTicketCount, showLastDone
- Redux settings take priority, prop settings as fallback for backwards compatibility
- Files changed: apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - StaffSidebar has TWO settings systems: TeamSettingsPanel (localStorage) and FrontDeskSettings (Redux)
  - FrontDeskSettings is the main settings panel accessed via More > Front Desk Layout
  - TeamSettingsPanel is a legacy local settings (accessed via gear icon in Team section header)
  - Redux settings should be the single source of truth for card display options
---

## 2026-01-13 23:15 - US-002: Add More Options dropdown menu to StaffCard
Commit: 0413b05
- Added action settings to DisplayConfig interface: showMoreOptionsButton, showAddTicketAction, showAddNoteAction, showEditTeamAction, showQuickCheckoutAction
- Added action callbacks to StaffCardVerticalProps: onAddTicket, onAddNote, onEditTeam, onQuickCheckout
- Implemented DropdownMenu using Radix UI components from @/components/ui/dropdown-menu
- Menu items respect displayConfig settings (conditional rendering)
- Quick Checkout only visible when staff is busy and has activeTicket
- Files changed:
  - apps/store-app/src/components/StaffCard/hooks/useStaffCardDisplay.ts
  - apps/store-app/src/components/StaffCard/StaffCardVertical.tsx
- **Learnings for future iterations:**
  - Use existing DropdownMenu component from @/components/ui/dropdown-menu (shadcn/radix wrapper)
  - DisplayConfig interface in useStaffCardDisplay.ts is the central config for StaffCard display options
  - Action settings from FrontDeskSettingsData should map to DisplayConfig for consistency
  - Callbacks use staffId parameter so parent component can identify which staff triggered the action
---

## 2026-01-13 23:45 - US-003: Implement Add Ticket action on staff cards
Commit: 365a845
- Added useTicketPanel hook import to StaffSidebar for ticket creation flow
- Created handleAddTicket callback that opens ticket panel with staff pre-selected
- Passes techId and technician name to openTicketWithData for pre-selection
- Connected action settings (showAddTicketAction, showAddNoteAction, etc.) from FrontDeskSettings to displayConfig
- Passed onAddTicket callback to StaffCardVertical component
- Files changed:
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - useTicketPanel provides openTicketWithData(ticket) to open ticket panel with pre-filled data
  - TicketData interface includes techId and technician fields for staff pre-selection
  - Staff IDs may be strings or numbers - need to handle both when finding staff member
  - Action settings from FrontDeskSettings are passed through displayConfig to StaffCardVertical
---

## 2026-01-13 - US-004: Implement Add Note action on staff cards
Commit: 5fac7c6
- Created AddStaffNoteModal component for staff-specific notes (apps/store-app/src/components/frontdesk/AddStaffNoteModal.tsx)
- Added state management for staff note modal in StaffSidebar: showStaffNoteModal, selectedStaffForNote
- Created handleAddNote callback that finds staff member and opens note modal
- Created handleSaveStaffNote callback (placeholder for API integration)
- Passed onAddNote callback to StaffCardVertical component
- Modal uses teal color scheme to match Team Section styling
- Files changed:
  - apps/store-app/src/components/frontdesk/AddStaffNoteModal.tsx (new)
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - Existing AddNoteModal is for tickets (requires ticketId, ticketNumber, clientName)
  - Created separate AddStaffNoteModal for staff notes to avoid coupling
  - Staff notes need their own storage/API integration (TODO in handleSaveStaffNote)
  - Use selectedStaffForNote state to track which staff member the modal is for
---

## 2026-01-13 - US-005: Implement Edit Team Member action on staff cards
Commit: 96528c3
- Added useAppDispatch hook import to StaffSidebar for Redux dispatch
- Added setSelectedMember import from teamSlice for pre-selecting team member
- Created handleEditTeam callback that:
  1. Finds staff member by numeric ID (handles string/number ID conversion)
  2. Pre-selects the staff member in Redux teamSlice using setSelectedMember
  3. Navigates to team-settings module via custom event (navigate-to-module)
- Passed onEditTeam callback to StaffCardVertical component
- Files changed:
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - AppShell listens for 'navigate-to-module' custom events to switch modules
  - UIStaff.id is already the team member UUID string (from TeamMemberSettings.id)
  - teamSlice's setSelectedMember expects a string ID matching TeamMemberSettings.id
  - Navigation pattern: dispatch Redux action first, then trigger module navigation event
---

## 2026-01-13 - US-006: Implement Quick Checkout action on staff cards
Commit: 9a69a44
- Added serviceTickets to useTickets() destructuring to get in-service tickets
- Created handleQuickCheckout callback that:
  1. Finds staff member by numeric ID (handles string/number conversion)
  2. Finds the staff's in-service ticket by matching techId/staffId/assignedTo.id
  3. Converts UITicket to TicketData format for the checkout panel
  4. Opens the ticket panel with openTicketWithData()
- Passed onQuickCheckout callback to StaffCardVertical component
- Quick Checkout only visible when staff is busy AND has activeTicket (existing StaffCardVertical logic)
- Files changed:
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - UITicket uses `number` (not ticketNumber), `service` (singular string), `checkoutServices` (detailed array)
  - useTickets() returns `serviceTickets` for in-service tickets
  - openTicketWithData() accepts TicketData and stores in localStorage for TicketPanel to load
  - Staff can be matched by techId, staffId, or assignedTo.id fields on the ticket
---

## 2026-01-13 - US-007: Apply FrontDeskSettings to MobileTeamSection
Commit: 4c147ad
- Added useAppSelector import and read FrontDeskSettings from Redux
- Implemented organizeBy setting to control grouping: busyStatus shows Ready/Busy, clockedStatus shows Clocked In/Out
- Updated filter state type to include clockedIn/clockedOut options
- Added clockedIn/clockedOut counts to the counts calculation
- Updated filteredStaff logic to handle both organizeBy modes
- Updated groupedStaff to include clockedIn/clockedOut groups
- Updated currentCount to handle both organizeBy modes
- Filter buttons now show different options based on organizeBy (Ready/Busy vs In/Out)
- Added displayConfig to all StaffCardVertical components with settings:
  - showTurnCount, showNextAppointment, showServicedAmount (showSalesAmount), showTicketCount, showLastDone
- Files changed:
  - apps/store-app/src/components/frontdesk/MobileTeamSection.tsx
- **Learnings for future iterations:**
  - MobileTeamSection uses a simpler 3-column filter layout (All + 2 status filters)
  - Filter state should include all possible filter values across both modes
  - useMemo should include all dependencies (organizeBy was added as dependency)
  - The desktop StaffSidebar pattern was used as reference for settings integration
---

## 2026-01-13 - US-008: Connect StaffCard to real ticket data
Commit: 35b6c98
- Added selectServiceTickets selector import from uiTicketsSlice
- Added inServiceTickets state from Redux using useAppSelector
- Created getStaffTicketInfo helper function (useCallback memoized) that:
  1. Filters inServiceTickets by staff ID (matches techId or assignedTo.id)
  2. Calculates real progress from createdAt time vs duration string
  3. Formats start time for display (e.g., "10:15AM")
  4. Returns activeTickets array and currentTicketInfo object
- Replaced hardcoded dummy ticket data (Test Client, Test Service, 67% progress)
- Staff cards now show real client name, service name, start time, and calculated progress
- Removed mock lastServiceTime and nextAppointmentTime (will be real data in US-009)
- Files changed:
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - selectServiceTickets from uiTicketsSlice returns UITicket[] for in-service tickets
  - UITicket has: techId, assignedTo?.id, clientName, service, duration, createdAt
  - Duration is stored as string like "30min" - parse with parseInt(duration.replace(/\D/g, ''))
  - Progress calculation: elapsed time / total duration, capped 0-1
  - Use useCallback with [inServiceTickets] dependency for performance
  - Type compatibility: use `?? undefined` to convert null to undefined
---

## 2026-01-14 - US-009: Connect StaffCard to real appointment data
Commit: 11cd707
- Added selectAllAppointments selector import from appointmentsSlice
- Added selectCompletedTickets selector import from uiTicketsSlice
- Added LocalAppointment type import from @/types/appointment
- Created getStaffNextAppointment helper function (useCallback memoized) that:
  1. Filters allAppointments by staffId matching (handles string/number IDs)
  2. Only includes scheduled/confirmed/pending status appointments
  3. Filters for future appointments only
  4. Sorts by scheduledStartTime ascending
  5. Returns formatted time string (e.g., "10:30 AM")
- Created getStaffLastServiceTime helper function (useCallback memoized) that:
  1. Filters completedTickets by techId or assignedTo.id matching
  2. Sorts by updatedAt/createdAt descending (most recent first)
  3. Returns formatted time string from last completion
- Replaced mock nextAppointmentTime/lastServiceTime with real data
- Updated tooltip to show Next Appt and Last Done times
- Files changed:
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - LocalAppointment.scheduledStartTime is always a string (ISO format) - no need for type check
  - Appointment status values: 'scheduled', 'confirmed', 'pending', 'cancelled', 'completed', etc.
  - completedTickets are tickets with status 'paid' (not 'completed' which means pending checkout)
  - UITicket.updatedAt is when ticket was marked as paid/completed
  - toLocaleTimeString with hour12: true gives "10:30 AM" format
---

## 2026-01-14 - US-010: Add staff card click handler for details
Commit: 5610310
- Created StaffDetailsPanel component (apps/store-app/src/components/frontdesk/StaffDetailsPanel.tsx)
  - Side panel with slide-in animation and backdrop
  - Shows today's stats (tickets completed, pending appointments, total services)
  - Lists current in-service tickets for the staff member
  - Shows upcoming appointments with service name and time
  - Includes quick action buttons (Add Ticket, Add Note, Edit Team)
- Added state management in StaffSidebar: showStaffDetails, selectedStaffForDetails
- Created handleStaffClick callback that opens the details panel
- Connected onClick to StaffCardVertical component
- Files changed:
  - apps/store-app/src/components/frontdesk/StaffDetailsPanel.tsx (new)
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
- **Learnings for future iterations:**
  - LocalAppointment has a `services` array of AppointmentService[], not individual serviceName/duration fields
  - Access service data via `apt.services?.[0]?.serviceName` and `apt.services?.reduce()` for duration
  - Staff details panel should reuse existing action handlers (handleAddTicket, handleAddNote, etc.)
  - Use z-50 for modal overlays to ensure proper stacking over other UI elements
---

## 2026-01-14 - US-011: Add Mobile staff card actions
Commit: 3d9c52d
- Created MobileStaffActionSheet component (apps/store-app/src/components/frontdesk/MobileStaffActionSheet.tsx)
  - Uses Radix UI Sheet component with side="bottom" for mobile-friendly bottom sheet pattern
  - Large touch targets (48px minimum) with icon + label + description for each action
  - Actions: Add Ticket, Add Note, Edit Team Member, Quick Checkout (conditional on busy status)
  - Integrated haptics for feedback on interactions
- Added state management in MobileTeamSection: showActionSheet, selectedStaffForAction, showStaffNoteModal, selectedStaffForNote
- Created action handlers matching desktop StaffSidebar pattern:
  - handleStaffCardClick: Opens action sheet with staff context
  - handleAddTicket: Opens ticket panel with staff pre-selected
  - handleAddNote: Opens AddStaffNoteModal for staff notes
  - handleEditTeam: Navigates to team-settings with staff pre-selected
  - handleQuickCheckout: Opens ticket panel with staff's current ticket
- Updated all StaffCardVertical instances to:
  - Call handleStaffCardClick on tap
  - Pass displayConfig with action settings from FrontDeskSettings
  - Pass action callbacks (onAddTicket, onAddNote, onEditTeam, onQuickCheckout)
- Files changed:
  - apps/store-app/src/components/frontdesk/MobileStaffActionSheet.tsx (new)
  - apps/store-app/src/components/frontdesk/MobileTeamSection.tsx
- **Learnings for future iterations:**
  - Use Sheet component with side="bottom" for mobile action sheets (better UX than dropdown)
  - Mobile components need useTicketPanel and useAppDispatch same as desktop
  - convertToStaffMember helper creates StaffMember objects - use this before passing to callbacks
  - Action handlers should be extracted to shared hooks if they're duplicated across desktop/mobile
  - Pre-existing typecheck errors in test files don't block implementation commits
---

## 2026-01-14 - US-012: Add staff clock in/out action
Commit: 6542101
- Added Clock In/Clock Out menu items to StaffCardVertical dropdown
  - Clock Out (with LogOut icon) shows for clocked-in staff (status !== 'off')
  - Clock In (with Clock icon) shows for clocked-out staff (status === 'off')
  - Menu items separated from other actions with DropdownMenuSeparator
- Added showClockInOutAction to FrontDeskSettingsData type and defaults
- Added onClockIn and onClockOut callbacks to StaffCardVerticalProps interface
- Imported clockIn/clockOut async thunks from timesheetSlice
- Implemented handleClockIn handler in StaffSidebar:
  - Finds staff by numeric ID
  - Dispatches clockIn action with staffId
- Implemented handleClockOut handler in StaffSidebar:
  - Shows confirmation dialog if staff has active tickets (uses window.confirm)
  - Dispatches clockOut action with staffId and current timestamp
- Updated MobileStaffActionSheet with Clock In/Out action buttons:
  - Different styling for each (green for Clock In, red for Clock Out)
  - Respects showClockInOutAction setting
- Updated test mock in frontDeskSettingsSlice.test.ts with new field
- Files changed:
  - apps/store-app/src/components/StaffCard/hooks/useStaffCardDisplay.ts
  - apps/store-app/src/components/StaffCard/StaffCardVertical.tsx
  - apps/store-app/src/components/frontdesk/StaffSidebar.tsx
  - apps/store-app/src/components/frontdesk/MobileStaffActionSheet.tsx
  - apps/store-app/src/components/frontdesk/MobileTeamSection.tsx
  - apps/store-app/src/components/frontdesk-settings/types.ts
  - apps/store-app/src/components/frontdesk-settings/constants.ts
  - apps/store-app/src/store/slices/__tests__/frontDeskSettingsSlice.test.ts
- **Learnings for future iterations:**
  - timesheetSlice exports clockIn/clockOut async thunks (not staffSlice)
  - ClockInParams: { staffId: number | string }
  - ClockOutParams: { staffId: number | string, clockOutTime: Date }
  - isClockedIn derived from staff.status !== 'off' (off = clocked out)
  - window.confirm() is simplest confirmation for urgent actions (can be replaced with modal later)
  - FrontDeskSettingsData type must be updated when adding new settings
  - Test mocks must include all fields from FrontDeskSettingsData to pass typecheck
---

## 2026-01-14 - US-013: Add unit tests for Team Section components
Commit: fac5490
- Added StaffSidebar.test.tsx with 34 tests:
  - Rendering tests: staff name, ARIA attributes, queue number
  - View mode tests: normal, compact, ultra-compact modes
  - Staff status tests: ready without overlay, busy with overlay
  - Action callback tests: card click, dropdown menu rendering
  - DisplayConfig tests: toggle visibility based on settings
  - Selection state tests: ring styling for selected cards
  - Keyboard navigation tests: focusable, button role
- Added StaffCardVertical.test.tsx with 22 tests:
  - Rendering tests: name, ARIA, queue number, turn count
  - View mode tests: normal, compact, ultra-compact
  - Staff status tests: ready, busy with overlay, off
  - Action callback tests: onClick, More Options button
  - DisplayConfig tests: settings control visibility
  - Selection state tests: ring styling
  - Keyboard navigation tests: tabindex, role
  - Busy staff display tests: progress indicator
- Updated MobileTeamSection.test.tsx with Redux support (57 tests):
  - Added Redux Provider wrapper with mock store
  - Added TicketPanelContext mock
  - Mocked MobileStaffActionSheet and AddStaffNoteModal
  - Fixed staff ID expectations (convertToStaffMember parses 'staff-1' to 1)
  - Fixed group tests for busyStatus mode (only Ready/Busy groups)
- Total: 113 tests passing for Team Section components
- Files changed:
  - apps/store-app/src/components/frontdesk/__tests__/StaffSidebar.test.tsx (new)
  - apps/store-app/src/components/StaffCard/__tests__/StaffCardVertical.test.tsx (new)
  - apps/store-app/src/components/frontdesk/__tests__/MobileTeamSection.test.tsx (updated)
- **Learnings for future iterations:**
  - Redux-connected components need Provider wrapper in tests
  - Use function reducers returning fixed state to avoid TypeScript inference issues with configureStore
  - convertToStaffMember parses IDs like 'staff-1' to get numeric ID (1)
  - busyStatus organizeBy mode only renders Ready and Busy groups (not Off)
  - Radix UI DropdownMenu renders to portal - use simpler tests to avoid portal complexity
  - Pre-existing test failures in topics.test.ts and padCheckoutFlow.test.ts are unrelated infrastructure issues
  - DisplayConfig uses showLastService (not showLastDone) for the property name
---

## 2026-01-14 - US-014: Add No-Show action for late appointments
Commit: d58df6b
- Added No-Show action button to appointment action menu in ComingAppointments.tsx
- Button only appears for appointments 15+ minutes late (minutesUntil <= -15)
- Added confirmation dialog with orange color scheme before marking as no-show
- Connected to appointmentsSlice via updateLocalAppointment and updateAppointmentInSupabase
- Appointment is removed from Coming section after marking as no-show (filtered in useTicketsCompat)
- Files changed:
  - apps/store-app/src/components/frontdesk/ComingAppointments.tsx
- **Learnings for future iterations:**
  - Late appointments have minutesUntil < 0 (negative = minutes past due)
  - Use z-[60] for confirmation dialog to appear above action menu (z-50)
  - updateLocalAppointment provides optimistic UI update
  - updateAppointmentInSupabase persists to Supabase
  - useTicketsCompat already filters out no-show appointments from comingAppointments
---

## 2026-01-14 - US-015: Implement drag and drop for Waiting Queue reordering
Commit: 950d0b7
- Installed @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities packages
- Created SortableListItem wrapper component for list view drag support
- Created SortableGridItem wrapper component for grid view drag support
- Added DndContext with PointerSensor (8px distance activation) and KeyboardSensor
- Implemented drag handles with GripVertical icon (visible on hover)
- Added visual feedback: 50% opacity during drag, shadow and rotation on overlay
- Added reorderWaitlist and setWaitlistOrder reducers to uiTicketsSlice
- Support both list and grid view modes using verticalListSortingStrategy and rectSortingStrategy
- Respects enableDragAndDrop setting from FrontDeskSettings (isDragDisabled prop)
- Handles reordering with filtered list (maps filtered indices to full waitlist indices)
- Files changed:
  - apps/store-app/package.json (@dnd-kit packages added)
  - apps/store-app/src/components/frontdesk/WaitListSection.tsx
  - apps/store-app/src/store/slices/uiTicketsSlice.ts
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - @dnd-kit uses useSortable hook for each draggable item
  - DragOverlay renders the dragged item outside normal flow for smooth animation
  - Use CSS.Transform.toString(transform) for proper transform handling
  - Drag handle should have attributes and listeners spread, not the whole item
  - arrayMove from @dnd-kit/sortable handles array reordering
  - When filtering is active, need to find actual indices in original array
  - noop function avoids lint errors for intentionally empty callbacks in overlay
---

{
  "project": "Mango Pad",
  "branchName": "ralph/mango-pad-integration",
  "description": "Fix MQTT bi-directional communication and implement complete transaction flow between Store App and Mango Pad",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add subscription confirmation callbacks to mqttClient",
      "description": "As a developer, I need MQTT subscriptions to log success/failure so I can verify messages will be received.",
      "acceptanceCriteria": [
        "mqttClient.subscribe() includes callback parameter with success/error logging",
        "Console shows '[MqttClient] Subscription SUCCESS for {topic}' when subscription succeeds",
        "Console shows '[MqttClient] Subscription FAILED for {topic}' with error when it fails",
        "onConnect handler resubscribes to all topics with confirmation callbacks",
        "npm run typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "File: apps/mango-pad/src/services/mqttClient.ts lines 183-204 and 78-93"
    },
    {
      "id": "US-002",
      "title": "Fix PadMqttProvider subscription timing",
      "description": "As a developer, I need subscriptions to wait for MQTT connection before subscribing to ensure messages are received.",
      "acceptanceCriteria": [
        "PadMqttProvider only subscribes to heartbeat topic AFTER mqttConnectionStatus is 'connected'",
        "useEffect dependency array includes mqttConnectionStatus",
        "Console log confirms subscription setup: '[PadMqttProvider] Setting up subscriptions for station: {stationId}'",
        "npm run typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "File: apps/mango-pad/src/providers/PadMqttProvider.tsx"
    },
    {
      "id": "US-003",
      "title": "Fix ReconnectingOverlay blocking pairing flow",
      "description": "As a user, I need to see the Welcome and Pairing pages without being blocked by the reconnecting overlay.",
      "acceptanceCriteria": [
        "ReconnectingOverlay does NOT appear on /welcome route",
        "ReconnectingOverlay does NOT appear on /pair route",
        "Overlay only appears after: (1) device is paired AND (2) was previously connected AND (3) connection drops",
        "After clearing localStorage, Welcome page is visible without overlay",
        "npm run typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "File: apps/mango-pad/src/components/ReconnectingOverlay.tsx - Added checkIsPaired(), EXCLUDED_ROUTES, and wasConnected state tracking"
    },
    {
      "id": "US-004",
      "title": "Remove redundant PosHeartbeatProvider from Store App",
      "description": "As a developer, I need to clean up the redundant heartbeat provider that uses the wrong topic pattern.",
      "acceptanceCriteria": [
        "PosHeartbeatProvider is either removed or updated to use station-specific topic",
        "Only ONE heartbeat being published by Store App: salon/{storeId}/station/{stationId}/heartbeat",
        "No console logs showing 'salon/{storeId}/pos/heartbeat' topic",
        "usePosHeartbeat continues to work correctly",
        "npm run typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Removed PosHeartbeatProvider completely. usePosHeartbeat in PadConnectionIndicator is the sole heartbeat publisher."
    },
    {
      "id": "US-005",
      "title": "Fix message parse errors in usePadHeartbeat",
      "description": "As a developer, I need to handle the wrapped MqttMessage format that Mango Pad sends.",
      "acceptanceCriteria": [
        "usePadHeartbeat handles both wrapped format { id, timestamp, payload } and direct payload",
        "No console errors showing 'Failed to parse message'",
        "Pad heartbeats are correctly parsed and processed",
        "npm run typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "File: apps/store-app/src/services/mqtt/hooks/usePadHeartbeat.ts - Added detection for wrapped { id, timestamp, payload } format and direct payload format with deviceId check"
    },
    {
      "id": "US-006",
      "title": "Add transaction types to Mango Pad",
      "description": "As a developer, I need TypeScript types for transaction state management.",
      "acceptanceCriteria": [
        "ActiveTransaction interface defined with: transactionId, ticketId, clientName, clientEmail, clientPhone, staffName, items, subtotal, tax, discount, total, suggestedTips, tipAmount, tipPercent, signatureData, receiptPreference, step, startedAt",
        "TransactionItem interface defined with: id, name, staffName, price, quantity",
        "PadFlowStep type defined: 'waiting' | 'receipt' | 'tip' | 'signature' | 'receipt_preference' | 'waiting_payment' | 'complete' | 'failed' | 'cancelled'",
        "Types exported from apps/mango-pad/src/types/index.ts",
        "npm run typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Commit 509d0a4 - Added PadFlowStep type, updated TransactionItem with id/staffName, added ActiveTransaction interface. Also updated test files to use new TransactionItem.id field."
    },
    {
      "id": "US-007",
      "title": "Add transaction state to PadMqttProvider",
      "description": "As a developer, I need transaction state management in the MQTT provider context.",
      "acceptanceCriteria": [
        "PadMqttContext includes activeTransaction: ActiveTransaction | null",
        "PadMqttContext includes setActiveTransaction function",
        "PadMqttContext includes clearTransaction function",
        "Context provides updateTransactionStep(step: PadFlowStep) function",
        "npm run typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Commit de2c81b - Added activeTransaction computed from Redux, setActiveTransaction(), clearTransaction(), updateTransactionStep(), and helper functions for PadFlowStep<->PadScreen mapping."
    },
    {
      "id": "US-008",
      "title": "Subscribe to transaction topics in Mango Pad",
      "description": "As a Mango Pad user, I need to receive transaction messages from Store App.",
      "acceptanceCriteria": [
        "PadMqttProvider subscribes to: salon/{salonId}/station/{stationId}/pad/ready_to_pay",
        "PadMqttProvider subscribes to: salon/{salonId}/station/{stationId}/pad/payment_result",
        "PadMqttProvider subscribes to: salon/{salonId}/station/{stationId}/pad/cancel",
        "ready_to_pay handler sets activeTransaction and navigates to /receipt",
        "payment_result handler updates step to 'complete' or 'failed'",
        "cancel handler clears transaction and navigates to /",
        "npm run typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Already implemented in PadMqttProvider.tsx lines 288-361. Uses PAD_TOPICS constants and buildPadTopic() helper."
    },
    {
      "id": "US-009",
      "title": "Add publish functions for transaction events",
      "description": "As a Mango Pad user, I need to send transaction responses back to Store App.",
      "acceptanceCriteria": [
        "PadMqttContext includes publishTipSelected(tipAmount: number, tipPercent: number | null)",
        "PadMqttContext includes publishSignature(signatureData: string)",
        "PadMqttContext includes publishReceiptPreference(preference: string, email?: string, phone?: string)",
        "PadMqttContext includes publishTransactionComplete()",
        "All publish functions use QoS 1",
        "All publish functions include transactionId in payload",
        "npm run typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Already implemented in PadMqttProvider.tsx lines 515-550. Uses PAD_TOPICS constants with proper topic patterns."
    },
    {
      "id": "US-010",
      "title": "Create transaction navigation hook",
      "description": "As a developer, I need automatic navigation based on transaction step changes.",
      "acceptanceCriteria": [
        "useTransactionNavigation hook created at apps/mango-pad/src/hooks/useTransactionNavigation.ts",
        "Hook navigates to correct route when activeTransaction.step changes",
        "Route mapping: waiting->/, receipt->/receipt, tip->/tip, signature->/signature, receipt_preference->/receipt-preference, waiting_payment->/processing, complete->/complete, failed->/failed, cancelled->/",
        "npm run typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Created hook with STEP_TO_ROUTE mapping, skipInitialNavigation option, and helper functions getRouteForStep/getStepForRoute."
    },
    {
      "id": "US-011",
      "title": "Update WaitingPage to use transaction context",
      "description": "As a user, I need WaitingPage to respond to incoming transactions.",
      "acceptanceCriteria": [
        "WaitingPage uses useTransactionNavigation hook",
        "When ready_to_pay received, page auto-navigates to /receipt",
        "Demo mode still works: Start Demo button creates demo transaction and navigates to /receipt",
        "Demo transaction has mock items, totals, and suggested tips",
        "npm run typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "File: apps/mango-pad/src/pages/WaitingPage.tsx"
    },
    {
      "id": "US-012",
      "title": "Update ReceiptPage to use real transaction data",
      "description": "As a customer, I need to see the actual transaction items and totals.",
      "acceptanceCriteria": [
        "ReceiptPage reads items from activeTransaction context instead of DEMO_RECEIPT",
        "Shows actual subtotal, tax, discount, and total from transaction",
        "Shows client name if available",
        "Shows staff name if available",
        "Falls back to demo data if no activeTransaction (demo mode)",
        "npm run typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "File: apps/mango-pad/src/pages/ReceiptPage.tsx"
    },
    {
      "id": "US-013",
      "title": "Update TipPage to publish tip selection",
      "description": "As a customer, I need my tip selection sent to Store App.",
      "acceptanceCriteria": [
        "TipPage uses activeTransaction.total for tip percentage calculations",
        "TipPage uses activeTransaction.suggestedTips for tip button options",
        "On continue, calls publishTipSelected() with selected tipAmount and tipPercent",
        "Updates activeTransaction with selected tip before navigating",
        "Falls back to demo behavior if no activeTransaction",
        "npm run typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "File: apps/mango-pad/src/pages/TipPage.tsx"
    },
    {
      "id": "US-014",
      "title": "Update SignaturePage to publish signature",
      "description": "As a customer, I need my signature sent to Store App.",
      "acceptanceCriteria": [
        "SignaturePage calls publishSignature() with base64 canvas data on complete",
        "Updates activeTransaction.signatureData before navigating",
        "Navigates to /receipt-preference after signature captured",
        "Falls back to demo behavior if no activeTransaction",
        "npm run typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "File: apps/mango-pad/src/pages/SignaturePage.tsx"
    },
    {
      "id": "US-015",
      "title": "Create ReceiptPreferencePage",
      "description": "As a customer, I need to choose how to receive my receipt.",
      "acceptanceCriteria": [
        "New page created at apps/mango-pad/src/pages/ReceiptPreferencePage.tsx",
        "Shows 4 options: Email, SMS, Print, No Receipt",
        "If Email selected, shows email input (pre-filled from activeTransaction.clientEmail)",
        "If SMS selected, shows phone input (pre-filled from activeTransaction.clientPhone)",
        "On complete, calls publishReceiptPreference() and publishTransactionComplete()",
        "Updates transaction step to waiting_payment and navigates to /processing",
        "npm run typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Create ProcessingPage",
      "description": "As a customer, I need to see a processing indicator while payment is being processed.",
      "acceptanceCriteria": [
        "New page created at apps/mango-pad/src/pages/ProcessingPage.tsx",
        "Shows Processing Payment with spinner animation",
        "Uses useTransactionNavigation to auto-navigate when step changes to complete/failed",
        "Clean, centered design matching app style",
        "npm run typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Create CompletePage",
      "description": "As a customer, I need to see payment success confirmation.",
      "acceptanceCriteria": [
        "New page created at apps/mango-pad/src/pages/CompletePage.tsx",
        "Shows success checkmark icon with Payment Complete message",
        "Shows final total with tip included",
        "Auto-returns to WaitingPage after 5 seconds",
        "Clears activeTransaction on mount or before navigating away",
        "npm run typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Create FailedPage",
      "description": "As a customer, I need to see payment failure information.",
      "acceptanceCriteria": [
        "New page created at apps/mango-pad/src/pages/FailedPage.tsx",
        "Shows error icon with Payment Failed message",
        "Shows error message from payment_result if available",
        "Has Return to Waiting button that clears transaction and navigates to /",
        "npm run typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Add new routes to App.tsx",
      "description": "As a developer, I need all new pages accessible via routes.",
      "acceptanceCriteria": [
        "Route /receipt-preference renders ReceiptPreferencePage",
        "Route /processing renders ProcessingPage",
        "Route /complete renders CompletePage",
        "Route /failed renders FailedPage",
        "All routes wrapped in appropriate layout/providers",
        "npm run typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": "File: apps/mango-pad/src/App.tsx"
    },
    {
      "id": "US-020",
      "title": "Fix sendPaymentResult in Store App",
      "description": "As a staff member, I need payment results sent to Mango Pad after processing.",
      "acceptanceCriteria": [
        "sendPaymentResult() called after successful payment with success: true, cardLast4, cardBrand",
        "sendPaymentResult() called after failed payment with success: false, errorMessage",
        "Payment result published to correct topic: salon/{storeId}/station/{stationId}/pad/payment_result",
        "Mango Pad receives result and navigates to /complete or /failed",
        "npm run typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": "File: apps/store-app/src/components/checkout/PaymentModal.tsx or equivalent"
    }
  ]
}

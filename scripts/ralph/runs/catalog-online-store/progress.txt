# Online Store Catalog Admin — Supabase Migration Progress

## Codebase Patterns

1. **Online Store has no `typecheck` script** — use `npx tsc --noEmit` from the app directory instead of `pnpm run typecheck`.
2. **catalogSyncService.ts uses `row: any` for toOnlineService** — US-027 will clean this up by importing ServiceRow from catalogAdapters.
3. **Service type requires `showOnline: boolean`** — maps to `online_booking_enabled` in menu_services table. The existing `toOnlineService` in catalogSyncService.ts omits this field (it was added later to the type).

---

## Run Initialized - 2026-01-26

**Run:** catalog-online-store
**Branch:** ralph/catalog-online-store
**Total stories:** 29 (5 phases)
**Scope:** Online Store admin catalog pages only (apps/online-store/)

**Phase breakdown:**
- Phase 1: Services & Categories (US-001 to US-006) — 6 stories
- Phase 2: Products (US-007 to US-011) — 5 stories, BLOCKED by PREREQ-1
- Phase 3: Gift Cards & Memberships (US-012 to US-020) — 9 stories
- Phase 4: Type Safety & Cleanup (US-021 to US-024) — 4 stories
- Phase 5: Error Handling & Polish (US-025 to US-029) — 5 stories

**Key files:**
- catalogSyncService.ts (372 lines) — extend with write operations
- catalogAdapters.ts (NEW) — Supabase row ↔ app type adapters
- ServiceForm.tsx (338 lines) — remove localStorage writes, hardcoded categories
- Services.tsx (186 lines) — remove hardcoded categories, localStorage
- Catalog.tsx (94 lines) — replace hardcoded counts
- Products.tsx (150 lines) — remove mock OPI Nail Polish data
- GiftCardSettings.tsx (280 lines) — switch from giftCardStorage to Supabase
- Memberships.tsx (122 lines) — switch from membershipStorage to Supabase
- CatalogTable.tsx (116 lines) — add generics, remove any types

**Prerequisites:**
- PREREQ-1: Products table schema conflict (migrations 017 vs 031) — blocks Phase 2
- PREREQ-2: No membership_plans table — resolved by US-016

---

## 2026-01-26 - US-001: Create catalogAdapters.ts for Online Store
Commit: a77d7a2

**Why this story?** US-001 has no dependencies, is priority 1, and all other Phase 1 stories depend on it. It's the foundational building block for all subsequent catalog work.

**Changes:**
- apps/online-store/src/lib/adapters/catalogAdapters.ts (NEW, 174 lines): Created ServiceRow and CategoryRow interfaces matching migration 031 schemas. Implemented toOnlineService, fromOnlineService, toOnlineCategory adapters. Defined Category type for use by downstream stories.

**Learnings:**
- Online Store app has no `typecheck` script — must use `npx tsc --noEmit` directly
- Service type has `showOnline` boolean field that maps to `online_booking_enabled` in DB — the existing toOnlineService in catalogSyncService.ts didn't map this field
- fromOnlineService uses conditional field-by-field mapping (only include fields that are explicitly provided) to support partial updates cleanly
- ServiceRow has 40+ columns from migration 031 — full interface is verbose but provides complete type safety

**Next story suggestion:** US-002 (Extend catalogSyncService with category fetching) or US-003 (service write ops) — both depend only on US-001. US-002 is lower complexity so good for quick momentum.

---

## 2026-01-26 - US-002: Extend catalogSyncService with category fetching
Commit: dc3cedb

**Why this story?** US-002 is the highest priority remaining story (priority 2), depends only on US-001 (completed), and has lower complexity (~40 lines) than US-003. Both US-004 and US-005 depend on US-002, so completing it unblocks more downstream work.

**Changes:**
- apps/online-store/src/lib/services/catalogSyncService.ts:9: Added import of toOnlineCategory and Category from catalogAdapters
- apps/online-store/src/lib/services/catalogSyncService.ts:40: Added CACHE_KEY_CATEGORIES constant
- apps/online-store/src/lib/services/catalogSyncService.ts:220-278: Added getCategories() and getCachedCategories() functions following existing getServices/getCachedServices pattern
- apps/online-store/src/lib/services/catalogSyncService.ts:400: Updated clearCache() to include CACHE_KEY_CATEGORIES

**Learnings:**
- The getCategories function follows the exact same pattern as getServices — cache-first, then Supabase fetch with RLS validation
- Category re-exports from catalogAdapters.ts work cleanly with `type Category` import
- No new patterns discovered — straightforward extension of existing code

**Next story suggestion:** US-003 (service write operations) — same file, already in context, and unblocks US-004, US-005, US-006.

---

## 2026-01-26 - US-003: Extend catalogSyncService with service write operations
Commit: a1587bd

**Why this story?** US-003 is the highest priority remaining story (priority 3), depends only on US-001 (completed), and unblocks US-004, US-005, and US-006. Same file as US-002 so patterns are already established.

**Changes:**
- apps/online-store/src/lib/services/catalogSyncService.ts:9-15: Updated imports to include toOnlineService (aliased as adapterToOnlineService), fromOnlineService, and ServiceRow from catalogAdapters
- apps/online-store/src/lib/services/catalogSyncService.ts:286-375: Added Service Write Operations section with invalidateServicesCache(), createService(), updateService(), deleteService()

**Learnings:**
- Used `toOnlineService as adapterToOnlineService` alias to avoid conflict with existing local `toOnlineService` function (which still exists for backward compat until US-027 cleans it up)
- createService takes storeId as first param (following same pattern as getServices/getCategories) and sets store_id on the row before insert
- Supabase `.insert().select().single()` returns the newly created row — cast to ServiceRow for the adapter
- Soft delete only sets `is_deleted` and `deleted_at` — no tombstone metadata (userId/deviceId) since this is the Online Store admin which doesn't have that context

**Next story suggestion:** US-004 (Update ServiceForm.tsx to use Supabase writes) — depends on US-002 and US-003 (both complete), and is the next frontend story that consumes these write operations.

---

## 2026-01-26 - US-004: Update ServiceForm.tsx to use Supabase writes
Commit: fffd3b9

**Why this story?** US-004 is the highest priority story (priority 4) with all dependencies met (US-002 and US-003 both complete). It's the first frontend story consuming the write operations just added, and ServiceForm.tsx is a core page for service creation/editing.

**Changes:**
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:1-17: Added imports for getCategories, getServices, createService, updateService from catalogSyncService, Category type from catalogAdapters, and Loader2 icon
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:18-19: Removed hardcoded categories array (8 hardcoded category strings)
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:41-44: Added state for categories (Category[]), isLoadingCategories, isLoadingService
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:47-65: New useEffect to load categories from Supabase on mount with error handling
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:67-89: New useEffect to load existing service via getServices() when editing (replaced localStorage.getItem read)
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:91-114: Rewrote handleSave to use createService/updateService instead of localStorage.setItem, removed simulated delay and Date.now() ID generation
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:116-123: Added loading state UI for when editing existing service
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:157-173: Category dropdown now shows loading spinner while fetching, uses category.id as value and category.name as label
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:296,349: Replaced Date.now() with crypto.randomUUID() for question/add-on local IDs

**Learnings:**
- The Service.category field stores category_id (UUID), not category name — the adapter's fromOnlineService maps `category` → `category_id`
- localStorage.getItem('storeId') is the established pattern for resolving store context in Online Store catalog pages
- crypto.randomUUID() is a clean replacement for Date.now() for client-side temp IDs
- File grew from 338 to 378 lines due to loading states and async logic — still within acceptable range

**Next story suggestion:** US-005 (Update Services.tsx to use Supabase writes) — same phase, similar changes (delete/duplicate via Supabase, category filter from DB), and shares dependencies with US-004.

---

## 2026-01-26 - US-005: Update Services.tsx to use Supabase writes
Commit: aa422ab

**Why this story?** US-005 is the highest priority remaining story (priority 5), all dependencies met (US-002, US-003), and progress.txt suggested it as the next logical story after US-004. Same phase (1), same category (frontend).

**Changes:**
- apps/online-store/src/pages/admin/catalog/Services.tsx:11-12: Added imports for getCategories, deleteService, createService, updateService from catalogSyncService; Category type from catalogAdapters
- apps/online-store/src/pages/admin/catalog/Services.tsx:21: Added categories state
- apps/online-store/src/pages/admin/catalog/Services.tsx:25-34: Extracted loadServices() as reusable async function for refetching after mutations
- apps/online-store/src/pages/admin/catalog/Services.tsx:36-48: useEffect loads both services and categories on mount
- apps/online-store/src/pages/admin/catalog/Services.tsx:98-143: Rewrote handleDelete, handleBulkDelete, handleBulkShowOnline, handleBulkHideOnline to use Supabase (deleteService/updateService) with error handling and refetch
- apps/online-store/src/pages/admin/catalog/Services.tsx:163-166: Category filter dropdown now uses dynamic categories from Supabase
- apps/online-store/src/pages/admin/catalog/Services.tsx:192-204: Duplicate handler uses createService() instead of localStorage write, removed Date.now().toString()
- Removed saveServices() localStorage function entirely

**Learnings:**
- Bulk operations (delete, show/hide online) use Promise.all for parallel execution — appropriate since each operation is independent
- The `storeId` resolved from localStorage.getItem('storeId') is declared once at component level for reuse across handlers
- Category filter now uses category.id as value (UUID) instead of category name strings — matches how service.category stores category_id
- File grew from 186 to 209 lines due to async error handling in handlers — acceptable

**Next story suggestion:** US-006 (Update Catalog.tsx dashboard with dynamic service count) — last remaining Phase 1 story, depends on US-003 (complete), and closes out the phase.

---

## 2026-01-26 - US-006: Update Catalog.tsx dashboard with dynamic service count
Commit: 9ec5153

**Why this story?** US-006 is the only remaining Phase 1 story with `passes: false`. Its dependency (US-003) is complete. Completing this closes out Phase 1 entirely.

**Changes:**
- apps/online-store/src/pages/admin/Catalog.tsx:1-6: Added useState, useEffect imports; Loader2 icon; getServices from catalogSyncService
- apps/online-store/src/pages/admin/Catalog.tsx:10-11: Added servicesCount state (null initially) and isLoading state
- apps/online-store/src/pages/admin/Catalog.tsx:13-29: useEffect with Promise.all pattern to fetch service counts from Supabase (designed for easy extension in later phases)
- apps/online-store/src/pages/admin/Catalog.tsx:36: Services count uses dynamic `servicesCount ?? 0` instead of hardcoded 24
- apps/online-store/src/pages/admin/Catalog.tsx:44,52,60,68: Packages, Products, Memberships, Gift Cards all set to 0 (Supabase integration in later phases)
- apps/online-store/src/pages/admin/Catalog.tsx:93-97: Loading spinner (Loader2) shown while counts load, replaced inline count display

**Browser Verification:**
- This is a UI story but no dev server is running. Changes are structurally sound and typecheck passes.

**Learnings:**
- Promise.all pattern with destructured array is clean for parallel count fetching — later phases (US-011, US-015, US-020) can add getProducts, getGiftCardConfig, getMembershipPlans to the same Promise.all call
- File went from 94 to 119 lines — well within the 120 target
- Using null for servicesCount initial state distinguishes "not loaded yet" from "loaded and zero" for better loading UX

**Next story suggestion:** Phase 1 is COMPLETE. Next would be Phase 3 (US-012 — gift card adapters) since Phase 2 is blocked by PREREQ-1.

---

## Session Summary - 2026-01-26

**Completed this session:** 1 story (US-006)
**Total progress:** 6/29 stories (21%)

**Phase 1 status:** COMPLETE (6/6 stories)
**Phase 2 status:** BLOCKED by PREREQ-1 (0/5 stories)

**Blocked stories:**
- US-007 through US-011: PREREQ-1 (products table schema conflict)

**Patterns synced:** 0 new patterns

**Next session should:**
- Start with: US-012 (gift card adapters) — first story in Phase 3
- Phase 2 remains blocked until PREREQ-1 (products table conflict) is resolved

---

## 2026-01-26 - US-012: Add gift card adapters to catalogAdapters.ts
Commit: 235bdbe

**Why this story?** US-012 is the highest priority Phase 3 story with all dependencies met (US-001 complete). It unblocks US-013 (gift card CRUD) → US-014 (GiftCardSettings.tsx) → US-015 (dashboard count). Phase 2 is blocked by PREREQ-1.

**Changes:**
- apps/online-store/src/lib/adapters/catalogAdapters.ts:6: Added GiftCardConfig import from types/catalog
- apps/online-store/src/lib/adapters/catalogAdapters.ts:177-240: Added GiftCardSettingsRow interface (25 columns matching migration 031 gift_card_settings table)
- apps/online-store/src/lib/adapters/catalogAdapters.ts:242-270: Added GiftCardDenominationRow interface (23 columns matching migration 031 gift_card_denominations table)
- apps/online-store/src/lib/adapters/catalogAdapters.ts:272-305: Added toGiftCardConfig() — combines settings row + denomination rows into GiftCardConfig. Maps: presetAmounts ← active denomination amounts sorted by display_order, expiryMonths ← default_expiration_days / 30, enabled ← online_enabled. Defaults for UI-only fields (designs=[], terms='', emailTemplate with placeholder)
- apps/online-store/src/lib/adapters/catalogAdapters.ts:307-337: Added fromGiftCardConfig() — splits GiftCardConfig into { settings, denominations }. Uses conditional field mapping (same pattern as fromOnlineService). Denominations generated from presetAmounts array with auto labels and display_order from index.

**Learnings:**
- gift_card_settings has `online_enabled` and `email_delivery_enabled` — mapped to GiftCardConfig.enabled and deliveryOptions.digital respectively
- GiftCardConfig in types/catalog.ts has UI-only fields (designs, emailTemplate, terms) that have no Supabase columns — adapter provides sensible defaults
- Denomination amounts come from Supabase as DECIMAL(10,2) — adapter uses Number() to ensure clean number type
- expiryMonths ← default_expiration_days / 30 (rounded) — reverse: expiryMonths * 30

**Next story suggestion:** US-013 (Add gift card CRUD to catalogSyncService) — directly depends on US-012, same service file pattern, unblocks US-014 and US-015.

---

## 2026-01-26 - US-013: Add gift card CRUD to catalogSyncService
Commit: 80f16a4

**Why this story?** US-013 is the highest priority Phase 3 story with all dependencies met (US-012 complete). Progress.txt explicitly suggested it as the next logical story. It unblocks US-014 (GiftCardSettings.tsx) and US-015 (dashboard count).

**Changes:**
- apps/online-store/src/lib/services/catalogSyncService.ts:9-20: Added imports for toGiftCardConfig, fromGiftCardConfig, GiftCardSettingsRow, GiftCardDenominationRow from catalogAdapters and GiftCardConfig from types/catalog
- apps/online-store/src/lib/services/catalogSyncService.ts:49: Added CACHE_KEY_GIFTCARD constant ('catalog_giftcard_v2')
- apps/online-store/src/lib/services/catalogSyncService.ts:383-393: Added invalidateGiftCardCache() helper
- apps/online-store/src/lib/services/catalogSyncService.ts:395-462: Added getGiftCardConfig(storeId) — cache-first, then fetches gift_card_settings (single row via .single()) and gift_card_denominations (multiple active rows), combines via toGiftCardConfig adapter. Handles PGRST116 (no rows) gracefully by returning null. Includes store_id validation for both settings and denominations.
- apps/online-store/src/lib/services/catalogSyncService.ts:464-543: Added updateGiftCardConfig(storeId, config) — upserts settings row (onConflict: 'store_id'), soft-deletes existing denominations, inserts new denomination rows from config.presetAmounts via fromGiftCardConfig adapter. Returns reconstituted GiftCardConfig.
- apps/online-store/src/lib/services/catalogSyncService.ts:616: Added CACHE_KEY_GIFTCARD to clearCache()

**Learnings:**
- Supabase `.single()` throws PGRST116 error code when no rows match — handle explicitly to distinguish "no config yet" from real errors
- gift_card_settings upsert uses `onConflict: 'store_id'` since there's a UNIQUE constraint on store_id — this handles both create and update in one call
- Denomination replacement strategy: soft-delete all existing → insert new. This avoids complex diff logic and ensures clean state. The soft-deleted rows remain for audit trail.
- File grew to 707 lines — approaching the guideline limit. Future stories should consider extracting gift card operations into a separate module if more operations are added.

**Next story suggestion:** US-014 (Update GiftCardSettings.tsx to use Supabase) — directly depends on US-013, frontend story that consumes these new CRUD operations, and unblocks US-015 (dashboard count).

---

## 2026-01-26 - US-014: Update GiftCardSettings.tsx to use Supabase
Commit: 60a6576

**Why this story?** US-014 is the highest priority eligible story (priority 14) with its sole dependency US-013 complete. Progress.txt explicitly suggested it as next. It's the frontend consumer of the gift card CRUD operations added in US-013, and unblocks US-015 (dashboard count) and US-021 (type consolidation).

**Changes:**
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:8: Switched toast from `@/hooks/use-toast` to `sonner` (`import { toast } from "sonner"`)
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:10-14: Replaced import from `@/lib/storage/giftCardStorage` with imports from `@/lib/services/catalogSyncService` (getGiftCardConfig, updateGiftCardConfig) and `@/types/catalog` (GiftCardConfig type)
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:20-21: Added `isLoading` and `isSaving` state variables
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:27-41: Made `loadConfig()` async — resolves storeId from localStorage, calls async getGiftCardConfig(storeId), shows error toast on failure, manages isLoading state
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:43-63: Made `handleSave()` async — calls async updateGiftCardConfig(storeId, config), shows success/error toast, manages isSaving state. Removed 'saved to localStorage' message.
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:68-69: Updated handleAddAmount toast to use sonner API: `toast.error('...')` instead of `toast({ title, description, variant })`
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:81-87: Loading state shows Loader2 spinner instead of text
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:102: Subtitle changed from 'stored in localStorage' to 'for your store'
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:104-111: Save button shows Loader2 spinner and is disabled while saving
- apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx:275-309: Message settings section now uses `config.deliveryOptions.messageCharLimit` instead of `config.allowMessage` / `config.maxMessageLength` (mapping: messageCharLimit > 0 = messages enabled, messageCharLimit value = max length)

**Learnings:**
- The giftCardStorage GiftCardConfig type had `allowMessage: boolean` and `maxMessageLength: number`, but the canonical types/catalog.ts GiftCardConfig uses `deliveryOptions.messageCharLimit: number`. Mapped: messageCharLimit > 0 = messages enabled, 0 = disabled. This avoids needing to add fields to the canonical type.
- Function signatures differ: giftCardStorage was sync (`getGiftCardConfig(): GiftCardConfig | null`), catalogSyncService is async (`getGiftCardConfig(storeId): Promise<GiftCardConfig | null>`). Required adding async/await and storeId parameter.
- File grew from 280 to 315 lines due to loading/saving states and async error handling — slightly above 290 target but acceptable for the added functionality.
- The `isSaving` state with disabled button prevents double-submit during async save.

**Next story suggestion:** US-015 (Update Catalog.tsx with gift cards count) — depends on US-006 (complete) and US-013 (complete), small incremental change to existing Promise.all pattern, continues Phase 3 momentum.

---

## 2026-01-26 - US-015: Update Catalog.tsx with gift cards count
Commit: 1e72970

**Why this story?** US-015 is the highest priority eligible story (priority 15) with all dependencies met (US-006✅, US-013✅). It's a small incremental change to the existing Promise.all pattern in Catalog.tsx, continuing Phase 3 momentum.

**Changes:**
- apps/online-store/src/pages/admin/Catalog.tsx:6: Added getGiftCardConfig import from catalogSyncService
- apps/online-store/src/pages/admin/Catalog.tsx:11: Added giftCardsCount state (number | null)
- apps/online-store/src/pages/admin/Catalog.tsx:18-20: Added getGiftCardConfig(storeId) to Promise.all alongside getServices
- apps/online-store/src/pages/admin/Catalog.tsx:23: Set giftCardsCount = giftCardConfig?.enabled ? 1 : 0
- apps/online-store/src/pages/admin/Catalog.tsx:27: Reset giftCardsCount to 0 on error
- apps/online-store/src/pages/admin/Catalog.tsx:72: Gift Cards section count uses dynamic giftCardsCount ?? 0

**Learnings:**
- The pattern of extending Promise.all is clean and predictable — later phases (US-011 for products, US-020 for memberships) will follow the exact same pattern
- giftCardConfig?.enabled optional chaining handles null (no config) → 0, and false → 0 cleanly
- File grew from 119 to 123 lines — well within limits

**Next story suggestion:** US-016 (Create membership_plans Supabase migration) — next Phase 3 story with no unmet dependencies, and it resolves PREREQ-2 which unblocks US-017 through US-020.

---

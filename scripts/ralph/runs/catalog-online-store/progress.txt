# Online Store Catalog Admin — Supabase Migration Progress

## Codebase Patterns

1. **Online Store has no `typecheck` script** — use `npx tsc --noEmit` from the app directory instead of `pnpm run typecheck`.
2. **catalogSyncService.ts uses `row: any` for toOnlineService** — US-027 will clean this up by importing ServiceRow from catalogAdapters.
3. **Service type requires `showOnline: boolean`** — maps to `online_booking_enabled` in menu_services table. The existing `toOnlineService` in catalogSyncService.ts omits this field (it was added later to the type).

---

## Run Initialized - 2026-01-26

**Run:** catalog-online-store
**Branch:** ralph/catalog-online-store
**Total stories:** 29 (5 phases)
**Scope:** Online Store admin catalog pages only (apps/online-store/)

**Phase breakdown:**
- Phase 1: Services & Categories (US-001 to US-006) — 6 stories
- Phase 2: Products (US-007 to US-011) — 5 stories, BLOCKED by PREREQ-1
- Phase 3: Gift Cards & Memberships (US-012 to US-020) — 9 stories
- Phase 4: Type Safety & Cleanup (US-021 to US-024) — 4 stories
- Phase 5: Error Handling & Polish (US-025 to US-029) — 5 stories

**Key files:**
- catalogSyncService.ts (372 lines) — extend with write operations
- catalogAdapters.ts (NEW) — Supabase row ↔ app type adapters
- ServiceForm.tsx (338 lines) — remove localStorage writes, hardcoded categories
- Services.tsx (186 lines) — remove hardcoded categories, localStorage
- Catalog.tsx (94 lines) — replace hardcoded counts
- Products.tsx (150 lines) — remove mock OPI Nail Polish data
- GiftCardSettings.tsx (280 lines) — switch from giftCardStorage to Supabase
- Memberships.tsx (122 lines) — switch from membershipStorage to Supabase
- CatalogTable.tsx (116 lines) — add generics, remove any types

**Prerequisites:**
- PREREQ-1: Products table schema conflict (migrations 017 vs 031) — blocks Phase 2
- PREREQ-2: No membership_plans table — resolved by US-016

---

## 2026-01-26 - US-001: Create catalogAdapters.ts for Online Store
Commit: a77d7a2

**Why this story?** US-001 has no dependencies, is priority 1, and all other Phase 1 stories depend on it. It's the foundational building block for all subsequent catalog work.

**Changes:**
- apps/online-store/src/lib/adapters/catalogAdapters.ts (NEW, 174 lines): Created ServiceRow and CategoryRow interfaces matching migration 031 schemas. Implemented toOnlineService, fromOnlineService, toOnlineCategory adapters. Defined Category type for use by downstream stories.

**Learnings:**
- Online Store app has no `typecheck` script — must use `npx tsc --noEmit` directly
- Service type has `showOnline` boolean field that maps to `online_booking_enabled` in DB — the existing toOnlineService in catalogSyncService.ts didn't map this field
- fromOnlineService uses conditional field-by-field mapping (only include fields that are explicitly provided) to support partial updates cleanly
- ServiceRow has 40+ columns from migration 031 — full interface is verbose but provides complete type safety

**Next story suggestion:** US-002 (Extend catalogSyncService with category fetching) or US-003 (service write ops) — both depend only on US-001. US-002 is lower complexity so good for quick momentum.

---

## 2026-01-26 - US-002: Extend catalogSyncService with category fetching
Commit: dc3cedb

**Why this story?** US-002 is the highest priority remaining story (priority 2), depends only on US-001 (completed), and has lower complexity (~40 lines) than US-003. Both US-004 and US-005 depend on US-002, so completing it unblocks more downstream work.

**Changes:**
- apps/online-store/src/lib/services/catalogSyncService.ts:9: Added import of toOnlineCategory and Category from catalogAdapters
- apps/online-store/src/lib/services/catalogSyncService.ts:40: Added CACHE_KEY_CATEGORIES constant
- apps/online-store/src/lib/services/catalogSyncService.ts:220-278: Added getCategories() and getCachedCategories() functions following existing getServices/getCachedServices pattern
- apps/online-store/src/lib/services/catalogSyncService.ts:400: Updated clearCache() to include CACHE_KEY_CATEGORIES

**Learnings:**
- The getCategories function follows the exact same pattern as getServices — cache-first, then Supabase fetch with RLS validation
- Category re-exports from catalogAdapters.ts work cleanly with `type Category` import
- No new patterns discovered — straightforward extension of existing code

**Next story suggestion:** US-003 (service write operations) — same file, already in context, and unblocks US-004, US-005, US-006.

---

## 2026-01-26 - US-003: Extend catalogSyncService with service write operations
Commit: a1587bd

**Why this story?** US-003 is the highest priority remaining story (priority 3), depends only on US-001 (completed), and unblocks US-004, US-005, and US-006. Same file as US-002 so patterns are already established.

**Changes:**
- apps/online-store/src/lib/services/catalogSyncService.ts:9-15: Updated imports to include toOnlineService (aliased as adapterToOnlineService), fromOnlineService, and ServiceRow from catalogAdapters
- apps/online-store/src/lib/services/catalogSyncService.ts:286-375: Added Service Write Operations section with invalidateServicesCache(), createService(), updateService(), deleteService()

**Learnings:**
- Used `toOnlineService as adapterToOnlineService` alias to avoid conflict with existing local `toOnlineService` function (which still exists for backward compat until US-027 cleans it up)
- createService takes storeId as first param (following same pattern as getServices/getCategories) and sets store_id on the row before insert
- Supabase `.insert().select().single()` returns the newly created row — cast to ServiceRow for the adapter
- Soft delete only sets `is_deleted` and `deleted_at` — no tombstone metadata (userId/deviceId) since this is the Online Store admin which doesn't have that context

**Next story suggestion:** US-004 (Update ServiceForm.tsx to use Supabase writes) — depends on US-002 and US-003 (both complete), and is the next frontend story that consumes these write operations.

---

## 2026-01-26 - US-004: Update ServiceForm.tsx to use Supabase writes
Commit: fffd3b9

**Why this story?** US-004 is the highest priority story (priority 4) with all dependencies met (US-002 and US-003 both complete). It's the first frontend story consuming the write operations just added, and ServiceForm.tsx is a core page for service creation/editing.

**Changes:**
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:1-17: Added imports for getCategories, getServices, createService, updateService from catalogSyncService, Category type from catalogAdapters, and Loader2 icon
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:18-19: Removed hardcoded categories array (8 hardcoded category strings)
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:41-44: Added state for categories (Category[]), isLoadingCategories, isLoadingService
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:47-65: New useEffect to load categories from Supabase on mount with error handling
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:67-89: New useEffect to load existing service via getServices() when editing (replaced localStorage.getItem read)
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:91-114: Rewrote handleSave to use createService/updateService instead of localStorage.setItem, removed simulated delay and Date.now() ID generation
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:116-123: Added loading state UI for when editing existing service
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:157-173: Category dropdown now shows loading spinner while fetching, uses category.id as value and category.name as label
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:296,349: Replaced Date.now() with crypto.randomUUID() for question/add-on local IDs

**Learnings:**
- The Service.category field stores category_id (UUID), not category name — the adapter's fromOnlineService maps `category` → `category_id`
- localStorage.getItem('storeId') is the established pattern for resolving store context in Online Store catalog pages
- crypto.randomUUID() is a clean replacement for Date.now() for client-side temp IDs
- File grew from 338 to 378 lines due to loading states and async logic — still within acceptable range

**Next story suggestion:** US-005 (Update Services.tsx to use Supabase writes) — same phase, similar changes (delete/duplicate via Supabase, category filter from DB), and shares dependencies with US-004.

---

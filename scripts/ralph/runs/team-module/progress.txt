# Team Module Implementation Progress

## Codebase Patterns (Reusable)

### Domain Service Pattern
- Follow staffDataService.ts for all new domain services
- Use getStoreId() helper to get current store from Redux
- Queue sync operations via queueSyncOperation helper
- Route to IndexedDB/SQLite based on USE_SQLITE flag

### Redux Thunk Pattern
- Import dataService from @/services/dataService
- Use createAsyncThunk for async operations
- Include optimistic updates for UI responsiveness
- Handle errors with rejectWithValue

### Type Adapter Pattern
- Supabase uses snake_case, app uses camelCase
- Create toAppType() and toSupabaseRow() converters
- Handle null/undefined safely
- Place adapters in apps/store-app/src/services/supabase/adapters/

### Mock Data Removal
- CRITICAL: Remove ALL generateMock* functions
- Replace with Redux selectors and real data
- Add loading and error states when removing mock data
- grep for 'generateMock' to verify removal

---

## Progress Log

### Initialization
- Created prd.json with 61 stories across 7 phases
- Branch: ralph/team-module
- Started: [timestamp will be added by Ralph]

---

## 2026-01-22 - TM-001: Create teamDataService.ts domain service
Commit: c3fd869

**Changes:**
- apps/store-app/src/services/domain/teamDataService.ts (NEW): Created domain service following staffDataService.ts pattern

**Key Implementation Details:**
- Import teamDB from @/db/teamOperations (not database.ts since teamDB is not re-exported there)
- Auth state uses `state.auth.user?.id` for userId and `state.auth.device?.id` for deviceId (not userId/deviceId directly)
- Team members use IndexedDB only (no SQLite equivalent yet, unlike staffDataService)
- Methods: getAll(), getById(), getActive(), getArchived(), getByEmail(), search(), getBookable(), getByRole(), create(), update(), archive(), restore(), delete(), getStats(), bulkCreate(), upsert()

**Learnings:**
- AuthState has `user: { id: string, ... } | null` not `userId: string`
- AuthState has `device: { id: string, ... } | null` not `deviceId: string`
- teamDB is exported from teamOperations.ts directly, not re-exported from database.ts like other DB operations

---

## 2026-01-22 - TM-002: Create timesheetDataService.ts domain service
Commit: 1d934e3

**Changes:**
- apps/store-app/src/services/domain/timesheetDataService.ts (NEW): Created domain service following staffDataService.ts pattern

**Key Implementation Details:**
- Import timesheetDB from @/db/timesheetOperations (comprehensive IndexedDB operations)
- Implements all required methods: clockIn(), clockOut(), startBreak(), endBreak(), getByStaffId(), getByDateRange(), create(), update(), approve(), reject()
- Additional methods: getById(), getByStaffAndDate(), getPending(), getByStatus(), isStaffClockedIn(), isStaffOnBreak(), getShiftStatus(), getSummary(), bulkApprove(), delete()
- Uses LOCAL-FIRST pattern: reads from IndexedDB, queues writes for background sync
- timesheetDB already has extensive functionality including shift status tracking, break management, and summary calculations

**Learnings:**
- timesheetOperations.ts is very comprehensive (~900 lines) with clock in/out, break tracking, approval workflow, and sync operations
- The domain service acts as a thin wrapper that adds storeId/userId/deviceId context and queues sync operations
- timesheetDB.clockIn() creates the timesheet entry if it doesn't exist (handles create + clock in atomically)

---

## 2026-01-22 - TM-003: Create payrollDataService.ts domain service
Commit: d21ed8a

**Changes:**
- apps/store-app/src/services/domain/payrollDataService.ts (NEW): Created domain service following staffDataService.ts pattern

**Key Implementation Details:**
- Import payrollDB from @/db/payrollOperations (comprehensive IndexedDB operations)
- payrollDB already includes sync queue integration internally (via queueForSync helper)
- Implements all required methods: getAll(), getById(), create(), update(), delete()
- Implements workflow operations: submit(), approve(), reject(), process(), void()
- Implements adjustment operations: addAdjustment(), removeAdjustment()
- Additional methods: getByDateRange(), getByStatus(), getLatest(), upsertStaffPayment(), markStaffPaid()
- Uses LOCAL-FIRST pattern: payrollDB handles reads from IndexedDB and queues writes automatically
- getTenantId() must use `state.auth.store?.tenantId` (not `state.auth.tenantId`)

**Learnings:**
- payrollOperations.ts is comprehensive (~800+ lines) with full pay run lifecycle, staff payments, adjustments, and sync queue integration
- payrollDB handles sync queuing internally (unlike timesheetDataService which queues in the domain service)
- tenantId is nested inside `auth.store` not at the top level of AuthState
- Pay run statuses: draft, pending_approval, approved, processed, voided (not 'pending' as in PRD notes)

---

## 2026-01-23 - TM-004: Add team namespaces to dataService.ts
Commit: d201698

**Changes:**
- apps/store-app/src/services/domain/index.ts: Added exports for timesheetService and payrollService
- apps/store-app/src/services/dataService.ts: Imported and added timesheets and payRuns namespaces

**Key Implementation Details:**
- teamService was already imported and exported (added in TM-001)
- Added timesheetService and payrollService exports to domain/index.ts barrel file
- Added timesheets: timesheetService to dataService export object
- Added payRuns: payrollService to dataService export object
- Maintained existing dataService structure and patterns

**Learnings:**
- Domain service barrel exports are at apps/store-app/src/services/domain/index.ts
- dataService already had team: teamService added (line 1469), only needed timesheets and payRuns
- Re-exports section at bottom of dataService.ts also needed updating for backward compatibility

---

## 2026-01-23 - TM-005: Refactor teamThunks to use dataService
Commit: 1591c12

**Changes:**
- apps/store-app/src/store/slices/team/teamThunks.ts: Refactored all main thunks to use dataService.team

**Key Implementation Details:**
- Imported dataService from @/services/dataService
- Replaced fetchSupabaseMembers + teamDB fallback pattern with single dataService.team.getAll()
- fetchTeamMember now uses dataService.team.getById()
- saveTeamMember now uses dataService.team.create() and dataService.team.update()
- archiveTeamMember now uses dataService.team.archive()
- restoreTeamMember now uses dataService.team.restore()
- deleteTeamMember now uses dataService.team.delete()
- Removed complex Supabase-first-then-IndexedDB pattern from fetchTeamMembers
- Kept optimistic update pattern intact (dispatch before async, rollback on failure)

**Note on Time Off/Schedule Override Thunks:**
- saveTimeOffRequest, deleteTimeOffRequest, saveScheduleOverride, deleteScheduleOverride still use teamDB directly
- These are specialized nested operations that modify arrays within a member object
- They don't fit cleanly into the dataService CRUD pattern
- This is intentional and acceptable for now

**Learnings:**
- dataService.team.getAll() uses Redux auth state for storeId internally, so storeId param in thunk is now ignored
- Nested operations (time off, schedule overrides) are better kept with direct teamDB access
- The SyncContext parameter is now unused in main thunks (_context) since dataService handles userId/deviceId internally
- Simplifies code significantly: from ~50 lines per thunk to ~10-15 lines

---

## 2026-01-23 - TM-006: Refactor timesheetSlice to use dataService
Commit: e620cbf

**Changes:**
- apps/store-app/src/store/slices/timesheetSlice.ts: Refactored all thunks to use dataService.timesheets

**Files Updated to Fix Call Sites:**
- apps/store-app/src/components/frontdesk/MobileTeamSection.tsx: Updated clockIn/clockOut calls
- apps/store-app/src/components/frontdesk/StaffSidebar/hooks/useStaffActions.ts: Updated clockIn/clockOut calls
- apps/store-app/src/components/layout/ClockInOutButton.tsx: Updated clockIn/clockOut/fetchStaffShiftStatus calls
- apps/store-app/src/components/team-settings/components/TimesheetDashboard.tsx: Updated fetchTimesheetsByDateRange/bulkApproveTimesheets/approveTimesheet/disputeTimesheet calls
- apps/store-app/src/components/team-settings/sections/TimesheetSection/components/TimesheetDetailModal.tsx: Updated approveTimesheet/disputeTimesheet calls
- apps/store-app/src/components/team-settings/sections/TimesheetSection/hooks/useTimesheetActions.ts: Updated all clock/break action calls
- apps/store-app/src/components/team-settings/sections/TimesheetSection/TimesheetSection.tsx: Updated fetchStaffShiftStatus/fetchTimesheetsByStaff calls

**Key Implementation Details:**
- Imported dataService from @/services/dataService
- Removed all dynamic imports of timesheetDB
- Removed SyncContext import and usage (no longer needed)
- Simplified thunk signatures: removed { params, context } wrapper, thunks now take params directly
- clockIn/clockOut/startBreak/endBreak thunks now take ClockInParams/ClockOutParams/StartBreakParams/EndBreakParams directly
- approveTimesheet now takes timesheetId string directly (not object with context)
- bulkApproveTimesheets now takes string[] directly
- disputeTimesheet now takes { timesheetId, reason } (no context)
- All fetch thunks removed storeId parameter (dataService handles internally)
- Updated extraReducers to use action.meta.arg.staffId instead of action.meta.arg.params.staffId

**Learnings:**
- Breaking change: Simplifying thunk signatures requires updating ALL call sites across the codebase
- Use grep to find all usages before refactoring: `grep -r "dispatch(clockIn" --include="*.ts" --include="*.tsx"`
- dataService handles storeId/userId/deviceId internally, so thunks no longer need SyncContext parameter
- Cleaner API: thunks now match their param types directly without nested wrapper objects

---

## 2026-01-23 - TM-007: Refactor payrollSlice to use dataService
Commit: 0bda253

**Changes:**
- apps/store-app/src/store/slices/payrollSlice.ts: Refactored all thunks to use dataService.payRuns

**Files Updated to Fix Call Sites:**
- apps/store-app/src/components/payroll/PayRunList.tsx: Updated fetchPayRuns call (removed storeId param)
- apps/store-app/src/components/payroll/CreatePayRunModal.tsx: Updated createPayRun call (removed { params, context } wrapper)
- apps/store-app/src/components/payroll/PayRunDetail.tsx: Updated submitPayRunForApproval call (changed from object to direct payRunId)
- apps/store-app/src/components/payroll/PayRunAdjustmentModal.tsx: Updated addAdjustment call (removed { params } wrapper)
- apps/store-app/src/components/team-settings/sections/PayrollSection.tsx: Updated fetchPayRuns call (removed storeId param)

**Key Implementation Details:**
- Imported dataService from @/services/dataService
- Removed SyncContext import and getDefaultSyncContext usage
- Removed all dynamic imports of payrollDB
- Simplified thunk signatures: removed { params, context } wrappers
- fetchPayRuns now takes void (dataService.payRuns.getAll() gets storeId internally)
- fetchPayRunsByDateRange now takes { startDate, endDate } (no storeId)
- fetchPayRunsByStatus now takes PayRunStatus directly (no storeId)
- createPayRun now takes CreatePayRunParams directly (no context)
- updateStaffPayment now takes { payRunId, staffPayment } (no context)
- addAdjustment now takes AddAdjustmentParams directly (no context)
- removeAdjustment now takes { payRunId, staffId, adjustmentId } (no context)
- submitPayRunForApproval now takes payRunId string directly
- approvePayRun now takes { payRunId, approvalNotes? } (no context)
- rejectPayRun now takes { payRunId, reason } (no context)
- processPayRun now takes { payRunId, processingNotes? } (no context)
- voidPayRun now takes { payRunId, reason } (no context)
- deletePayRun now takes payRunId string directly

**Removed Unused Imports from CreatePayRunModal:**
- selectMemberId selector (was unused after removing context)
- deviceManager import (was unused after removing context)

**Learnings:**
- Similar pattern to TM-006: simplifying signatures requires updating all call sites
- dataService handles storeId/userId/deviceId/tenantId internally
- 96 lines of code removed from payrollSlice.ts (from 137+ lines to ~40 lines per thunk)
- CreatePayRunModal had unused imports from old context approach that needed cleanup

---

## 2026-01-23 - TM-P1R: REVIEW: Phase 1 Backend Integration
Commit: [this commit]

**Review Summary:** ✅ ALL CHECKS PASSED - No issues found

**Verification Steps Completed:**

1. **TypeCheck:** `pnpm run typecheck` passes with 0 errors ✅

2. **teamDataService.ts:** All required methods implemented ✅
   - getAll(), getById(), getActive(), create(), update(), delete()
   - Extra: getArchived(), getByEmail(), search(), getBookable(), getByRole(), archive(), restore(), getStats(), bulkCreate(), upsert()
   - Follows staffDataService.ts pattern correctly

3. **timesheetDataService.ts:** All required methods implemented ✅
   - clockIn(), clockOut(), startBreak(), endBreak()
   - getByStaffId(), getByDateRange(), create(), update(), approve(), reject()
   - Extra: getByDate(), getById(), getByStaffAndDate(), getPending(), getByStatus(), isStaffClockedIn(), isStaffOnBreak(), getShiftStatus(), getSummary(), bulkApprove(), delete()

4. **payrollDataService.ts:** All required methods implemented ✅
   - getAll(), getById(), create(), update(), delete()
   - submit(), approve(), reject(), process(), void()
   - addAdjustment(), removeAdjustment()
   - Extra: getByDateRange(), getByStatus(), getLatest(), upsertStaffPayment(), markStaffPaid()

5. **dataService.ts:** All namespaces exported correctly ✅
   - team: teamService (line 1473)
   - timesheets: timesheetService (line 1474)
   - payRuns: payrollService (line 1475)
   - Imports from @/services/domain (lines 142-144)

6. **teamThunks.ts:** Uses dataService.team for all main operations ✅
   - fetchTeamMembers uses dataService.team.getAll()
   - fetchTeamMember uses dataService.team.getById()
   - saveTeamMember uses dataService.team.create()/update()
   - archiveTeamMember uses dataService.team.archive()
   - restoreTeamMember uses dataService.team.restore()
   - deleteTeamMember uses dataService.team.delete()
   - Note: Time off/schedule override thunks intentionally use teamDB directly (documented)

7. **timesheetSlice.ts:** Uses dataService.timesheets for all operations ✅
   - No direct timesheetDB or timesheetsTable calls remaining
   - All thunks refactored to use dataService.timesheets.*

8. **payrollSlice.ts:** Uses dataService.payRuns for all operations ✅
   - No direct payrollDB or payRunsTable calls remaining
   - All thunks refactored to use dataService.payRuns.*

**Issues Found:** None - Phase 1 implementation is complete and correct.

**Learnings:**
- Review confirms consistent pattern usage across all three domain services
- All services follow LOCAL-FIRST architecture with sync queue integration
- Thunk simplification (removing SyncContext wrappers) was done correctly across all call sites

---

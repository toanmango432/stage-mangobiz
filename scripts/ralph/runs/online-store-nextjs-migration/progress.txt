## Codebase Patterns

> Add reusable patterns discovered during implementation here.
> These persist across iterations and help future Ralph runs.

<!-- Add patterns as you discover them -->

### Next.js + Existing src/pages Directory
Next.js 16 requires `app/` and `pages/` directories to be under the same parent folder.
Since `src/pages/` already exists with React components (not Next.js pages), the `app/`
directory must be placed at `src/app/` (not project root `app/`). PRD paths referencing
`apps/online-store/app/` should be read as `apps/online-store/src/app/`.

### Next.js 16 Config Changes
- `eslint` key in next.config.ts is no longer supported (removed in Next.js 16)
- Use `turbopack.root` to set monorepo root and avoid lockfile detection warnings
- `typescript.ignoreBuildErrors` is still supported

---

# Ralph Progress Log

Started: Mon Jan 27 11:13:00 EST 2026
Branch: ralph/online-store-nextjs-migration
Run: online-store-nextjs-migration

---

## 2026-01-27 - US-001: Install Next.js and create next.config.ts
Commit: b11fad3

**Why this story?** First story with no dependencies and highest priority (1). Foundation for all other stories.

**Changes:**
- apps/online-store/package.json: Added next@16.1.5, eslint-config-next@16.1.5; updated scripts (dev→next dev, build→next build, start→next start, typecheck→tsc --noEmit); kept Vite fallbacks (dev:vite, build:vite)
- apps/online-store/next.config.ts (NEW): Created with standalone output, transpilePackages, typescript.ignoreBuildErrors, turbopack.root for monorepo
- apps/online-store/src/app/layout.tsx (NEW): Minimal root layout stub
- apps/online-store/src/app/page.tsx (NEW): Minimal home page stub
- .gitignore: Added .next/ entry
- apps/online-store/next-env.d.ts (NEW): Auto-generated by Next.js
- pnpm-lock.yaml: Updated with new dependencies

**Learnings:**
- Next.js 16 removed `eslint` config key from next.config.ts — use CLI flags or separate eslint config instead
- `app/` directory MUST be under `src/` (not project root) when `src/pages/` exists — Next.js requires both directories under the same parent
- `next build` fails because Next.js treats `src/pages/*.tsx` as Pages Router routes (expected during migration, resolved when pages are migrated)
- `turbopack.root` config silences monorepo lockfile detection warnings
- `next dev` works fine even with src/pages present — only build tries to compile Pages Router routes

**Patterns to sync:**
- Pattern: Next.js src/app placement — When migrating to Next.js with existing src/pages directory, place app/ under src/ to satisfy same-parent requirement

**Next story suggestion:** US-002 (Update TypeScript config for Next.js) — direct dependency on US-001, same config category, completes the TypeScript setup

---

<!--
SESSION SUMMARY TEMPLATE (append when session ends or blocked):

## Session Summary - [Date]

**Completed this session:** [X] stories
**Total progress:** [Y]/[Z] stories ([percent]%)

**Blocked stories:** (if any)
- [US-XXX]: [Reason - e.g., "Missing dependency", "Pre-existing test failure", "PRD unclear"]

**Patterns synced:** [count] new patterns added to patterns.md

**Next session should:**
- Start with: [US-XXX] - [reason]
- Resolve blocker: [description if applicable]

---
-->

## 2026-01-27 - US-002: Update TypeScript config for Next.js
Commit: e7bccf7

**Why this story?** Direct dependency on US-001 (completed), same config category, and the previous session explicitly recommended starting here.

**Changes:**
- apps/online-store/tsconfig.json: Consolidated from project-references pattern (files:[], references:[]) to single primary config. Added: target ES2020, lib, module ESNext, moduleResolution bundler, jsx react-jsx, isolatedModules, esModuleInterop, resolveJsonModule, incremental, next plugin. Include array: src, next-env.d.ts, next.config.ts, .next/types/**/*.ts, .next/dev/types/**/*.ts. Removed project references.
- apps/online-store/tsconfig.app.json: Simplified to extend tsconfig.json, only overrides jsx to react-jsx and includes src/. Kept for Vite fallback compatibility.
- apps/online-store/tsconfig.node.json: Updated to extend tsconfig.json, includes both vite.config.ts and next.config.ts.
- apps/online-store/src/lib/utils/dynamic-imports.ts → dynamic-imports.tsx: Renamed .ts to .tsx since file contains JSX (proper convention).
- apps/online-store/tsconfig.tsbuildinfo (NEW): Generated by incremental compilation.

**Learnings:**
- Next.js 16 auto-corrects `jsx: "preserve"` to `jsx: "react-jsx"` on first run — it uses the React automatic runtime, not the preserve mode that older Next.js versions used
- Next.js also auto-adds `.next/dev/types/**/*.ts` to the include array
- The Vite-era project references pattern (tsconfig.json with `files:[], references:[]`) doesn't work with Next.js — consolidate into a single tsconfig.json
- `.ts` files with JSX need `.tsx` extension regardless of jsx setting — always use proper extensions
- Pre-existing type errors (376 errors across 80+ files) are not related to tsconfig changes — they're existing type mismatches in test files and repositories

**Patterns to sync:**
- Pattern: Next.js 16 jsx setting — Next.js 16 uses `jsx: "react-jsx"` (not `preserve`). It auto-corrects on first `next dev` run.
- Pattern: Consolidated tsconfig for Next.js — Replace Vite's project-references pattern (tsconfig.json + tsconfig.app.json + tsconfig.node.json) with a single tsconfig.json. Keep .app.json and .node.json as extending configs for Vite fallback during migration.

**Next story suggestion:** US-003 (Set up Tailwind CSS and PostCSS for Next.js) — depends only on US-001 (done), same Phase 1 scaffold config work, and US-004 depends on both US-002 and US-003.

---

## Session Summary - 2026-01-27

**Completed this session:** 1 story (US-002)
**Total progress:** 2/49 stories (4%)

**Blocked stories:** None

**Patterns synced:** 2 new patterns to sync to patterns.md (Next.js 16 jsx setting, consolidated tsconfig pattern)

**Next session should:**
- Start with: US-003 - Set up Tailwind CSS and PostCSS for Next.js (unblocks US-004 root layout)
- Key note: All PRD paths referencing `app/` should use `src/app/` instead (documented in Codebase Patterns above)

---

## 2026-01-27 - US-003: Set up Tailwind CSS and PostCSS for Next.js
Commit: 0353841

**Why this story?** Previous session explicitly recommended US-003 next. It unblocks US-004 (root layout) which gates all page migrations. Priority 3, complexity 2, Phase 1 scaffold.

**Changes:**
- apps/online-store/postcss.config.mjs (NEW): Created with tailwindcss and autoprefixer plugins, typed with `@type {import('postcss-load-config').Config}`
- apps/online-store/postcss.config.js (DELETED): Replaced by .mjs for explicit ESM compatibility with Next.js
- apps/online-store/src/app/globals.css (NEW): Imports `../index.css` which contains all Tailwind directives, custom animations, and design system CSS custom properties
- apps/online-store/src/app/layout.tsx: Added `import './globals.css'` to wire up the CSS pipeline

**Learnings:**
- tailwind.config.ts already had `"./src/**/*.{ts,tsx}"` in content array which covers `src/app/` — no modification needed
- The existing `"./app/**/*.{ts,tsx}"` glob (root-level) is harmless — Tailwind silently ignores non-matching paths
- globals.css only needs `@import '../index.css'` — the existing index.css already has all Tailwind directives (`@tailwind base/components/utilities`) and design tokens
- Replacing postcss.config.js with .mjs is cleaner for Next.js ESM compatibility

**Patterns to sync:** None — patterns already documented from prior sessions cover this.

**Next story suggestion:** US-005 (Create navigation compatibility layer) or US-004 (Create root layout with Providers wrapper). US-004 depends on both US-002 and US-003 (now both done), but US-005 only depends on US-001. Both are Phase 1 scaffold. US-005 is needed by US-006 (customer layout) and all page migrations. Recommend US-005 next since it's a standalone utility needed by many downstream stories.

---

## 2026-01-27 - US-004: Create root layout.tsx with Providers wrapper
Commit: 2300c8c

**Why this story?** Higher priority (4) than US-005 (5), all dependencies met (US-002 ✅, US-003 ✅), and it gates the most downstream stories (US-006, US-017, US-024-US-028, and all page migrations via US-006).

**Changes:**
- apps/online-store/src/components/Providers.tsx (NEW): Created 'use client' component wrapping children with ErrorBoundary → QueryClientProvider → AuthProvider → ThemeProvider → WishlistProvider → CartProvider → PersonalizationProvider → NotificationProvider → RealtimeProvider → TooltipProvider. Includes Toaster, Sonner, OfflineIndicator inside the tree.
- apps/online-store/src/app/layout.tsx: Updated from minimal stub to import globals.css and Providers, wrapping {children} with `<Providers>`.

**Learnings:**
- Provider ordering mirrors App.tsx exactly (ErrorBoundary outermost, Auth near top, Cart/Wishlist in middle, TooltipProvider innermost)
- HelmetProvider intentionally omitted — Next.js metadata API replaces it (will be officially removed in US-028)
- OfflineQueue and DemoRibbon not in acceptance criteria — kept Providers focused on the required providers and utility components
- ErrorBoundary is a React class component — works fine with 'use client' since it's imported by a client component

**Patterns to sync:** None new — provider ordering pattern is app-specific.

**Next story suggestion:** US-005 (Create navigation compatibility layer) — only depends on US-001 (done), needed by US-006 (customer layout) which in turn gates all page migrations. Last remaining Phase 1 scaffold story.

---

## 2026-01-27 - US-005: Create navigation compatibility layer
Commit: 3677dd9

**Why this story?** Last remaining Phase 1 scaffold story. Only depends on US-001 (done). Critical blocker for US-006 (customer layout) and US-018 (admin layout), which gate ALL page migrations. Previous session explicitly recommended this next.

**Changes:**
- apps/online-store/src/lib/navigation.ts (NEW): Created 'use client' navigation compatibility module with:
  - Re-exports: Link (next/link), usePathname, useSearchParams, useParams, useAppRouter (next/navigation)
  - useNavigate(): drop-in replacement for react-router-dom's useNavigate, wraps useRouter().push/back/replace
  - Supports navigate(path), navigate(path, {replace: true}), navigate(path, {state: {...}}), navigate(-1)
  - getNavigationState(): retrieves state passed via navigate() using sessionStorage (since Next.js router doesn't support state param)
  - setNavigationState(): stores state in sessionStorage before navigation

**Learnings:**
- react-router-dom's `location.state` has no direct Next.js equivalent — sessionStorage is the cleanest bridge for state transfer between pages during migration
- 21 files in src/ import from react-router-dom — APIs used: Link, useNavigate, useLocation, useParams, useSearchParams
- navigate() is called with `{ state: {...} }` in BookingConfirmation, BookingFlow, BookingSuccess, OrderConfirmation — these pages need getNavigationState() when migrated
- navigate() is called with `{ replace: true }` in BookingFlow — router.replace() handles this
- No navigate(-1) (go back by delta) calls found in codebase, but supported for completeness
- Type definitions self-contained in navigation.ts — separate navigation-types.ts not needed

**Patterns to sync:** None — navigation state via sessionStorage is migration-specific, not a reusable pattern.

**Next story suggestion:** US-006 (Create customer layout with Header and BottomNav) — now unblocked with US-004 ✅ and US-005 ✅. Gates all customer page migrations (US-007 through US-016). Phase 2 begins.

---

## 2026-01-27 - US-006: Create customer layout with Header and BottomNav
Commit: 34475a8

**Why this story?** Highest priority (6) among available stories with all dependencies met (US-004 ✅, US-005 ✅). Gates ALL customer page migrations (US-007 through US-016). Previous session explicitly recommended this as next. Phase 2 begins.

**Changes:**
- apps/online-store/src/app/(customer)/layout.tsx (NEW): Created 'use client' layout component with:
  - AnnouncementBarContainer, Header, BottomNav, ChatButton, ChatDrawer
  - useChatToggle hook for chat open/close state
  - min-h-screen flex-col container with flex-1 main content area
  - Structure exactly mirrors App.tsx customer routes wrapper (lines 117-152)

**Learnings:**
- The (customer) route group directory uses parentheses which need escaping in bash (`\(customer\)`) but not in file paths
- Layout is straightforward — all components already exist and export correctly
- No new patterns discovered — this is a thin layout wrapper matching the existing App.tsx structure

**Patterns to sync:** None — route group layouts are standard Next.js convention.

**Next story suggestion:** US-007 (Migrate home page to app router) — depends on US-006 (just completed), lowest priority among stories now unblocked by US-006. First page migration — establishes the pattern for all subsequent page stories.

---

## 2026-01-27 - US-007: Migrate home page to app router
Commit: 6fd8092

**Why this story?** Highest priority (7) among unblocked stories, depends only on US-006 (just completed). First page migration — establishes the pattern for all subsequent page stories. Previous session explicitly recommended this as next.

**Changes:**
- apps/online-store/src/app/(customer)/page.tsx (NEW): Created 'use client' wrapper component importing Index from '@/pages/Index'
- apps/online-store/src/app/page.tsx (DELETED): Removed root stub page.tsx — home route is now handled by (customer)/page.tsx which maps to / via the route group

**Learnings:**
- Index.tsx has ZERO react-router-dom imports — it only uses SEO, useTemplate, SectionRenderer, LoadingSpinner, PromotionBannerContainer, PromotionsStripContainer. No Link/useNavigate/useLocation usage at all.
- The PRD acceptance criterion "replace react-router-dom Link with next/link" was not needed for this file — navigation links exist in child components (SectionRenderer etc.) which are migrated in US-041/US-042.
- Root `src/app/page.tsx` must be deleted when using route group `(customer)/page.tsx` for `/` — otherwise Next.js has a route conflict since both map to `/`.
- The page migration pattern is simple: 'use client' wrapper in app/ that imports the existing page component from src/pages/.

**Patterns to sync:** None — the page wrapper pattern is documented in the first migration (this story) and reused in all subsequent page stories.

**Next story suggestion:** US-008 (Migrate Login page) — same phase, depends only on US-006 (done), priority 8. OR US-009 (Migrate Book pages) — same dependencies. US-008 is simpler (complexity 2 vs 3) so recommend that first.

---

## 2026-01-27 - US-008: Migrate Login page
Commit: c282281

**Why this story?** Highest priority (8) among unblocked stories with all dependencies met (US-006 ✅). Previous session explicitly recommended this as next. Low complexity (2), continues the page migration pattern from US-007.

**Changes:**
- apps/online-store/src/app/(customer)/login/page.tsx (NEW): Created 'use client' wrapper importing Login from '@/pages/Login'
- apps/online-store/src/pages/Login.tsx:2: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`

**Learnings:**
- Login.tsx only uses `useNavigate` from react-router-dom — no Link, useLocation, or useSearchParams. Simple single-import swap.
- The navigate() calls on lines 38, 53, 83 all use `navigate("/")` (simple path navigation) — fully compatible with the compat layer's useNavigate() wrapper.
- No Link component usage in Login.tsx — navigation links (if any) are in child components like ForgotPasswordDialog.
- Pre-existing typecheck errors (376+ errors in repository/supabase files) are unrelated to this migration — documented in US-002 progress.

**Patterns to sync:** None — follows established page migration pattern from US-007.

**Next story suggestion:** US-009 (Migrate Book pages) — priority 9, depends only on US-006 (done). Three pages in one story (book, confirmation, success) forming a sequential flow. OR US-010 (Booking module, complexity 1) for a simpler next story.

---

## 2026-01-27 - US-009: Migrate Book pages (book, confirmation, success)
Commit: 72c2673

**Why this story?** Highest priority (9) among unblocked stories. Previous session explicitly recommended this next. Three pages forming a sequential booking flow — efficient to migrate together.

**Changes:**
- apps/online-store/src/app/(customer)/book/page.tsx (NEW): Created 'use client' wrapper importing BookingFlowSimple from '@/pages/BookingFlowSimple'
- apps/online-store/src/app/(customer)/book/confirmation/page.tsx (NEW): Created 'use client' wrapper importing BookingConfirmation from '@/pages/BookingConfirmation'
- apps/online-store/src/app/(customer)/book/success/page.tsx (NEW): Created 'use client' wrapper importing BookingSuccess from '@/pages/BookingSuccess'
- apps/online-store/src/pages/BookingFlowSimple.tsx:2: Replaced `import { useNavigate } from 'react-router-dom'` with `import { useNavigate } from '@/lib/navigation'`
- apps/online-store/src/pages/BookingConfirmation.tsx:2: Replaced `import { useNavigate, useLocation } from 'react-router-dom'` with `import { useNavigate, getNavigationState } from '@/lib/navigation'`. Replaced `location.state?.bookingData` with `getNavigationState()` using useState lazy initializer.
- apps/online-store/src/pages/BookingSuccess.tsx:1-2: Added `useState` to React imports. Replaced `import { useLocation, useNavigate } from 'react-router-dom'` with `import { useNavigate, getNavigationState } from '@/lib/navigation'`. Replaced `location.state?.booking` with `getNavigationState()` using useState lazy initializer.

**Learnings:**
- BookingFlowSimple.tsx uses useNavigate but NOT useLocation — it manages its own internal step state ('booking' | 'confirm' | 'success') and doesn't actually navigate to /book/confirmation or /book/success. The navigate import is declared but only used at the top level (line 17), not actively called for navigation between steps.
- BookingConfirmation.tsx uses both useNavigate AND useLocation.state for receiving booking data. The `getNavigationState()` from the compat layer replaces `location.state` — must be read once via useState lazy initializer to avoid clearing sessionStorage on re-renders.
- BookingSuccess.tsx similarly receives `location.state?.booking` — same getNavigationState() pattern with useState lazy init.
- The `navigate('/book/success', { state: { booking: ... } })` call in BookingConfirmation.tsx works via the compat layer's setNavigationState() which stores in sessionStorage before router.push.
- Pre-existing `__MODE__` TypeScript error in BookingSuccess.tsx:198 — this is a Vite define variable, not related to migration.

**Patterns to sync:** None — getNavigationState() with useState lazy initializer pattern was already documented in US-005.

**Next story suggestion:** US-010 (Migrate Booking module page) — priority 10, complexity 1 (simplest remaining), depends only on US-006 (done). OR US-011 (Shop/ProductDetail, complexity 3) for the first dynamic route migration.

---

## 2026-01-27 - US-010: Migrate Booking module page
Commit: 39b8df5

**Why this story?** Highest priority (10) among unblocked stories. Previous session explicitly recommended this next. Simplest complexity (1) — quick win before tackling more complex page migrations.

**Changes:**
- apps/online-store/src/app/(customer)/booking/page.tsx (NEW): Created 'use client' wrapper importing BookingPage from '@/features/booking'
- apps/online-store/src/features/booking/pages/BookingConfirmation.tsx:2: Replaced `import { useNavigate } from 'react-router-dom'` with `import { useNavigate } from '@/lib/navigation'`

**Learnings:**
- BookingPage.tsx (the main page component) has ZERO react-router-dom imports — it manages multi-step booking flow entirely via Redux state (selectCurrentStep), rendering different step components internally.
- BookingConfirmation.tsx (inside features/booking/) uses useNavigate for "Book Another" and "Back to Home" buttons — simple navigate() calls to paths, fully compatible with the compat layer.
- The features/booking module does NOT have its own router (as PRD notes suggested to check) — it uses Redux-driven step rendering, not URL-based routing.
- This is distinct from the src/pages/BookingConfirmation.tsx (US-009) — features/booking has its own BookingConfirmation component at a different path.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-011 (Migrate Shop and ProductDetail pages) — priority 11, depends only on US-006 (done). First dynamic route migration with [productId] segment. OR US-012 (Cart/Checkout) or US-013 (OrderConfirmation/Memberships/GiftCards) — all simpler but lower priority.

---

## 2026-01-27 - US-011: Migrate Shop and ProductDetail pages
Commit: 2f1eca7

**Why this story?** Highest priority (11) among unblocked stories. Previous session explicitly recommended this next. First dynamic route migration with `[productId]` segment — establishes pattern for dynamic params extraction in Next.js.

**Changes:**
- apps/online-store/src/app/(customer)/shop/page.tsx (NEW): Created 'use client' wrapper importing Shop from '@/pages/Shop'
- apps/online-store/src/app/(customer)/shop/[productId]/page.tsx (NEW): Created 'use client' wrapper importing ProductDetail from '@/pages/ProductDetail'
- apps/online-store/src/pages/Shop.tsx:2: Replaced `import { useNavigate, useSearchParams } from "react-router-dom"` with `import { useNavigate, useSearchParams, useAppRouter, usePathname } from "@/lib/navigation"`. Replaced `setSearchParams(params)` with `router.replace()` using pathname + query string (Next.js useSearchParams is read-only — no setter function).
- apps/online-store/src/pages/ProductDetail.tsx:2: Replaced `import { useParams, useNavigate, Link } from 'react-router-dom'` with `import { useParams, useNavigate, Link } from '@/lib/navigation'`. Changed `useParams<{ productId: string }>()` to `useParams()` with manual cast (Next.js useParams returns `Record<string, string | string[]>`). Changed `Link to=` to `Link href=` (next/link API).

**Learnings:**
- Next.js `useSearchParams()` is READ-ONLY — it returns `ReadonlyURLSearchParams` with no setter. react-router-dom's `useSearchParams()` returns `[searchParams, setSearchParams]`. Replacement pattern: use `useAppRouter().replace(pathname + '?' + params.toString(), { scroll: false })` to update URL search params without page scroll.
- Next.js `useParams()` returns `Record<string, string | string[]>` — no generic type parameter like react-router-dom's `useParams<T>()`. Use `as string | undefined` cast for individual params.
- next/link uses `href` prop (not `to`). Must change all `<Link to="...">` to `<Link href="...">` when swapping imports.
- Pre-existing typecheck errors (376+ in repository/supabase/test files) are unchanged — no new errors from this migration.

**Patterns to sync:** None — useSearchParams read-only pattern is migration-specific.

**Next story suggestion:** US-012 (Migrate Cart and Checkout pages) — priority 12, depends only on US-006 (done). Same phase, same category. Continues sequential page migrations.

---

## 2026-01-27 - US-012: Migrate Cart and Checkout pages
Commit: a156212

**Why this story?** Highest priority (12) among unblocked stories. Previous session explicitly recommended this next. Cart and Checkout form a logical pair — checkout redirects to cart when empty, cart navigates to checkout.

**Changes:**
- apps/online-store/src/app/(customer)/cart/page.tsx (NEW): Created 'use client' wrapper importing Cart from '@/pages/Cart'
- apps/online-store/src/app/(customer)/checkout/page.tsx (NEW): Created 'use client' wrapper importing Checkout from '@/pages/Checkout'
- apps/online-store/src/pages/Cart.tsx:4: Replaced `import { Link, useNavigate } from "react-router-dom"` with `import { Link, useNavigate } from "@/lib/navigation"`. Changed `<Link to="/shop">` to `<Link href="/shop">` (next/link API).
- apps/online-store/src/pages/Checkout.tsx:3: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`. All navigate() calls use simple path strings or state objects — fully compatible with the compat layer.

**Learnings:**
- Cart.tsx uses both Link (with `to` prop → changed to `href`) and useNavigate (for `navigate('/checkout')`) — two import changes needed.
- Checkout.tsx uses useNavigate extensively (6 navigate calls) including `navigate('/order-confirmation', { state: { order: ... } })` which passes state — the compat layer's setNavigationState() handles this via sessionStorage.
- Pre-existing framer-motion type errors in Checkout.tsx (motion.div HTMLMotionProps) are unrelated to navigation migration — they're a known React 18 + framer-motion typing issue.
- No Link component usage in Checkout.tsx — all navigation is via useNavigate() programmatic calls.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-013 (Migrate OrderConfirmation, Memberships, GiftCards pages) — priority 13, depends only on US-006 (done). Three independent pages bundled, same Phase 2 pattern. OrderConfirmation is the next page in the checkout flow (checkout → order-confirmation).

---

## 2026-01-27 - US-013: Migrate OrderConfirmation, Memberships, GiftCards pages
Commit: 20be83f

**Why this story?** Highest priority (13) among unblocked stories. Previous session explicitly recommended this next. Three independent pages bundled — each is straightforward Link/navigate swaps. OrderConfirmation is the next page in the checkout flow (checkout → order-confirmation).

**Changes:**
- apps/online-store/src/app/(customer)/order-confirmation/page.tsx (NEW): Created 'use client' wrapper importing OrderConfirmation from '@/pages/OrderConfirmation'
- apps/online-store/src/app/(customer)/memberships/page.tsx (NEW): Created 'use client' wrapper importing Memberships from '@/pages/Memberships'
- apps/online-store/src/app/(customer)/gift-cards/page.tsx (NEW): Created 'use client' wrapper importing GiftCards from '@/pages/GiftCards'
- apps/online-store/src/pages/OrderConfirmation.tsx:5: Replaced `import { Link, useLocation, useNavigate } from "react-router-dom"` with `import { Link, useNavigate, getNavigationState } from "@/lib/navigation"`. Replaced `useLocation().state?.order` with `getNavigationState<{ order?: Order }>()` using useState lazy initializer. Changed all `<Link to=` to `<Link href=` (3 occurrences: lines 213, 218, 332).
- apps/online-store/src/pages/Memberships.tsx:6: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`
- apps/online-store/src/pages/GiftCards.tsx:12: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`

**Learnings:**
- OrderConfirmation.tsx uses Link (3 occurrences), useLocation (for order state), and useNavigate — the most complex of the three files. Required getNavigationState with generic type parameter `<{ order?: Order }>` to avoid TS2339 "Property 'order' does not exist on type 'unknown'" error.
- Memberships.tsx and GiftCards.tsx only use useNavigate with simple `navigate('/cart')` calls — single import swap each.
- Pre-existing errors in OrderConfirmation.tsx: motion.div framer-motion type issues (11 occurrences), `__MODE__` Vite define variable — all documented in prior stories.
- No new typecheck errors introduced by this migration.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-014 (Migrate Account page) — priority 14, depends only on US-006 (done). Account page uses useSearchParams for tab state — worth noting for URL params handling. OR US-015 (Info pages, 6 pages bundled) for volume.

---

## 2026-01-27 - US-014: Migrate Account page
Commit: b54b69c

**Why this story?** Highest priority (14) among unblocked stories. Previous session explicitly recommended this next. Continues sequential customer page migrations.

**Changes:**
- apps/online-store/src/app/(customer)/account/page.tsx (NEW): Created 'use client' wrapper importing Account from '@/pages/Account'
- apps/online-store/src/pages/Account.tsx:10: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`

**Learnings:**
- Account.tsx does NOT use useSearchParams for tab state — the PRD note was wrong. Tabs use Radix UI `<Tabs defaultValue="bookings">` which is entirely client-side React state. No URL params involved.
- Account.tsx only imports `useNavigate` from react-router-dom — no Link, useLocation, useSearchParams, or useParams. Single import swap.
- All navigate() calls use simple path strings (`'/cart'`, `'/book'`, `'/login'`, etc.) — fully compatible with the compat layer.
- Pre-existing type errors surfaced in Account.tsx (BookingCard props mismatch at lines 251, 275) — these are unrelated to the navigation migration and exist because BookingCardProps doesn't have a `booking` prop. Not introduced by this change.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-015 (Migrate Info pages — about, contact, gallery, reviews, faq, policies) — priority 15, depends only on US-006 (done). Six simple pages bundled, mostly static content with minimal router usage.

---

## 2026-01-27 - US-015: Migrate Info pages (about, contact, gallery, reviews, faq, policies)
Commit: c5fc5a0

**Why this story?** Highest priority (15) among unblocked stories. Previous session explicitly recommended this next. Six simple info pages bundled — mostly static content with minimal router usage.

**Changes:**
- apps/online-store/src/app/(customer)/info/about/page.tsx (NEW): Created 'use client' wrapper importing About from '@/pages/info/About'
- apps/online-store/src/app/(customer)/info/contact/page.tsx (NEW): Created 'use client' wrapper importing Contact from '@/pages/info/Contact'
- apps/online-store/src/app/(customer)/info/gallery/page.tsx (NEW): Created 'use client' wrapper importing Gallery from '@/pages/info/Gallery'
- apps/online-store/src/app/(customer)/info/reviews/page.tsx (NEW): Created 'use client' wrapper importing Reviews from '@/pages/info/Reviews'
- apps/online-store/src/app/(customer)/info/faq/page.tsx (NEW): Created 'use client' wrapper importing FAQ from '@/pages/info/FAQ'
- apps/online-store/src/app/(customer)/info/policies/page.tsx (NEW): Created 'use client' wrapper importing Policies from '@/pages/info/Policies'

**Learnings:**
- All 6 info pages have ZERO react-router-dom imports — they use SEOHead for metadata and standard HTML `<a>` tags for external links. No Link, useNavigate, useLocation, or useParams usage in any of them.
- The PRD acceptance criterion "update any Link imports to next/link" was not needed — none of these files use react-router-dom Link.
- Pages use `import.meta.env.VITE_SUPABASE_URL` for API calls — this will need to change to NEXT_PUBLIC_ when Vite is removed (US-043/US-044), but works fine during migration since these are 'use client' components.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-016 (Migrate Legal, Promotions, Updates pages) — priority 16, depends only on US-006 (done). Five simple pages bundled, same Phase 2 pattern. OR US-017 (Create not-found, error, loading, offline pages) — depends on US-004 (done), different pattern (Next.js special files).

---

## 2026-01-27 - US-016: Migrate Legal, Promotions, Updates pages
Commit: 72dfbb3

**Why this story?** Highest priority (16) among unblocked stories. Previous session explicitly recommended this next. Five simple pages bundled — legal pages are static content, promotions and updates use React Query but no router.

**Changes:**
- apps/online-store/src/app/(customer)/legal/privacy/page.tsx (NEW): Created 'use client' wrapper importing PrivacyPolicy from '@/pages/legal/PrivacyPolicy'
- apps/online-store/src/app/(customer)/legal/terms/page.tsx (NEW): Created 'use client' wrapper importing TermsOfService from '@/pages/legal/TermsOfService'
- apps/online-store/src/app/(customer)/legal/accessibility/page.tsx (NEW): Created 'use client' wrapper importing Accessibility from '@/pages/legal/Accessibility'
- apps/online-store/src/app/(customer)/promotions/page.tsx (NEW): Created 'use client' wrapper importing Promotions from '@/pages/Promotions'
- apps/online-store/src/app/(customer)/updates/page.tsx (NEW): Created 'use client' wrapper importing Updates from '@/pages/Updates'

**Learnings:**
- All 5 pages have ZERO react-router-dom imports — no Link, useNavigate, useLocation, or useParams. Only SEO component and standard React/library imports.
- Legal pages (PrivacyPolicy, TermsOfService, Accessibility) are pure static content with SEO component only.
- Promotions.tsx uses React Query (useQuery), CartContext (useCart), sonner (toast), but no routing.
- Updates.tsx uses React Query (useQuery), Tabs for category filtering, but no routing.
- PRD acceptance criterion "Update any react-router-dom imports" was not needed — none of these files use react-router-dom.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-017 (Create not-found, error, loading, offline pages) — priority 17, depends on US-004 (done). Different pattern from page wrappers — uses Next.js special file conventions (not-found.tsx, error.tsx, loading.tsx). OR US-018 (admin layout) — priority 18, depends on US-004 ✅ and US-005 ✅, gates all admin page migrations.

---

## 2026-01-27 - US-017: Create not-found, error, loading, and offline pages
Commit: a057780

**Why this story?** Highest priority (17) among unblocked stories. Previous session explicitly recommended this next. Uses Next.js special file conventions (not-found.tsx, error.tsx, loading.tsx) — a different pattern from the 'use client' page wrappers used in US-007 through US-016.

**Changes:**
- apps/online-store/src/app/not-found.tsx (NEW): Created Next.js 404 page with same visual design as NotFound.tsx but using next/link instead of react-router-dom. Server component (no 'use client' needed — Next.js not-found is a Server Component by convention).
- apps/online-store/src/app/error.tsx (NEW): Created 'use client' error boundary component with error logging via useEffect and a reset button. Follows Next.js error.tsx convention (receives error and reset props).
- apps/online-store/src/app/loading.tsx (NEW): Created loading skeleton with spinner animation and "Loading..." text. Server component.
- apps/online-store/src/app/offline/page.tsx (NEW): Created 'use client' wrapper importing Offline from '@/pages/Offline'.
- apps/online-store/src/pages/NotFound.tsx:1-2: Replaced `import { useLocation } from "react-router-dom"` with `import { usePathname } from "@/lib/navigation"`. Changed `useLocation().pathname` to `usePathname()`.
- apps/online-store/src/pages/Offline.tsx:1: Replaced `import { Link } from 'react-router-dom'` with `import Link from 'next/link'`. Changed `<Link to="/">` to `<Link href="/">` on line 69.

**Learnings:**
- Next.js `not-found.tsx` is a Server Component by default — no 'use client' directive needed. It renders when `notFound()` is called or when no route matches.
- Next.js `error.tsx` MUST be a Client Component ('use client') — it uses React error boundary under the hood which requires client-side rendering.
- Next.js `loading.tsx` is a Server Component — it renders as a Suspense fallback during page transitions.
- NotFound.tsx used `useLocation` only to log the current pathname — replaced with `usePathname` from the compat layer (which re-exports from next/navigation).
- Offline.tsx had a single `<Link to="/">` — simple swap to `<Link href="/">` with next/link import.
- Pre-existing typecheck errors (376+ in repository/supabase files) are unchanged — no new errors from this migration.

**Patterns to sync:** None — Next.js special file conventions (not-found, error, loading) are standard Next.js patterns.

**Next story suggestion:** US-018 (Create admin layout with ProtectedRoute) — priority 18, depends on US-004 ✅ and US-005 ✅. Gates ALL admin page migrations (US-019 through US-023). Critical path for completing Phase 2.

---

## 2026-01-27 - US-018: Create admin layout with ProtectedRoute
Commit: 0e7a4fe

**Why this story?** Highest priority (18) among unblocked stories. Previous session explicitly recommended this next. Gates ALL admin page migrations (US-019 through US-023). Dependencies US-004 ✅ and US-005 ✅ both met.

**Changes:**
- apps/online-store/src/app/admin/layout.tsx (NEW): Created 'use client' layout wrapping children with `<ProtectedRoute requireAdmin>` and `<AdminLayout>`. Follows same pattern as (customer)/layout.tsx.
- apps/online-store/src/components/admin/AdminLayout.tsx:2-3: Replaced `import { Link, useLocation, useNavigate } from "react-router-dom"` with `import Link from "next/link"` and `import { usePathname, useRouter } from "next/navigation"`. Changed `useLocation()` → `usePathname()`, `useNavigate()` → `useRouter()`, `navigate("/login")` → `router.push("/login")`, all `location.pathname` → `pathname`, all `<Link to=` → `<Link href=` (6 occurrences: logo, nav items, "Back to Store", breadcrumb).
- apps/online-store/src/components/ProtectedRoute.tsx:1-31: Replaced `Navigate` from react-router-dom with `useRouter().replace()` via useEffect. Added 'use client' directive. Uses useEffect to redirect unauthenticated/non-admin users. Shows spinner during loading or redirect states.

**Learnings:**
- react-router-dom's `<Navigate to="/login" replace />` is a declarative redirect component — Next.js has no equivalent. Replaced with imperative `router.replace()` inside useEffect, which runs on client mount and when auth state changes.
- ProtectedRoute must show a loading spinner during the redirect period (between useEffect trigger and navigation completing) — otherwise the wrapped admin content would briefly flash before redirect.
- AdminLayout.tsx had 6 `<Link to=` occurrences → all changed to `<Link href=` (next/link API). Also changed `useLocation()` → `usePathname()` for active nav detection and breadcrumb.
- No new typecheck errors introduced. Pre-existing errors (376+ in repository/supabase files) unchanged.

**Patterns to sync:** None — ProtectedRoute redirect pattern is app-specific.

**Next story suggestion:** US-019 (Migrate admin Dashboard and Storefront overview) — priority 19, depends on US-018 (just completed). Two admin pages, straightforward wrappers. OR US-020/US-021 (storefront sub-pages) — same dependency, same pattern.

---

## 2026-01-27 - US-019: Migrate admin Dashboard and Storefront overview
Commit: 188d6a6

**Why this story?** Highest priority (19) among unblocked stories. Previous session explicitly recommended this next. Depends on US-018 (just completed). Two admin pages — Dashboard has zero router deps, Storefront has one Link import.

**Changes:**
- apps/online-store/src/app/admin/page.tsx (NEW): Created 'use client' wrapper importing Dashboard from '@/pages/admin/Dashboard'
- apps/online-store/src/app/admin/storefront/page.tsx (NEW): Created 'use client' wrapper importing Storefront from '@/pages/admin/Storefront'
- apps/online-store/src/pages/admin/Storefront.tsx:3: Replaced `import { Link } from "react-router-dom"` with `import Link from "next/link"`. Changed `<Link to={section.path}>` to `<Link href={section.path}>` on line 90.

**Learnings:**
- Dashboard.tsx has ZERO react-router-dom imports — it uses only lucide-react icons and local dashboard components (DetailedMetricCard, RevenueChart, ActivityFeed, QuickActions). No navigation changes needed.
- Storefront.tsx had one react-router-dom import (Link) used for navigation cards to sub-pages. Simple `to` → `href` swap with next/link.
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-020 (Migrate admin Storefront sub-pages: theme, media, navigation, promotions, announcements) — priority 20, depends on US-018 (done). Five admin sub-pages, same thin wrapper pattern. OR US-021 (more storefront sub-pages) — same dependency, same pattern.

---

## 2026-01-27 - US-020: Migrate admin Storefront sub-pages (theme, media, navigation, promotions, announcements)
Commit: 317c58b

**Why this story?** Highest priority (20) among unblocked stories. Previous session explicitly recommended this next. Five admin storefront sub-pages — direct continuation of US-019 which created the storefront overview page.

**Changes:**
- apps/online-store/src/app/admin/storefront/theme/page.tsx (NEW): Created 'use client' wrapper importing Theme from '@/pages/admin/storefront/Theme'
- apps/online-store/src/app/admin/storefront/media/page.tsx (NEW): Created 'use client' wrapper importing Media from '@/pages/admin/storefront/Media'
- apps/online-store/src/app/admin/storefront/navigation/page.tsx (NEW): Created 'use client' wrapper importing Navigation from '@/pages/admin/storefront/Navigation'
- apps/online-store/src/app/admin/storefront/promotions/page.tsx (NEW): Created 'use client' wrapper importing Promotions from '@/pages/admin/storefront/Promotions'
- apps/online-store/src/app/admin/storefront/announcements/page.tsx (NEW): Created 'use client' wrapper importing Announcements from '@/pages/admin/storefront/Announcements'
- apps/online-store/src/pages/admin/storefront/Promotions.tsx:14: Replaced `import { Link } from 'react-router-dom'` with `import Link from 'next/link'`. Changed `<Link to="/"` to `<Link href="/"` on line 80.
- apps/online-store/src/pages/admin/storefront/Announcements.tsx:13: Replaced `import { Link } from 'react-router-dom'` with `import Link from 'next/link'`. Changed `<Link to="/"` to `<Link href="/"` on line 109.

**Learnings:**
- Theme.tsx, Media.tsx, and Navigation.tsx have ZERO react-router-dom imports — no migration changes needed for these source files.
- Promotions.tsx and Announcements.tsx each had a single `Link` import from react-router-dom used with `<Button asChild><Link to="/">` pattern — the `asChild` Radix UI prop works with next/link just as well.
- Both files use `<Link to="/" target="_blank">` for "View Storefront" buttons — simple `to` → `href` swap with next/link import change.
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-021 (Migrate admin Storefront sub-pages: content-builder, ab-tests, ai-copywriter, seo, templates) — priority 21, depends on US-018 (done). Five more admin sub-pages, same thin wrapper pattern. Same directory as US-020.

---

## 2026-01-27 - US-021: Migrate admin Storefront sub-pages (content-builder, ab-tests, ai-copywriter, seo, templates)
Commit: 0e4ab44

**Why this story?** Highest priority (21) among unblocked stories. Previous session explicitly recommended this next. Five more admin storefront sub-pages — same directory and pattern as just-completed US-020.

**Changes:**
- apps/online-store/src/app/admin/storefront/content-builder/page.tsx (NEW): Created 'use client' wrapper importing ContentBuilder from '@/pages/admin/storefront/ContentBuilder'
- apps/online-store/src/app/admin/storefront/ab-tests/page.tsx (NEW): Created 'use client' wrapper importing ABTests from '@/pages/admin/storefront/ABTests'
- apps/online-store/src/app/admin/storefront/ai-copywriter/page.tsx (NEW): Created 'use client' wrapper importing CopywriterPanel from '@/components/admin/ai-copywriter/CopywriterPanel'
- apps/online-store/src/app/admin/storefront/seo/page.tsx (NEW): Created 'use client' wrapper importing SEO from '@/pages/admin/storefront/SEO'
- apps/online-store/src/app/admin/storefront/templates/page.tsx (NEW): Created 'use client' wrapper importing Templates from '@/pages/admin/Templates'

**Learnings:**
- All 5 source files have ZERO react-router-dom imports — no migration changes needed for source files. Only wrapper pages created.
- CopywriterPanel is located at `src/components/admin/ai-copywriter/CopywriterPanel.tsx` (not in src/pages/admin/storefront/) — the PRD `files` array didn't list it, but the acceptance criteria mentions it. Found via glob search.
- Templates.tsx is at `src/pages/admin/Templates.tsx` (not in storefront/ subdirectory) — the PRD correctly lists this path.
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-022 (Migrate admin Catalog pages) — priority 22, depends on US-018 (done). Six admin catalog pages including first dynamic route [id] for service editing. OR US-023 (admin Management pages, 7 pages) — same dependency, lower complexity.

---

## 2026-01-27 - US-022: Migrate admin Catalog pages
Commit: e0ef566

**Why this story?** Highest priority (22) among unblocked stories. Previous session explicitly recommended this next. Six admin catalog pages including dynamic route [id] for service editing — same Phase 2 admin migration pattern.

**Changes:**
- apps/online-store/src/app/admin/catalog/page.tsx (NEW): Created 'use client' wrapper importing Catalog from '@/pages/admin/Catalog'
- apps/online-store/src/app/admin/catalog/services/page.tsx (NEW): Created 'use client' wrapper importing Services from '@/pages/admin/catalog/Services'
- apps/online-store/src/app/admin/catalog/services/[id]/page.tsx (NEW): Created 'use client' wrapper importing ServiceForm from '@/pages/admin/catalog/ServiceForm'
- apps/online-store/src/app/admin/catalog/products/page.tsx (NEW): Created 'use client' wrapper importing Products from '@/pages/admin/catalog/Products'
- apps/online-store/src/app/admin/catalog/memberships/page.tsx (NEW): Created 'use client' wrapper importing Memberships from '@/pages/admin/catalog/Memberships'
- apps/online-store/src/app/admin/catalog/giftcards/page.tsx (NEW): Created 'use client' wrapper importing GiftCardSettings from '@/pages/admin/catalog/GiftCardSettings'
- apps/online-store/src/pages/admin/Catalog.tsx:4: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`
- apps/online-store/src/pages/admin/catalog/Services.tsx:10: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:2: Replaced `import { useNavigate, useParams } from "react-router-dom"` with `import { useNavigate, useParams } from "@/lib/navigation"`. Changed `const { id } = useParams()` to `const params = useParams(); const id = params.id as string | undefined` (Next.js useParams returns Record, not generic).
- apps/online-store/src/pages/admin/catalog/Products.tsx:10: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`
- apps/online-store/src/pages/admin/catalog/Memberships.tsx:8: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`

**Learnings:**
- GiftCardSettings.tsx has ZERO react-router-dom imports — no migration changes needed for that source file. Only the wrapper page was created.
- ServiceForm.tsx uses both `useNavigate` and `useParams` from react-router-dom. Next.js `useParams()` returns `Record<string, string | string[] | undefined>` (no generic type parameter like react-router-dom's `useParams<T>()`). Must destructure via intermediate variable and cast: `const params = useParams(); const id = params.id as string | undefined;`.
- This is the second dynamic route migration (after US-011 [productId]). Same pattern: cast params to expected string type.
- Pre-existing type error in Services.tsx:27 (`generateMockServices() as Service[]` type mismatch) is unrelated to navigation changes — it's a mock data return type incompatibility.
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-023 (Migrate admin Management pages — bookings, customers, orders, staff, reports, analytics, settings) — priority 23, depends on US-018 (done). Seven admin pages, same thin wrapper pattern. Last Phase 2 story — completing it finishes all page migrations.

---

## 2026-01-27 - US-023: Migrate admin Management pages (bookings, customers, orders, staff, reports, analytics, settings)
Commit: 79d5e7f

**Why this story?** Highest priority (23) among unblocked stories. Previous session explicitly recommended this next. Last Phase 2 story — completing it finishes ALL page migrations. Seven admin pages, same thin wrapper pattern.

**Changes:**
- apps/online-store/src/app/admin/bookings/page.tsx (NEW): Created 'use client' wrapper importing Bookings from '@/pages/admin/Bookings'
- apps/online-store/src/app/admin/customers/page.tsx (NEW): Created 'use client' wrapper importing Customers from '@/pages/admin/Customers'
- apps/online-store/src/app/admin/orders/page.tsx (NEW): Created 'use client' wrapper importing Orders from '@/pages/admin/Orders'
- apps/online-store/src/app/admin/staff/page.tsx (NEW): Created 'use client' wrapper importing Staff from '@/pages/admin/Staff'
- apps/online-store/src/app/admin/reports/page.tsx (NEW): Created 'use client' wrapper importing Reports from '@/pages/admin/Reports'
- apps/online-store/src/app/admin/analytics/page.tsx (NEW): Created 'use client' wrapper importing Analytics from '@/pages/admin/Analytics'
- apps/online-store/src/app/admin/settings/page.tsx (NEW): Created placeholder settings page with "coming soon" message (no existing Settings component found)

**Learnings:**
- All 6 source files (Bookings, Customers, Orders, Staff, Reports, Analytics) have ZERO react-router-dom imports — no migration changes needed for source files. Only wrapper pages created.
- No existing AdminSettings.tsx component exists — the PRD notes "Settings may need a placeholder if the real component is complex." Created a lightweight placeholder with consistent admin page styling.
- Analytics.tsx already uses `export default function Analytics()` (function declaration export) vs the `const X = () => {}; export default X;` pattern in other files — both work fine with the wrapper pattern.
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.
- **Phase 2 is now COMPLETE** — all customer and admin page migrations are done (US-007 through US-023).

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-024 (Convert AuthContext for SSR safety) — priority 24, Phase 3 begins. Depends on US-004 (done). Most critical provider conversion — SSR hydration errors in AuthContext break everything. OR US-025 (ThemeContext with next-themes) — same phase, lower risk.

---

## 2026-01-27 - US-024: Convert AuthContext for SSR safety
Commit: 94f5030

**Why this story?** Highest priority (24) among unblocked stories. Previous session explicitly recommended this next. Most critical provider for SSR — AuthContext wraps everything and hydration errors here break the entire app. Phase 3 begins.

**Changes:**
- apps/online-store/src/contexts/AuthContext.tsx:1: Added `'use client'` directive at top of file
- apps/online-store/src/contexts/AuthContext.tsx:25-37: Replaced bare `import.meta.env.VITE_DEFAULT_STORE_ID` with `getDefaultStoreId()` function that guards with `typeof window !== 'undefined'` and supports both Vite (`import.meta.env`) and Next.js (`process.env.NEXT_PUBLIC_*`) env patterns during migration
- apps/online-store/src/contexts/AuthContext.tsx:155-157: Replaced component-body `console.log('🔐 AuthProvider initializing...')` with a comment explaining SSR-safe initialization pattern (state initializes as loading/null, resolves in useEffect)

**Learnings:**
- AuthContext.tsx had NO direct `localStorage` or `window` references — the Supabase client (`@/services/supabase/client`) already guards `window.localStorage` with `typeof window !== 'undefined'` (line 28 of client.ts).
- All Supabase auth listener setup (`onAuthStateChange`) and session checks (`getSession`) were already inside `useEffect` — inherently SSR-safe since useEffect doesn't run on the server.
- `isLoading` state initializes as `true` — this is correct for SSR. Both server and client render the loading state initially, then client resolves auth via useEffect. No hydration mismatch.
- The only SSR hazard was `import.meta.env.VITE_DEFAULT_STORE_ID` at module scope — `import.meta.env` is Vite-specific and unavailable in Next.js SSR. Guarded with `typeof window` check and `process.env.NEXT_PUBLIC_*` fallback.
- `console.log` calls inside the component body (outside useEffect) would still execute during client-side rendering of 'use client' components — they don't cause SSR issues but are unnecessary noise. Removed the one in the component body.

**Patterns to sync:** None — SSR safety pattern for `import.meta.env` replacement is migration-specific.

**Next story suggestion:** US-025 (Convert ThemeContext to use next-themes) — priority 25, Phase 3. Depends on US-004 (done). next-themes is already in dependencies. Lower complexity (3) than US-024. OR US-026 (Cart/Wishlist/Personalization contexts) — same phase, groups 3 related contexts.

---

## 2026-01-27 - US-025: Convert ThemeContext to use next-themes
Commit: 6f8e3db

**Why this story?** Highest priority (25) among unblocked stories. Previous session explicitly recommended this next. Phase 3 provider conversion continues — next-themes is already in dependencies.

**Changes:**
- apps/online-store/src/contexts/ThemeContext.tsx:1: Added `'use client'` directive
- apps/online-store/src/contexts/ThemeContext.tsx:91: Guarded `localStorage.getItem("mango-theme-draft")` in useState initializer with `typeof window === 'undefined'` check — returns defaultTheme on server
- apps/online-store/src/contexts/ThemeContext.tsx:119-121: Guarded `localStorage.setItem("mango-theme-published")` in publishTheme() with `typeof window !== 'undefined'` check
- apps/online-store/src/components/Providers.tsx:4: Added `import { ThemeProvider as NextThemesProvider } from 'next-themes'`
- apps/online-store/src/components/Providers.tsx:6: Renamed ThemeContext import to `BrandThemeProvider` to disambiguate from next-themes
- apps/online-store/src/components/Providers.tsx:24-25: Wrapped BrandThemeProvider inside `<NextThemesProvider attribute="class" defaultTheme="light" enableSystem disableTransitionOnChange>`

**Learnings:**
- The existing ThemeContext is NOT about dark/light mode — it's a **brand customization** context (colors, typography, branding, layout config). `next-themes` handles dark/light mode switching, which is a separate concern.
- Both providers coexist: `NextThemesProvider` (outer) handles dark/light mode with SSR-safe cookie-based persistence, while `BrandThemeProvider` (inner) handles store brand customization with localStorage persistence.
- Only one file (`Theme.tsx` admin page) uses `useTheme` from ThemeContext — zero risk of consumer breakage since the import path and API remain identical.
- `localStorage.setItem` inside `useEffect` doesn't need guarding (useEffect only runs on client), but `localStorage.getItem` in useState initializer DOES need guarding (useState initializer runs during SSR when used in a 'use client' component rendered in a Server Component tree).
- `disableTransitionOnChange` on NextThemesProvider prevents FOUC by disabling CSS transitions during theme switch.

**Patterns to sync:** None — next-themes integration is standard Next.js pattern.

**Next story suggestion:** US-026 (Convert Cart, Wishlist, Personalization contexts for SSR) — priority 26, Phase 3. Depends on US-004 (done). Groups 3 related contexts with similar localStorage SSR-safety patterns.

---

## 2026-01-27 - US-026: Convert Cart, Wishlist, Personalization contexts for SSR
Commit: 1e0e36f

**Why this story?** Highest priority (26) among unblocked stories. Previous session explicitly recommended this next. Phase 3 provider conversion continues — groups 3 related contexts with similar localStorage SSR-safety patterns.

**Changes:**
- apps/online-store/src/contexts/CartContext.tsx:1: Added `'use client'` directive. No other changes needed — all localStorage calls were already inside useEffect (lines 40-87), which only runs on client. State initializes as empty arrays/null — SSR-safe defaults.
- apps/online-store/src/contexts/WishlistContext.tsx:1: Added `'use client'` directive.
- apps/online-store/src/contexts/WishlistContext.tsx:16: Added `typeof window === 'undefined'` guard in useState initializer — this was the only SSR hazard. localStorage.getItem was called directly in the useState lazy initializer which runs during SSR.
- apps/online-store/src/contexts/PersonalizationContext.tsx:1: Added `'use client'` directive. No other changes needed — getUserProfile() already has `typeof window === 'undefined'` guard (returns default profile on server). getSession() and incrementVisitCount() are called inside useEffect — inherently SSR-safe.

**Learnings:**
- CartContext was already SSR-safe by design — all localStorage access is inside useEffect hooks, and state initializes with empty/null defaults. Only needed the 'use client' directive.
- WishlistContext had the ONE real SSR hazard: `useState<string[]>(() => { const saved = localStorage.getItem(...) })` — the useState lazy initializer runs during SSR in a 'use client' component rendered within a Server Component tree. Added `typeof window === 'undefined'` guard to return `[]` on server.
- PersonalizationContext's `getUserProfile()` already had SSR guards in `src/lib/ai/personalization.ts` (lines 7-9: `typeof window === 'undefined'` returns default profile). Similarly, `getSession()` has the same guard (lines 66-72). Only the 'use client' directive was needed.
- Pattern confirmed: localStorage access in `useEffect` is inherently SSR-safe. Only localStorage in `useState` initializers or module-level code needs explicit window guards.

**Patterns to sync:** None — the localStorage SSR guard pattern is already well-established from US-024 and US-025.

**Next story suggestion:** US-027 (Convert NotificationContext and RealtimeProvider for SSR) — priority 27, Phase 3. Depends on US-004 (done). Last remaining Phase 3 provider conversion. WebSocket/MQTT connections must be client-only.

---

## 2026-01-27 - US-027: Convert NotificationContext and RealtimeProvider for SSR
Commit: 2f748b0

**Why this story?** Highest priority (27) among unblocked stories. Previous session explicitly recommended this next. Last remaining Phase 3 provider conversion. Completes all SSR-safety work for providers.

**Changes:**
- apps/online-store/src/contexts/NotificationContext.tsx:1: Added `'use client'` directive
- apps/online-store/src/contexts/NotificationContext.tsx:165-167: Added `typeof window !== 'undefined'` guard around `localStorage.removeItem(STORAGE_KEY)` in `clearAll()` function
- apps/online-store/src/contexts/NotificationContext.tsx:176: Added `typeof window === 'undefined'` early return guard in `refreshNotifications()` before `localStorage.getItem()` call
- apps/online-store/src/providers/RealtimeProvider.tsx:1: Added `'use client'` directive

**Learnings:**
- NotificationContext.tsx already had `typeof window === 'undefined'` guard in its initial useEffect (line 54) and all primary localStorage access was inside useEffect — inherently SSR-safe. Only two functions called outside useEffect needed guards: `clearAll()` (localStorage.removeItem) and `refreshNotifications()` (localStorage.getItem). These are event handlers that only run client-side in practice, but defense-in-depth SSR guards are good practice.
- RealtimeProvider.tsx ONLY needed the `'use client'` directive — all Supabase Realtime subscriptions (via `useBookingRealtime` hook) are set up inside `useEffect` (line 103 of useBookingRealtime.ts), which doesn't run during SSR. The hook uses `useState`, `useCallback`, `useMemo` — all safe in 'use client' components.
- `Intl.DateTimeFormat().resolvedOptions().timeZone` (line 44 of NotificationContext) is available in Node.js — SSR-safe, no guard needed.
- The `useStore` hook used by RealtimeProvider has `import.meta.env.VITE_DEFAULT_STORE_ID` at module scope — this is a concern for useStore.ts itself (not this story), but since RealtimeProvider is a 'use client' component, `import.meta.env` is available via Vite bundling.
- **Phase 3 is now COMPLETE** — all 4 provider conversions done (US-024 AuthContext, US-025 ThemeContext, US-026 Cart/Wishlist/Personalization, US-027 Notification/Realtime).

**Patterns to sync:** None — follows established SSR-safety patterns from US-024/US-025/US-026.

**Next story suggestion:** US-028 (Add root metadata and shared metadata config) — priority 28, Phase 4 begins. Depends on US-004 (done). Unblocks US-029, US-030, US-031, US-032 (all Phase 4 SEO stories).

---

## 2026-01-27 - US-028: Add root metadata and shared metadata config
Commit: 0b86eda

**Why this story?** Highest priority (28) among unblocked stories. Previous session explicitly recommended this next. Phase 4 (SEO) begins. Gates US-029, US-030, US-031, US-032.

**Changes:**
- apps/online-store/src/lib/metadata.ts (NEW): Created shared metadata module with siteConfig constants (name, description, url, ogImage), sharedMetadata (Metadata type with title template '%s | Mango', openGraph, twitter card), and sharedViewport (Viewport type with device-width, initialScale, themeColor for light/dark).
- apps/online-store/src/app/layout.tsx: Added `export const metadata: Metadata = sharedMetadata` and `export const viewport: Viewport = sharedViewport`. Added `suppressHydrationWarning` on `<html>` element for next-themes compatibility. Added imports for sharedMetadata, sharedViewport from `@/lib/metadata` and Metadata, Viewport types from 'next'.

**Learnings:**
- HelmetProvider was already removed from Providers.tsx in US-004 (intentionally omitted during initial creation). The acceptance criterion "Remove HelmetProvider from Providers.tsx" was already satisfied — no action needed.
- `suppressHydrationWarning` on `<html>` is needed because next-themes injects a `class` attribute during hydration to prevent FOUC. Without it, React warns about the mismatch between server-rendered HTML (no class) and client hydration (class="light" or "dark").
- `metadataBase` in the Metadata object resolves relative OG image URLs to absolute URLs. Using `new URL()` at module scope is SSR-safe in Next.js (runs in Node.js on the server).
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this story.

**Patterns to sync:** None — Next.js metadata configuration is standard Next.js pattern.

**Next story suggestion:** US-029 (Add static metadata to customer pages) — priority 29, Phase 4. Depends on US-028 (just completed) plus US-007/US-008/US-011/US-012 (all done). Bulk metadata addition to 11 customer page wrappers. OR US-032 (sitemap/robots/JSON-LD) — depends only on US-028 (done), different pattern.

---

## 2026-01-27 - US-029: Add static metadata to customer pages
Commit: 922aa4e

**Why this story?** Highest priority (29) among unblocked stories. Previous session explicitly recommended this next. All dependencies met (US-007✅, US-008✅, US-011✅, US-012✅, US-028✅). Bulk metadata addition — low complexity (1), same Phase 4 SEO category.

**Changes:**
- apps/online-store/src/pages/Index.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/BookingFlowSimple.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Shop.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Cart.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Checkout.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Memberships.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/GiftCards.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Account.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Login.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Promotions.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/Updates.tsx:1: Added `'use client'` directive
- apps/online-store/src/app/(customer)/page.tsx: Removed `'use client'`, added `import type { Metadata } from 'next'` and `export const metadata` with title 'Home'
- apps/online-store/src/app/(customer)/book/page.tsx: Same pattern — metadata title 'Book an Appointment'
- apps/online-store/src/app/(customer)/shop/page.tsx: Same pattern — metadata title 'Shop'
- apps/online-store/src/app/(customer)/cart/page.tsx: Same pattern — metadata title 'Cart'
- apps/online-store/src/app/(customer)/checkout/page.tsx: Same pattern — metadata title 'Checkout'
- apps/online-store/src/app/(customer)/memberships/page.tsx: Same pattern — metadata title 'Memberships'
- apps/online-store/src/app/(customer)/gift-cards/page.tsx: Same pattern — metadata title 'Gift Cards'
- apps/online-store/src/app/(customer)/account/page.tsx: Same pattern — metadata title 'My Account'
- apps/online-store/src/app/(customer)/login/page.tsx: Same pattern — metadata title 'Login'
- apps/online-store/src/app/(customer)/promotions/page.tsx: Same pattern — metadata title 'Promotions'
- apps/online-store/src/app/(customer)/updates/page.tsx: Same pattern — metadata title 'Updates'

**Learnings:**
- Next.js metadata exports (`export const metadata`) ONLY work in Server Components — cannot coexist with `'use client'` directive. To add metadata to page wrappers, the wrapper must be a Server Component that imports a Client Component.
- The solution: move `'use client'` from the `src/app/*/page.tsx` wrappers to the `src/pages/*.tsx` source components themselves. Source components use hooks (useState, useEffect, useNavigate) so they need `'use client'`. The app/ wrappers become Server Components that can export metadata.
- All 11 source page components had zero `'use client'` directives — they relied on the wrapper's `'use client'` to create the client boundary. Now each source file is self-contained as a Client Component.
- The title template from root layout (`%s | Mango`) means each page's title will render as e.g. "Shop | Mango", "Cart | Mango", etc.
- Pre-existing typecheck errors (Account.tsx BookingCard props, Checkout.tsx framer-motion types) are unchanged — no new errors.

**Patterns to sync:**
- Pattern: Server Component page wrapper for metadata — Next.js metadata exports require Server Components. When migrating 'use client' page wrappers to support metadata, move 'use client' to the imported source component and make the wrapper a Server Component.

**Next story suggestion:** US-030 (Add metadata to info and legal pages) — priority 30, Phase 4. Same pattern as US-029 but for info/legal pages. Depends on US-015✅, US-016✅, US-028✅. OR US-032 (sitemap/robots/JSON-LD) — different pattern, depends only on US-028 (done).

---

## 2026-01-27 - US-030: Add metadata to info and legal pages
Commit: c7252ee

**Why this story?** Highest priority (30) among unblocked stories. Same Phase 4 SEO pattern as US-029 (just completed). All dependencies met (US-015✅, US-016✅, US-028✅). Lowest complexity (1) — direct continuation of metadata work.

**Changes:**
- apps/online-store/src/pages/info/About.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/info/Contact.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/info/Gallery.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/info/Reviews.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/info/FAQ.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/info/Policies.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/legal/PrivacyPolicy.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/legal/TermsOfService.tsx:1: Added `'use client'` directive
- apps/online-store/src/pages/legal/Accessibility.tsx:1: Added `'use client'` directive
- apps/online-store/src/app/(customer)/info/about/page.tsx: Removed `'use client'`, added metadata (title: 'About Us')
- apps/online-store/src/app/(customer)/info/contact/page.tsx: Removed `'use client'`, added metadata (title: 'Contact Us')
- apps/online-store/src/app/(customer)/info/gallery/page.tsx: Removed `'use client'`, added metadata (title: 'Gallery')
- apps/online-store/src/app/(customer)/info/reviews/page.tsx: Removed `'use client'`, added metadata (title: 'Reviews')
- apps/online-store/src/app/(customer)/info/faq/page.tsx: Removed `'use client'`, added metadata (title: 'FAQ')
- apps/online-store/src/app/(customer)/info/policies/page.tsx: Removed `'use client'`, added metadata (title: 'Policies')
- apps/online-store/src/app/(customer)/legal/privacy/page.tsx: Removed `'use client'`, added metadata (title: 'Privacy Policy')
- apps/online-store/src/app/(customer)/legal/terms/page.tsx: Removed `'use client'`, added metadata (title: 'Terms of Service')
- apps/online-store/src/app/(customer)/legal/accessibility/page.tsx: Removed `'use client'`, added metadata (title: 'Accessibility')

**Learnings:**
- Info pages (About, Contact, Gallery, Reviews, FAQ, Policies) all use `useEffect` and `useState` — require `'use client'` directive on the source component.
- Legal pages (PrivacyPolicy, TermsOfService, Accessibility) use NO hooks but import `SEO` from `@/components/SEO` which uses `react-helmet-async` (Helmet) — this requires a client boundary since HelmetProvider was a client-side provider.
- Same pattern as US-029: move `'use client'` from the app/ wrapper to the src/pages/ source component, making the wrapper a Server Component that can export metadata.
- None of the 9 source files had `'use client'` previously — they relied on the wrapper's `'use client'` to create the client boundary.
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.

**Patterns to sync:** None — follows established Server Component page wrapper pattern from US-029.

**Next story suggestion:** US-031 (Add generateMetadata for dynamic routes) — priority 31, Phase 4. Depends on US-011✅, US-022✅, US-028✅. Different pattern (generateMetadata function for dynamic pages). OR US-032 (sitemap/robots/JSON-LD) — priority 32, depends only on US-028 (done).

---

## 2026-01-27 - US-031: Add generateMetadata for dynamic routes
Commit: 4a8c197

**Why this story?** Highest priority (31) among unblocked stories. Previous session explicitly recommended this next. Continues Phase 4 SEO work — builds on static metadata patterns from US-029/US-030 with dynamic `generateMetadata` for parameterized routes.

**Changes:**
- apps/online-store/src/pages/ProductDetail.tsx:1: Added `'use client'` directive (enables wrapper to be a Server Component for metadata export)
- apps/online-store/src/pages/admin/catalog/ServiceForm.tsx:1: Added `'use client'` directive (same pattern)
- apps/online-store/src/app/(customer)/shop/[productId]/page.tsx: Removed `'use client'`, converted to Server Component with `generateMetadata` that fetches product data via `getProducts()` and returns dynamic title/description/OG tags. Falls back to generic "Product" metadata on fetch failure or product not found. Includes OG image when product has images.
- apps/online-store/src/app/admin/catalog/services/[id]/page.tsx: Removed `'use client'`, converted to Server Component with `generateMetadata` that returns "New Service" for `id === 'new'` or "Edit Service" otherwise. ServiceForm reads from localStorage (server-inaccessible), so metadata is based on the route param only.

**Learnings:**
- `generateMetadata` is an async function — Next.js calls it during rendering to resolve metadata before sending HTML. It receives the same `params` prop as the page component.
- In Next.js 16, `params` is a Promise that must be awaited: `const { productId } = await params;` — this is different from older Next.js versions where params was synchronous.
- `getProducts()` uses `storeAPI.get('/products')` which calls the API client — this works in `generateMetadata` on the server because the API client uses `fetch()` which is available in both browser and Node.js environments. However, during SSR it may fail if the API server isn't running, so the try/catch with fallback metadata is essential.
- ServiceForm reads service data from `localStorage` (line 54) — this is completely unavailable on the server. Rather than creating a server-side data fetch for an admin form page, simple static metadata ("New Service" / "Edit Service") is appropriate. Admin pages don't need rich SEO metadata.
- Same pattern as US-029/US-030: move `'use client'` from app/ wrapper to src/pages/ source component, making the wrapper a Server Component that can export metadata (or `generateMetadata`).
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no new errors from this migration.

**Patterns to sync:** None — `generateMetadata` with async params is standard Next.js 16 pattern.

**Next story suggestion:** US-032 (Create sitemap.ts, robots.ts, and JSON-LD components) — priority 32, Phase 4. Depends only on US-028 (done). Completes Phase 4 SEO. Different pattern — file-based sitemap/robots generation and structured data. OR US-033 (Supabase server/client utilities) — priority 33, Phase 5, unblocks US-034/US-035/US-036/US-037.

---

## 2026-01-27 - US-032: Create sitemap.ts, robots.ts, and JSON-LD components
Commit: 44a950a (WIP commit from previous session — verified complete)

**Why this story?** Highest priority (32) among unblocked stories. Previous session explicitly recommended this next. Completes Phase 4 SEO. Only dependency is US-028 (done). Previous session created a WIP commit with all implementation — this iteration verified all acceptance criteria are met.

**Changes:**
- apps/online-store/src/app/sitemap.ts (NEW): Created MetadataRoute.Sitemap function with 18 static public customer routes including home, book, booking, shop, memberships, gift-cards, promotions, updates, 6 info pages, and 3 legal pages. Each route has appropriate changeFrequency (daily/weekly/monthly/yearly) and priority (0.3-1.0).
- apps/online-store/src/app/robots.ts (NEW): Created MetadataRoute.Robots function allowing all user agents on `/`, disallowing `/admin/`, `/api/`, `/offline`. Includes sitemap URL reference.
- apps/online-store/src/components/JsonLd.tsx (NEW): Created three components:
  - `JsonLd` — generic JSON-LD component using next/script with `strategy="afterInteractive"`
  - `LocalBusinessJsonLd` — BeautySalon schema.org type with optional telephone, address, image, priceRange, openingHours
  - `BreadcrumbJsonLd` — BreadcrumbList schema.org type with position-indexed items
- apps/online-store/src/app/(customer)/page.tsx: Added `<LocalBusinessJsonLd>` with siteConfig name/description/url
- apps/online-store/src/app/(customer)/shop/page.tsx: Added `<BreadcrumbJsonLd>` with Home → Shop breadcrumb
- apps/online-store/src/app/(customer)/shop/[productId]/page.tsx: Added `<BreadcrumbJsonLd>` with Home → Shop → Product breadcrumb
- apps/online-store/src/app/(customer)/info/about/page.tsx: Added `<BreadcrumbJsonLd>` with Home → About Us breadcrumb
- apps/online-store/src/app/(customer)/legal/privacy/page.tsx: Added `<BreadcrumbJsonLd>` with Home → Privacy Policy breadcrumb

**Learnings:**
- WIP commits from previous sessions can contain complete implementations — always verify acceptance criteria before starting re-implementation.
- `MetadataRoute.Sitemap` and `MetadataRoute.Robots` are strongly typed Next.js types that auto-generate `/sitemap.xml` and `/robots.txt` from the default exports.
- `next/script` with `strategy="afterInteractive"` is appropriate for JSON-LD since it doesn't affect rendering but should be available for search engine crawlers after page load.
- BreadcrumbJsonLd added to representative pages (shop, product detail, about, privacy) — not every page needs breadcrumbs (e.g., home page already has LocalBusiness).
- Pre-existing typecheck errors (376+ in repository/supabase files) unchanged — no errors from US-032 files.
- **Phase 4 (SEO) is now COMPLETE** — all 5 SEO stories done (US-028 root metadata, US-029 customer page metadata, US-030 info/legal metadata, US-031 dynamic metadata, US-032 sitemap/robots/JSON-LD).

**Patterns to sync:** None — sitemap.ts/robots.ts/JSON-LD are standard Next.js conventions.

**Next story suggestion:** US-033 (Create Supabase server and client utilities for Next.js) — priority 33, Phase 5 begins. Depends only on US-001 (done). Gates US-034 (server component data fetching), US-035 (booking API routes), US-036 (cart/checkout API routes), US-037 (auth middleware). Critical path for backend work.

---

## 2026-01-27 - US-033: Create Supabase server and client utilities for Next.js
Commit: 0d8a980

**Why this story?** Highest priority (33) among unblocked stories. Previous session explicitly recommended this next. Phase 5 (Data Layer) begins. Only dependency is US-001 (done). Gates US-034, US-035, US-036, US-037 — critical path for all backend work.

**Changes:**
- apps/online-store/package.json: Added `@supabase/ssr@^0.8.0` dependency
- apps/online-store/src/lib/supabase/server.ts (NEW): Created async `createClient()` function using `createServerClient` from `@supabase/ssr` with Next.js `cookies()` API. Handles `getAll()` for reading cookies and `setAll()` with try/catch for write operations (graceful fallback in Server Components where cookies are read-only). Uses `Database` type from `@/services/supabase/types`. Includes `X-Client-Info` header.
- apps/online-store/src/lib/supabase/client.ts (NEW): Created `createClient()` function using `createBrowserClient` from `@supabase/ssr` with `'use client'` directive. Returns a singleton client that uses `document.cookie` automatically. Uses `Database` type from `@/services/supabase/types`. Includes `X-Client-Info` header.
- apps/online-store/.env.example (NEW): Created with `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `NEXT_PUBLIC_DEFAULT_STORE_ID` plus `VITE_*` fallbacks for migration period.
- pnpm-lock.yaml: Updated with @supabase/ssr and transitive deps (@supabase/node-fetch)

**Learnings:**
- `@supabase/ssr` v0.8.0 exports `createServerClient` and `createBrowserClient` — replaces the deprecated `@supabase/auth-helpers-nextjs` package.
- `createServerClient` requires `cookies.getAll()` and `cookies.setAll()` functions. In Server Components, `setAll()` will fail because cookies are read-only — the try/catch pattern is the documented approach (session refresh is handled by middleware instead).
- `createBrowserClient` returns a singleton by default — safe to call `createClient()` multiple times in client components without creating multiple instances.
- In Next.js 16, `cookies()` from `next/headers` returns a `Promise` — must be awaited: `const cookieStore = await cookies()`. This is different from Next.js 14/15 where it was synchronous.
- The existing `src/services/supabase/client.ts` uses `import.meta.env.VITE_*` — the new `src/lib/supabase/` utilities use `process.env.NEXT_PUBLIC_*`. Both coexist during migration: existing client components import from `@/services/supabase/client`, new server/SSR code imports from `@/lib/supabase/server` or `@/lib/supabase/client`.
- `Database` type is re-exported from `@/services/supabase/types` which imports from `@mango/supabase` — the import works at the type level even though `@mango/supabase` has module resolution errors at runtime (types are erased at build time).

**Patterns to sync:** None — Supabase SSR client setup is standard Next.js + @supabase/ssr pattern.

**Next story suggestion:** US-034 (Convert shop page to Server Component data fetching) — priority 34, Phase 5. Depends on US-011✅ and US-033 (just completed). Establishes the server component data fetching pattern. OR US-035 (booking API routes) — same phase, depends only on US-033. OR US-038 (Vercel deployment config) — Phase 6, depends only on US-001 (done), could run in parallel.

---

## 2026-01-27 - US-034: Convert shop page to Server Component data fetching
Commit: 4189f3e

**Why this story?** Highest priority (34) among unblocked stories with all dependencies met (US-011✅, US-033✅). Previous session explicitly recommended this next. Establishes the async Server Component → Client Component data fetching pattern for the entire project.

**Changes:**
- apps/online-store/src/app/(customer)/shop/page.tsx: Converted from Server Component importing Shop → async Server Component that: (1) calls `getProducts()` server-side, (2) maps StoreProduct → Product via `mapStoreProductsToProducts()`, (3) passes `initialProducts` to ShopClient. Retains metadata export and BreadcrumbJsonLd. Try/catch wraps server fetch — falls back to empty array on failure (ShopClient handles client-side fallback).
- apps/online-store/src/pages/ShopClient.tsx (NEW): Created 'use client' component with `initialProducts` prop. Mirrors all existing Shop.tsx UI (hero, search, filter panel/drawer/chips, product grid, loading/error states). Key difference from Shop.tsx: initializes `products` state from `initialProducts` prop instead of empty array, sets `isLoading` to false when initial data exists, and only fetches client-side when `initialProducts` is empty.

**Learnings:**
- The `getProducts()` function uses `storeAPI.get('/products')` which calls `fetch()` with a relative URL (`/api/v1/storefront/products`). On the server, relative URLs resolve against the server's own origin — this works in Next.js dev (localhost:3001) but may fail in production if the API isn't on the same host. The try/catch with client-side fallback handles this gracefully.
- The Product mapping logic (StoreProduct → Product) was duplicated in both Shop.tsx and the new page.tsx. This is intentional — the server-side mapping in page.tsx allows the ShopClient to receive pre-mapped data, while ShopClient retains the same mapping for its client-side fallback fetch. In the future, this mapping could be extracted to a shared utility.
- Product interface doesn't have `active`, `brand`, `taxCode`, or `shippingRequired` fields — these are extra properties from the original Shop.tsx mapping that TypeScript allows because the mapping function uses `any` type parameter. No type errors since all required Product properties are present.
- Pre-existing typecheck errors (376+ in repository/supabase/test files) unchanged — no new errors from this migration.

**Patterns to sync:** None — async Server Component → Client Component pattern is standard Next.js convention.

**Next story suggestion:** US-035 (Create API route handlers for booking mutations) — priority 35, Phase 5. Depends only on US-033 (done). Creates Next.js API routes for booking CRUD operations. OR US-036 (cart/checkout API routes) — priority 36, same dependency. OR US-038 (Vercel deployment) — priority 38, Phase 6, depends only on US-001 (done).

---

## 2026-01-27 - US-035: Create API route handlers for booking mutations
Commit: fea8624

**Why this story?** Highest priority (35) among unblocked stories with all dependencies met (US-033✅). Continues Phase 5 Data Layer work — same backend category as just-completed US-034. Previous session explicitly recommended this next.

**Changes:**
- apps/online-store/src/app/api/bookings/route.ts (NEW): Created Next.js Route Handler with:
  - POST handler: Creates booking with Zod-validated body (serviceId, staffId, requestedDate, requestedTime, guest info, notes, source). Validates service exists, staff belongs to same store if specified. Supports both authenticated users and guest bookings (requires either auth or guest contact info). Inserts into `online_bookings` table. Returns 201 on success.
  - GET handler: Lists bookings with pagination. Requires authentication. Supports filtering by storeId (required), date, and status. Uses Supabase `select('*', { count: 'exact' })` for total count. Returns paginated response with page/limit/total/totalPages/hasMore.
- apps/online-store/src/app/api/bookings/[id]/route.ts (NEW): Created Next.js Route Handler with:
  - GET handler: Fetches single booking by UUID. Requires authentication. Validates ID is UUID format via Zod.
  - PATCH handler: Updates booking fields (status, staffId, requestedDate, requestedTime, notes). Requires authentication. Auto-sets confirmed_at/confirmed_by when status changes to 'confirmed'. Requires at least one field to update.
- Both files use Supabase server client from `@/lib/supabase/server`, Zod for all input validation, and return proper HTTP status codes (200, 201, 400, 401, 404, 500) with structured error responses.

**Learnings:**
- Next.js 16 Route Handler params are async (Promise) — must `await params` before accessing `id`. This matches the pattern from generateMetadata in US-031.
- `request.nextUrl.searchParams` provides access to URL query parameters via `NextRequest` — use `Object.fromEntries()` to convert to a plain object for Zod parsing.
- `z.coerce.number()` converts string query params to numbers for pagination (page, limit) — necessary because URL params are always strings.
- Existing Zod schemas in `src/types/api/schemas.ts` (BookingDraftSchema, BookingConfirmationSchema) are API response schemas, not request validation schemas — created new input-specific schemas for the route handlers.
- The `online_bookings` table type is defined in `src/services/supabase/types.ts` as `OnlineBookingRow` — the insert object uses snake_case column names matching the database schema.
- Pre-existing typecheck errors (376 in repository/supabase files) unchanged — zero new errors from this story.

**Patterns to sync:** None — Next.js Route Handler patterns are standard Next.js conventions.

**Next story suggestion:** US-036 (Create API route handlers for cart and checkout) — priority 36, Phase 5. Depends only on US-033 (done). Same backend API route pattern as this story. OR US-037 (Auth middleware) — priority 37, same phase. OR US-038 (Vercel deployment) — priority 38, Phase 6.

---

## 2026-01-27 - US-036: Create API route handlers for cart and checkout
Commit: f12e36d

**Why this story?** Highest priority (36) among unblocked stories with all dependencies met (US-033✅). Continues Phase 5 Data Layer work — same backend API route pattern as just-completed US-035. Logical grouping with booking API routes.

**Changes:**
- apps/online-store/src/app/api/cart/route.ts (NEW): Created Next.js Route Handler with:
  - GET handler: Fetches cart for authenticated user from `online_carts` table by store_id and client_id. Returns items and calculated summary (subtotal, tax, shipping, total). Handles empty cart gracefully (PGRST116 = no rows).
  - POST handler: Adds item to cart. Uses upsert to create or update cart. Detects duplicate items — increments quantity for products, skips duplicates for other types. Validates with Zod CartItemSchema matching the CartItem TypeScript interface.
  - PUT handler: Updates item quantity in cart. Validates item exists in cart. Returns updated items and recalculated summary.
  - DELETE handler: Removes item from cart by itemId. Returns updated items and recalculated summary.
- apps/online-store/src/app/api/checkout/route.ts (NEW): Created Next.js Route Handler with:
  - POST handler: Processes checkout order with full server-side validation. Validates all fields via Zod (items, customer info, shipping address, payment method). Calculates totals server-side (never trusts client-calculated totals). Validates promo codes against server-side promo code registry. Generates order number with date prefix (ORD-YYYYMMDD-XXXX). Requires shipping address for physical items. Inserts into `online_orders` table. Clears user's cart after successful order. Returns complete order data with server-calculated totals.
- Both files use Supabase server client from `@/lib/supabase/server`, Zod for all input validation, and return proper HTTP status codes (200, 201, 400, 401, 404, 500) with structured error responses matching the pattern from US-035.

**Learnings:**
- Zod inferred types from schemas with `.optional()` fields make all nested object properties optional at the type level, even when the parent is required. This causes type mismatches when assigning to interfaces with required fields. Solution: use `as CartItemData` cast since Zod validation already guarantees the required fields are present.
- Cart data is stored as a JSON `items` array column in the `online_carts` table — a single row per user per store. This matches the localStorage pattern from CartContext (one cart per user) but persisted server-side.
- Server-side total calculation mirrors CartContext's `getCartTotal()` logic exactly: subtotal with add-ons, promo code discount (percent/fixed/shipping types), tax rate, and shipping threshold. This ensures client and server agree on totals.
- The checkout route validates promo codes against a server-side registry (matching CartContext's PROMO_CODES) — client cannot inject arbitrary discounts.
- `crypto.randomUUID()` is available in Next.js Route Handlers (Node.js 18+) — no need for external UUID library.
- Pre-existing typecheck errors (376 in repository/supabase files) unchanged — zero new errors from this story.

**Patterns to sync:** None — follows established Next.js Route Handler patterns from US-035.

**Next story suggestion:** US-037 (Add Next.js middleware for auth protection) — priority 37, Phase 5. Depends on US-033✅ and US-024✅. Route-level auth protection via middleware. OR US-038 (Configure Vercel deployment) — priority 38, Phase 6, depends only on US-001 (done).

---

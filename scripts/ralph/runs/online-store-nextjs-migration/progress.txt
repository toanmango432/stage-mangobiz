## Codebase Patterns

> Add reusable patterns discovered during implementation here.
> These persist across iterations and help future Ralph runs.

<!-- Add patterns as you discover them -->

### Next.js + Existing src/pages Directory
Next.js 16 requires `app/` and `pages/` directories to be under the same parent folder.
Since `src/pages/` already exists with React components (not Next.js pages), the `app/`
directory must be placed at `src/app/` (not project root `app/`). PRD paths referencing
`apps/online-store/app/` should be read as `apps/online-store/src/app/`.

### Next.js 16 Config Changes
- `eslint` key in next.config.ts is no longer supported (removed in Next.js 16)
- Use `turbopack.root` to set monorepo root and avoid lockfile detection warnings
- `typescript.ignoreBuildErrors` is still supported

---

# Ralph Progress Log

Started: Mon Jan 27 11:13:00 EST 2026
Branch: ralph/online-store-nextjs-migration
Run: online-store-nextjs-migration

---

## 2026-01-27 - US-001: Install Next.js and create next.config.ts
Commit: b11fad3

**Why this story?** First story with no dependencies and highest priority (1). Foundation for all other stories.

**Changes:**
- apps/online-store/package.json: Added next@16.1.5, eslint-config-next@16.1.5; updated scripts (dev→next dev, build→next build, start→next start, typecheck→tsc --noEmit); kept Vite fallbacks (dev:vite, build:vite)
- apps/online-store/next.config.ts (NEW): Created with standalone output, transpilePackages, typescript.ignoreBuildErrors, turbopack.root for monorepo
- apps/online-store/src/app/layout.tsx (NEW): Minimal root layout stub
- apps/online-store/src/app/page.tsx (NEW): Minimal home page stub
- .gitignore: Added .next/ entry
- apps/online-store/next-env.d.ts (NEW): Auto-generated by Next.js
- pnpm-lock.yaml: Updated with new dependencies

**Learnings:**
- Next.js 16 removed `eslint` config key from next.config.ts — use CLI flags or separate eslint config instead
- `app/` directory MUST be under `src/` (not project root) when `src/pages/` exists — Next.js requires both directories under the same parent
- `next build` fails because Next.js treats `src/pages/*.tsx` as Pages Router routes (expected during migration, resolved when pages are migrated)
- `turbopack.root` config silences monorepo lockfile detection warnings
- `next dev` works fine even with src/pages present — only build tries to compile Pages Router routes

**Patterns to sync:**
- Pattern: Next.js src/app placement — When migrating to Next.js with existing src/pages directory, place app/ under src/ to satisfy same-parent requirement

**Next story suggestion:** US-002 (Update TypeScript config for Next.js) — direct dependency on US-001, same config category, completes the TypeScript setup

---

<!--
SESSION SUMMARY TEMPLATE (append when session ends or blocked):

## Session Summary - [Date]

**Completed this session:** [X] stories
**Total progress:** [Y]/[Z] stories ([percent]%)

**Blocked stories:** (if any)
- [US-XXX]: [Reason - e.g., "Missing dependency", "Pre-existing test failure", "PRD unclear"]

**Patterns synced:** [count] new patterns added to patterns.md

**Next session should:**
- Start with: [US-XXX] - [reason]
- Resolve blocker: [description if applicable]

---
-->

## 2026-01-27 - US-002: Update TypeScript config for Next.js
Commit: e7bccf7

**Why this story?** Direct dependency on US-001 (completed), same config category, and the previous session explicitly recommended starting here.

**Changes:**
- apps/online-store/tsconfig.json: Consolidated from project-references pattern (files:[], references:[]) to single primary config. Added: target ES2020, lib, module ESNext, moduleResolution bundler, jsx react-jsx, isolatedModules, esModuleInterop, resolveJsonModule, incremental, next plugin. Include array: src, next-env.d.ts, next.config.ts, .next/types/**/*.ts, .next/dev/types/**/*.ts. Removed project references.
- apps/online-store/tsconfig.app.json: Simplified to extend tsconfig.json, only overrides jsx to react-jsx and includes src/. Kept for Vite fallback compatibility.
- apps/online-store/tsconfig.node.json: Updated to extend tsconfig.json, includes both vite.config.ts and next.config.ts.
- apps/online-store/src/lib/utils/dynamic-imports.ts → dynamic-imports.tsx: Renamed .ts to .tsx since file contains JSX (proper convention).
- apps/online-store/tsconfig.tsbuildinfo (NEW): Generated by incremental compilation.

**Learnings:**
- Next.js 16 auto-corrects `jsx: "preserve"` to `jsx: "react-jsx"` on first run — it uses the React automatic runtime, not the preserve mode that older Next.js versions used
- Next.js also auto-adds `.next/dev/types/**/*.ts` to the include array
- The Vite-era project references pattern (tsconfig.json with `files:[], references:[]`) doesn't work with Next.js — consolidate into a single tsconfig.json
- `.ts` files with JSX need `.tsx` extension regardless of jsx setting — always use proper extensions
- Pre-existing type errors (376 errors across 80+ files) are not related to tsconfig changes — they're existing type mismatches in test files and repositories

**Patterns to sync:**
- Pattern: Next.js 16 jsx setting — Next.js 16 uses `jsx: "react-jsx"` (not `preserve`). It auto-corrects on first `next dev` run.
- Pattern: Consolidated tsconfig for Next.js — Replace Vite's project-references pattern (tsconfig.json + tsconfig.app.json + tsconfig.node.json) with a single tsconfig.json. Keep .app.json and .node.json as extending configs for Vite fallback during migration.

**Next story suggestion:** US-003 (Set up Tailwind CSS and PostCSS for Next.js) — depends only on US-001 (done), same Phase 1 scaffold config work, and US-004 depends on both US-002 and US-003.

---

## Session Summary - 2026-01-27

**Completed this session:** 1 story (US-002)
**Total progress:** 2/49 stories (4%)

**Blocked stories:** None

**Patterns synced:** 2 new patterns to sync to patterns.md (Next.js 16 jsx setting, consolidated tsconfig pattern)

**Next session should:**
- Start with: US-003 - Set up Tailwind CSS and PostCSS for Next.js (unblocks US-004 root layout)
- Key note: All PRD paths referencing `app/` should use `src/app/` instead (documented in Codebase Patterns above)

---

## 2026-01-27 - US-003: Set up Tailwind CSS and PostCSS for Next.js
Commit: 0353841

**Why this story?** Previous session explicitly recommended US-003 next. It unblocks US-004 (root layout) which gates all page migrations. Priority 3, complexity 2, Phase 1 scaffold.

**Changes:**
- apps/online-store/postcss.config.mjs (NEW): Created with tailwindcss and autoprefixer plugins, typed with `@type {import('postcss-load-config').Config}`
- apps/online-store/postcss.config.js (DELETED): Replaced by .mjs for explicit ESM compatibility with Next.js
- apps/online-store/src/app/globals.css (NEW): Imports `../index.css` which contains all Tailwind directives, custom animations, and design system CSS custom properties
- apps/online-store/src/app/layout.tsx: Added `import './globals.css'` to wire up the CSS pipeline

**Learnings:**
- tailwind.config.ts already had `"./src/**/*.{ts,tsx}"` in content array which covers `src/app/` — no modification needed
- The existing `"./app/**/*.{ts,tsx}"` glob (root-level) is harmless — Tailwind silently ignores non-matching paths
- globals.css only needs `@import '../index.css'` — the existing index.css already has all Tailwind directives (`@tailwind base/components/utilities`) and design tokens
- Replacing postcss.config.js with .mjs is cleaner for Next.js ESM compatibility

**Patterns to sync:** None — patterns already documented from prior sessions cover this.

**Next story suggestion:** US-005 (Create navigation compatibility layer) or US-004 (Create root layout with Providers wrapper). US-004 depends on both US-002 and US-003 (now both done), but US-005 only depends on US-001. Both are Phase 1 scaffold. US-005 is needed by US-006 (customer layout) and all page migrations. Recommend US-005 next since it's a standalone utility needed by many downstream stories.

---

## 2026-01-27 - US-004: Create root layout.tsx with Providers wrapper
Commit: 2300c8c

**Why this story?** Higher priority (4) than US-005 (5), all dependencies met (US-002 ✅, US-003 ✅), and it gates the most downstream stories (US-006, US-017, US-024-US-028, and all page migrations via US-006).

**Changes:**
- apps/online-store/src/components/Providers.tsx (NEW): Created 'use client' component wrapping children with ErrorBoundary → QueryClientProvider → AuthProvider → ThemeProvider → WishlistProvider → CartProvider → PersonalizationProvider → NotificationProvider → RealtimeProvider → TooltipProvider. Includes Toaster, Sonner, OfflineIndicator inside the tree.
- apps/online-store/src/app/layout.tsx: Updated from minimal stub to import globals.css and Providers, wrapping {children} with `<Providers>`.

**Learnings:**
- Provider ordering mirrors App.tsx exactly (ErrorBoundary outermost, Auth near top, Cart/Wishlist in middle, TooltipProvider innermost)
- HelmetProvider intentionally omitted — Next.js metadata API replaces it (will be officially removed in US-028)
- OfflineQueue and DemoRibbon not in acceptance criteria — kept Providers focused on the required providers and utility components
- ErrorBoundary is a React class component — works fine with 'use client' since it's imported by a client component

**Patterns to sync:** None new — provider ordering pattern is app-specific.

**Next story suggestion:** US-005 (Create navigation compatibility layer) — only depends on US-001 (done), needed by US-006 (customer layout) which in turn gates all page migrations. Last remaining Phase 1 scaffold story.

---

## 2026-01-27 - US-005: Create navigation compatibility layer
Commit: 3677dd9

**Why this story?** Last remaining Phase 1 scaffold story. Only depends on US-001 (done). Critical blocker for US-006 (customer layout) and US-018 (admin layout), which gate ALL page migrations. Previous session explicitly recommended this next.

**Changes:**
- apps/online-store/src/lib/navigation.ts (NEW): Created 'use client' navigation compatibility module with:
  - Re-exports: Link (next/link), usePathname, useSearchParams, useParams, useAppRouter (next/navigation)
  - useNavigate(): drop-in replacement for react-router-dom's useNavigate, wraps useRouter().push/back/replace
  - Supports navigate(path), navigate(path, {replace: true}), navigate(path, {state: {...}}), navigate(-1)
  - getNavigationState(): retrieves state passed via navigate() using sessionStorage (since Next.js router doesn't support state param)
  - setNavigationState(): stores state in sessionStorage before navigation

**Learnings:**
- react-router-dom's `location.state` has no direct Next.js equivalent — sessionStorage is the cleanest bridge for state transfer between pages during migration
- 21 files in src/ import from react-router-dom — APIs used: Link, useNavigate, useLocation, useParams, useSearchParams
- navigate() is called with `{ state: {...} }` in BookingConfirmation, BookingFlow, BookingSuccess, OrderConfirmation — these pages need getNavigationState() when migrated
- navigate() is called with `{ replace: true }` in BookingFlow — router.replace() handles this
- No navigate(-1) (go back by delta) calls found in codebase, but supported for completeness
- Type definitions self-contained in navigation.ts — separate navigation-types.ts not needed

**Patterns to sync:** None — navigation state via sessionStorage is migration-specific, not a reusable pattern.

**Next story suggestion:** US-006 (Create customer layout with Header and BottomNav) — now unblocked with US-004 ✅ and US-005 ✅. Gates all customer page migrations (US-007 through US-016). Phase 2 begins.

---

## 2026-01-27 - US-006: Create customer layout with Header and BottomNav
Commit: 34475a8

**Why this story?** Highest priority (6) among available stories with all dependencies met (US-004 ✅, US-005 ✅). Gates ALL customer page migrations (US-007 through US-016). Previous session explicitly recommended this as next. Phase 2 begins.

**Changes:**
- apps/online-store/src/app/(customer)/layout.tsx (NEW): Created 'use client' layout component with:
  - AnnouncementBarContainer, Header, BottomNav, ChatButton, ChatDrawer
  - useChatToggle hook for chat open/close state
  - min-h-screen flex-col container with flex-1 main content area
  - Structure exactly mirrors App.tsx customer routes wrapper (lines 117-152)

**Learnings:**
- The (customer) route group directory uses parentheses which need escaping in bash (`\(customer\)`) but not in file paths
- Layout is straightforward — all components already exist and export correctly
- No new patterns discovered — this is a thin layout wrapper matching the existing App.tsx structure

**Patterns to sync:** None — route group layouts are standard Next.js convention.

**Next story suggestion:** US-007 (Migrate home page to app router) — depends on US-006 (just completed), lowest priority among stories now unblocked by US-006. First page migration — establishes the pattern for all subsequent page stories.

---

## 2026-01-27 - US-007: Migrate home page to app router
Commit: 6fd8092

**Why this story?** Highest priority (7) among unblocked stories, depends only on US-006 (just completed). First page migration — establishes the pattern for all subsequent page stories. Previous session explicitly recommended this as next.

**Changes:**
- apps/online-store/src/app/(customer)/page.tsx (NEW): Created 'use client' wrapper component importing Index from '@/pages/Index'
- apps/online-store/src/app/page.tsx (DELETED): Removed root stub page.tsx — home route is now handled by (customer)/page.tsx which maps to / via the route group

**Learnings:**
- Index.tsx has ZERO react-router-dom imports — it only uses SEO, useTemplate, SectionRenderer, LoadingSpinner, PromotionBannerContainer, PromotionsStripContainer. No Link/useNavigate/useLocation usage at all.
- The PRD acceptance criterion "replace react-router-dom Link with next/link" was not needed for this file — navigation links exist in child components (SectionRenderer etc.) which are migrated in US-041/US-042.
- Root `src/app/page.tsx` must be deleted when using route group `(customer)/page.tsx` for `/` — otherwise Next.js has a route conflict since both map to `/`.
- The page migration pattern is simple: 'use client' wrapper in app/ that imports the existing page component from src/pages/.

**Patterns to sync:** None — the page wrapper pattern is documented in the first migration (this story) and reused in all subsequent page stories.

**Next story suggestion:** US-008 (Migrate Login page) — same phase, depends only on US-006 (done), priority 8. OR US-009 (Migrate Book pages) — same dependencies. US-008 is simpler (complexity 2 vs 3) so recommend that first.

---

## 2026-01-27 - US-008: Migrate Login page
Commit: c282281

**Why this story?** Highest priority (8) among unblocked stories with all dependencies met (US-006 ✅). Previous session explicitly recommended this as next. Low complexity (2), continues the page migration pattern from US-007.

**Changes:**
- apps/online-store/src/app/(customer)/login/page.tsx (NEW): Created 'use client' wrapper importing Login from '@/pages/Login'
- apps/online-store/src/pages/Login.tsx:2: Replaced `import { useNavigate } from "react-router-dom"` with `import { useNavigate } from "@/lib/navigation"`

**Learnings:**
- Login.tsx only uses `useNavigate` from react-router-dom — no Link, useLocation, or useSearchParams. Simple single-import swap.
- The navigate() calls on lines 38, 53, 83 all use `navigate("/")` (simple path navigation) — fully compatible with the compat layer's useNavigate() wrapper.
- No Link component usage in Login.tsx — navigation links (if any) are in child components like ForgotPasswordDialog.
- Pre-existing typecheck errors (376+ errors in repository/supabase files) are unrelated to this migration — documented in US-002 progress.

**Patterns to sync:** None — follows established page migration pattern from US-007.

**Next story suggestion:** US-009 (Migrate Book pages) — priority 9, depends only on US-006 (done). Three pages in one story (book, confirmation, success) forming a sequential flow. OR US-010 (Booking module, complexity 1) for a simpler next story.

---

## 2026-01-27 - US-009: Migrate Book pages (book, confirmation, success)
Commit: 72c2673

**Why this story?** Highest priority (9) among unblocked stories. Previous session explicitly recommended this next. Three pages forming a sequential booking flow — efficient to migrate together.

**Changes:**
- apps/online-store/src/app/(customer)/book/page.tsx (NEW): Created 'use client' wrapper importing BookingFlowSimple from '@/pages/BookingFlowSimple'
- apps/online-store/src/app/(customer)/book/confirmation/page.tsx (NEW): Created 'use client' wrapper importing BookingConfirmation from '@/pages/BookingConfirmation'
- apps/online-store/src/app/(customer)/book/success/page.tsx (NEW): Created 'use client' wrapper importing BookingSuccess from '@/pages/BookingSuccess'
- apps/online-store/src/pages/BookingFlowSimple.tsx:2: Replaced `import { useNavigate } from 'react-router-dom'` with `import { useNavigate } from '@/lib/navigation'`
- apps/online-store/src/pages/BookingConfirmation.tsx:2: Replaced `import { useNavigate, useLocation } from 'react-router-dom'` with `import { useNavigate, getNavigationState } from '@/lib/navigation'`. Replaced `location.state?.bookingData` with `getNavigationState()` using useState lazy initializer.
- apps/online-store/src/pages/BookingSuccess.tsx:1-2: Added `useState` to React imports. Replaced `import { useLocation, useNavigate } from 'react-router-dom'` with `import { useNavigate, getNavigationState } from '@/lib/navigation'`. Replaced `location.state?.booking` with `getNavigationState()` using useState lazy initializer.

**Learnings:**
- BookingFlowSimple.tsx uses useNavigate but NOT useLocation — it manages its own internal step state ('booking' | 'confirm' | 'success') and doesn't actually navigate to /book/confirmation or /book/success. The navigate import is declared but only used at the top level (line 17), not actively called for navigation between steps.
- BookingConfirmation.tsx uses both useNavigate AND useLocation.state for receiving booking data. The `getNavigationState()` from the compat layer replaces `location.state` — must be read once via useState lazy initializer to avoid clearing sessionStorage on re-renders.
- BookingSuccess.tsx similarly receives `location.state?.booking` — same getNavigationState() pattern with useState lazy init.
- The `navigate('/book/success', { state: { booking: ... } })` call in BookingConfirmation.tsx works via the compat layer's setNavigationState() which stores in sessionStorage before router.push.
- Pre-existing `__MODE__` TypeScript error in BookingSuccess.tsx:198 — this is a Vite define variable, not related to migration.

**Patterns to sync:** None — getNavigationState() with useState lazy initializer pattern was already documented in US-005.

**Next story suggestion:** US-010 (Migrate Booking module page) — priority 10, complexity 1 (simplest remaining), depends only on US-006 (done). OR US-011 (Shop/ProductDetail, complexity 3) for the first dynamic route migration.

---

## 2026-01-27 - US-010: Migrate Booking module page
Commit: 39b8df5

**Why this story?** Highest priority (10) among unblocked stories. Previous session explicitly recommended this next. Simplest complexity (1) — quick win before tackling more complex page migrations.

**Changes:**
- apps/online-store/src/app/(customer)/booking/page.tsx (NEW): Created 'use client' wrapper importing BookingPage from '@/features/booking'
- apps/online-store/src/features/booking/pages/BookingConfirmation.tsx:2: Replaced `import { useNavigate } from 'react-router-dom'` with `import { useNavigate } from '@/lib/navigation'`

**Learnings:**
- BookingPage.tsx (the main page component) has ZERO react-router-dom imports — it manages multi-step booking flow entirely via Redux state (selectCurrentStep), rendering different step components internally.
- BookingConfirmation.tsx (inside features/booking/) uses useNavigate for "Book Another" and "Back to Home" buttons — simple navigate() calls to paths, fully compatible with the compat layer.
- The features/booking module does NOT have its own router (as PRD notes suggested to check) — it uses Redux-driven step rendering, not URL-based routing.
- This is distinct from the src/pages/BookingConfirmation.tsx (US-009) — features/booking has its own BookingConfirmation component at a different path.

**Patterns to sync:** None — follows established page migration pattern.

**Next story suggestion:** US-011 (Migrate Shop and ProductDetail pages) — priority 11, depends only on US-006 (done). First dynamic route migration with [productId] segment. OR US-012 (Cart/Checkout) or US-013 (OrderConfirmation/Memberships/GiftCards) — all simpler but lower priority.

---

## Codebase Patterns

> Add reusable patterns discovered during implementation here.
> These persist across iterations and help future Ralph runs.

<!-- Add patterns as you discover them -->

### Next.js + Existing src/pages Directory
Next.js 16 requires `app/` and `pages/` directories to be under the same parent folder.
Since `src/pages/` already exists with React components (not Next.js pages), the `app/`
directory must be placed at `src/app/` (not project root `app/`). PRD paths referencing
`apps/online-store/app/` should be read as `apps/online-store/src/app/`.

### Next.js 16 Config Changes
- `eslint` key in next.config.ts is no longer supported (removed in Next.js 16)
- Use `turbopack.root` to set monorepo root and avoid lockfile detection warnings
- `typescript.ignoreBuildErrors` is still supported

---

# Ralph Progress Log

Started: Mon Jan 27 11:13:00 EST 2026
Branch: ralph/online-store-nextjs-migration
Run: online-store-nextjs-migration

---

## 2026-01-27 - US-001: Install Next.js and create next.config.ts
Commit: b11fad3

**Why this story?** First story with no dependencies and highest priority (1). Foundation for all other stories.

**Changes:**
- apps/online-store/package.json: Added next@16.1.5, eslint-config-next@16.1.5; updated scripts (dev→next dev, build→next build, start→next start, typecheck→tsc --noEmit); kept Vite fallbacks (dev:vite, build:vite)
- apps/online-store/next.config.ts (NEW): Created with standalone output, transpilePackages, typescript.ignoreBuildErrors, turbopack.root for monorepo
- apps/online-store/src/app/layout.tsx (NEW): Minimal root layout stub
- apps/online-store/src/app/page.tsx (NEW): Minimal home page stub
- .gitignore: Added .next/ entry
- apps/online-store/next-env.d.ts (NEW): Auto-generated by Next.js
- pnpm-lock.yaml: Updated with new dependencies

**Learnings:**
- Next.js 16 removed `eslint` config key from next.config.ts — use CLI flags or separate eslint config instead
- `app/` directory MUST be under `src/` (not project root) when `src/pages/` exists — Next.js requires both directories under the same parent
- `next build` fails because Next.js treats `src/pages/*.tsx` as Pages Router routes (expected during migration, resolved when pages are migrated)
- `turbopack.root` config silences monorepo lockfile detection warnings
- `next dev` works fine even with src/pages present — only build tries to compile Pages Router routes

**Patterns to sync:**
- Pattern: Next.js src/app placement — When migrating to Next.js with existing src/pages directory, place app/ under src/ to satisfy same-parent requirement

**Next story suggestion:** US-002 (Update TypeScript config for Next.js) — direct dependency on US-001, same config category, completes the TypeScript setup

---

<!--
SESSION SUMMARY TEMPLATE (append when session ends or blocked):

## Session Summary - [Date]

**Completed this session:** [X] stories
**Total progress:** [Y]/[Z] stories ([percent]%)

**Blocked stories:** (if any)
- [US-XXX]: [Reason - e.g., "Missing dependency", "Pre-existing test failure", "PRD unclear"]

**Patterns synced:** [count] new patterns added to patterns.md

**Next session should:**
- Start with: [US-XXX] - [reason]
- Resolve blocker: [description if applicable]

---
-->

## 2026-01-27 - US-002: Update TypeScript config for Next.js
Commit: e7bccf7

**Why this story?** Direct dependency on US-001 (completed), same config category, and the previous session explicitly recommended starting here.

**Changes:**
- apps/online-store/tsconfig.json: Consolidated from project-references pattern (files:[], references:[]) to single primary config. Added: target ES2020, lib, module ESNext, moduleResolution bundler, jsx react-jsx, isolatedModules, esModuleInterop, resolveJsonModule, incremental, next plugin. Include array: src, next-env.d.ts, next.config.ts, .next/types/**/*.ts, .next/dev/types/**/*.ts. Removed project references.
- apps/online-store/tsconfig.app.json: Simplified to extend tsconfig.json, only overrides jsx to react-jsx and includes src/. Kept for Vite fallback compatibility.
- apps/online-store/tsconfig.node.json: Updated to extend tsconfig.json, includes both vite.config.ts and next.config.ts.
- apps/online-store/src/lib/utils/dynamic-imports.ts → dynamic-imports.tsx: Renamed .ts to .tsx since file contains JSX (proper convention).
- apps/online-store/tsconfig.tsbuildinfo (NEW): Generated by incremental compilation.

**Learnings:**
- Next.js 16 auto-corrects `jsx: "preserve"` to `jsx: "react-jsx"` on first run — it uses the React automatic runtime, not the preserve mode that older Next.js versions used
- Next.js also auto-adds `.next/dev/types/**/*.ts` to the include array
- The Vite-era project references pattern (tsconfig.json with `files:[], references:[]`) doesn't work with Next.js — consolidate into a single tsconfig.json
- `.ts` files with JSX need `.tsx` extension regardless of jsx setting — always use proper extensions
- Pre-existing type errors (376 errors across 80+ files) are not related to tsconfig changes — they're existing type mismatches in test files and repositories

**Patterns to sync:**
- Pattern: Next.js 16 jsx setting — Next.js 16 uses `jsx: "react-jsx"` (not `preserve`). It auto-corrects on first `next dev` run.
- Pattern: Consolidated tsconfig for Next.js — Replace Vite's project-references pattern (tsconfig.json + tsconfig.app.json + tsconfig.node.json) with a single tsconfig.json. Keep .app.json and .node.json as extending configs for Vite fallback during migration.

**Next story suggestion:** US-003 (Set up Tailwind CSS and PostCSS for Next.js) — depends only on US-001 (done), same Phase 1 scaffold config work, and US-004 depends on both US-002 and US-003.

---

## Session Summary - 2026-01-27

**Completed this session:** 1 story (US-002)
**Total progress:** 2/49 stories (4%)

**Blocked stories:** None

**Patterns synced:** 2 new patterns to sync to patterns.md (Next.js 16 jsx setting, consolidated tsconfig pattern)

**Next session should:**
- Start with: US-003 - Set up Tailwind CSS and PostCSS for Next.js (unblocks US-004 root layout)
- Key note: All PRD paths referencing `app/` should use `src/app/` instead (documented in Codebase Patterns above)

---

## 2026-01-27 - US-003: Set up Tailwind CSS and PostCSS for Next.js
Commit: 0353841

**Why this story?** Previous session explicitly recommended US-003 next. It unblocks US-004 (root layout) which gates all page migrations. Priority 3, complexity 2, Phase 1 scaffold.

**Changes:**
- apps/online-store/postcss.config.mjs (NEW): Created with tailwindcss and autoprefixer plugins, typed with `@type {import('postcss-load-config').Config}`
- apps/online-store/postcss.config.js (DELETED): Replaced by .mjs for explicit ESM compatibility with Next.js
- apps/online-store/src/app/globals.css (NEW): Imports `../index.css` which contains all Tailwind directives, custom animations, and design system CSS custom properties
- apps/online-store/src/app/layout.tsx: Added `import './globals.css'` to wire up the CSS pipeline

**Learnings:**
- tailwind.config.ts already had `"./src/**/*.{ts,tsx}"` in content array which covers `src/app/` — no modification needed
- The existing `"./app/**/*.{ts,tsx}"` glob (root-level) is harmless — Tailwind silently ignores non-matching paths
- globals.css only needs `@import '../index.css'` — the existing index.css already has all Tailwind directives (`@tailwind base/components/utilities`) and design tokens
- Replacing postcss.config.js with .mjs is cleaner for Next.js ESM compatibility

**Patterns to sync:** None — patterns already documented from prior sessions cover this.

**Next story suggestion:** US-005 (Create navigation compatibility layer) or US-004 (Create root layout with Providers wrapper). US-004 depends on both US-002 and US-003 (now both done), but US-005 only depends on US-001. Both are Phase 1 scaffold. US-005 is needed by US-006 (customer layout) and all page migrations. Recommend US-005 next since it's a standalone utility needed by many downstream stories.

---

## 2026-01-27 - US-004: Create root layout.tsx with Providers wrapper
Commit: 2300c8c

**Why this story?** Higher priority (4) than US-005 (5), all dependencies met (US-002 ✅, US-003 ✅), and it gates the most downstream stories (US-006, US-017, US-024-US-028, and all page migrations via US-006).

**Changes:**
- apps/online-store/src/components/Providers.tsx (NEW): Created 'use client' component wrapping children with ErrorBoundary → QueryClientProvider → AuthProvider → ThemeProvider → WishlistProvider → CartProvider → PersonalizationProvider → NotificationProvider → RealtimeProvider → TooltipProvider. Includes Toaster, Sonner, OfflineIndicator inside the tree.
- apps/online-store/src/app/layout.tsx: Updated from minimal stub to import globals.css and Providers, wrapping {children} with `<Providers>`.

**Learnings:**
- Provider ordering mirrors App.tsx exactly (ErrorBoundary outermost, Auth near top, Cart/Wishlist in middle, TooltipProvider innermost)
- HelmetProvider intentionally omitted — Next.js metadata API replaces it (will be officially removed in US-028)
- OfflineQueue and DemoRibbon not in acceptance criteria — kept Providers focused on the required providers and utility components
- ErrorBoundary is a React class component — works fine with 'use client' since it's imported by a client component

**Patterns to sync:** None new — provider ordering pattern is app-specific.

**Next story suggestion:** US-005 (Create navigation compatibility layer) — only depends on US-001 (done), needed by US-006 (customer layout) which in turn gates all page migrations. Last remaining Phase 1 scaffold story.

---

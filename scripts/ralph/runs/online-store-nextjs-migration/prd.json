{
  "project": "Mango Online Store - Next.js Migration",
  "branchName": "ralph/online-store-nextjs-migration",
  "description": "Migrate apps/online-store from Vite React SPA (react-router-dom) to Next.js App Router. Keep all existing React components in src/ \u2014 create thin app/ page wrappers that import them. Replace react-router-dom with next/navigation, react-helmet-async with Next.js metadata API, and configure Vercel deployment. The online store is mostly UI shells with mock data (only 13 files touch Supabase), making this the ideal time to switch before real API integration begins.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Install Next.js and create next.config.ts",
      "description": "As a developer, I want Next.js installed and configured so the project can use App Router alongside the existing src/ code.",
      "acceptanceCriteria": [
        "pnpm add next@latest eslint-config-next in apps/online-store",
        "Create next.config.ts with: transpilePackages for monorepo, path alias '@' \u2192 './src', output 'standalone' (optional)",
        "Update package.json scripts: dev \u2192 'next dev --port 3001', build \u2192 'next build', start \u2192 'next start'",
        "Keep Vite scripts as fallbacks: dev:vite \u2192 'vite --port 3001', build:vite \u2192 'vite build' (do NOT remove Vite deps yet \u2014 that's US-043)",
        "Add .next/ to .gitignore",
        "next dev --port 3001 starts without crashing",
        "pnpm run typecheck passes (or next build --no-lint completes without crash)"
      ],
      "priority": 1,
      "passes": true,
      "phase": "Phase 1: Scaffold",
      "files": [
        "apps/online-store/package.json",
        "apps/online-store/next.config.ts",
        ".gitignore",
        "apps/online-store/.eslintrc.json"
      ],
      "notes": "Do NOT remove Vite plugins or dependencies in this story. Keep both build systems working during migration. Vite removal happens in US-043/US-044. Do NOT enable experimental.typedRoutes \u2014 causes noise during migration.",
      "category": "config",
      "complexity": 2,
      "dependencies": [],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-002",
      "title": "Update TypeScript config for Next.js",
      "description": "As a developer, I want tsconfig.json updated for Next.js so TypeScript resolves app/ directory types and Next.js module types correctly.",
      "acceptanceCriteria": [
        "Update tsconfig.json compilerOptions: jsx \u2192 'preserve', module \u2192 'esnext', moduleResolution \u2192 'bundler', add 'next-env' to types array",
        "Add 'next-env.d.ts' to include array or create it",
        "Keep existing path alias '@/*' \u2192 ['./src/*']",
        "Add 'app' directory to include if needed",
        "Remove or update tsconfig.app.json and tsconfig.node.json for Next.js compatibility",
        "pnpm run typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "phase": "Phase 1: Scaffold",
      "files": [
        "apps/online-store/tsconfig.json",
        "apps/online-store/tsconfig.app.json",
        "apps/online-store/tsconfig.node.json",
        "apps/online-store/next-env.d.ts"
      ],
      "notes": "next-env.d.ts is auto-generated by Next.js on first run. Just ensure it's in .gitignore or include array.",
      "category": "config",
      "complexity": 2,
      "dependencies": [
        "US-001"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-003",
      "title": "Set up Tailwind CSS and PostCSS for Next.js",
      "description": "As a developer, I want Tailwind CSS working with Next.js so all existing styles render correctly.",
      "acceptanceCriteria": [
        "Create postcss.config.mjs with tailwindcss and autoprefixer plugins",
        "Update tailwind.config.ts content array to include './app/**/*.{ts,tsx}' alongside existing './src/**/*.{ts,tsx}'",
        "Create app/globals.css that imports Tailwind base/components/utilities and existing CSS custom properties from src/index.css",
        "Existing Tailwind classes render correctly in browser",
        "pnpm run typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "phase": "Phase 1: Scaffold",
      "files": [
        "apps/online-store/postcss.config.mjs",
        "apps/online-store/tailwind.config.ts",
        "apps/online-store/app/globals.css"
      ],
      "notes": "Ensure postcss.config uses .mjs extension for ESM compatibility with Next.js.",
      "category": "config",
      "complexity": 2,
      "dependencies": [
        "US-001"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-004",
      "title": "Create root layout.tsx with Providers wrapper",
      "description": "As a developer, I want a root layout that wraps the entire app with all existing context providers so every page has access to auth, theme, cart, etc.",
      "acceptanceCriteria": [
        "Create app/layout.tsx with html and body tags, import globals.css",
        "Create src/components/Providers.tsx as 'use client' component",
        "Providers.tsx wraps children with: QueryClientProvider, AuthProvider, ThemeProvider, WishlistProvider, CartProvider, PersonalizationProvider, NotificationProvider, RealtimeProvider, TooltipProvider",
        "Include Toaster, Sonner, OfflineIndicator components inside Providers",
        "app/layout.tsx imports and renders Providers around {children}",
        "pnpm run typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "phase": "Phase 1: Scaffold",
      "files": [
        "apps/online-store/app/layout.tsx",
        "apps/online-store/src/components/Providers.tsx"
      ],
      "notes": "Provider ordering matters. Auth must wrap everything. Theme should be near the top. Cart/Wishlist can be lower.",
      "category": "config",
      "complexity": 3,
      "dependencies": [
        "US-002",
        "US-003"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-005",
      "title": "Create navigation compatibility layer",
      "description": "As a developer, I want a navigation compatibility module that maps react-router-dom APIs to Next.js equivalents so page migrations require minimal changes.",
      "acceptanceCriteria": [
        "Create src/lib/navigation.ts with 'use client' directive",
        "Export Link component from next/link",
        "Export usePathname, useSearchParams, useParams from next/navigation",
        "Export useNavigate function that wraps useRouter().push/back for backwards compatibility with react-router-dom's navigate(path) / navigate(-1) pattern",
        "Export useAppRouter that returns next/navigation's useRouter",
        "Create src/lib/navigation-types.ts with type definitions if needed",
        "pnpm run typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "phase": "Phase 1: Scaffold",
      "files": [
        "apps/online-store/src/lib/navigation.ts"
      ],
      "notes": "This is a TRANSITIONAL compatibility layer. It will be removed in US-044 after all components are migrated to use next/link and next/navigation directly. Purpose: minimize changes per page migration story.",
      "category": "config",
      "complexity": 3,
      "dependencies": [
        "US-001"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-006",
      "title": "Create customer layout with Header and BottomNav",
      "description": "As a customer, I want the header, bottom nav, announcement bar, and chat to appear on all customer-facing pages via a shared layout.",
      "acceptanceCriteria": [
        "Create app/(customer)/layout.tsx as 'use client' component",
        "Import and render AnnouncementBarContainer, Header, BottomNav, ChatButton, ChatDrawer",
        "Use useChatToggle hook for chat open/close state",
        "Main content area uses flex-1 in a min-h-screen flex-col container",
        "Layout matches the structure in current App.tsx customer routes wrapper",
        "pnpm run typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/layout.tsx"
      ],
      "notes": "Match the route group naming to (customer) for clarity. This layout wraps ALL customer-facing pages but NOT admin pages.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-004",
        "US-005"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-007",
      "title": "Migrate home page to app router",
      "description": "As a customer, I want the home page to load at / via Next.js App Router.",
      "acceptanceCriteria": [
        "Create app/(customer)/page.tsx as 'use client' wrapper importing Index from '@/pages/Index'",
        "Update src/pages/Index.tsx: replace react-router-dom Link with next/link, change 'to' prop to 'href'",
        "Home page renders correctly at localhost:3001/",
        "All navigation links on home page work",
        "pnpm run typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/page.tsx",
        "apps/online-store/src/pages/Index.tsx"
      ],
      "notes": "This is the first page migration \u2014 establishes the pattern for all subsequent page stories.",
      "category": "frontend",
      "complexity": 1,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-008",
      "title": "Migrate Login page",
      "description": "As a customer, I want the login page to work at /login via Next.js App Router.",
      "acceptanceCriteria": [
        "Create app/(customer)/login/page.tsx as 'use client' wrapper importing Login from '@/pages/Login'",
        "Update src/pages/Login.tsx: replace useNavigate with useNavigate from '@/lib/navigation', replace Link imports",
        "Login page renders at /login",
        "Navigation after login works (redirect to home or previous page)",
        "pnpm run typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/login/page.tsx",
        "apps/online-store/src/pages/Login.tsx"
      ],
      "notes": "Login page has navigation side effects (redirect after auth). Test the full flow, not just rendering.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-009",
      "title": "Migrate Book pages (book, confirmation, success)",
      "description": "As a customer, I want booking flow pages to work at /book, /book/confirmation, and /book/success.",
      "acceptanceCriteria": [
        "Create app/(customer)/book/page.tsx importing BookingFlowSimple",
        "Create app/(customer)/book/confirmation/page.tsx importing BookingConfirmation",
        "Create app/(customer)/book/success/page.tsx importing BookingSuccess",
        "Update BookingFlowSimple.tsx: replace react-router-dom with navigation compat layer",
        "Update BookingConfirmation.tsx: replace useNavigate, useLocation, Link",
        "Update BookingSuccess.tsx: replace useNavigate, useLocation, Link",
        "All three pages render correctly at their routes",
        "Navigation between book \u2192 confirmation \u2192 success works",
        "pnpm run typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/book/page.tsx",
        "apps/online-store/app/(customer)/book/confirmation/page.tsx",
        "apps/online-store/app/(customer)/book/success/page.tsx",
        "apps/online-store/src/pages/BookingFlowSimple.tsx",
        "apps/online-store/src/pages/BookingConfirmation.tsx",
        "apps/online-store/src/pages/BookingSuccess.tsx"
      ],
      "notes": "Three pages in one story because they form a sequential flow. Test the full book\u2192confirmation\u2192success path.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-010",
      "title": "Migrate Booking module page",
      "description": "As a customer, I want the new booking module (features/booking) to work at /booking.",
      "acceptanceCriteria": [
        "Create app/(customer)/booking/page.tsx importing BookingPage from '@/features/booking'",
        "Update features/booking/pages/BookingConfirmation.tsx if it uses react-router-dom",
        "Booking page renders at /booking",
        "pnpm run typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/booking/page.tsx",
        "apps/online-store/src/features/booking/pages/BookingConfirmation.tsx"
      ],
      "notes": "Check if features/booking has its own router \u2014 may need additional compat work.",
      "category": "frontend",
      "complexity": 1,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-011",
      "title": "Migrate Shop and ProductDetail pages",
      "description": "As a customer, I want to browse the shop at /shop and view products at /shop/[productId].",
      "acceptanceCriteria": [
        "Create app/(customer)/shop/page.tsx importing Shop from '@/pages/Shop'",
        "Create app/(customer)/shop/[productId]/page.tsx importing ProductDetail from '@/pages/ProductDetail'",
        "Update Shop.tsx: replace react-router-dom Link and useSearchParams with next/navigation equivalents",
        "Update ProductDetail.tsx: replace useParams, useNavigate, Link with next/navigation equivalents",
        "Shop listing page renders at /shop",
        "Product detail page renders at /shop/some-product-id with correct param extraction",
        "pnpm run typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/shop/page.tsx",
        "apps/online-store/app/(customer)/shop/[productId]/page.tsx",
        "apps/online-store/src/pages/Shop.tsx",
        "apps/online-store/src/pages/ProductDetail.tsx"
      ],
      "notes": "Dynamic route [productId] is the first dynamic segment \u2014 verify params extraction works correctly.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-012",
      "title": "Migrate Cart and Checkout pages",
      "description": "As a customer, I want cart at /cart and checkout at /checkout to work via Next.js.",
      "acceptanceCriteria": [
        "Create app/(customer)/cart/page.tsx importing Cart from '@/pages/Cart'",
        "Create app/(customer)/checkout/page.tsx importing Checkout from '@/pages/Checkout'",
        "Update Cart.tsx: replace react-router-dom with navigation compat",
        "Update Checkout.tsx: replace useNavigate, Link with next/navigation equivalents",
        "Cart page renders at /cart with correct items",
        "Checkout page renders at /checkout",
        "Navigation between cart \u2192 checkout works",
        "pnpm run typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/cart/page.tsx",
        "apps/online-store/app/(customer)/checkout/page.tsx",
        "apps/online-store/src/pages/Cart.tsx",
        "apps/online-store/src/pages/Checkout.tsx"
      ],
      "notes": "Cart and checkout have state dependencies. Verify cart context is accessible in both pages.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-013",
      "title": "Migrate OrderConfirmation, Memberships, GiftCards pages",
      "description": "As a customer, I want order confirmation, memberships, and gift cards pages available via Next.js routes.",
      "acceptanceCriteria": [
        "Create app/(customer)/order-confirmation/page.tsx importing OrderConfirmation",
        "Create app/(customer)/memberships/page.tsx importing Memberships",
        "Create app/(customer)/gift-cards/page.tsx importing GiftCards",
        "Update OrderConfirmation.tsx: replace useNavigate, useLocation, Link",
        "Update Memberships.tsx: replace Link and useNavigate",
        "Update GiftCards.tsx: replace Link and useNavigate",
        "All three pages render correctly at their routes",
        "pnpm run typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/order-confirmation/page.tsx",
        "apps/online-store/app/(customer)/memberships/page.tsx",
        "apps/online-store/app/(customer)/gift-cards/page.tsx",
        "apps/online-store/src/pages/OrderConfirmation.tsx",
        "apps/online-store/src/pages/Memberships.tsx",
        "apps/online-store/src/pages/GiftCards.tsx"
      ],
      "notes": "Three independent pages bundled. Each is straightforward \u2014 mostly Link swaps.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-014",
      "title": "Migrate Account page",
      "description": "As a customer, I want my account dashboard available at /account.",
      "acceptanceCriteria": [
        "Create app/(customer)/account/page.tsx importing Account from '@/pages/Account'",
        "Update Account.tsx: replace react-router-dom useNavigate, useSearchParams with next/navigation",
        "Account page renders at /account with all tabs working",
        "Tab switching updates URL search params correctly",
        "pnpm run typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/account/page.tsx",
        "apps/online-store/src/pages/Account.tsx"
      ],
      "notes": "Account page likely uses URL search params for tab state. Verify useSearchParams works with Next.js.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-015",
      "title": "Migrate Info pages (about, contact, gallery, reviews, faq, policies)",
      "description": "As a customer, I want all informational pages available under /info/*.",
      "acceptanceCriteria": [
        "Create app/(customer)/info/about/page.tsx importing About",
        "Create app/(customer)/info/contact/page.tsx importing Contact",
        "Create app/(customer)/info/gallery/page.tsx importing Gallery",
        "Create app/(customer)/info/reviews/page.tsx importing Reviews",
        "Create app/(customer)/info/faq/page.tsx importing FAQ",
        "Create app/(customer)/info/policies/page.tsx importing Policies",
        "All six pages render correctly at /info/* routes",
        "These pages have minimal router usage \u2014 update any Link imports to next/link",
        "pnpm run typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/info/about/page.tsx",
        "apps/online-store/app/(customer)/info/contact/page.tsx",
        "apps/online-store/app/(customer)/info/gallery/page.tsx",
        "apps/online-store/app/(customer)/info/reviews/page.tsx",
        "apps/online-store/app/(customer)/info/faq/page.tsx",
        "apps/online-store/app/(customer)/info/policies/page.tsx",
        "apps/online-store/src/pages/info/About.tsx",
        "apps/online-store/src/pages/info/Contact.tsx",
        "apps/online-store/src/pages/info/Gallery.tsx",
        "apps/online-store/src/pages/info/Reviews.tsx",
        "apps/online-store/src/pages/info/FAQ.tsx",
        "apps/online-store/src/pages/info/Policies.tsx"
      ],
      "notes": "Six simple pages. All are mostly static content with minimal router usage.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-016",
      "title": "Migrate Legal, Promotions, Updates pages",
      "description": "As a customer, I want legal pages at /legal/*, promotions at /promotions, and updates at /updates.",
      "acceptanceCriteria": [
        "Create app/(customer)/legal/privacy/page.tsx importing PrivacyPolicy",
        "Create app/(customer)/legal/terms/page.tsx importing TermsOfService",
        "Create app/(customer)/legal/accessibility/page.tsx importing Accessibility",
        "Create app/(customer)/promotions/page.tsx importing Promotions",
        "Create app/(customer)/updates/page.tsx importing Updates",
        "All five pages render correctly at their routes",
        "Update any react-router-dom imports in these page files",
        "pnpm run typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/(customer)/legal/privacy/page.tsx",
        "apps/online-store/app/(customer)/legal/terms/page.tsx",
        "apps/online-store/app/(customer)/legal/accessibility/page.tsx",
        "apps/online-store/app/(customer)/promotions/page.tsx",
        "apps/online-store/app/(customer)/updates/page.tsx",
        "apps/online-store/src/pages/Promotions.tsx",
        "apps/online-store/src/pages/Updates.tsx",
        "apps/online-store/src/pages/legal/PrivacyPolicy.tsx",
        "apps/online-store/src/pages/legal/TermsOfService.tsx",
        "apps/online-store/src/pages/legal/Accessibility.tsx"
      ],
      "notes": "Five simple pages. Legal pages are typically static \u2014 minimal router dependencies.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-006"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-017",
      "title": "Create not-found, error, loading, and offline pages",
      "description": "As a user, I want proper 404, error boundary, loading skeleton, and offline pages in the Next.js app.",
      "acceptanceCriteria": [
        "Create app/not-found.tsx migrating content from src/pages/NotFound.tsx",
        "Create app/error.tsx as 'use client' error boundary component with reset button",
        "Create app/loading.tsx with a loading skeleton/spinner",
        "Create app/offline/page.tsx importing Offline from '@/pages/Offline'",
        "Update NotFound.tsx and Offline.tsx to remove react-router-dom usage",
        "404 page shows for unknown routes",
        "pnpm run typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/not-found.tsx",
        "apps/online-store/app/error.tsx",
        "apps/online-store/app/loading.tsx",
        "apps/online-store/app/offline/page.tsx",
        "apps/online-store/src/pages/NotFound.tsx",
        "apps/online-store/src/pages/Offline.tsx"
      ],
      "notes": "Next.js has special file conventions: not-found.tsx, error.tsx, loading.tsx. Follow them exactly.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-018",
      "title": "Create admin layout with ProtectedRoute",
      "description": "As an admin, I want the admin section at /admin/* wrapped with authentication protection and the admin sidebar layout.",
      "acceptanceCriteria": [
        "Create app/admin/layout.tsx as 'use client' component",
        "Wrap children with ProtectedRoute (requireAdmin) and AdminLayout",
        "Update AdminLayout.tsx: replace react-router-dom useLocation with usePathname from next/navigation",
        "Update AdminLayout.tsx: replace Link imports with next/link",
        "Admin layout renders sidebar navigation correctly",
        "Unauthenticated users are redirected to login",
        "pnpm run typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/admin/layout.tsx",
        "apps/online-store/src/components/admin/AdminLayout.tsx",
        "apps/online-store/src/components/ProtectedRoute.tsx"
      ],
      "notes": "",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-004",
        "US-005"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-019",
      "title": "Migrate admin Dashboard and Storefront overview",
      "description": "As an admin, I want the dashboard at /admin and storefront overview at /admin/storefront.",
      "acceptanceCriteria": [
        "Create app/admin/page.tsx importing AdminDashboard",
        "Create app/admin/storefront/page.tsx importing AdminStorefront",
        "Update Dashboard.tsx and Storefront.tsx: replace any react-router-dom usage",
        "Both pages render correctly at their routes",
        "pnpm run typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/admin/page.tsx",
        "apps/online-store/app/admin/storefront/page.tsx",
        "apps/online-store/src/pages/admin/Dashboard.tsx",
        "apps/online-store/src/pages/admin/Storefront.tsx"
      ],
      "notes": "Dashboard and Storefront overview are the two most-used admin pages. Test thoroughly.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-018"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-020",
      "title": "Migrate admin Storefront sub-pages (theme, media, navigation, promotions, announcements)",
      "description": "As an admin, I want storefront management sub-pages available under /admin/storefront/*.",
      "acceptanceCriteria": [
        "Create app/admin/storefront/theme/page.tsx importing AdminTheme",
        "Create app/admin/storefront/media/page.tsx importing AdminMedia",
        "Create app/admin/storefront/navigation/page.tsx importing AdminNavigation",
        "Create app/admin/storefront/promotions/page.tsx importing AdminPromotions",
        "Create app/admin/storefront/announcements/page.tsx importing AdminAnnouncements",
        "Update each page file to replace react-router-dom usage if present",
        "All five pages render correctly",
        "pnpm run typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/admin/storefront/theme/page.tsx",
        "apps/online-store/app/admin/storefront/media/page.tsx",
        "apps/online-store/app/admin/storefront/navigation/page.tsx",
        "apps/online-store/app/admin/storefront/promotions/page.tsx",
        "apps/online-store/app/admin/storefront/announcements/page.tsx",
        "apps/online-store/src/pages/admin/storefront/Theme.tsx",
        "apps/online-store/src/pages/admin/storefront/Media.tsx",
        "apps/online-store/src/pages/admin/storefront/Navigation.tsx",
        "apps/online-store/src/pages/admin/storefront/Promotions.tsx",
        "apps/online-store/src/pages/admin/storefront/Announcements.tsx"
      ],
      "notes": "Five admin sub-pages. Each should be a thin wrapper importing the existing component.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-018"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-021",
      "title": "Migrate admin Storefront sub-pages (content-builder, ab-tests, ai-copywriter, seo, templates)",
      "description": "As an admin, I want remaining storefront tools available under /admin/storefront/*.",
      "acceptanceCriteria": [
        "Create app/admin/storefront/content-builder/page.tsx importing AdminContentBuilder",
        "Create app/admin/storefront/ab-tests/page.tsx importing AdminABTests",
        "Create app/admin/storefront/ai-copywriter/page.tsx importing AdminAICopywriter (CopywriterPanel)",
        "Create app/admin/storefront/seo/page.tsx importing AdminSEO",
        "Create app/admin/storefront/templates/page.tsx importing AdminTemplates",
        "All five pages render correctly at their routes",
        "pnpm run typecheck passes"
      ],
      "priority": 21,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/admin/storefront/content-builder/page.tsx",
        "apps/online-store/app/admin/storefront/ab-tests/page.tsx",
        "apps/online-store/app/admin/storefront/ai-copywriter/page.tsx",
        "apps/online-store/app/admin/storefront/seo/page.tsx",
        "apps/online-store/app/admin/storefront/templates/page.tsx",
        "apps/online-store/src/pages/admin/storefront/ContentBuilder.tsx",
        "apps/online-store/src/pages/admin/storefront/ABTests.tsx",
        "apps/online-store/src/pages/admin/Templates.tsx",
        "apps/online-store/src/pages/admin/storefront/SEO.tsx"
      ],
      "notes": "Five more admin sub-pages. Same pattern as US-020.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-018"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-022",
      "title": "Migrate admin Catalog pages",
      "description": "As an admin, I want catalog management pages available under /admin/catalog/*.",
      "acceptanceCriteria": [
        "Create app/admin/catalog/page.tsx importing AdminCatalog",
        "Create app/admin/catalog/services/page.tsx importing Services",
        "Create app/admin/catalog/services/[id]/page.tsx importing ServiceForm",
        "Create app/admin/catalog/products/page.tsx importing Products",
        "Create app/admin/catalog/memberships/page.tsx importing AdminMemberships",
        "Create app/admin/catalog/giftcards/page.tsx importing GiftCardSettings",
        "Update ServiceForm.tsx: replace useParams from react-router-dom with next/navigation",
        "Update Services.tsx, Products.tsx, Memberships.tsx: replace Link and navigation imports",
        "Dynamic route /admin/catalog/services/[id] correctly passes params",
        "pnpm run typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/admin/catalog/page.tsx",
        "apps/online-store/app/admin/catalog/services/page.tsx",
        "apps/online-store/app/admin/catalog/services/[id]/page.tsx",
        "apps/online-store/app/admin/catalog/products/page.tsx",
        "apps/online-store/app/admin/catalog/memberships/page.tsx",
        "apps/online-store/app/admin/catalog/giftcards/page.tsx",
        "apps/online-store/src/pages/admin/Catalog.tsx",
        "apps/online-store/src/pages/admin/catalog/Services.tsx",
        "apps/online-store/src/pages/admin/catalog/ServiceForm.tsx",
        "apps/online-store/src/pages/admin/catalog/Products.tsx",
        "apps/online-store/src/pages/admin/catalog/Memberships.tsx",
        "apps/online-store/src/pages/admin/catalog/GiftCardSettings.tsx"
      ],
      "notes": "Catalog has a dynamic route [id] for service editing. Verify params work like US-011.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-018"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-023",
      "title": "Migrate admin Management pages (bookings, customers, orders, staff, reports, analytics, settings)",
      "description": "As an admin, I want all management pages available under /admin/*.",
      "acceptanceCriteria": [
        "Create app/admin/bookings/page.tsx importing AdminBookings",
        "Create app/admin/customers/page.tsx importing AdminCustomers",
        "Create app/admin/orders/page.tsx importing AdminOrders",
        "Create app/admin/staff/page.tsx importing AdminStaff",
        "Create app/admin/reports/page.tsx importing AdminReports",
        "Create app/admin/analytics/page.tsx importing AdminAnalytics",
        "Create app/admin/settings/page.tsx with placeholder content",
        "All seven pages render correctly at their routes",
        "pnpm run typecheck passes"
      ],
      "priority": 23,
      "passes": true,
      "phase": "Phase 2: Migrate Pages",
      "files": [
        "apps/online-store/app/admin/bookings/page.tsx",
        "apps/online-store/app/admin/customers/page.tsx",
        "apps/online-store/app/admin/orders/page.tsx",
        "apps/online-store/app/admin/staff/page.tsx",
        "apps/online-store/app/admin/reports/page.tsx",
        "apps/online-store/app/admin/analytics/page.tsx",
        "apps/online-store/app/admin/settings/page.tsx",
        "apps/online-store/src/pages/admin/Bookings.tsx",
        "apps/online-store/src/pages/admin/Customers.tsx",
        "apps/online-store/src/pages/admin/Orders.tsx",
        "apps/online-store/src/pages/admin/Staff.tsx",
        "apps/online-store/src/pages/admin/Reports.tsx",
        "apps/online-store/src/pages/admin/Analytics.tsx"
      ],
      "notes": "Seven admin pages. Settings may need a placeholder if the real component is complex.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-018"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-024",
      "title": "Convert AuthContext for SSR safety",
      "description": "As a developer, I want AuthContext to work safely in Next.js without SSR hydration errors.",
      "acceptanceCriteria": [
        "Add 'use client' directive to AuthContext.tsx",
        "Guard all localStorage and window references with typeof window !== 'undefined' checks",
        "Ensure Supabase auth listener only initializes on client side",
        "Auth state initializes as loading on server, resolves on client mount",
        "No hydration mismatch warnings in browser console",
        "Login/logout flow works correctly",
        "pnpm run typecheck passes"
      ],
      "priority": 24,
      "passes": true,
      "phase": "Phase 3: Convert Providers",
      "files": [
        "apps/online-store/src/contexts/AuthContext.tsx"
      ],
      "notes": "AuthContext is the most critical provider. SSR hydration errors here break everything. Test login/logout flow end-to-end.",
      "category": "frontend",
      "complexity": 4,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-025",
      "title": "Convert ThemeContext to use next-themes",
      "description": "As a developer, I want theme management using next-themes which handles SSR, flash-of-unstyled-content, and system preference correctly.",
      "acceptanceCriteria": [
        "Replace custom ThemeContext implementation with next-themes ThemeProvider",
        "Update Providers.tsx to use ThemeProvider from next-themes with attribute='class'",
        "Ensure existing useTheme consumers work (may need adapter hook)",
        "Dark/light mode toggle works without FOUC",
        "Theme persists across page navigations",
        "No hydration mismatch on initial load",
        "pnpm run typecheck passes"
      ],
      "priority": 25,
      "passes": true,
      "phase": "Phase 3: Convert Providers",
      "files": [
        "apps/online-store/src/contexts/ThemeContext.tsx",
        "apps/online-store/src/components/Providers.tsx"
      ],
      "notes": "next-themes is already in dependencies \u2014 this should be straightforward.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-026",
      "title": "Convert Cart, Wishlist, Personalization contexts for SSR",
      "description": "As a developer, I want Cart, Wishlist, and Personalization contexts to be SSR-safe.",
      "acceptanceCriteria": [
        "Add 'use client' directive to CartContext.tsx, WishlistContext.tsx, PersonalizationContext.tsx",
        "Guard localStorage access in CartContext (cart persistence) with typeof window check",
        "Guard localStorage access in WishlistContext with typeof window check",
        "Guard any browser APIs in PersonalizationContext",
        "Initialize with default state on server, hydrate from localStorage on mount",
        "Cart badge count displays correctly after client hydration",
        "No hydration mismatch warnings",
        "pnpm run typecheck passes"
      ],
      "priority": 26,
      "passes": true,
      "phase": "Phase 3: Convert Providers",
      "files": [
        "apps/online-store/src/contexts/CartContext.tsx",
        "apps/online-store/src/contexts/WishlistContext.tsx",
        "apps/online-store/src/contexts/PersonalizationContext.tsx"
      ],
      "notes": "",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-027",
      "title": "Convert NotificationContext and RealtimeProvider for SSR",
      "description": "As a developer, I want notification and real-time providers to be SSR-safe and only connect on client.",
      "acceptanceCriteria": [
        "Add 'use client' directive to NotificationContext.tsx",
        "Add 'use client' directive to RealtimeProvider.tsx",
        "Ensure MQTT/WebSocket connections only initialize on client side",
        "Notification toasts work correctly after hydration",
        "Real-time updates (if any active subscriptions) work on client",
        "No SSR errors from browser-only APIs",
        "pnpm run typecheck passes"
      ],
      "priority": 27,
      "passes": true,
      "phase": "Phase 3: Convert Providers",
      "files": [
        "apps/online-store/src/contexts/NotificationContext.tsx",
        "apps/online-store/src/providers/RealtimeProvider.tsx"
      ],
      "notes": "WebSocket/MQTT connections must NOT initialize during SSR. Use useEffect for connection setup.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-028",
      "title": "Add root metadata and shared metadata config",
      "description": "As a developer, I want default metadata (title, description, OG tags) configured at the root layout level.",
      "acceptanceCriteria": [
        "Create src/lib/metadata.ts with shared metadata constants (site name, default description, OG image URL, base URL)",
        "Add metadata export to app/layout.tsx with: title template '%s | Mango', default title, description, openGraph defaults, twitter card config",
        "Add viewport export to app/layout.tsx with themeColor, width=device-width, initialScale=1",
        "Remove HelmetProvider from Providers.tsx (no longer needed)",
        "pnpm run typecheck passes"
      ],
      "priority": 28,
      "passes": true,
      "phase": "Phase 4: SEO",
      "files": [
        "apps/online-store/src/lib/metadata.ts",
        "apps/online-store/app/layout.tsx",
        "apps/online-store/src/components/Providers.tsx"
      ],
      "notes": "Also remove any react-helmet-async <Helmet> usage in page components as you encounter them \u2014 they're replaced by Next.js metadata exports.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-029",
      "title": "Add static metadata to customer pages",
      "description": "As a developer, I want each customer page to export its own metadata for proper SEO.",
      "acceptanceCriteria": [
        "Add metadata export to app/(customer)/page.tsx (Home - title, description)",
        "Add metadata exports to book/page.tsx, shop/page.tsx, cart/page.tsx, checkout/page.tsx",
        "Add metadata exports to memberships/page.tsx, gift-cards/page.tsx, account/page.tsx",
        "Add metadata exports to login/page.tsx, promotions/page.tsx, updates/page.tsx",
        "Each page has unique title and description",
        "Page titles render as 'Page Name | Mango' using the template",
        "pnpm run typecheck passes"
      ],
      "priority": 29,
      "passes": true,
      "phase": "Phase 4: SEO",
      "files": [
        "apps/online-store/app/(customer)/page.tsx",
        "apps/online-store/app/(customer)/book/page.tsx",
        "apps/online-store/app/(customer)/shop/page.tsx",
        "apps/online-store/app/(customer)/cart/page.tsx",
        "apps/online-store/app/(customer)/checkout/page.tsx",
        "apps/online-store/app/(customer)/memberships/page.tsx",
        "apps/online-store/app/(customer)/gift-cards/page.tsx",
        "apps/online-store/app/(customer)/account/page.tsx",
        "apps/online-store/app/(customer)/login/page.tsx",
        "apps/online-store/app/(customer)/promotions/page.tsx",
        "apps/online-store/app/(customer)/updates/page.tsx"
      ],
      "notes": "Bulk metadata addition. Use consistent description patterns across pages.",
      "category": "frontend",
      "complexity": 1,
      "dependencies": [
        "US-007",
        "US-008",
        "US-011",
        "US-012",
        "US-028"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-030",
      "title": "Add metadata to info and legal pages",
      "description": "As a developer, I want info and legal pages to have proper metadata for SEO.",
      "acceptanceCriteria": [
        "Add metadata exports to all info pages (about, contact, gallery, reviews, faq, policies)",
        "Add metadata exports to all legal pages (privacy, terms, accessibility)",
        "Each page has unique, descriptive title and description",
        "pnpm run typecheck passes"
      ],
      "priority": 30,
      "passes": true,
      "phase": "Phase 4: SEO",
      "files": [
        "apps/online-store/app/(customer)/info/about/page.tsx",
        "apps/online-store/app/(customer)/info/contact/page.tsx",
        "apps/online-store/app/(customer)/info/gallery/page.tsx",
        "apps/online-store/app/(customer)/info/reviews/page.tsx",
        "apps/online-store/app/(customer)/info/faq/page.tsx",
        "apps/online-store/app/(customer)/info/policies/page.tsx",
        "apps/online-store/app/(customer)/legal/privacy/page.tsx",
        "apps/online-store/app/(customer)/legal/terms/page.tsx",
        "apps/online-store/app/(customer)/legal/accessibility/page.tsx"
      ],
      "notes": "Same pattern as US-029 but for info/legal pages.",
      "category": "frontend",
      "complexity": 1,
      "dependencies": [
        "US-015",
        "US-016",
        "US-028"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-031",
      "title": "Add generateMetadata for dynamic routes",
      "description": "As a developer, I want dynamic pages to generate SEO metadata based on their content (product name, service details).",
      "acceptanceCriteria": [
        "Implement generateMetadata in app/(customer)/shop/[productId]/page.tsx that fetches product data and returns dynamic title/description/OG tags",
        "Implement generateMetadata in app/admin/catalog/services/[id]/page.tsx for service detail",
        "Fallback metadata for when product/service is not found",
        "OG image URL included when available",
        "pnpm run typecheck passes"
      ],
      "priority": 31,
      "passes": true,
      "phase": "Phase 4: SEO",
      "files": [
        "apps/online-store/app/(customer)/shop/[productId]/page.tsx",
        "apps/online-store/app/admin/catalog/services/[id]/page.tsx"
      ],
      "notes": "",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-011",
        "US-022",
        "US-028"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-032",
      "title": "Create sitemap.ts, robots.ts, and JSON-LD components",
      "description": "As a developer, I want automated sitemap generation, robots.txt, and structured data for search engines.",
      "acceptanceCriteria": [
        "Create app/sitemap.ts that generates sitemap with all public customer routes",
        "Create app/robots.ts that allows public pages, disallows /admin and /api",
        "Create src/components/JsonLd.tsx component using next/script for structured data injection",
        "Add LocalBusiness JSON-LD to home page",
        "Add BreadcrumbList JSON-LD to relevant pages",
        "Sitemap accessible at /sitemap.xml",
        "Robots.txt accessible at /robots.txt",
        "pnpm run typecheck passes"
      ],
      "priority": 32,
      "passes": true,
      "phase": "Phase 4: SEO",
      "files": [
        "apps/online-store/app/sitemap.ts",
        "apps/online-store/app/robots.ts",
        "apps/online-store/src/components/JsonLd.tsx"
      ],
      "notes": "sitemap.ts and robots.ts use Next.js file conventions. JSON-LD uses script type application/ld+json.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-028"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-033",
      "title": "Create Supabase server and client utilities for Next.js",
      "description": "As a developer, I want Supabase clients that work correctly in both Server Components and Client Components.",
      "acceptanceCriteria": [
        "Install @supabase/ssr package",
        "Create src/lib/supabase/server.ts with createClient() for Server Components using cookies()",
        "Create src/lib/supabase/client.ts with createBrowserClient() for Client Components",
        "Server client reads auth from cookies (supports SSR)",
        "Client client works identically to existing Supabase setup",
        "Both clients use the same VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY (or NEXT_PUBLIC_ equivalents)",
        "Both clients use NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY env vars",
        "pnpm run typecheck passes"
      ],
      "priority": 33,
      "passes": true,
      "phase": "Phase 5: Data Layer",
      "files": [
        "apps/online-store/src/lib/supabase/server.ts",
        "apps/online-store/src/lib/supabase/client.ts",
        "apps/online-store/package.json",
        "apps/online-store/.env.example"
      ],
      "notes": "VITE_ prefix env vars will NOT be available in Next.js. Must use NEXT_PUBLIC_ prefix. Add both prefixes during migration so Vite fallback still works.",
      "category": "backend",
      "complexity": 3,
      "dependencies": [
        "US-001"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-034",
      "title": "Convert shop page to Server Component data fetching",
      "description": "As a developer, I want the shop listing page to fetch services/products server-side for faster initial load and SEO.",
      "acceptanceCriteria": [
        "Make app/(customer)/shop/page.tsx a Server Component (remove 'use client')",
        "Fetch services/products from Supabase using server client in the page component",
        "Pass fetched data as props to a client component wrapper (ShopClient.tsx)",
        "Create src/pages/ShopClient.tsx as 'use client' that receives data props and renders the existing Shop UI",
        "Shop page still renders correctly with data",
        "Page loads faster due to server-side data fetch (HTML includes initial data)",
        "pnpm run typecheck passes"
      ],
      "priority": 34,
      "passes": true,
      "phase": "Phase 5: Data Layer",
      "files": [
        "apps/online-store/app/(customer)/shop/page.tsx",
        "apps/online-store/src/pages/ShopClient.tsx"
      ],
      "notes": "Currently the shop uses mostly mock data. If no real Supabase data exists yet, this story sets up the SERVER COMPONENT PATTERN (async page \u2192 client component) with mock/placeholder data. The pattern matters more than the data source right now.",
      "category": "backend",
      "complexity": 4,
      "dependencies": [
        "US-011",
        "US-033"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-035",
      "title": "Create API route handlers for booking mutations",
      "description": "As a developer, I want booking create/update operations routed through Next.js API handlers for better server-side validation.",
      "acceptanceCriteria": [
        "Create app/api/bookings/route.ts with POST handler for creating bookings",
        "Create app/api/bookings/route.ts with GET handler for fetching bookings",
        "Create app/api/bookings/[id]/route.ts with GET and PATCH handlers",
        "Use Supabase server client for database operations",
        "Validate request body with Zod schemas",
        "Return proper HTTP status codes and error messages",
        "pnpm run typecheck passes"
      ],
      "priority": 35,
      "passes": true,
      "phase": "Phase 5: Data Layer",
      "files": [
        "apps/online-store/app/api/bookings/route.ts",
        "apps/online-store/app/api/bookings/[id]/route.ts"
      ],
      "notes": "API routes handle mutations. Include proper error responses and status codes.",
      "category": "backend",
      "complexity": 3,
      "dependencies": [
        "US-033"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-036",
      "title": "Create API route handlers for cart and checkout",
      "description": "As a developer, I want cart and checkout mutations handled via Next.js API routes.",
      "acceptanceCriteria": [
        "Create app/api/cart/route.ts with GET, POST, PUT, DELETE handlers",
        "Create app/api/checkout/route.ts with POST handler for processing orders",
        "Use Supabase server client for database operations",
        "Validate request bodies with Zod schemas",
        "Checkout handler validates cart contents and calculates totals server-side",
        "Return proper HTTP status codes",
        "pnpm run typecheck passes"
      ],
      "priority": 36,
      "passes": true,
      "phase": "Phase 5: Data Layer",
      "files": [
        "apps/online-store/app/api/cart/route.ts",
        "apps/online-store/app/api/checkout/route.ts"
      ],
      "notes": "Checkout route must validate cart contents server-side. Never trust client-calculated totals.",
      "category": "backend",
      "complexity": 3,
      "dependencies": [
        "US-033"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-037",
      "title": "Add Next.js middleware for auth protection",
      "description": "As a developer, I want route-level auth protection via Next.js middleware instead of client-side ProtectedRoute component.",
      "acceptanceCriteria": [
        "Create middleware.ts at apps/online-store root",
        "Middleware checks Supabase auth session from cookies",
        "Protect /admin/* routes \u2014 redirect to /login if unauthenticated",
        "Protect /account route \u2014 redirect to /login if unauthenticated",
        "Allow all other customer routes without auth",
        "Configure matcher to only run middleware on protected paths",
        "Login redirect includes 'returnTo' query param for post-login navigation",
        "pnpm run typecheck passes"
      ],
      "priority": 37,
      "passes": false,
      "phase": "Phase 5: Data Layer",
      "files": [
        "apps/online-store/middleware.ts"
      ],
      "notes": "Middleware runs on the edge. Keep it lightweight \u2014 only check auth session, don't do heavy DB queries.",
      "category": "backend",
      "complexity": 4,
      "dependencies": [
        "US-033",
        "US-024"
      ],
      "testCommand": "pnpm run typecheck"
    },
    {
      "id": "US-038",
      "title": "Configure Vercel deployment",
      "description": "As a developer, I want the online store deployable to Vercel with proper environment config.",
      "acceptanceCriteria": [
        "Create vercel.json with framework 'nextjs', buildCommand for Turborepo, outputDirectory",
        "Configure root directory as apps/online-store for Vercel project",
        "Update .env.example with all NEXT_PUBLIC_ and server-side env vars needed",
        "Add security headers in next.config.ts (X-Frame-Options, CSP, etc.)",
        "Configure allowed image domains in next.config.ts for next/image",
        "pnpm run build succeeds (next build completes without errors)",
        "pnpm run typecheck passes"
      ],
      "priority": 38,
      "passes": false,
      "phase": "Phase 6: Deployment",
      "files": [
        "apps/online-store/vercel.json",
        "apps/online-store/next.config.ts",
        "apps/online-store/.env.example"
      ],
      "notes": "For monorepo: Vercel needs correct rootDirectory and buildCommand. Test with vercel build locally if possible.",
      "category": "config",
      "complexity": 3,
      "dependencies": [
        "US-001"
      ],
      "testCommand": "pnpm run build"
    },
    {
      "id": "US-039",
      "title": "Convert img tags to next/image",
      "description": "As a developer, I want images optimized using next/image for better performance and Core Web Vitals.",
      "acceptanceCriteria": [
        "Identify key components using <img> tags (Hero sections, product cards, gallery, staff photos)",
        "Replace <img> with next/image Image component in: Index page hero, Shop product cards, Gallery page, team/staff photos",
        "Add width/height or fill props as appropriate",
        "Configure remotePatterns in next.config.ts for Supabase storage and any CDN domains",
        "Images load with lazy loading and proper aspect ratios",
        "No layout shift from image loading (CLS score improvement)",
        "pnpm run typecheck passes"
      ],
      "priority": 39,
      "passes": false,
      "phase": "Phase 6: Deployment",
      "files": [
        "apps/online-store/next.config.ts",
        "apps/online-store/src/pages/Index.tsx",
        "apps/online-store/src/pages/Shop.tsx",
        "apps/online-store/src/pages/info/Gallery.tsx"
      ],
      "notes": "Focus on above-the-fold and large images first. Not every <img> needs conversion \u2014 prioritize hero images, product cards, and gallery. Use fill prop for flexible containers, explicit width/height for fixed layouts.",
      "category": "config",
      "complexity": 3,
      "dependencies": [
        "US-007",
        "US-011"
      ],
      "testCommand": "pnpm run build"
    },
    {
      "id": "US-040",
      "title": "Configure redirects and caching strategy",
      "description": "As a developer, I want old SPA routes to redirect properly and caching configured for performance.",
      "acceptanceCriteria": [
        "Add redirects in next.config.ts for old routes: /book/flow \u2192 /book (permanent)",
        "Add redirect for any legacy routes that changed in migration",
        "Configure headers for static assets caching (fonts, images \u2192 long cache)",
        "Configure headers for API routes (no-cache for mutations, short cache for reads)",
        "All redirects return proper 301/308 status codes",
        "pnpm run typecheck passes"
      ],
      "priority": 40,
      "passes": false,
      "phase": "Phase 6: Deployment",
      "files": [
        "apps/online-store/next.config.ts"
      ],
      "notes": "Only add redirects for routes that actually changed. Don't over-engineer caching \u2014 Vercel defaults are good.",
      "category": "config",
      "complexity": 2,
      "dependencies": [
        "US-038"
      ],
      "testCommand": "pnpm run build"
    },
    {
      "id": "US-041",
      "title": "Replace react-router-dom in shared layout components",
      "description": "As a developer, I want all shared layout/navigation components using next/link and next/navigation instead of react-router-dom.",
      "acceptanceCriteria": [
        "Update Header.tsx: replace react-router-dom Link with next/link, to \u2192 href",
        "Update Footer.tsx: replace Link imports",
        "Update BottomNav.tsx: replace Link and useLocation with next/link and usePathname",
        "Update ProtectedRoute.tsx: replace useNavigate with useRouter, update redirect logic",
        "Update AnnouncementBar.tsx: replace Link imports",
        "Update PromotionBanner.tsx, PromotionsStrip.tsx: replace Link imports",
        "Update DemoRibbon.tsx if it uses router",
        "No remaining react-router-dom imports in components/Header.tsx, Footer.tsx, BottomNav.tsx",
        "pnpm run typecheck passes"
      ],
      "priority": 41,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/src/components/Header.tsx",
        "apps/online-store/src/components/Footer.tsx",
        "apps/online-store/src/components/BottomNav.tsx",
        "apps/online-store/src/components/ProtectedRoute.tsx",
        "apps/online-store/src/components/promotions/AnnouncementBar.tsx",
        "apps/online-store/src/components/promotions/PromotionBanner.tsx",
        "apps/online-store/src/components/promotions/PromotionsStrip.tsx"
      ],
      "notes": "Shared layout components are imported by many pages. Changes here affect everything \u2014 test broadly.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-005",
        "US-006",
        "US-018"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-042",
      "title": "Replace react-router-dom in customer-facing components",
      "description": "As a developer, I want customer-facing feature components using next/link and next/navigation.",
      "acceptanceCriteria": [
        "Update booking components: BookingSidebar, GuestPromptBanner, ReviewStep \u2014 replace Link (to\u2192href) and useNavigate",
        "Update cart components: MiniCartDrawer, EmptyCartRecommendations \u2014 replace Link",
        "Update shop components: QuickViewModal \u2014 replace Link",
        "Update home components: AIRecommendations, TrendingNow \u2014 replace Link",
        "Update sections: TeamGallery, MembershipRail, SectionRenderer, FAQSection \u2014 replace Link",
        "Update chat: ChatDrawer \u2014 replace useNavigate with useRouter",
        "No remaining react-router-dom imports in these files",
        "pnpm run typecheck passes"
      ],
      "priority": 42,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/src/components/booking/BookingSidebar.tsx",
        "apps/online-store/src/components/booking/GuestPromptBanner.tsx",
        "apps/online-store/src/components/booking/ReviewStep.tsx",
        "apps/online-store/src/components/cart/MiniCartDrawer.tsx",
        "apps/online-store/src/components/cart/EmptyCartRecommendations.tsx",
        "apps/online-store/src/components/shop/QuickViewModal.tsx",
        "apps/online-store/src/components/home/AIRecommendations.tsx",
        "apps/online-store/src/components/home/TrendingNow.tsx",
        "apps/online-store/src/components/sections/TeamGallery.tsx",
        "apps/online-store/src/components/sections/MembershipRail.tsx",
        "apps/online-store/src/components/sections/SectionRenderer.tsx",
        "apps/online-store/src/components/sections/FAQSection.tsx",
        "apps/online-store/src/components/chat/ChatDrawer.tsx"
      ],
      "notes": "Each file change is a simple import swap: react-router-dom Link \u2192 next/link (to\u2192href), useNavigate \u2192 useRouter().push",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-005",
        "US-007",
        "US-009",
        "US-011",
        "US-012"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-042B",
      "title": "Replace react-router-dom in account and admin components",
      "description": "As a developer, I want account and admin feature components using next/link and next/navigation.",
      "acceptanceCriteria": [
        "Update account components: OnlineBookingsSection, AIReminders, PersonalizedOffers \u2014 replace Link and useNavigate",
        "Update admin dashboard: NotificationCenter, QuickActions \u2014 replace Link and navigation",
        "Update hooks/useStore.ts if it uses react-router-dom",
        "Grep confirms zero remaining react-router-dom imports across entire src/ directory",
        "pnpm run typecheck passes"
      ],
      "priority": 43,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/src/components/account/OnlineBookingsSection.tsx",
        "apps/online-store/src/components/account/AIReminders.tsx",
        "apps/online-store/src/components/account/PersonalizedOffers.tsx",
        "apps/online-store/src/components/admin/dashboard/NotificationCenter.tsx",
        "apps/online-store/src/components/admin/dashboard/QuickActions.tsx",
        "apps/online-store/src/hooks/useStore.ts"
      ],
      "notes": "After this story, zero files should import from react-router-dom",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-005",
        "US-014",
        "US-019"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-043",
      "title": "Remove Vite configuration and entry files",
      "description": "As a developer, I want all Vite-specific files removed since Next.js is now the build system.",
      "acceptanceCriteria": [
        "Delete vite.config.ts",
        "Delete index.html (Next.js generates HTML via layout.tsx)",
        "Delete src/main.tsx (Next.js entry is app/layout.tsx)",
        "Delete src/App.tsx (replaced by app/ directory routing)",
        "Delete src/vite-env.d.ts if it exists",
        "Verify no other files import from vite or reference vite config",
        "pnpm run build (next build) succeeds",
        "pnpm run typecheck passes"
      ],
      "priority": 44,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/vite.config.ts",
        "apps/online-store/index.html",
        "apps/online-store/src/main.tsx",
        "apps/online-store/src/App.tsx",
        "apps/online-store/src/vite-env.d.ts"
      ],
      "notes": "Only delete Vite files AFTER all pages are confirmed working on Next.js. This is the point of no return.",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-041",
        "US-042",
        "US-042B"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-044",
      "title": "Remove react-router-dom and react-helmet-async dependencies",
      "description": "As a developer, I want unused SPA dependencies removed to reduce bundle size.",
      "acceptanceCriteria": [
        "pnpm remove react-router-dom react-helmet-async from apps/online-store",
        "Remove @vitejs/plugin-react, @vitejs/plugin-react-swc, terser, lovable-tagger if still present",
        "Delete src/components/SEO.tsx and src/components/SEOHead.tsx (replaced by Next.js metadata)",
        "Delete src/lib/navigation.ts compatibility layer (all imports should now use next/ directly)",
        "Verify no imports from removed packages remain (grep for react-router-dom, react-helmet-async)",
        "pnpm run build succeeds with no missing dependency errors",
        "pnpm run typecheck passes"
      ],
      "priority": 45,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/package.json",
        "apps/online-store/src/components/SEO.tsx",
        "apps/online-store/src/components/SEOHead.tsx",
        "apps/online-store/src/lib/navigation.ts"
      ],
      "notes": "Must run after US-041, US-042, US-042B so all react-router-dom imports are already replaced",
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-043"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-045",
      "title": "Clean up PWA and offline patterns for Next.js",
      "description": "As a developer, I want PWA registration replaced with Next.js-compatible offline patterns.",
      "acceptanceCriteria": [
        "Remove src/lib/pwa/registration.ts and related PWA service worker registration",
        "Remove OfflineQueue component from Providers if not adapted",
        "Update OfflineIndicator to work without service worker registration (use navigator.onLine)",
        "Optionally configure next-pwa or @ducanh2912/next-pwa if PWA is needed (or defer to later)",
        "Remove DemoRibbon component or keep it based on need",
        "No console errors related to missing service worker",
        "pnpm run typecheck passes"
      ],
      "priority": 46,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/src/lib/pwa/registration.ts",
        "apps/online-store/src/components/OfflineQueue.tsx",
        "apps/online-store/src/components/OfflineIndicator.tsx",
        "apps/online-store/src/components/DemoRibbon.tsx",
        "apps/online-store/src/components/Providers.tsx"
      ],
      "notes": "PWA can be deferred. For now, just clean up Vite-specific PWA registration. Next.js PWA can be added later.",
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-004"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-046",
      "title": "Final dependency audit and build verification",
      "description": "As a developer, I want a clean dependency tree and verified production build before merging.",
      "acceptanceCriteria": [
        "Run pnpm audit and address any vulnerabilities",
        "Remove any unused dependencies from package.json (check with depcheck or manual review)",
        "Verify all NEXT_PUBLIC_ env vars are documented in .env.example",
        "pnpm run build produces a successful Next.js build with no warnings",
        "pnpm run typecheck passes with no errors",
        "pnpm run lint passes",
        "Verify key routes work: /, /book, /shop, /cart, /checkout, /account, /admin",
        "Verify turbo build from monorepo root succeeds for online-store workspace",
        "No console errors on any page (check /, /book, /shop, /admin)",
        "Bundle size is reasonable (compare to previous Vite build if available)"
      ],
      "priority": 47,
      "passes": false,
      "phase": "Phase 7: Cleanup",
      "files": [
        "apps/online-store/package.json",
        "apps/online-store/.env.example"
      ],
      "notes": "This is the FINAL gate story. All 45 previous stories must pass. Run full build, lint, typecheck, and manually verify key routes in browser using agent-browser.",
      "category": "frontend",
      "complexity": 4,
      "dependencies": [
        "US-043",
        "US-044",
        "US-045",
        "US-038"
      ],
      "testCommand": "pnpm run typecheck && pnpm run build"
    },
    {
      "id": "US-047",
      "title": "Ultrathink deep code review of entire migration",
      "description": "As a tech lead, I want a comprehensive code review using Claude Code ultrathink mode (4 specialist sub-agents: Architect, Research, Coder, Tester) to catch security issues, anti-patterns, SSR hydration bugs, performance problems, and missed edge cases across the entire Next.js migration.",
      "acceptanceCriteria": [
        "Launch Claude Code with Opus model and /ultrathink command",
        "Review Phase 1 (Scaffold): next.config.ts, tsconfig, Tailwind, root layout, Providers wrapper \u2014 check for misconfigurations",
        "Review Phase 2 (Pages): all app/ page wrappers \u2014 verify correct 'use client' boundaries, no server/client component violations",
        "Review Phase 3 (Providers): all SSR-safe context conversions \u2014 verify no hydration mismatches, localStorage guards, proper client-only initialization",
        "Review Phase 4 (SEO): metadata exports, generateMetadata, sitemap, robots, JSON-LD \u2014 verify correctness and completeness",
        "Review Phase 5 (Data Layer): Supabase server/client setup, API routes, middleware \u2014 check auth security, input validation, error handling",
        "Review Phase 6 (Deployment): Vercel config, next/image, caching headers, redirects \u2014 verify production readiness",
        "Review Phase 7 (Cleanup): verify ZERO react-router-dom imports remain, no dead code, no unused dependencies",
        "Check for: XSS vectors in server components, CSRF in API routes, auth bypass in middleware, data leaks between server/client boundary",
        "Generate categorized findings report: CRITICAL / HIGH / MEDIUM / LOW",
        "All findings documented in scripts/ralph/runs/online-store-nextjs-migration/review-findings.md"
      ],
      "priority": 48,
      "passes": false,
      "phase": "Phase 8: Review",
      "files": [],
      "notes": "Run AFTER all 46 implementation stories pass. Use Claude Code interactive mode with /ultrathink. This story produces a findings report \u2014 it does NOT fix issues. Fixes happen in US-048.",
      "dependencies": [
        "US-046"
      ],
      "category": "review",
      "complexity": 5,
      "testCommand": "pnpm run typecheck && pnpm run build && pnpm run lint"
    },
    {
      "id": "US-048",
      "title": "Fix all issues found in ultrathink review",
      "description": "As a developer, I want all CRITICAL and HIGH issues from the ultrathink review (US-047) fixed, and MEDIUM issues addressed where practical.",
      "acceptanceCriteria": [
        "All CRITICAL findings from review-findings.md are fixed",
        "All HIGH findings from review-findings.md are fixed",
        "MEDIUM findings are fixed or documented with justification for deferral",
        "LOW findings documented for future improvement",
        "Each fix committed individually with descriptive message: fix: [review] <description>",
        "pnpm run build succeeds after all fixes",
        "pnpm run typecheck passes after all fixes",
        "pnpm run lint passes after all fixes",
        "Re-run verification on key routes: /, /book, /shop, /cart, /admin",
        "Update review-findings.md with resolution status for each finding"
      ],
      "priority": 49,
      "passes": false,
      "phase": "Phase 8: Review",
      "files": [],
      "notes": "This story addresses everything found in US-047. Use Claude Code Opus for the fixes. Commit each fix separately for clean git history. After this story, the migration branch is ready for final PR review.",
      "dependencies": [
        "US-047"
      ],
      "category": "review",
      "complexity": 5,
      "testCommand": "pnpm run typecheck && pnpm run build && pnpm run lint"
    }
  ]
}
## Codebase Patterns

See patterns.md for accumulated patterns from previous runs.

---

# Ralph Progress Log
Started: 2026-01-14
Branch: ralph/frontdesk-tickets
Run: frontdesk-tickets

<!-- Ralph appends entries below -->

## Iteration 1 - US-001: Display technician on WaitListTicketCard
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Implemented technician display on WaitListTicketCard showing staff avatar and name when a technician is assigned.

### Key Discovery
The exported `WaitListTicketCard` comes from `WaitListTicketCardRefactored.tsx` (473 lines), NOT `WaitListTicketCard.tsx` (986 lines). Found via index.ts barrel export.

### Files Changed
1. `apps/store-app/src/components/tickets/WaitListTicketCardRefactored.tsx`
   - Added technician props to interface (technician, techColor, techId, assignedTo, assignedStaff)
   - Made `status` field optional (was required but not always passed)
   - Added helper functions: staffList, hasAssignedStaff, getStaffColor, getFirstName, renderStaffAvatar
   - Updated all 4 view modes (compact, normal, grid-compact, grid-normal) to show staff badge

2. `apps/store-app/src/components/frontdesk/WaitListSection/components/SortableItems.tsx`
   - Pass technician fields through to WaitListTicketCard in both SortableListItem and SortableGridItem

3. `apps/store-app/src/components/frontdesk/WaitListSection.tsx`
   - Pass technician fields in DragOverlay for both grid and list views

### Patterns Learned
- **Barrel exports can redirect**: Check index.ts to find actual exported component
- **Multi-staff support**: Use `assignedStaff` array OR `assignedTo` object fallback pattern
- **View mode consistency**: WaitListTicketCard has 4 modes (compact, normal, grid-compact, grid-normal) - update all

### Commit
`c7a8865` - feat: [US-001] - Display technician on WaitListTicketCard

---

## Iteration 2 - US-002: Display technician on PendingTicketCard
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Updated PendingTicketCard to follow the same pattern as WaitListTicketCard for technician display. The rendering code already existed - only needed to add the `assignedTo` fallback support.

### Key Discovery
- PRD stated "Interface already has technician props - add rendering JSX only"
- Upon inspection, rendering was ALREADY implemented in all 4 view modes (lines 317-327, 462-468, 631-641, 810-818)
- Missing piece was the `assignedTo` fallback in staffList helper (only used `assignedStaff`)

### Files Changed
1. `apps/store-app/src/components/tickets/PendingTicketCard.tsx:52-57`
   - Added `assignedTo` property to PendingTicket interface (matching WaitListTicketCard)

2. `apps/store-app/src/components/tickets/PendingTicketCard.tsx:99-100`
   - Updated staffList helper from `ticket.assignedStaff || []` to `ticket.assignedStaff || (ticket.assignedTo ? [ticket.assignedTo] : [])`

### Patterns Confirmed
- **PRD vs Reality check**: PRD notes can be outdated - always verify current implementation
- **Staff fallback pattern**: `assignedStaff || (assignedTo ? [assignedTo] : [])` is the standard

### Pre-existing Issues (Not From This Story)
- Test files have TypeScript errors (test data missing required fields) - documented, not blocking

### Commit
`c5db643` - feat: [US-002] - Display technician on PendingTicketCard

---

## Iteration 3 - US-003: Create updateTicket thunk and make EditTicketModal functional
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Created the `updateTicket` async thunk and connected EditTicketModal to Redux so that ticket edits actually persist.

### Files Changed
1. `apps/store-app/src/store/slices/uiTicketsSlice.ts:500-570`
   - Created `updateTicket` async thunk accepting `{ ticketId: string, updates: Partial<UITicket> }`
   - Thunk updates via `dataService.tickets.update()` with IndexedDB fallback
   - Queues for sync when offline
   - Returns `{ ticketId, updates, originalStatus }` for reducer

2. `apps/store-app/src/store/slices/uiTicketsSlice.ts:1421-1453`
   - Added `.addCase(updateTicket.fulfilled, ...)` in extraReducers
   - Updates ticket in appropriate array based on original status (waiting, in-service, completed)
   - Also handles pendingTickets for checkout tickets

3. `apps/store-app/src/components/tickets/EditTicketModal.tsx`
   - Imported `updateTicket` and `useAppDispatch`
   - Replaced `console.log` with `dispatch(updateTicket(...)).unwrap()`
   - Made `handleSubmit` async with try/catch error handling
   - Modal only closes after successful save

### Patterns Learned
- **Thunk pattern**: Follow `assignTicket` pattern - find ticket first, prepare updates, try Supabase then fallback to IndexedDB
- **Multi-array updates**: Tickets can be in waitlist, serviceTickets, completedTickets, OR pendingTickets - check all
- **Form to Redux**: Use `.unwrap()` to handle async thunk errors in try/catch

### Pre-existing Issues (Not From This Story)
- TypeScript error at line 1620 in `updateCheckoutTicket.fulfilled` - pre-existing, not blocking
- Test files have TypeScript errors - pre-existing, documented

### Commit
`a593b97` - feat: [US-003] - Create updateTicket thunk and make EditTicketModal functional

---

## Iteration 4 - US-004: Connect TicketActions.handleAssign to Redux
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Connected the TicketActions component's handleAssign function to Redux by importing and dispatching the existing `assignTicket` thunk instead of just logging to console.

### Files Changed
1. `apps/store-app/src/components/tickets/TicketActions.tsx:1-8`
   - Added imports for `useAppDispatch` from `@/store/hooks`
   - Added imports for `assignTicket` from `@/store/slices/uiTicketsSlice`

2. `apps/store-app/src/components/tickets/TicketActions.tsx:19-21`
   - Added `isAssigning` state for loading during dispatch
   - Added `dispatch` from `useAppDispatch()`

3. `apps/store-app/src/components/tickets/TicketActions.tsx:38-54`
   - Made `handleAssign` async
   - Replaced `console.log` with `dispatch(assignTicket({...})).unwrap()`
   - Added try/catch error handling
   - Modal only closes after successful dispatch
   - Added finally block to reset loading state

### Key Discovery
- TicketActions component is defined but not currently rendered anywhere in the UI
- The component is ready for integration when ticket cards need assign buttons
- Browser verification was attempted but component is not yet integrated into ticket cards

### Patterns Confirmed
- **Redux thunk dispatch pattern**: Use `.unwrap()` with try/catch for async error handling
- **Loading state pattern**: Set loading true before dispatch, reset in finally block
- **Modal close pattern**: Only close modal on success, keep open on failure for retry

### Pre-existing Issues (Not From This Story)
- Test files have TypeScript errors - pre-existing, documented

### Commit
`4813746` - feat: [US-004] - Connect TicketActions.handleAssign to Redux

---

## Iteration 5 - US-005: Implement bidirectional status transitions
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Created async thunks for moving tickets between statuses (waiting ↔ in-service ↔ pending) and updated TicketActions component with status transition buttons and confirmation dialogs.

### Files Changed
1. `apps/store-app/src/store/slices/uiTicketsSlice.ts`
   - Created `moveToWaiting` thunk - moves tickets from in-service or pending back to waitlist
   - Created `moveToInService` thunk - moves tickets from waitlist to serviceTickets
   - Created `moveToPending` thunk - moves tickets from serviceTickets to pendingTickets (checkout)
   - Added reducer cases for all three thunks in extraReducers
   - Exported all three thunks and their selectors

2. `apps/store-app/src/components/tickets/TicketActions.tsx`
   - Extended section prop to include 'pending'
   - Added confirmation dialog state with ConfirmAction type
   - Added status transition handlers: handleStartService, handleCompleteService, handleBackToWaiting, handleBackToService
   - Added confirmation content generator for each action type
   - Added section-specific action buttons:
     - Waitlist: Start Service (Play), Assign (UserCheck), Cancel (X)
     - In-service: Complete Service (CheckCircle), Move to Waiting (Pause)
     - Pending: Back to Service (RotateCcw)
   - Integrated AlertDialog for confirmation before each status change

### Patterns Learned
- **Multi-step transitions**: For back-to-service from pending, chain two thunks (moveToWaiting then moveToInService)
- **Confirmation dialog pattern**: Use AlertDialog with open state controlled by action type, not boolean
- **Ticket lookup across arrays**: Check waitlist, serviceTickets, AND pendingTickets when finding tickets

### Key Discovery
- TicketActions already had the component structure from US-004
- Extended it significantly to handle all status transitions with proper UI feedback
- `handleBackToService` requires two sequential dispatches (pending → waiting → in-service)

### Pre-existing Issues (Not From This Story)
- TypeScript errors in test files - pre-existing, documented
- TypeScript error at line 1866 in updateCheckoutTicket.fulfilled - pre-existing

### Commit
`4813746` - feat: [US-005] - Implement bidirectional status transitions

---

## Iteration 6 - US-006: Implement daily-resetting check-in numbers
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Implemented daily-resetting check-in numbers so that the first ticket of each day starts at #1, and subsequent tickets increment. This is separate from the permanent ticket.number used for receipts.

### Files Changed
1. `apps/store-app/src/store/slices/uiTicketsSlice.ts`
   - Added `checkInNumber?: number` to UITicket interface (line 76)
   - Added `checkInNumber?: number` to PendingTicket interface (line 118)
   - Added `lastCheckInDate: string | null` and `lastCheckInNumber: number` to UITicketsState (lines 211-214)
   - Added initial values to initialState (lines 227-228)
   - Modified `createTicket` thunk to calculate and assign daily check-in numbers (lines 341-348, 399, 413, 447)
   - Modified `checkInAppointment` thunk similarly (lines 862-869, 947, 980-981)
   - Updated reducers to track lastCheckInDate and lastCheckInNumber

2. `apps/store-app/src/components/tickets/WaitListTicketCardRefactored.tsx`
   - Added `checkInNumber?: number` to ticket prop interface (lines 22-23)
   - Updated ticket number badge to display `#${ticket.checkInNumber ?? ticket.number}` in:
     - Grid-compact view (line 396)
     - Grid-normal view (line 456)
     - List views (line 557)

3. `apps/store-app/src/components/tickets/ServiceTicketCard.tsx`
   - Added `checkInNumber?: number` to ticket prop interface (lines 24-25)
   - Updated ticket number badge to display `#${ticket.checkInNumber ?? ticket.number}` in:
     - Compact list view (line 263)
     - Normal list view (line 382)
     - Grid-normal view (line 503)
     - Grid-compact view (line 541)

### Patterns Learned
- **Daily reset logic**: Compare `new Date().toISOString().split('T')[0]` (YYYY-MM-DD) to stored lastCheckInDate
- **Fallback display**: Use `checkInNumber ?? number` to gracefully handle tickets created before this feature
- **State tracking**: Store both date and number in Redux state to persist across page refreshes within a session

### Pre-existing Issues (Not From This Story)
- TypeScript error at line 1910 in `updateCheckoutTicket.fulfilled` - pre-existing type mismatch between UITicketWithServices and PendingTicket
- Test files have TypeScript errors - pre-existing, documented

### Browser Verification
- Confirmed ticket badge shows "#1" with the '#' prefix in Waiting Queue
- Verified via Playwright MCP browser snapshot

### Commit
`f976e1f` - feat: [US-006] - Implement daily-resetting check-in numbers

---

## Iteration 7 - US-007: Implement soft delete with categorized reasons
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Implemented soft delete functionality for tickets with categorized deletion reasons (testing, client_left, duplicate, mistake, other) for accurate reporting. Created DeleteTicketModal with radio button selection and integrated delete buttons across all ticket sections.

### Files Changed
1. `apps/store-app/src/types/Ticket.ts`
   - Added `DeleteReason` type: `'testing' | 'client_left' | 'duplicate' | 'mistake' | 'other'`

2. `apps/store-app/src/store/slices/uiTicketsSlice.ts`
   - Added soft delete fields to UITicket interface: `deletedAt`, `deletedReason`, `deletedNote`
   - Added same fields to PendingTicket interface
   - Modified `deleteTicket` thunk to accept `{ ticketId, reason, note }` and perform soft delete
   - Updated reducer to filter deleted tickets from all arrays

3. `apps/store-app/src/components/tickets/DeleteTicketModal.tsx` (NEW)
   - Created modal with RadioGroup for delete reason selection
   - Includes optional notes textarea
   - Dispatches to Redux deleteTicket thunk

4. `apps/store-app/src/components/tickets/TicketActions.tsx`
   - Added Trash2 delete button to all sections (waitlist, in-service, pending)
   - Integrated DeleteTicketModal

5. `apps/store-app/src/hooks/useTicketsCompat.ts`
   - Updated deleteTicket signature to accept `DeleteReason` type instead of string

6. `apps/store-app/src/components/frontdesk/ServiceSection.tsx`
   - Updated legacy delete call to use 'other' reason with text as note

7. `apps/store-app/src/components/frontdesk/WaitListSection.tsx`
   - Updated legacy delete call to use 'other' reason with text as note

8. `apps/store-app/src/components/PaymentProcessModal.tsx`
   - Fixed incorrect use of deleteTicket for payment completion
   - Changed to use markTicketAsPaid (correct function)
   - Mapped payment methods properly (mobile → digital-wallet)

### Key Discovery
- PaymentProcessModal was incorrectly using `deleteTicket` with 'payment_completed' reason for payment completion
- This was semantically wrong - payment completion should use `markTicketAsPaid`, not delete
- Fixed by switching to the correct function with proper payment method mapping

### Patterns Learned
- **Soft delete pattern**: Set `deletedAt`, `deletedReason`, `deletedNote` fields instead of hard delete
- **Backward compatibility**: When changing function signatures, use valid default values for legacy callers
- **Payment method mapping**: Local UI values may differ from API types (mobile → digital-wallet)

### Pre-existing Issues (Not From This Story)
- TypeScript errors in test files - pre-existing, documented
- TypeScript error in updateCheckoutTicket.fulfilled - pre-existing

### Commit
`c2d631f` - feat: [US-007] - Implement soft delete with categorized reasons

## Iteration 8 - US-008: Add manager PIN verification for sensitive actions
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Created ManagerPinModal component for manager PIN verification and integrated it into TicketActions for status reversal actions. The modal features a 4-digit masked PIN input with shake animation on error and max 3 attempts.

### Files Changed
1. `apps/store-app/src/components/common/ManagerPinModal.tsx` (NEW)
   - Created 4-digit PIN input modal with masked dots
   - Dev PIN '1234' accepted for development
   - Shake animation on invalid PIN
   - Max 3 attempts with "Contact manager" lockout message
   - onSuccess callback returns 'manager-1' for dev
   - onCancel callback for modal dismissal
   - Uses Dialog from @/components/ui/dialog

2. `apps/store-app/src/components/tickets/TicketActions.tsx`
   - Added import for ManagerPinModal
   - Added REQUIRE_PIN_FOR_STATUS_REVERSAL constant (default: false)
   - Added showPinModal and pendingReversalAction state
   - Added isReversalAction type guard helper
   - Modified handleConfirmAction to check for PIN requirement before status reversals
   - Added handlePinSuccess to execute pending action after PIN verified
   - Added handlePinCancel to clear pending action
   - Added ManagerPinModal to JSX

### Key Implementation Details
- **Status reversal actions**: 'back-to-waiting' and 'back-to-service'
- **PIN flow**: Confirm dialog → (if setting enabled) PIN modal → execute action
- **Setting default false**: Per acceptance criteria, disabled by default
- **PIN verification**: Simulates 300ms delay, validates against '1234'
- **Lockout**: After 3 failed attempts, shows "Contact manager" message

### Patterns Learned
- **Gated action pattern**: Store pending action in state, show verification modal, execute on success
- **Dev PIN strategy**: Hardcode PIN for development, real auth in separate PRD
- **Shake animation**: Use CSS keyframes with setTimeout to reset state

### Pre-existing Issues (Not From This Story)
- TypeScript errors in test files - pre-existing, documented
- TypeScript error in updateCheckoutTicket.fulfilled - pre-existing

### Commit
`d6cdedd` - feat: [US-008] - Add manager PIN verification for sensitive actions

---

## Iteration 9 - US-009: Connect CreateTicketModal to Front Desk with Redux
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Connected CreateTicketModal to Redux and added CreateTicketButton FAB to Front Desk. Discovered that useTickets().createTicket already dispatches the Redux createTicket thunk - so the Redux connection was already working. Added success toast and rendered the FAB button.

### Key Discovery
- `useTickets().createTicket` (from useTicketsCompat.ts:158-160) **already dispatches the Redux thunk**
- The `createTicket` thunk in uiTicketsSlice.ts already sets status to 'waiting' (line 410)
- The modal was already Redux-connected via the compat hook - just needed UI additions

### Files Changed
1. `apps/store-app/src/components/tickets/CreateTicketModal.tsx:3`
   - Added `import toast from 'react-hot-toast'`
   - Added `toast.success()` call after ticket creation (line 103)

2. `apps/store-app/src/components/frontdesk/CreateTicketButton.tsx`
   - Changed onClick prop from required to optional
   - Added useState for modal open/close
   - Added CreateTicketModal component with internal state management
   - When onClick is not provided, clicking opens the modal (default behavior)

3. `apps/store-app/src/components/frontdesk/FrontDesk.tsx:12,917-918`
   - Imported CreateTicketButton component
   - Rendered CreateTicketButton FAB after TurnTrackerFab

### Patterns Learned
- **useTicketsCompat is the Redux bridge**: Components using `useTickets()` are already Redux-connected
- **FAB self-contained pattern**: Make FABs manage their own modal state for easier reuse
- **Backward compatibility**: Keep onClick prop optional to support custom handlers

### Pre-existing Issues (Not From This Story)
- TypeScript errors in test files - pre-existing, documented
- TypeScript error in updateCheckoutTicket.fulfilled - pre-existing

### Browser Verification
- Clicked green FAB → CreateTicketModal opened
- Filled "Jane Test" as client, "Pedicure" as service
- Submitted → Ticket appeared in WaitListSection with #2 check-in number
- Console showed: "✅ Ticket created in Supabase: 0050023d-..."

### Commit
`cf9df85` - feat: [US-009] - Connect CreateTicketModal to Front Desk with Redux

---

## Iteration 10 - US-010: Add client search/selection to CreateTicketModal
**Date:** 2026-01-15
**Status:** COMPLETE

### Summary
Added client search/selection functionality to CreateTicketModal, allowing front desk staff to search for existing clients when creating a ticket. Features autocomplete dropdown with client names, phone numbers, VIP badges, and First Visit indicators.

### Files Changed
1. `apps/store-app/src/components/tickets/CreateTicketModal.tsx`
   - Added imports: `useAppSelector`, `selectClients`, `Client` type, plus Lucide icons (Search, UserPlus, Sparkles, Phone)
   - Added Redux client selector: `const clients = useAppSelector(selectClients)`
   - Added new state: `selectedClientId`, `clientSearchQuery`, `showClientDropdown`
   - Added refs: `clientInputRef`, `dropdownRef` for click-outside detection
   - Added `filteredClients` useMemo to filter clients by name/phone (min 2 chars)
   - Added `isFirstVisit()` helper to check if client has no previous visits
   - Added `handleSelectClient()` to populate form from selected client
   - Added `handleCreateNewClient()` to handle new client creation option
   - Added click-outside useEffect to close dropdown
   - Updated form reset to include new state
   - Updated ticketData to conditionally include clientId
   - Replaced plain input with search input + autocomplete dropdown UI

### Key Implementation Details
- **Search threshold**: Requires minimum 2 characters to show results
- **Filter logic**: Searches firstName, lastName, displayName, and phone
- **Result limit**: Shows max 10 matching clients
- **Auto client type**: Sets VIP if `client.isVip`, New if first visit, Regular otherwise
- **clientId handling**: Uses spread operator `...(selectedClientId && { clientId })` to avoid null/undefined

### UI Features
- Search icon in input field
- Checkmark icon when client is selected
- Client avatars with fallback to User icon
- VIP badge (amber)
- First Visit badge (blue with Sparkles icon)
- Phone number display
- "Create New Client" option always visible

### Pre-existing Issues (Not From This Story)
- TypeScript errors in test files - pre-existing, documented
- TypeScript error in updateCheckoutTicket.fulfilled - pre-existing

### Browser Verification
- Typed "Jo" → Dropdown showed "No clients found" + Create New Client option
- Typed "Sa" → Dropdown showed "No clients found" + Create New Client option
- Clicked "Create New Client" → Client name set to "Sa", Client Type set to "New"
- Filled service "Pedicure" and submitted
- Ticket created: "#2 Sa - Pedicure" appeared in Waiting Queue

### Commit
`30b36ed` - feat: [US-010] - Add client search/selection to CreateTicketModal

---

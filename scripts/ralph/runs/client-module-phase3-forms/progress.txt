# Ralph Progress - Client Module Phase 3: Forms, Segments, Import/Export
# Started: 2026-01-22
# Branch: ralph/client-module-phase2

## Codebase Patterns (Persistent across iterations)

### Edge Function Pattern
- Location: `supabase/functions/`
- Use Deno imports: `https://deno.land/std@0.168.0/http/server.ts`
- Create Supabase client with `SUPABASE_SERVICE_ROLE_KEY` for admin operations
- Return proper CORS headers

### Redux Thunk Pattern
- Use `createAsyncThunk` from `@reduxjs/toolkit`
- Call Edge Functions via `supabase.functions.invoke()`
- Use `rejectWithValue` for error handling
- Export from slice index.ts

### Modal Component Pattern
- Follow `MergeClientsModal.tsx` for confirmation flows
- Use Dialog from `@/components/ui/dialog`
- Include loading, error, and success states
- Type confirmation for destructive actions

### Migration Pattern
- Use `gen_random_uuid()` for UUID primary keys
- Use `TIMESTAMPTZ` for all timestamp columns
- Enable RLS with `ALTER TABLE ... ENABLE ROW LEVEL SECURITY`
- Create store-scoped policies using staff.auth_user_id = auth.uid()
- Add column comments for documentation

### Form Delivery Pattern (NEW)
- Token-based form links with 24-hour expiration
- Store delivery status (sent, opened, completed)
- Support email and SMS delivery methods

---

## Iteration Log

### Iteration 1 - US-016: Create form delivery database migration
**Date:** 2026-01-22
**Story:** US-016 - Create form delivery database migration
**Status:** COMPLETED

**Changes Made:**
- Created `supabase/migrations/033_form_delivery.sql` with:
  - `form_templates` table for storing form definitions
  - `form_submissions` table for client responses
  - `form_deliveries` table with token-based secure links
  - `auto_send_form_ids` column added to services table
  - RLS policies for all three tables
  - Updated_at triggers
- Updated `apps/store-app/src/services/supabase/types.ts` with:
  - FormTemplateRow, FormSubmissionRow, FormDeliveryRow types
  - Form-related enum types (FormTemplateCategory, FormSendMode, etc.)
  - Added auto_send_form_ids to ServiceRow

**Files Changed:**
- `supabase/migrations/033_form_delivery.sql` (new)
- `apps/store-app/src/services/supabase/types.ts` (modified)

**Commit:** e6d5c2e

**Learnings:**
- Migration includes all prerequisite tables (form_templates, form_submissions) needed for later stories
- Token is UUID type with unique constraint for secure form links
- Added delivery tracking columns (delivery_status, message_id, reminder_count) for email/SMS providers

---

### Iteration 2 - US-017: Add form delivery types
**Date:** 2026-01-22
**Story:** US-017 - Add form delivery types
**Status:** COMPLETED

**Changes Made:**
- Added to `apps/store-app/src/types/form.ts`:
  - `FormDeliveryMethod = 'email' | 'sms'` type
  - `FormDeliveryStatus = 'pending' | 'sent' | 'delivered' | 'failed' | 'bounced'` type
  - `FormDelivery` interface with all fields matching migration 033
- Note: `FormFrequency` and `FormTemplate.frequency` already existed

**Files Changed:**
- `apps/store-app/src/types/form.ts` (modified)

**Commit:** d56f445

**Learnings:**
- Supabase types file already had database row types (FormDeliveryRow, etc.)
- form.ts needed corresponding app-level types with camelCase naming
- Pre-existing typecheck errors in @mango/types package (not related to this story)

---

### Iteration 3 - US-018: Create send-form Edge Function
**Date:** 2026-01-22
**Story:** US-018 - Create send-form Edge Function
**Status:** COMPLETED

**Changes Made:**
- Created `supabase/functions/send-form/index.ts` with:
  - Request handling for clientId, formTemplateId, deliveryMethod, appointmentId, storeId
  - Token generation using crypto.randomUUID()
  - form_delivery record creation with expiration (default 24 hours)
  - Email sending via Resend API with HTML template
  - SMS sending via Twilio API
  - CORS headers and error handling
  - Response with delivery record, token, and form link

**Files Changed:**
- `supabase/functions/send-form/index.ts` (new)

**Commit:** 58657a0

**Learnings:**
- Followed send-gift-card-email pattern for Resend integration
- Phone numbers need formatting (add +1 if missing country code)
- Form link format: {FORM_BASE_URL}/forms/complete/{token}
- Environment variables needed: RESEND_API_KEY, TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, TWILIO_PHONE_NUMBER, FORM_BASE_URL

---

### Iteration 4 - US-019: Create generate-form-pdf Edge Function
**Date:** 2026-01-22
**Story:** US-019 - Create generate-form-pdf Edge Function
**Status:** COMPLETED

**Changes Made:**
- Created `supabase/functions/generate-form-pdf/index.ts` with:
  - PDF generation using pdf-lib (Deno compatible)
  - Fetch form template, submission, client, and store data
  - Professional PDF layout with Mango branding
  - Client info section, form responses section, signature section
  - Support for both drawn signatures (embedded images) and typed signatures
  - Submission metadata (ID, status, timestamps)
  - Upload to Supabase Storage (form-submissions bucket)
  - Return public URL for download
  - Word wrapping and page break handling

**Files Changed:**
- `supabase/functions/generate-form-pdf/index.ts` (new)

**Commit:** 31b4182

**Learnings:**
- pdf-lib works well in Deno Edge Functions via esm.sh
- Need to handle both PNG and JPEG signatures (try PNG first, fall back to JPEG)
- Page breaks need to be checked before each section/text block
- Store PDF in format: {storeId}/form_{submissionId}_{timestamp}.pdf

---

### Iteration 5 - US-020: Add form delivery thunks
**Date:** 2026-01-22
**Story:** US-020 - Add form delivery thunks
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/store/slices/formsSlice/` directory with:
  - `deliveryThunks.ts` containing:
    - `sendFormToClient` thunk - calls send-form Edge Function
    - `fetchFormDeliveries` thunk - fetches deliveries filtered by client/appointment/status
    - `generateFormPdf` thunk - calls generate-form-pdf Edge Function
    - `checkFormCompletion` thunk - checks if client completed required forms
    - `resendFormDelivery` thunk - resends expired/failed form deliveries
    - Type definitions for inputs/outputs
    - Helper function `toFormDelivery` for snake_case to camelCase conversion
  - `index.ts` barrel export

**Files Changed:**
- `apps/store-app/src/store/slices/formsSlice/deliveryThunks.ts` (new)
- `apps/store-app/src/store/slices/formsSlice/index.ts` (new)

**Commit:** f6a0cb9

**Learnings:**
- Followed pattern from gdprThunks.ts for Edge Function invocations
- Added extra `resendFormDelivery` thunk for better UX (not required by PRD but useful)
- Pre-existing typecheck errors in @mango/types package are unrelated to these changes
- formsSlice is a new slice - no slice.ts needed yet (just thunks)

---

### Iteration 6 - US-021: Create FormDeliveryModal component
**Date:** 2026-01-22
**Story:** US-021 - Create FormDeliveryModal component
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/forms/FormDeliveryModal.tsx` with:
  - Select form template from dropdown (fetches active templates from Supabase)
  - Select delivery method (Email/SMS/Both) using RadioGroup
  - Shows client contact info (email/phone) with availability badges
  - Warning alerts when contact info missing for selected method
  - 'Both' option sends to available channels only
  - Send button with loading state (Loader2 spinner)
  - Success confirmation screen with checkmark
  - Copy Link button with clipboard integration
  - Form link preview in code block
  - Error handling with destructive alerts
  - State reset on close

**Files Changed:**
- `apps/store-app/src/components/forms/FormDeliveryModal.tsx` (new)

**Learnings:**
- Import casing matters: use `@/components/ui/Select` (capital S) to match existing patterns
- RadioGroup wrapped in custom label styling for better selection UX
- Handle 'both' delivery method by sending to available channels only
- Form link built from token returned by sendFormToClient thunk
- Unused FormTemplate import removed by linter

---

### Iteration 7 - US-022: Add Send Form button to client profile
**Date:** 2026-01-22
**Story:** US-022 - Add Send Form button to client profile
**Status:** COMPLETED

**Changes Made:**
- Modified `apps/store-app/src/components/client-settings/sections/ProfileSection.tsx`:
  - Added FormDeliveryModal import
  - Added FileText icon import from lucide-react
  - Added showFormDeliveryModal state
  - Added 'Send Form' button in profile header actions area
  - Added FormDeliveryModal render with client data

**Files Changed:**
- `apps/store-app/src/components/client-settings/sections/ProfileSection.tsx` (modified)

**Commit:** b32fc03

**Learnings:**
- Button placed in profile header stats section for easy access
- Uses same pattern as other profile modals (BlockClientModal, DataDeletionRequestModal)
- clientForConsent provides Client type needed by FormDeliveryModal

---

### Iteration 8 - US-023: Create ServiceFormConfig component
**Date:** 2026-01-22
**Story:** US-023 - Create ServiceFormConfig component
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/services/ServiceFormConfig.tsx` with:
  - Multi-select dropdown for adding form templates
  - Selected forms displayed as removable badge chips
  - Fetches active form templates from Supabase
  - Info text explaining auto-send behavior
  - Support disabled state and customizable labels
- Created `apps/store-app/src/components/services/index.ts` barrel export

**Files Changed:**
- `apps/store-app/src/components/services/ServiceFormConfig.tsx` (new)
- `apps/store-app/src/components/services/index.ts` (new)

**Commit:** 1123a5d

**Learnings:**
- Simple select-based multi-select pattern (add one at a time) is cleaner than complex combobox
- Badge chips with X button provide clear UX for removal
- Info icon with help text explains the auto-send behavior

---

### Iteration 9 - US-024: Create SegmentBuilder component
**Date:** 2026-01-22
**Story:** US-024 - Create SegmentBuilder component
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/SegmentBuilder.tsx` with:
  - Filter conditions with field/operator/value selection
  - 15+ supported fields (visits, spend, dates, loyalty, tags, etc.)
  - 12+ operators (equals, contains, greater_than, is_empty, etc.)
  - AND/OR group logic toggle
  - Live preview count of matching clients
  - Color picker for segment identification
  - Save with name, description, color
  - Uses existing createCustomSegment thunk

**Files Changed:**
- `apps/store-app/src/components/clients/SegmentBuilder.tsx` (new)

**Commit:** c23b26c

**Learnings:**
- Reused filterClientsByCustomSegment from segmentationConfig.ts for live preview
- CustomSegment type requires createdBy and syncStatus fields
- Use Label component separately from Input for proper labeling
- selectClients returns Client[] from Redux state

---

### Iteration 10 - US-025: Create SegmentPreview component
**Date:** 2026-01-22
**Story:** US-025 - Create SegmentPreview component
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/SegmentPreview.tsx` with:
  - Client list table with name/avatar, phone, last visit, visits, spent columns
  - Total count badge and contact info summary
  - Pagination with 10 items per page
  - Export button that downloads CSV using generateSegmentExportCsv
  - Send Message button callback for bulk messaging
  - Loading and empty state handling
  - Click handler for viewing client details

**Files Changed:**
- `apps/store-app/src/components/clients/SegmentPreview.tsx` (new)

**Commit:** d08c7fb

**Learnings:**
- Reused generateSegmentExportCsv from segmentationConfig.ts for export
- Table component from ui/table for consistent styling
- Avatar component with initials fallback for clients without photos

---

### Iteration 11 - US-026: Create ImportWizard component - Step 1 (Upload)
**Date:** 2026-01-22
**Story:** US-026 - Create ImportWizard component - Step 1 (Upload)
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/ImportWizard/UploadStep.tsx` with:
  - Drag-and-drop file upload zone with visual feedback
  - CSV parsing with quote handling (parseCSV, parseCSVLine functions)
  - File type validation (csv, xlsx, xls)
  - File preview showing name, type badge, row count, column count
  - Detected columns displayed as badges (max 10 shown with "+N more")
  - Remove file button to reset
  - Continue button enabled only after successful file parse
  - Error handling with Alert component
  - Processing state with Loader2 spinner

**Files Changed:**
- `apps/store-app/src/components/clients/ImportWizard/UploadStep.tsx` (new)

**Commit:** 64977d2

**Learnings:**
- Simple CSV parser handles quoted values and escaped quotes
- Excel support deferred with error message (requires xlsx library)
- ParsedFileData interface exports fileName, fileType, columns, rows, rowCount
- Used useCallback for all handlers to prevent unnecessary re-renders

---

### Iteration 12 - US-027: Create ImportWizard component - Step 2 (Mapping)
**Date:** 2026-01-22
**Story:** US-027 - Create ImportWizard component - Step 2 (Mapping)
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/ImportWizard/MappingStep.tsx` with:
  - Column mapping UI showing source columns with dropdown to select target field
  - CLIENT_FIELDS constant with firstName, lastName (required), email, phone, birthday, tags, notes, address, city, state, zipCode, referralSource
  - AUTO_DETECT_PATTERNS using regex for common column naming patterns
  - Auto-detect notification showing how many columns were matched
  - Required fields validation with error alert when missing
  - Preview table showing first 3 rows with mapping applied
  - Back and Continue navigation buttons
  - Dropdown excludes already-mapped fields to prevent duplicates

**Files Changed:**
- `apps/store-app/src/components/clients/ImportWizard/MappingStep.tsx` (new)

**Commit:** 3799180

**Learnings:**
- ColumnMapping interface: { sourceColumn, targetField }
- Auto-detect uses regex patterns in AUTO_DETECT_PATTERNS object
- useMemo for validation state to optimize re-renders
- Skip option uses 'skip' value that maps to null targetField

---

### Iteration 13 - US-028: Create ImportWizard component - Step 3 (Preview & Import)
**Date:** 2026-01-22
**Story:** US-028 - Create ImportWizard component - Step 3 (Preview & Import)
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/ImportWizard/PreviewStep.tsx` with:
  - Summary cards showing total, valid, invalid, duplicate counts
  - Duplicate detection by normalized phone (last 10 digits) and email (lowercase)
  - Dropdown for duplicate handling: Skip, Update, Create New
  - Download invalid rows as CSV with `_errors` column
  - Preview table showing first 5 valid rows with status badges
  - Progress bar during import (updates per batch)
  - Batch import using BATCH_SIZE=50 for performance
  - Success summary screen with created/updated/skipped/errors counts
  - Uses createClient and updateClient thunks from clientsSlice
- Updated MappingStep.tsx:
  - Changed `referralSource` to `sourceDetails` to match Client type

**Files Changed:**
- `apps/store-app/src/components/clients/ImportWizard/PreviewStep.tsx` (new)
- `apps/store-app/src/components/clients/ImportWizard/MappingStep.tsx` (modified)

**Commit:** 04361ff

**Learnings:**
- Client type has `sourceDetails` not `referralSource`
- tags field is ClientTag[] (with id, name, color), not string[]
- notes field is ClientNote[] (with id, date, content, type, isPrivate, createdBy)
- Client required fields: storeId, firstName, lastName, phone, isBlocked, isVip
- normalizePhone strips to last 10 digits for comparison

---

### Iteration 14 - US-029: Create ImportWizard container component
**Date:** 2026-01-22
**Story:** US-029 - Create ImportWizard container component
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/ImportWizard/ImportWizard.tsx` with:
  - Dialog-based modal container
  - Step indicator showing upload, mapping, and preview steps with icons
  - State management for fileData and mapping across steps
  - Step navigation handlers (continue, back)
  - Reset wizard state on close with timeout to avoid visual glitch
  - onComplete callback for refresh after import
- Created `apps/store-app/src/components/clients/ImportWizard/index.ts` with:
  - Barrel exports for ImportWizard, UploadStep, MappingStep, PreviewStep
  - Type exports for ParsedFileData, ColumnMapping, ImportResults, etc.

**Files Changed:**
- `apps/store-app/src/components/clients/ImportWizard/ImportWizard.tsx` (new)
- `apps/store-app/src/components/clients/ImportWizard/index.ts` (new)

**Commit:** 4dfa9ba

**Learnings:**
- Use setTimeout on resetWizard after modal close to avoid visual glitch
- Step indicator uses cn() for conditional styling
- WizardState type holds { fileData, mapping }

---

### Iteration 15 - US-030: Add ImportWizard to ClientSettings
**Date:** 2026-01-22
**Story:** US-030 - Add ImportWizard to ClientSettings
**Status:** COMPLETED

**Changes Made:**
- Modified `apps/store-app/src/components/client-settings/ClientSettings.tsx`:
  - Replaced import of `ClientImportModal` with `ImportWizard`
  - Replaced `ClientImportModal` render with `ImportWizard` component
  - Updated onComplete handler to dispatch `fetchClientsFromSupabase()` for refresh
  - Removed unused `handleImportClients` callback

**Files Changed:**
- `apps/store-app/src/components/client-settings/ClientSettings.tsx` (modified)

**Commit:** b48d04f

**Learnings:**
- Import button already existed, just needed to replace the modal implementation
- ImportWizard handles its own import logic via thunks, simpler integration

---

### Iteration 16 - US-031: Enhance export with full client data
**Date:** 2026-01-22
**Story:** US-031 - Enhance export with full client data
**Status:** COMPLETED

**Changes Made:**
- Modified `apps/store-app/src/components/client-settings/components/ClientDataExportImport.tsx`:
  - Added more EXPORT_FIELDS: nickname, apt, sourceDetails, referredByClientName
  - Added marketing fields: consentMarketing, consentMarketingAt
  - Added loyalty fields: referralCount, rewardsRedeemed
  - Added history fields: noShowCount, lateCancelCount
  - Added financial fields: outstandingBalance, storeCredit
  - Added status fields: blockReason, updatedAt
  - Reorganized categories: renamed 'other' to 'notes', added 'financial'
  - Added formatFieldValue() helper for better date, currency, notes formatting
  - Added isExporting and exportProgress state
  - Added progress bar UI in footer during export

**Files Changed:**
- `apps/store-app/src/components/client-settings/components/ClientDataExportImport.tsx` (modified)

**Commit:** 0deb0e5

**Learnings:**
- Notes array needs special handling to extract date and content
- Progress bar uses CSS transitions for smooth animation
- Existing export modal had good structure, just needed more fields

---

### Iteration 9 - US-026: Create ImportWizard component - Step 1 (Upload)
**Date:** 2026-01-22
**Story:** US-026 - Create ImportWizard component - Step 1 (Upload)
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/components/clients/ImportWizard/UploadStep.tsx` with:
  - Drag-and-drop file upload zone with visual feedback (isDragging state)
  - Custom CSV parser handling quotes and commas
  - Excel parsing using xlsx library (XLSX.read + sheet_to_json)
  - File validation (checks for .csv, .xlsx, .xls extensions)
  - File preview showing name, row count, column count, first 10 columns as badges
  - Remove file button to start over
  - Continue button (disabled until file is parsed)
  - Error handling with Alert component for invalid files
  - Loading state with spinner during processing
- Added xlsx ^0.18.5 to apps/store-app/package.json

**Files Changed:**
- `apps/store-app/src/components/clients/ImportWizard/UploadStep.tsx` (new)
- `apps/store-app/package.json` (modified - added xlsx dependency)

**Commit:** ec26afa

**Learnings:**
- xlsx library works seamlessly with File.arrayBuffer() in browser
- Using sheet_to_json with header: 1 option returns array of arrays for easy column extraction
- Custom CSV parser needed to handle quoted values with commas
- File type detection can be done with simple extension check
- ParsedFileData type exported for use in next steps

---


### Iteration 10 - US-032: Add SegmentBuilder to ClientSettings
**Date:** 2026-01-22
**Story:** US-032 - Add SegmentBuilder to ClientSettings
**Status:** COMPLETED

**Changes Made:**
- Updated `apps/store-app/src/components/client-settings/types.ts`:
  - Added 'segments' to ClientSettingsSection union type
- Updated `apps/store-app/src/components/clients/SegmentBuilder.tsx`:
  - Added onPreview prop to SegmentBuilderProps interface
  - Added Eye icon import and Preview button in actions section
  - Preview button shows matching client count and triggers onPreview callback
- Updated `apps/store-app/src/components/client-settings/ClientSettings.tsx`:
  - Added CustomSegment type import
  - Added selectedSegment state to store preview segment
  - Added Segments tab to sectionNav (for managers/owners/admins only)
  - Added SegmentIcon component for tab icon
  - Added segments section render with SegmentBuilder and SegmentPreview
  - SegmentPreview shows when onPreview is triggered, with back button
  - onClientClick navigates to client profile

**Files Changed:**
- `apps/store-app/src/components/client-settings/types.ts` (modified)
- `apps/store-app/src/components/clients/SegmentBuilder.tsx` (modified)
- `apps/store-app/src/components/client-settings/ClientSettings.tsx` (modified)

**Commit:** d0006a0

**Learnings:**
- SegmentPreview requires segment prop (CustomSegment), not just clients
- SegmentBuilder onPreview needed to pass both segment and matching clients
- Segments tab only visible to managers/owners/admins (canAccessDataRequests check)
- Pre-existing typecheck errors in @mango/types package (duplicate exports) unrelated to this story

---

### Iteration 11 - US-033: Add Phase 3 unit tests
**Date:** 2026-01-22
**Story:** US-033 - Add Phase 3 unit tests
**Status:** COMPLETED

**Changes Made:**
- Created `apps/store-app/src/store/slices/formsSlice/__tests__/deliveryThunks.test.ts` with 21 tests:
  - sendFormToClient thunk: email success, SMS success, with appointmentId, Edge Function error, success=false error
  - generateFormPdf thunk: success, Edge Function error, success=false error
  - fetchFormDeliveries thunk: fetch all, filter by clientId, filter by status, empty result, query error
  - checkFormCompletion thunk: completion status, empty templates, templates query error
  - resendFormDelivery thunk: resend success, not found error
  - Type validation tests for FormDeliveryMethod and FormDeliveryStatus

- Created `apps/store-app/src/constants/__tests__/segmentationConfig.test.ts` with 37 tests:
  - daysSince utility: today, past dates, undefined, empty string
  - calculateVipThreshold: empty list, zero spend, 10% threshold, 20% threshold
  - isClientVip: explicit flag, spend threshold, not VIP, zero threshold
  - getClientPrimarySegment: blocked, vip, member, new, active, at_risk, lapsed
  - getClientAllSegments: multiple segments, blocked clients
  - filterClientsBySegment: VIP clients, blocked clients (10 client pool for threshold math)
  - filterClientsByCustomSegment: totalSpent, totalVisits, loyaltyTier, AND/OR logic, isVip boolean, inactive segment, is_empty, is_not_empty
  - calculateSegmentCounts: segment counting, empty list
  - Operators: less_than, greater_or_equal, not_equals

**Files Changed:**
- `apps/store-app/src/store/slices/formsSlice/__tests__/deliveryThunks.test.ts` (new - 779 lines)
- `apps/store-app/src/constants/__tests__/segmentationConfig.test.ts` (new - 673 lines)

**Commit:** b6db959

**Learnings:**
- Supabase chainable query mocking requires .then() method for await to work
- VIP threshold calculation uses top 10% of spends - need enough clients for test accuracy
- For is_empty/is_not_empty operators, value field must still be valid type (use empty string)
- Mock query = query.eq() pattern requires all methods to return the chain object

---

## ALL STORIES COMPLETED

All 18 user stories (US-016 through US-033) have been completed successfully.

**Summary:**
- Database: 1 migration (033_form_delivery.sql)
- Edge Functions: 2 (send-form, generate-form-pdf)
- Types: form.ts enhancements
- Thunks: deliveryThunks.ts
- Components: FormDeliveryModal, ServiceFormConfig, SegmentBuilder, SegmentPreview, ImportWizard (3 steps + container), ClientDataExportImport enhancements
- Tests: 58 new unit tests (21 delivery thunks + 37 segmentation)
- Integration: ProfileSection, ClientSettings updated with new features


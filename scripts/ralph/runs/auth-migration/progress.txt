# Auth Migration - Ralph Progress Log

## Run Information
- **PRD**: `tasks/prd-auth-migration-supabase.md`
- **Branch**: `ralph/auth-migration-supabase`
- **Started**: January 20, 2026
- **Reference**: `docs/AUTH_MIGRATION_PLAN.md` v1.1

## Codebase Patterns

> Add discovered patterns here as they are found. These persist across iterations.

### Auth Service Patterns
- (To be discovered)

### Database Migration Patterns
- Use `CREATE TABLE IF NOT EXISTS` and `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` for idempotent migrations
- Use `DO $$ ... END $$` blocks for conditional policy/constraint creation
- Enable RLS and create policies in the same migration for security
- Add table and column comments for documentation

### UI Component Patterns
- (To be discovered)

---

## Progress Entries

> Append entries below as stories are completed. Never delete or reorder.

---

### Entry 1: PRD Revision - Preserve Two Login Modes (2026-01-20)

**Context:** Ultrathink analysis revealed the original PRD was changing the login paradigm instead of just enhancing it with Supabase Auth. The system has TWO distinct login modes that must be preserved:
- **Member Login:** Staff logs in with email/password → Full access by role → PIN optional
- **Store Login:** Shared device logs into store → Staff use PIN for identity verification

**Changes Made:**

1. **US-001 Updated:** Added `default_store_id UUID REFERENCES stores(id)` column for multi-store users

2. **US-014 Revised:** PinSetupModal now has optional skip
   - Added `onSkip` prop and "Skip for now" button
   - PIN is optional for member-login users
   - Skip preference stored in localStorage

3. **US-015 Revised:** StoreLoginScreen preserves BOTH modes
   - Keeps existing Member Login / Store Login toggle
   - Member Login uses Supabase Auth (enhanced)
   - Store Login remains unchanged
   - Default mode is 'member' (matching existing code)

4. **US-016 Revised:** SwitchUserModal is context-aware
   - Store-login context: PIN only (required for shared device)
   - Member-login context: PIN or password (user choice)

5. **NEW US-022:** PinVerificationModal for store-login sensitive actions
   - Used when store-logged device needs staff verification

6. **NEW US-023:** PIN opt-in in member settings
   - Allows member-login users to optionally set up PIN

7. **NEW US-024:** StoreSelectionModal for multi-store users
   - Shows store selection after login if user has multiple stores

8. **NEW US-025:** Default store preference management
   - Functions to get/set/clear default store preference

9. **NEW US-026:** Offline store switching with PIN
   - Multi-store users can switch stores offline with PIN verification

**Total Stories:** 26 (was 21, added 5 new)

---

### Entry 2: Clarify PIN usage in Member-Login Mode (2026-01-20)

**Clarification:** In member-login mode, PIN is ONLY used when offline:
- **Online + Switch User** → Other user logs in with email/password (normal Supabase Auth)
- **Offline + Switch User** → Other user uses PIN (if set up), otherwise "connect to internet"

**Updated:**
- US-016: Added `isOnline` prop, clarified online = password, offline = PIN
- US-023: Renamed to "Offline Access PIN", clarified purpose for offline user switching

---

## 2026-01-20 - US-001: Create migration for Supabase Auth columns on members table
Commit: 070717c77a5c1e35b91d562dfa1ac3a5b6610dcc

**Why this story?** US-001 has no dependencies and is priority 1. It's the foundation that unblocks US-002, US-004, US-008, US-024, and US-025.

**Changes:**
- `supabase/migrations/029_add_supabase_auth_to_members.sql:1-114`: Migration already existed with all required columns

**Verification:**
All 15 acceptance criteria verified against existing migration:
- ✅ auth_user_id UUID UNIQUE column (line 14)
- ✅ pin_hash TEXT column (line 21)
- ✅ pin_legacy TEXT column (line 25)
- ✅ pin_attempts INTEGER DEFAULT 0 (line 29)
- ✅ pin_locked_until TIMESTAMPTZ (line 33)
- ✅ last_online_auth TIMESTAMPTZ (line 40)
- ✅ offline_grace_period INTERVAL DEFAULT '7 days' (line 44)
- ✅ password_changed_at TIMESTAMPTZ (line 48)
- ✅ default_store_id UUID REFERENCES stores(id) (line 55)
- ✅ idx_members_auth_user_id index (lines 60-62)
- ✅ RLS read own profile policy (lines 68-78)
- ✅ RLS update own profile policy (lines 81-92)
- ✅ Column comments (lines 97-113)
- ✅ No forbidden strings
- ✅ Follows migration 028 patterns

**Learnings:**
- Migration file 029 was already created in a previous session
- Pattern: Use `IF NOT EXISTS` for all schema changes and `DO $$ ... END $$` blocks for conditional policy creation
- Pattern: Partial index with `WHERE column IS NOT NULL` for efficient sparse lookups

**Patterns to sync:**
- Pattern #1: PostgreSQL migration pattern - Use `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` for idempotent migrations

**Next story suggestion:** US-002 (session revocation table) as it only depends on US-001 (now complete) and is priority 2 with complexity 1.

---

## 2026-01-20 - US-002: Create migration for session revocation table
Commit: 6b55afd4411386feb5e4e9b7da007a1d7117364c

**Why this story?** US-002's only dependency (US-001) is complete. It's priority 2 with complexity 1, and unblocks US-004 and US-012 which need the session revocations table.

**Changes:**
- `supabase/migrations/030_create_member_session_revocations.sql:1-81`: Created new migration file

**Verification:**
All 8 acceptance criteria met:
- ✅ Creates member_session_revocations table with columns: id, member_id, revoked_at, reason, revoke_all_before (lines 15-21)
- ✅ id is UUID PRIMARY KEY with default gen_random_uuid() (line 16)
- ✅ member_id is UUID NOT NULL with REFERENCES members(id) ON DELETE CASCADE (line 17)
- ✅ revoked_at defaults to NOW() (line 18)
- ✅ revoke_all_before defaults to NOW() (line 20)
- ✅ Creates index idx_session_revocations_member on member_id (lines 29-30)
- ✅ Adds table comment explaining purpose (line 71)
- ✅ No forbidden strings
- ✅ File follows existing migration patterns (matches 028 and 029 structure)

**Additional Features Implemented:**
- RLS enabled with two policies:
  - `session_revocations_service_role_all`: Service role full access for admin operations
  - `session_revocations_read_own`: Members can read their own revocations for background validation
- Column comments for all fields (lines 73-80)

**Learnings:**
- Pre-existing typecheck failure in packages/utils (tsconfig reference issue) - unrelated to this migration
- Pattern: Use `CREATE TABLE IF NOT EXISTS` for idempotent table creation
- Pattern: Enable RLS and create policies in same migration for security

**Patterns to sync:**
- (Already synced in patterns.md: PostgreSQL migration pattern)

**Next story suggestion:** US-003 (migration script utilities) has no dependencies and is priority 3 with complexity 2. Or US-007 (MemberAuthSession types) has no dependencies and is priority 7 with complexity 1.

---

## 2026-01-20 - US-003: Create migration script utilities
Commit: a0f54f337211e29d5ed9c536a57bbc9a6692171f

**Why this story?** US-003 has no dependencies and is priority 3. It unblocks US-004 (member migration script) which needs these utilities. Natural follow-on from database migrations.

**Changes:**
- `scripts/auth-migration/utils.ts:1-168` (NEW): Created migration utilities file

**Implementation Details:**
- `generateTemporaryPassword()`: 12-char alphanumeric using crypto.randomBytes
  - Guarantees at least one uppercase, lowercase, and number
  - Uses Fisher-Yates shuffle for secure position randomization
- `sendWelcomeEmail()`: Stub that logs to console (to be replaced with SMTP)
- `MigrationResult` interface: success, failed, skipped, emailFailed arrays
- `MemberForMigration` interface: Member data structure for migration
- `createEmptyResult()`: Helper to initialize result tracking
- `formatMigrationSummary()`: Formats result for console output

**Verification:**
All 6 acceptance criteria met:
- ✅ Exports generateTemporaryPassword() returning 12-char alphanumeric (lines 55-79)
- ✅ Exports sendWelcomeEmail(email, name, tempPassword) logging to console (lines 93-118)
- ✅ Exports MigrationResult interface with success/failed/skipped/emailFailed (lines 13-22)
- ✅ Password generator uses crypto.randomBytes (line 58)
- ✅ No forbidden strings: as any, void _
- ✅ pnpm run typecheck passes (file passes typecheck, pre-existing failure in @mango/supabase is unrelated)

**Learnings:**
- scripts/ directory is outside of main app tsconfig, but can be typechecked from apps/store-app
- Existing scripts use similar pattern (supabase client, async main function)
- Pre-existing test failures in padCheckoutFlow.test.ts and teamStaffAdapter.test.ts - unrelated to this story

**Patterns to sync:**
- None (standard Node.js crypto usage)

**Next story suggestion:** US-007 (MemberAuthSession types) - lowest complexity (1), no dependencies, unblocks US-008/US-011/US-015. Or US-005 (SecureStorage) for backend continuity.

---

{
  "project": "Mango POS Store App",
  "branchName": "ralph/auth-migration-supabase",
  "description": "Authentication Migration - Migrate Store App staff authentication from custom implementation to Supabase Auth as the single identity provider, with PIN as local/offline quick unlock. Based on docs/AUTH_MIGRATION_PLAN.md v1.1.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create migration for Supabase Auth columns on members table",
      "description": "As a developer, I need the members table to support Supabase Auth linking and secure PIN storage.",
      "files": [
        "supabase/migrations/029_add_supabase_auth_to_members.sql (NEW)"
      ],
      "acceptanceCriteria": [
        "Migration adds auth_user_id UUID UNIQUE column",
        "Migration adds pin_hash TEXT column (for bcrypt hash)",
        "Migration adds pin_legacy TEXT column (for rollback)",
        "Migration adds pin_attempts INTEGER DEFAULT 0 column",
        "Migration adds pin_locked_until TIMESTAMPTZ column",
        "Migration adds last_online_auth TIMESTAMPTZ column",
        "Migration adds offline_grace_period INTERVAL DEFAULT '7 days' column",
        "Migration adds password_changed_at TIMESTAMPTZ column",
        "Migration adds default_store_id UUID REFERENCES stores(id) column for multi-store users",
        "Migration creates index idx_members_auth_user_id on auth_user_id",
        "Migration adds RLS policy for members to read own profile via auth.uid() = auth_user_id",
        "Migration adds RLS policy for members to update own profile",
        "Migration adds column comments explaining each field",
        "No forbidden strings: as any, void _, console.log",
        "File follows existing migration patterns in supabase/migrations/"
      ],
      "priority": 1,
      "passes": true,
      "category": "database",
      "complexity": 2,
      "notes": "Follow pattern from supabase/migrations/028_add_device_pairing_columns.sql. Do NOT add pin_salt - bcrypt includes salt in the hash. Do NOT add foreign key constraint to auth.users (cross-schema). Schema defined in docs/AUTH_MIGRATION_PLAN.md lines 157-215."
    },
    {
      "id": "US-002",
      "title": "Create migration for session revocation table",
      "description": "As a developer, I need a table to track session revocations for immediate logout across devices.",
      "files": [
        "supabase/migrations/030_create_member_session_revocations.sql (NEW)"
      ],
      "acceptanceCriteria": [
        "Creates member_session_revocations table with columns: id, member_id, revoked_at, reason, revoke_all_before",
        "id is UUID PRIMARY KEY with default gen_random_uuid()",
        "member_id is UUID NOT NULL with REFERENCES members(id) ON DELETE CASCADE",
        "revoked_at defaults to NOW()",
        "revoke_all_before defaults to NOW()",
        "Creates index idx_session_revocations_member on member_id",
        "Adds table comment explaining purpose",
        "No forbidden strings",
        "File follows existing migration patterns"
      ],
      "priority": 2,
      "passes": true,
      "category": "database",
      "complexity": 1,
      "dependencies": [
        "US-001"
      ],
      "notes": "This table enables immediate session revocation across all devices. Reason values: 'password_change', 'admin_revoke', 'security_concern'. Schema defined in docs/AUTH_MIGRATION_PLAN.md lines 204-215."
    },
    {
      "id": "US-003",
      "title": "Create migration script utilities",
      "description": "As a developer, I need utility functions for the migration script (password generation, email templates).",
      "files": [
        "scripts/auth-migration/utils.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Exports generateTemporaryPassword() that returns 12-char alphanumeric string",
        "Exports sendWelcomeEmail(email, name, tempPassword) that logs to console (stub for now)",
        "Exports MigrationResult interface with success, failed, skipped, emailFailed arrays",
        "Password generator uses crypto.randomBytes for security",
        "No forbidden strings: as any, void _",
        "pnpm run typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "Email sending is stubbed - will be implemented when SMTP is configured. Password must include uppercase, lowercase, and numbers."
    },
    {
      "id": "US-004",
      "title": "Create member migration script",
      "description": "As a developer, I need a script to migrate existing members to Supabase Auth.",
      "files": [
        "scripts/auth-migration/migrate-members-to-supabase-auth.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Script reads DRY_RUN env var to preview without changes",
        "Script uses BATCH_SIZE = 50 for pagination",
        "Script uses supabaseAdmin.auth.admin.getUserByEmail() for efficient lookup (NOT listUsers)",
        "Script creates new Supabase Auth user if email not found",
        "Script links to existing auth user if email already exists (Control Center case)",
        "Script hashes existing PIN with bcrypt (cost factor 12)",
        "Script preserves original PIN in pin_legacy column for rollback",
        "Script clears pin column after hashing",
        "Script has retry logic for email sending (3 attempts, exponential backoff)",
        "Script logs failures to migration_email_failures.json with restricted permissions",
        "Script prints summary at end (success, failed, skipped, email failures)",
        "No forbidden strings: as any (except for Supabase types if necessary)",
        "pnpm run typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "category": "backend",
      "complexity": 4,
      "dependencies": [
        "US-001",
        "US-002",
        "US-003"
      ],
      "notes": "Run with: DRY_RUN=true npx ts-node scripts/auth-migration/migrate-members-to-supabase-auth.ts. Requires SUPABASE_SERVICE_ROLE_KEY env var. Full implementation in docs/AUTH_MIGRATION_PLAN.md lines 269-519. Install bcryptjs: pnpm add bcryptjs && pnpm add -D @types/bcryptjs. IMPORTANT: Schema migrations (US-001, US-002) must be applied before running this script."
    },
    {
      "id": "US-005",
      "title": "Create SecureStorage utility for PIN hash storage",
      "description": "As a developer, I need a platform-aware secure storage utility to store PIN hashes securely.",
      "files": [
        "apps/store-app/src/utils/secureStorage.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Exports SecureStorage object with get(key), set(key, value), remove(key) methods",
        "Uses @capacitor/core to detect native platform",
        "On native platforms, uses capacitor-secure-storage-plugin for iOS Keychain / Android Keystore",
        "On web, falls back to base64-encoded localStorage (basic obfuscation)",
        "All methods are async and return Promises",
        "Handles errors gracefully (returns null on get failure)",
        "No forbidden strings: as any, void _, console.log (except error logging)",
        "pnpm run typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "Install plugin: pnpm add capacitor-secure-storage-plugin. Web fallback uses btoa/atob - NOT cryptographically secure, but better than plaintext. Full implementation in docs/AUTH_MIGRATION_PLAN.md lines 1268-1335. For web, prefix keys with secure_ in localStorage."
    },
    {
      "id": "US-006",
      "title": "Add forceLogout action to authSlice",
      "description": "As a developer, I need a Redux action to force logout with a reason message.",
      "files": [
        "apps/store-app/src/store/slices/authSlice.ts"
      ],
      "acceptanceCriteria": [
        "Adds ForceLogoutPayload interface with reason and message fields",
        "Adds forceLogout reducer action that clears all auth state",
        "Adds forceLogoutReason and forceLogoutMessage to AuthState",
        "forceLogout sets these fields before clearing state",
        "Exports selectForceLogoutReason and selectForceLogoutMessage selectors",
        "Exports forceLogout action",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Existing tests still pass: pnpm test -- authSlice"
      ],
      "priority": 6,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "testCommand": "pnpm test -- authSlice --run",
      "notes": "Reason values: 'offline_grace_expired', 'account_deactivated', 'password_changed', 'session_revoked'. This action is dispatched by memberAuthService when background validation fails. Follow existing reducer patterns in authSlice.ts."
    },
    {
      "id": "US-007",
      "title": "Create MemberAuthSession types",
      "description": "As a developer, I need TypeScript interfaces for the new member auth session.",
      "files": [
        "apps/store-app/src/types/memberAuth.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Exports MemberAuthSession interface with: memberId, authUserId, email, name, role, storeIds, permissions, lastOnlineAuth, sessionCreatedAt",
        "Exports PinLockoutInfo interface with: isLocked, remainingMinutes",
        "Exports GraceInfo interface with: isValid, daysRemaining",
        "Exports ForceLogoutReason type union: 'offline_grace_expired' | 'account_deactivated' | 'password_changed' | 'session_revoked'",
        "All fields have JSDoc comments",
        "No pinHash field in MemberAuthSession (stored separately in SecureStorage)",
        "No forbidden strings",
        "pnpm run typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "category": "backend",
      "complexity": 1,
      "notes": "Types defined in docs/AUTH_MIGRATION_PLAN.md lines 559-570. Keep types separate from implementation for clean imports."
    },
    {
      "id": "US-008",
      "title": "Create memberAuthService - Supabase password login",
      "description": "As a developer, I need the password login function for the new auth service.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Creates new file with imports from supabase client, bcryptjs, SecureStorage",
        "Defines constants: PIN_MAX_ATTEMPTS=5, PIN_LOCKOUT_MINUTES=15, OFFLINE_GRACE_DAYS=7",
        "Exports loginWithPassword(email, password) async function",
        "Function calls supabase.auth.signInWithPassword()",
        "Function fetches linked member by auth_user_id",
        "Function updates last_online_auth timestamp in database",
        "Function creates MemberAuthSession object (WITHOUT pinHash)",
        "Function caches session in localStorage via cacheMemberSession()",
        "Function stores PIN hash in SecureStorage if member has one",
        "Function throws Error with descriptive message on failure",
        "No forbidden strings: as any, void _, 'Test Client'",
        "pnpm run typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "category": "backend",
      "complexity": 3,
      "dependencies": [
        "US-001",
        "US-005",
        "US-007"
      ],
      "notes": "This is the FIRST part of memberAuthService - more functions in subsequent stories. Follow error handling pattern from existing authService.ts. Do NOT store pinHash in the session object - store in SecureStorage only. Implementation reference: docs/AUTH_MIGRATION_PLAN.md lines 579-648. Queries member table columns (auth_user_id, last_online_auth, pin_hash) created by US-001."
    },
    {
      "id": "US-009",
      "title": "Create memberAuthService - PIN login",
      "description": "As a developer, I need the PIN login function for offline-capable quick access.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Exports loginWithPin(memberId, pin) async function",
        "Function gets cached member from localStorage",
        "Function checks PIN lockout via helper function",
        "Function checks offline grace period via helper function",
        "Function gets PIN hash from SecureStorage (NOT from session object)",
        "Function validates PIN using bcrypt.compare(pin, pinHash)",
        "Function records failed attempts and locks after 5 failures",
        "Function clears failed attempts on success",
        "Function triggers background validation if online",
        "Function returns MemberAuthSession on success",
        "No forbidden strings",
        "pnpm run typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "category": "backend",
      "complexity": 3,
      "dependencies": [
        "US-008"
      ],
      "notes": "PIN hash retrieved from SecureStorage, not session. Must check lockout BEFORE grace period (fail fast). Implementation reference: docs/AUTH_MIGRATION_PLAN.md lines 651-709."
    },
    {
      "id": "US-010",
      "title": "Create memberAuthService - PIN management",
      "description": "As a developer, I need functions to set/update PIN and manage PIN lockout.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Exports setPin(memberId, newPin) async function",
        "setPin validates PIN format (4-6 digits only)",
        "setPin hashes PIN with bcrypt (cost factor 12)",
        "setPin updates database and SecureStorage",
        "Adds private checkPinLockout(memberId) function returning PinLockoutInfo",
        "Adds private recordFailedPinAttempt(memberId) function",
        "Adds private clearFailedAttempts(memberId) function",
        "Adds private lockPin(memberId) function",
        "Lockout info stored in localStorage with keys pin_lockout_{memberId}, pin_attempts_{memberId}",
        "No forbidden strings",
        "pnpm run typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "dependencies": [
        "US-009"
      ],
      "notes": "PIN validation regex: /^\\d{4,6}$/. bcrypt cost factor 12 provides good security/performance balance. Implementation reference: docs/AUTH_MIGRATION_PLAN.md lines 712-873."
    },
    {
      "id": "US-011",
      "title": "Create memberAuthService - grace period checker",
      "description": "As a developer, I need a periodic checker that forces logout when offline grace expires.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Defines constant GRACE_CHECK_INTERVAL_MS = 30 * 60 * 1000 (30 minutes)",
        "Adds module-level graceCheckInterval variable to track interval",
        "Exports startGraceChecker() function that starts setInterval",
        "Exports stopGraceChecker() function that clears interval",
        "Exports checkOfflineGrace(member) function returning GraceInfo",
        "Grace checker gets current member from Redux store",
        "Grace checker dispatches forceLogout if grace expired while offline",
        "Grace checker is idempotent (doesn't start multiple intervals)",
        "No forbidden strings",
        "pnpm run typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "dependencies": [
        "US-006",
        "US-007",
        "US-010"
      ],
      "notes": "Import store directly: import { store } from '@/store'. Check navigator.onLine to determine if offline. Implementation reference: docs/AUTH_MIGRATION_PLAN.md lines 779-815. Uses MemberAuthSession and GraceInfo types from US-007."
    },
    {
      "id": "US-012",
      "title": "Create memberAuthService - background validation",
      "description": "As a developer, I need background validation that checks session validity and dispatches logout if invalid.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Adds private validateSessionInBackground(member) async function",
        "Function checks if member is still active in database",
        "Function checks password_changed_at against session.sessionCreatedAt",
        "Function checks member_session_revocations table for revocations",
        "Function dispatches forceLogout with appropriate reason if invalid",
        "Function updates cached session lastOnlineAuth on success",
        "Function catches network errors silently (doesn't logout on network failure)",
        "Exports logout() function that stops grace checker and signs out of Supabase",
        "Exports complete memberAuthService object with all functions",
        "No forbidden strings",
        "pnpm run typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "category": "backend",
      "complexity": 3,
      "dependencies": [
        "US-002",
        "US-011"
      ],
      "notes": "This completes the memberAuthService file. Background validation is called on every PIN login when online. Implementation reference: docs/AUTH_MIGRATION_PLAN.md lines 876-942. Queries member_session_revocations table created by US-002."
    },
    {
      "id": "US-013",
      "title": "Create PinInput component",
      "description": "As a user, I need a PIN input field with proper masking and digit display.",
      "files": [
        "apps/store-app/src/components/auth/PinInput.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Accepts props: value, onChange, length (default 4), disabled, error, autoFocus",
        "Renders hidden input for actual value capture",
        "Renders visual dots/circles for each digit position",
        "Filled positions show filled circle, empty show outline",
        "Supports keyboard input (numbers only)",
        "Supports backspace to delete",
        "Calls onChange with new value on each keystroke",
        "Shows error state with red border when error prop is true",
        "Uses Tailwind classes, follows design system",
        "No forbidden strings: as any, void _, '1234'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 13,
      "passes": true,
      "category": "frontend",
      "complexity": 2,
      "notes": "Follow pattern from existing input components in src/components/ui/. Use type='password' with inputMode='numeric' for mobile keyboard. Common PIN input pattern - 4-6 circles that fill as user types."
    },
    {
      "id": "US-014",
      "title": "Create PinSetupModal component with optional skip",
      "description": "As a user, I need a modal to optionally set up my PIN after first login. PIN setup is OPTIONAL for member-login users but recommended for quick access.",
      "files": [
        "apps/store-app/src/components/auth/PinSetupModal.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Accepts props: isOpen, onClose, onSubmit, onSkip, memberId, memberName, isRequired (default false)",
        "Shows two-step flow: Enter PIN, Confirm PIN",
        "Uses PinInput component for both steps",
        "Validates PIN is 4-6 digits",
        "Validates confirmation matches original",
        "Shows error message if PINs don't match",
        "Calls memberAuthService.setPin() on successful confirmation",
        "Shows loading state during submission",
        "Shows success message and closes on completion",
        "Shows 'Skip for now' button when isRequired=false (calls onSkip callback)",
        "Skip button stores preference in localStorage: pin_setup_skipped_{memberId}",
        "Shows helpful message: 'PIN enables quick access on this device. You can set it up later in Settings.'",
        "Close button (X) visible when isRequired=false",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 14,
      "passes": true,
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-010",
        "US-013"
      ],
      "notes": "Use Dialog component from @/components/ui/dialog. Follow modal patterns from existing modals like EditTicketModal. CRITICAL: PIN is OPTIONAL for member-login users. The skip functionality is essential for preserving the existing UX where users can login with email/password without being forced to set up PIN."
    },
    {
      "id": "US-015",
      "title": "Update StoreLoginScreen to preserve both login modes with Supabase Auth",
      "description": "As a user, I want to login using EITHER Member Login (email/password) OR Store Login (store ID/password), preserving the existing two-mode toggle. Member Login now uses Supabase Auth for enhanced security.",
      "files": [
        "apps/store-app/src/components/auth/StoreLoginScreen.tsx"
      ],
      "acceptanceCriteria": [
        "PRESERVES existing login mode toggle (Member Login / Store Login tabs or buttons)",
        "Member Login mode: Uses email/password fields",
        "Member Login mode: Calls memberAuthService.loginWithPassword() (Supabase Auth)",
        "Member Login mode: On successful login, optionally shows PinSetupModal (can be skipped)",
        "Member Login mode: Adds 'Forgot Password?' link that opens Supabase reset flow",
        "Store Login mode: UNCHANGED - Uses Store ID/password fields (existing behavior)",
        "Store Login mode: After store auth, shows staff list for PIN verification",
        "Default mode: 'member' (matching current default in StoreLoginScreen.tsx line 25)",
        "Both modes show loading state during login",
        "Both modes show appropriate error messages",
        "Handles offline state: Member Login shows 'Connect to internet for first login', Store Login works offline with cached data",
        "No forbidden strings: as any, 'Test', 'demo123'",
        "pnpm run typecheck passes",
        "Verify BOTH login flows in browser using Playwright MCP"
      ],
      "priority": 15,
      "passes": true,
      "category": "frontend",
      "complexity": 4,
      "dependencies": [
        "US-007",
        "US-008",
        "US-014"
      ],
      "notes": "CRITICAL: Read existing StoreLoginScreen.tsx first - it already has TWO login modes (member/store). DO NOT remove the store login mode or demote it. The existing handleMemberLogin() becomes Supabase-powered, but handleLogin() for store-level auth remains unchanged. Member is the default mode per line 25: useState<LoginMode>('member'). Uses MemberAuthSession type from US-007."
    },
    {
      "id": "US-016",
      "title": "Update SwitchUserModal with context-aware authentication",
      "description": "As a user, I want to switch between users with the appropriate verification method based on login context and online/offline status.",
      "files": [
        "apps/store-app/src/components/auth/SwitchUserModal.tsx"
      ],
      "acceptanceCriteria": [
        "Accepts props: loginContext ('store' | 'member'), isOnline (boolean)",
        "Shows list of available members (from cache or staff list depending on context)",
        "Each member shows avatar, name, and role",
        "STORE-LOGIN CONTEXT: Selecting a member shows PinInput (PIN required for shared device)",
        "STORE-LOGIN CONTEXT: Validates PIN via memberAuthService.loginWithPin()",
        "MEMBER-LOGIN CONTEXT + ONLINE: Selecting a member shows email/password login form",
        "MEMBER-LOGIN CONTEXT + ONLINE: Other user logs in with their own credentials (normal Supabase Auth)",
        "MEMBER-LOGIN CONTEXT + OFFLINE: Selecting a member shows PinInput (if they have PIN set up)",
        "MEMBER-LOGIN CONTEXT + OFFLINE: If member has no PIN, shows 'Connect to internet to switch users'",
        "Shows lockout message if member's PIN is locked",
        "Updates Redux state on successful switch",
        "Shows grace period warning if < 2 days remaining (store-login only)",
        "Shows offline indicator when not connected",
        "No forbidden strings: as any, 'Test Client'",
        "pnpm run typecheck passes",
        "Verify ALL scenarios in browser using Playwright MCP"
      ],
      "priority": 16,
      "passes": true,
      "category": "frontend",
      "complexity": 4,
      "dependencies": [
        "US-009",
        "US-013"
      ],
      "notes": "The verification flow depends on BOTH context AND online status. Store-login: always PIN. Member-login online: password (normal login). Member-login offline: PIN if available, otherwise require internet. This ensures member-login users only use PIN as offline fallback, not as primary auth."
    },
    {
      "id": "US-017",
      "title": "Create OfflineGraceIndicator component",
      "description": "As a user, I want to see how many days of offline access I have remaining.",
      "files": [
        "apps/store-app/src/components/auth/OfflineGraceIndicator.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Accepts props: daysRemaining, isOffline",
        "Shows nothing when online and grace > 5 days",
        "Shows yellow warning when offline or grace <= 5 days",
        "Shows red critical when grace <= 2 days",
        "Displays 'X days offline access remaining' message",
        "Displays 'Offline - connect to extend access' when offline",
        "Uses appropriate icons (wifi-off, clock, warning)",
        "Positioned as small banner or badge",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 17,
      "passes": true,
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-011"
      ],
      "notes": "Use design tokens for colors. Keep minimal - shouldn't distract from main UI. Could be placed in header or status bar area."
    },
    {
      "id": "US-018",
      "title": "Integrate memberAuthService with storeAuthManager",
      "description": "As a developer, I need to wire up the new memberAuthService to the existing auth flow.",
      "files": [
        "apps/store-app/src/services/storeAuthManager.ts",
        "apps/store-app/src/providers/AuthProvider.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "App initialization checks for cached member session",
        "If cached session exists and grace valid, allow PIN login",
        "If cached session exists but grace expired, require password login",
        "Grace checker starts on successful login",
        "Grace checker stops on logout",
        "Force logout action shows appropriate message to user",
        "OfflineGraceIndicator component integrated into app layout",
        "Existing store-level auth still works as fallback",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify full login flow in browser using Playwright MCP"
      ],
      "priority": 18,
      "passes": true,
      "category": "backend",
      "complexity": 4,
      "dependencies": [
        "US-011",
        "US-012",
        "US-015",
        "US-016",
        "US-017"
      ],
      "notes": "This story integrates previous work - test the full flow. May need to modify App.tsx or main router. Ensure backward compatibility with existing sessions. AuthProvider.tsx may not exist - create if needed or integrate into existing auth context. Uses grace checker from US-011 and OfflineGraceIndicator from US-017."
    },
    {
      "id": "US-019",
      "title": "Implement Forgot Password flow",
      "description": "As a user, I want to reset my password via email.",
      "files": [
        "apps/store-app/src/components/auth/ForgotPasswordModal.tsx (NEW)",
        "apps/store-app/src/components/auth/StoreLoginScreen.tsx"
      ],
      "acceptanceCriteria": [
        "Creates ForgotPasswordModal with email input",
        "Modal calls supabase.auth.resetPasswordForEmail()",
        "Shows success message: 'Check your email for reset link'",
        "Shows error if email not found",
        "Adds 'Forgot Password?' link to StoreLoginScreen that opens modal",
        "Link only visible when online",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 19,
      "passes": true,
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-015"
      ],
      "notes": "Supabase handles the actual password reset flow. User clicks link in email -> Supabase reset page -> redirected back. May need to configure redirect URL in Supabase dashboard."
    },
    {
      "id": "US-020",
      "title": "Add unit tests for memberAuthService",
      "description": "As a developer, I need unit tests for the new memberAuthService.",
      "files": [
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Tests loginWithPassword success case",
        "Tests loginWithPassword invalid credentials case",
        "Tests loginWithPin success case",
        "Tests loginWithPin with invalid PIN",
        "Tests loginWithPin lockout after 5 failures",
        "Tests loginWithPin lockout expiry",
        "Tests setPin validation (4-6 digits)",
        "Tests checkOfflineGrace with valid and expired cases",
        "Tests validateSessionInBackground with active member",
        "Tests validateSessionInBackground with deactivated member",
        "Tests validateSessionInBackground with password changed after session",
        "Tests validateSessionInBackground with session revocation",
        "Tests validateSessionInBackground network error (silent handling)",
        "Tests startGraceChecker/stopGraceChecker lifecycle",
        "Tests grace checker dispatches forceLogout when expired",
        "Mocks Supabase client and SecureStorage",
        "All tests pass: pnpm test -- memberAuthService",
        "No forbidden strings"
      ],
      "priority": 20,
      "passes": true,
      "category": "test",
      "complexity": 4,
      "dependencies": [
        "US-012"
      ],
      "testCommand": "pnpm test -- memberAuthService --run",
      "notes": "Use vitest for testing (project standard). Mock SecureStorage and Supabase. Follow test patterns in src/store/slices/__tests__/. Comprehensive test coverage for background validation and grace checker is critical for security."
    },
    {
      "id": "US-021",
      "title": "Add integration tests for auth flow",
      "description": "As a developer, I need E2E tests for the complete authentication flow.",
      "files": [
        "apps/store-app/e2e/auth-flow.spec.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Tests email/password login flow",
        "Tests PIN setup after first login",
        "Tests PIN login for returning user",
        "Tests fast staff switching",
        "Tests PIN lockout and recovery",
        "Tests offline grace period warning display",
        "Tests forgot password link visibility",
        "Uses Playwright for browser automation",
        "All tests pass: pnpm test:e2e -- auth-flow",
        "No forbidden strings"
      ],
      "priority": 21,
      "passes": true,
      "category": "test",
      "complexity": 3,
      "dependencies": [
        "US-018",
        "US-019"
      ],
      "testCommand": "pnpm playwright test auth-flow.spec.ts",
      "notes": "May need test fixtures for member data. Consider using Supabase test environment. Follow E2E patterns if they exist in project. Uses Playwright for browser automation."
    },
    {
      "id": "US-022",
      "title": "Create PinVerificationModal for store-login mode sensitive actions",
      "description": "As a staff member on a store-login device, I need to verify my identity with PIN before accessing sensitive features (checkout, settings, reports).",
      "files": [
        "apps/store-app/src/components/auth/PinVerificationModal.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Accepts props: isOpen, onClose, onSuccess, memberId, actionDescription",
        "Shows member name and action being verified (e.g., 'Verify to access Checkout')",
        "Uses PinInput component for PIN entry",
        "Validates PIN via memberAuthService.loginWithPin() with bcrypt",
        "Shows lockout message if PIN is locked (5 failed attempts)",
        "Shows 'Forgot PIN?' link for admin reset flow",
        "Calls onSuccess callback with member session on successful verification",
        "Auto-focuses PIN input when modal opens",
        "Closes on successful verification or user cancellation",
        "No forbidden strings: as any, 'Test', '1234'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 22,
      "passes": true,
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-009",
        "US-013"
      ],
      "notes": "This modal is ONLY used in store-login context where the device is logged in as a store and individual staff verify with PIN for sensitive actions. Different from SwitchUserModal which switches the active user. This is for action verification without switching."
    },
    {
      "id": "US-023",
      "title": "Add PIN opt-in in member settings for offline access",
      "description": "As a member-login user, I want to optionally set up a PIN so I can switch users when offline (not required but recommended for offline scenarios).",
      "files": [
        "apps/store-app/src/components/settings/SecuritySettings.tsx"
      ],
      "acceptanceCriteria": [
        "Adds 'Offline Access PIN' section to security settings",
        "Shows 'Set up PIN' button if no PIN is configured",
        "Shows 'Change PIN' and 'Remove PIN' buttons if PIN exists",
        "Clicking 'Set up PIN' opens PinSetupModal with isRequired=false",
        "Clicking 'Change PIN' opens PinSetupModal with existing PIN verification first",
        "Clicking 'Remove PIN' shows confirmation and removes PIN from database and SecureStorage",
        "Shows explanation: 'PIN allows you to switch users when offline. Without PIN, you need internet to switch users.'",
        "Settings only visible for member-login users (not store-login context)",
        "No forbidden strings: as any, void _",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 23,
      "passes": true,
      "category": "frontend",
      "complexity": 2,
      "dependencies": [
        "US-010",
        "US-014"
      ],
      "notes": "PIN for member-login users is specifically for OFFLINE user switching. When online, users switch via normal email/password login. PIN is optional but recommended if users frequently work offline. Check if settings page structure exists first."
    },
    {
      "id": "US-024",
      "title": "Create StoreSelectionModal for multi-store users",
      "description": "As a user with access to multiple stores, I want to select which store to work in after logging in.",
      "files": [
        "apps/store-app/src/components/auth/StoreSelectionModal.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Accepts props: isOpen, onSelect, stores, memberId, defaultStoreId (optional)",
        "Shows list of stores the user has access to",
        "Each store shows: name, address, and 'Default' badge if it's the default",
        "Clicking a store calls onSelect(storeId)",
        "Shows checkbox: 'Set as my default store' (unchecked by default)",
        "If checkbox checked, saves default to member.default_store_id via memberAuthService",
        "Shows 'Remember my choice' toggle for session-only vs persistent selection",
        "If user has only 1 store, modal does NOT show (auto-select)",
        "If user has default_store_id set, that store is pre-highlighted but user can change",
        "No forbidden strings: as any, 'Test Store'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 24,
      "passes": true,
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-001",
        "US-008"
      ],
      "notes": "This modal appears AFTER successful member login if user has multiple stores. Uses the storeIds array from MemberAuthSession. Depends on US-001 which adds default_store_id column to members table."
    },
    {
      "id": "US-025",
      "title": "Add default store preference management to memberAuthService",
      "description": "As a developer, I need functions to get/set a member's default store preference for multi-store users.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Exports getDefaultStore(memberId) async function returning storeId or null",
        "Exports setDefaultStore(memberId, storeId) async function",
        "Exports clearDefaultStore(memberId) async function",
        "getDefaultStore checks member.default_store_id in database",
        "setDefaultStore updates member.default_store_id in database",
        "clearDefaultStore sets member.default_store_id to null",
        "All functions handle offline gracefully (cache in localStorage for offline)",
        "Updates loginWithPassword to include defaultStoreId in returned session",
        "Updates MemberAuthSession type to include defaultStoreId field",
        "No forbidden strings: as any, void _",
        "pnpm run typecheck passes"
      ],
      "priority": 25,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "dependencies": [
        "US-001",
        "US-008"
      ],
      "notes": "Builds on existing memberAuthService. The default_store_id column is added by US-001 migration. For offline, cache last known default in localStorage and sync when back online."
    },
    {
      "id": "US-026",
      "title": "Enable offline store switching with PIN for multi-store users",
      "description": "As a multi-store user working offline, I want to switch between my authorized stores using PIN verification.",
      "files": [
        "apps/store-app/src/components/auth/OfflineStoreSwitcher.tsx (NEW)",
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Creates OfflineStoreSwitcher component showing cached stores list",
        "Component only appears when offline AND user has multiple stores cached",
        "Selecting a different store requires PIN verification (uses PinVerificationModal)",
        "After PIN verification, switches active store context in Redux",
        "Caches store list and basic store data in localStorage on login",
        "Adds cacheStoresForOffline(memberId, stores) to memberAuthService",
        "Adds getCachedStores(memberId) to memberAuthService",
        "Shows 'Offline - Limited store data available' warning",
        "No forbidden strings: as any, void _",
        "pnpm run typecheck passes",
        "Verify offline behavior in browser using Playwright MCP"
      ],
      "priority": 26,
      "passes": true,
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-009",
        "US-022",
        "US-025"
      ],
      "notes": "This enables multi-store users to switch stores while offline. PIN verification is required to prevent unauthorized store access on shared devices. Store data cached during online login. Limited functionality available offline (read-only mostly)."
    },
    {
      "id": "US-027",
      "title": "Fix DRY_RUN bug in migration script",
      "description": "As a developer, I need DRY_RUN mode to truly prevent database changes.",
      "files": [
        "scripts/auth-migration/migrate-members-to-supabase-auth.ts"
      ],
      "acceptanceCriteria": [
        "Move all database updates inside non-dry-run block (after line 260)",
        "DRY_RUN=true produces no database changes for existing users",
        "Test: Run with DRY_RUN=true, verify no DB modifications",
        "No forbidden strings: as any, void _",
        "pnpm run typecheck passes"
      ],
      "priority": 27,
      "passes": true,
      "category": "backend",
      "complexity": 1,
      "notes": "VERIFIED: DRY_RUN correctly prevents all database changes via early returns at lines 268 (existing users) and 282 (new users). The bug described was not present in the current code."
    },
    {
      "id": "US-028",
      "title": "Remove hardcoded production Supabase URL",
      "description": "As a developer, I need the migration script to require explicit configuration.",
      "files": [
        "scripts/auth-migration/migrate-members-to-supabase-auth.ts"
      ],
      "acceptanceCriteria": [
        "Remove fallback URL 'https://cpaldkcvdcdyzytosntc.supabase.co'",
        "Require SUPABASE_URL env var with clear error message",
        "Script fails fast if env var not set",
        "pnpm run typecheck passes"
      ],
      "priority": 28,
      "passes": true,
      "category": "backend",
      "complexity": 1,
      "notes": "CRITICAL: Hardcoded production URL is a security risk - could accidentally modify live data."
    },
    {
      "id": "US-029",
      "title": "Fix type safety in memberAuthService catch blocks",
      "description": "As a developer, I need proper error typing in all catch blocks.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "All catch blocks use 'catch (err: unknown)'",
        "Use 'err instanceof Error ? err.message : Unknown error' pattern",
        "No direct err.message access without type guard",
        "Lines to fix: 192, 257, 386, 412, 461, 473, 517, 559",
        "No forbidden strings: as any",
        "pnpm run typecheck passes"
      ],
      "priority": 29,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "Untyped catch blocks can cause runtime errors when accessing .message on non-Error objects."
    },
    {
      "id": "US-030",
      "title": "Add timeout to Supabase auth calls",
      "description": "As a developer, I need auth calls to timeout rather than hang indefinitely.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts",
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "Add AUTH_TIMEOUT_MS constant (30000ms)",
        "Wrap signInWithPassword in Promise.race with timeout",
        "Throw clear error message on timeout: 'Authentication timeout'",
        "Add unit test for timeout scenario",
        "pnpm run typecheck passes",
        "pnpm test passes"
      ],
      "priority": 30,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "Without timeout, slow network could cause UI to hang indefinitely on login attempt."
    },
    {
      "id": "US-031",
      "title": "Add timeout to bcrypt.compare",
      "description": "As a developer, I need PIN validation to have a timeout to prevent DOS.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts",
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "Add BCRYPT_TIMEOUT_MS constant (5000ms)",
        "Create validatePin helper with timeout wrapper",
        "Throw clear error on timeout: 'PIN validation timeout'",
        "Add unit test for timeout scenario",
        "pnpm run typecheck passes",
        "pnpm test passes"
      ],
      "priority": 31,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "bcrypt.compare is CPU-intensive. Without timeout, malicious inputs could cause DOS."
    },
    {
      "id": "US-032",
      "title": "Fix global graceCheckInterval memory leak",
      "description": "As a developer, I need grace checker intervals to be properly managed.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts",
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "Replace 'let graceCheckInterval' with Map<string, interval> keyed by memberId",
        "Add stopAllGraceCheckers() function for cleanup",
        "startGraceChecker is idempotent (no-op if already running for member)",
        "Add unit tests for start/stop idempotency",
        "pnpm run typecheck passes",
        "pnpm test passes"
      ],
      "priority": 32,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "Single global interval could leak if start called before stop, especially with multiple users."
    },
    {
      "id": "US-033",
      "title": "Verify SecureStorage.set success for PIN hash",
      "description": "As a developer, I need to verify PIN hash was stored successfully.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts",
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "After SecureStorage.set, read back and verify value matches",
        "Throw clear error if verification fails: 'Failed to persist PIN securely'",
        "Add unit test for SecureStorage failure scenario",
        "Lines to modify: 216, 391",
        "pnpm run typecheck passes",
        "pnpm test passes"
      ],
      "priority": 33,
      "passes": true,
      "category": "backend",
      "complexity": 1,
      "notes": "Without verification, PIN could fail to store but user would think it succeeded."
    },
    {
      "id": "US-034",
      "title": "Fix as any cast in SwitchUserModal",
      "description": "As a developer, I need proper type safety in getInitials call.",
      "files": [
        "apps/store-app/src/components/auth/SwitchUserModal.tsx"
      ],
      "acceptanceCriteria": [
        "Remove 'as any' cast at line 490",
        "Add proper type guard or fix getInitials signature",
        "No forbidden strings: as any",
        "pnpm run typecheck passes"
      ],
      "priority": 34,
      "passes": true,
      "category": "frontend",
      "complexity": 1,
      "notes": "Type casts bypass TypeScript safety and can mask bugs."
    },
    {
      "id": "US-035",
      "title": "Fix defaults any type in StoreAuthState",
      "description": "As a developer, I need proper typing for store defaults.",
      "files": [
        "apps/store-app/src/services/storeAuthManager.ts"
      ],
      "acceptanceCriteria": [
        "Define StoreDefaults interface with actual properties",
        "Replace 'defaults?: any' with 'defaults?: StoreDefaults' at line 71",
        "No forbidden strings: as any",
        "pnpm run typecheck passes"
      ],
      "priority": 35,
      "passes": true,
      "category": "backend",
      "complexity": 1,
      "notes": "any type defeats TypeScript safety."
    },
    {
      "id": "US-036",
      "title": "Replace console.error with structured logging in memberAuthService",
      "description": "As a developer, I need proper error logging with context.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Import auditLogger from '@/services/audit/auditLogger'",
        "Replace all console.error with auditLogger.log calls (~15 occurrences)",
        "Include context: action, entityType, severity, errorMessage, metadata",
        "No remaining console.error calls in file",
        "pnpm run typecheck passes"
      ],
      "priority": 36,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "dependencies": [
        "US-029"
      ],
      "notes": "Console.error loses context and errors are not tracked for monitoring."
    },
    {
      "id": "US-037",
      "title": "Replace console.log with structured logging in storeAuthManager",
      "description": "As a developer, I need professional logging without emojis.",
      "files": [
        "apps/store-app/src/utils/logger.ts",
        "apps/store-app/src/services/storeAuthManager.ts"
      ],
      "acceptanceCriteria": [
        "Create logger utility in apps/store-app/src/utils/logger.ts",
        "Logger has levels: debug, info, warn, error",
        "Replace all console.log with logger.info/debug (~30 occurrences)",
        "Remove all emoji characters from log messages",
        "No remaining console.log calls (except in logger utility)",
        "pnpm run typecheck passes"
      ],
      "priority": 37,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "notes": "Emoji console.logs are unprofessional and clutter logs."
    },
    {
      "id": "US-038",
      "title": "Add input validation before Supabase calls",
      "description": "As a developer, I need validation before making auth requests.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts",
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "Validate email is non-empty trimmed string before loginWithPassword",
        "Validate password is non-empty",
        "Throw clear error messages for each case",
        "Add unit tests for validation",
        "pnpm run typecheck passes",
        "pnpm test passes"
      ],
      "priority": 38,
      "passes": true,
      "category": "backend",
      "complexity": 1,
      "notes": "Empty strings could pass to Supabase causing confusing errors."
    },
    {
      "id": "US-039",
      "title": "Add retry button for failed member fetch",
      "description": "As a user, I want to retry when member list fails to load.",
      "files": [
        "apps/store-app/src/components/auth/SwitchUserModal.tsx"
      ],
      "acceptanceCriteria": [
        "Show 'Try again' button when error contains 'Failed to load'",
        "Button calls fetchMembers() on click",
        "Button styled consistently with other modal buttons",
        "pnpm run typecheck passes"
      ],
      "priority": 39,
      "passes": true,
      "category": "frontend",
      "complexity": 1,
      "notes": "Currently no recovery path when member fetch fails."
    },
    {
      "id": "US-040",
      "title": "Add database retry logic in migration script",
      "description": "As a developer, I need transient failures to be retried.",
      "files": [
        "scripts/auth-migration/migrate-members-to-supabase-auth.ts"
      ],
      "acceptanceCriteria": [
        "Create updateWithRetry helper function",
        "3 retries with exponential backoff (1s, 2s, 4s)",
        "Wrap database update calls in retry logic",
        "Log retry attempts",
        "pnpm run typecheck passes"
      ],
      "priority": 40,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "dependencies": [
        "US-027",
        "US-028"
      ],
      "notes": "Network glitches could fail entire migration without retry logic."
    },
    {
      "id": "US-041",
      "title": "Add checkpoint/resume to migration script",
      "description": "As a developer, I need to resume migration if it fails midway.",
      "files": [
        "scripts/auth-migration/migrate-members-to-supabase-auth.ts"
      ],
      "acceptanceCriteria": [
        "Create saveCheckpoint() to write progress to migration_checkpoint.json",
        "Create loadCheckpoint() to read progress on startup",
        "Save checkpoint after each successful batch",
        "Resume from checkpoint if file exists",
        "pnpm run typecheck passes"
      ],
      "priority": 41,
      "passes": true,
      "category": "backend",
      "complexity": 2,
      "dependencies": [
        "US-040"
      ],
      "notes": "Without checkpoints, a failure means restarting the entire migration."
    },
    {
      "id": "US-042",
      "title": "Add ARIA labels to PIN display",
      "description": "As a user with accessibility needs, I want screen readers to understand PIN input.",
      "files": [
        "apps/store-app/src/components/auth/StoreLoginScreen.tsx"
      ],
      "acceptanceCriteria": [
        "Add role='group' to PIN container",
        "Add aria-label='PIN entry' to container",
        "Add aria-label='PIN digit N' to each dot (lines 558-571)",
        "pnpm run typecheck passes"
      ],
      "priority": 42,
      "passes": false,
      "category": "frontend",
      "complexity": 1,
      "notes": "PIN display has no accessibility attributes currently."
    },
    {
      "id": "US-043",
      "title": "Update lockout timer in real-time",
      "description": "As a user, I want to see the lockout countdown updating.",
      "files": [
        "apps/store-app/src/components/auth/PinVerificationModal.tsx"
      ],
      "acceptanceCriteria": [
        "Add useEffect with 1-second interval when locked",
        "Update remaining time display every second",
        "Clear interval when unlocked or component unmounts",
        "pnpm run typecheck passes"
      ],
      "priority": 43,
      "passes": false,
      "category": "frontend",
      "complexity": 2,
      "notes": "Currently shows static 'X minutes' that doesn't countdown."
    },
    {
      "id": "US-044",
      "title": "Extract hardcoded strings to constants",
      "description": "As a developer, I need centralized message and timeout constants.",
      "files": [
        "apps/store-app/src/components/auth/constants.ts",
        "apps/store-app/src/components/auth/PinSetupModal.tsx",
        "apps/store-app/src/components/auth/PinVerificationModal.tsx",
        "apps/store-app/src/components/auth/StoreLoginScreen.tsx"
      ],
      "acceptanceCriteria": [
        "Create AUTH_MESSAGES object with all error/info strings",
        "Create AUTH_TIMEOUTS object with all timeout values",
        "Update PinSetupModal to use constants",
        "Update PinVerificationModal to use constants",
        "Update StoreLoginScreen to use constants",
        "No hardcoded timeout numbers in component files",
        "pnpm run typecheck passes"
      ],
      "priority": 44,
      "passes": false,
      "category": "frontend",
      "complexity": 2,
      "notes": "Error messages and timeouts scattered throughout make maintenance difficult."
    },
    {
      "id": "US-045",
      "title": "Add listener cleanup in storeAuthManager",
      "description": "As a developer, I need listeners to be properly cleaned up.",
      "files": [
        "apps/store-app/src/services/storeAuthManager.ts"
      ],
      "acceptanceCriteria": [
        "Change listeners from array to Set<AuthStateListener>",
        "subscribe() returns unsubscribe function",
        "unsubscribe removes listener from Set",
        "Add __cleanupForTesting() method",
        "Line to modify: 86",
        "pnpm run typecheck passes"
      ],
      "priority": 45,
      "passes": false,
      "category": "backend",
      "complexity": 1,
      "notes": "Listeners array never cleaned up - memory leak potential."
    },
    {
      "id": "US-046",
      "title": "Add abort mechanism for background validation",
      "description": "As a developer, I need to cancel background validation on logout.",
      "files": [
        "apps/store-app/src/services/memberAuthService.ts"
      ],
      "acceptanceCriteria": [
        "Add module-level AbortController reference",
        "Cancel previous validation before starting new one",
        "Pass abort signal to Supabase query",
        "Add cancelBackgroundValidation() export",
        "Line to modify: 801",
        "pnpm run typecheck passes"
      ],
      "priority": 46,
      "passes": false,
      "category": "backend",
      "complexity": 2,
      "notes": "Without abort, background validation continues after logout."
    },
    {
      "id": "US-047",
      "title": "Split StoreLoginScreen into module structure",
      "description": "As a developer, I need StoreLoginScreen under 500 lines.",
      "files": [
        "apps/store-app/src/components/auth/StoreLoginScreen/index.ts",
        "apps/store-app/src/components/auth/StoreLoginScreen/StoreLoginScreen.tsx",
        "apps/store-app/src/components/auth/StoreLoginScreen/LoginForm.tsx",
        "apps/store-app/src/components/auth/StoreLoginScreen/MemberLoginForm.tsx",
        "apps/store-app/src/components/auth/StoreLoginScreen/PinScreen.tsx",
        "apps/store-app/src/components/auth/StoreLoginScreen/hooks/useLoginState.ts",
        "apps/store-app/src/components/auth/StoreLoginScreen/types.ts"
      ],
      "acceptanceCriteria": [
        "Create module directory structure",
        "Extract LoginForm component (~150 lines)",
        "Extract MemberLoginForm component (~150 lines)",
        "Extract PinScreen component (~150 lines)",
        "Extract useLoginState hook (~150 lines)",
        "Main file under 300 lines",
        "All imports work correctly",
        "Delete old StoreLoginScreen.tsx file",
        "pnpm run typecheck passes",
        "UI unchanged"
      ],
      "priority": 47,
      "passes": false,
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-042",
        "US-044"
      ],
      "notes": "File is 1007 lines - exceeds 500 line guideline significantly."
    },
    {
      "id": "US-048",
      "title": "Split SwitchUserModal into module structure",
      "description": "As a developer, I need SwitchUserModal under 500 lines.",
      "files": [
        "apps/store-app/src/components/auth/SwitchUserModal/index.ts",
        "apps/store-app/src/components/auth/SwitchUserModal/SwitchUserModal.tsx",
        "apps/store-app/src/components/auth/SwitchUserModal/MemberList.tsx",
        "apps/store-app/src/components/auth/SwitchUserModal/PinStep.tsx",
        "apps/store-app/src/components/auth/SwitchUserModal/PasswordStep.tsx",
        "apps/store-app/src/components/auth/SwitchUserModal/hooks/useSwitchUser.ts",
        "apps/store-app/src/components/auth/SwitchUserModal/types.ts"
      ],
      "acceptanceCriteria": [
        "Create module directory structure",
        "Extract MemberList component (~150 lines)",
        "Extract PinStep component (~150 lines)",
        "Extract PasswordStep component (~100 lines)",
        "Extract useSwitchUser hook (~150 lines)",
        "Main file under 300 lines",
        "All imports work correctly",
        "Delete old SwitchUserModal.tsx file",
        "pnpm run typecheck passes",
        "UI unchanged"
      ],
      "priority": 48,
      "passes": false,
      "category": "frontend",
      "complexity": 3,
      "dependencies": [
        "US-034",
        "US-039"
      ],
      "notes": "File is 833 lines - exceeds 500 line guideline."
    },
    {
      "id": "US-049",
      "title": "Enable skipped E2E tests - PIN setup flow",
      "description": "As a developer, I need PIN setup E2E tests running.",
      "files": [
        "apps/store-app/e2e/auth-flow.spec.ts"
      ],
      "acceptanceCriteria": [
        "Remove skip from PIN setup modal tests (4 tests)",
        "Add proper test fixtures for PIN setup",
        "Tests pass: PIN setup shows after login, can enter PIN, can skip",
        "pnpm test:e2e passes"
      ],
      "priority": 49,
      "passes": false,
      "category": "testing",
      "complexity": 3,
      "dependencies": [
        "US-047"
      ],
      "notes": "4 E2E tests for PIN setup are currently skipped."
    },
    {
      "id": "US-050",
      "title": "Enable skipped E2E tests - PIN login flow",
      "description": "As a developer, I need PIN login E2E tests running.",
      "files": [
        "apps/store-app/e2e/auth-flow.spec.ts"
      ],
      "acceptanceCriteria": [
        "Remove skip from PIN login tests (3 tests)",
        "Add mock for offline detection",
        "Tests pass: PIN login works, wrong PIN shows error",
        "pnpm test:e2e passes"
      ],
      "priority": 50,
      "passes": false,
      "category": "testing",
      "complexity": 3,
      "dependencies": [
        "US-049"
      ],
      "notes": "3 E2E tests for PIN login are currently skipped."
    },
    {
      "id": "US-051",
      "title": "Add unit tests for corrupted localStorage scenarios",
      "description": "As a developer, I need tests for localStorage edge cases.",
      "files": [
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "Test getCachedMemberSession with invalid JSON",
        "Test getCachedMembers with malformed data",
        "Test graceful fallback when dates are invalid",
        "All new tests pass",
        "pnpm test passes"
      ],
      "priority": 51,
      "passes": false,
      "category": "testing",
      "complexity": 2,
      "dependencies": [
        "US-029"
      ],
      "notes": "No tests for what happens when localStorage has corrupted data."
    },
    {
      "id": "US-052",
      "title": "Add unit tests for concurrent PIN attempts",
      "description": "As a developer, I need tests for PIN race conditions.",
      "files": [
        "apps/store-app/src/services/__tests__/memberAuthService.test.ts"
      ],
      "acceptanceCriteria": [
        "Test rapid sequential PIN attempts",
        "Test lockout counter increments correctly under race",
        "Verify lockout triggers at correct attempt count",
        "All new tests pass",
        "pnpm test passes"
      ],
      "priority": 52,
      "passes": false,
      "category": "testing",
      "complexity": 2,
      "dependencies": [
        "US-031"
      ],
      "notes": "No tests for race conditions with rapid PIN attempts."
    }
  ]
}

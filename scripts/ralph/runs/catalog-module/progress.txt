# Catalog Module Implementation Progress

## Run Info
- Branch: ralph/catalog-module
- Started: 2026-01-21
- PRD: 88 user stories across 6 phases (includes Review + Fix stories)

## Phase-by-Phase Execution

To run a specific phase only, use:
```bash
./scripts/ralph/ralph.sh <iterations> catalog-module --phase <N>
```

Example: `./scripts/ralph/ralph.sh 30 catalog-module --phase 1`

## Codebase Patterns

### Catalog Module Architecture
- Types: `apps/store-app/src/types/catalog.ts`
- IndexedDB: `apps/store-app/src/db/catalogDatabase.ts`
- Data Service: `apps/store-app/src/services/domain/catalogDataService.ts`
- Primary Hook: `apps/store-app/src/hooks/useCatalog.ts`
- UI Components: `apps/store-app/src/components/menu-settings/`

### Supabase Patterns
- Adapters: `apps/store-app/src/services/supabase/adapters/` - snake_case ↔ camelCase
- Tables: `apps/store-app/src/services/supabase/tables/` - CRUD operations
- Follow existing patterns from `clientAdapter.ts` and `clientsTable.ts`

### Type Extension Pattern
```typescript
import { BaseSyncableEntity } from './common';

export interface CatalogEntity extends BaseSyncableEntity {
  // Business fields here
}
```

### Adapter Pattern
```typescript
export function toAppType(row: SupabaseRow): AppType {
  return {
    id: row.id,
    tenantId: row.tenant_id,
    storeId: row.store_id,
    // ... map all fields
  };
}
```

### Table Operation Pattern
```typescript
export const entityTable = {
  async getByStoreId(storeId: string): Promise<Row[]> {
    const { data, error } = await supabase
      .from('table_name')
      .select('*')
      .eq('store_id', storeId)
      .eq('is_deleted', false);
    if (error) throw error;
    return data || [];
  },
  // ... other CRUD methods
};
```

## Phase Checkpoints

### Phase 1: Backend Foundation (US-001 to US-021 + US-P1R + US-P1F) - 23 stories
**Implementation Stories (21):**
- [x] US-001: ServiceCategory extends BaseSyncableEntity ✓
- [x] US-002: MenuService extends BaseSyncableEntity ✓
- [x] US-003: ServiceVariant and ServicePackage extend BaseSyncableEntity ✓
- [x] US-004: AddOnGroup and AddOnOption extend BaseSyncableEntity ✓
- [x] US-005: All remaining catalog types extend BaseSyncableEntity ✓
- [x] US-006: service_categories table created ✓
- [x] US-007: menu_services and service_variants tables created ✓
- [x] US-008: service_packages table created ✓
- [x] US-009: add_on_groups and add_on_options tables created ✓
- [x] US-010: All remaining tables created (staff_service_assignments, catalog_settings, booking_sequences, products, gift_card_denominations, gift_card_settings) ✓
- [x] US-011: Supabase types added ✓
- [x] US-012: serviceCategoryAdapter.ts created ✓
- [x] US-013: menuServiceAdapter.ts created ✓
- [x] US-014: serviceVariantAdapter.ts and servicePackageAdapter.ts created ✓
- [x] US-015: addOnGroupAdapter.ts and addOnOptionAdapter.ts created ✓
- [x] US-016: Remaining adapters (staffServiceAssignment, catalogSettings, bookingSequence, product, giftCardDenomination, giftCardSettings) ✓
- [x] US-017: serviceCategoriesTable.ts created ✓
- [x] US-018: menuServicesTable.ts created ✓
- [x] US-019: serviceVariantsTable.ts and servicePackagesTable.ts created ✓
- [x] US-020: addOnGroupsTable.ts and addOnOptionsTable.ts created ✓
- [x] US-021: Remaining table operations (staffServiceAssignments, catalogSettings, bookingSequences, products, giftCardDenominations, giftCardSettings) ✓
- [x] `pnpm run typecheck` passes ✓

**Review Story (US-P1R):**
- [x] Explore agent analyzes all Phase 1 files ✓
- [x] Plan agent verifies architectural decisions ✓
- [x] Document issues in 'Phase 1 Review Issues' section below ✓

**Fix Story (US-P1F):**
- [x] All Phase 1 Review Issues resolved (4/4 issues fixed) ✓

- Status: ✅ PHASE 1 COMPLETE (23/23 stories pass)

### Phase 2: Data Layer (US-022 to US-030 + US-P2R + US-P2F) - 11 stories
**Implementation Stories (9):**
- [x] US-022: Booking sequence CRUD in IndexedDB ✓
- [x] US-023: Product restore method ✓
- [x] US-024: getByBarcode fixed for multi-tenant ✓
- [ ] US-025: Supabase routing in catalogDataService
- [ ] `pnpm test --run` passes

**Review Story (US-P2R):**
- [ ] Security check: multi-tenant isolation verified
- [ ] Document issues in 'Phase 2 Review Issues' section below

**Fix Story (US-P2F):**
- [ ] All Phase 2 Review Issues resolved

- Status: In Progress (3/11 stories complete)

### Phase 3: UI Components (US-031 to US-054 + US-P3R + US-P3F) - 26 stories
**Implementation Stories (24):**
- [ ] ConfirmDialog component replaces all browser confirm()
- [ ] Skeleton loaders in all sections
- [ ] Keyboard drag-drop where applicable
- [ ] Zod validation in ServiceModal
- [ ] Staff assignments load in ServiceModal
- [ ] More Options button works

**Review Story (US-P3R):**
- [ ] Browser verification via Playwright MCP
- [ ] No browser confirm() or alert() calls remain
- [ ] Document issues in 'Phase 3 Review Issues' section below

**Fix Story (US-P3F):**
- [ ] All Phase 3 Review Issues resolved

- Status: Not started

### Phase 4: Checkout & Booking (US-055 to US-063 + US-P4R + US-P4F) - 11 stories
**Implementation Stories (9):**
- [ ] VariantSelector component
- [ ] AddOnSelector component
- [ ] ServiceGrid shows variant/add-on flow
- [ ] useBookingServices hook
- [ ] Availability badges in booking
- [ ] turnWeight in smartAutoAssign

**Review Story (US-P4R):**
- [ ] Full checkout flow tested in browser
- [ ] Variant → Add-on → Price calculation verified
- [ ] Document issues in 'Phase 4 Review Issues' section below

**Fix Story (US-P4F):**
- [ ] All Phase 4 Review Issues resolved

- Status: Not started

### Phase 5: Module Integrations (US-064 to US-072 + US-P5R + US-P5F) - 11 stories
**Implementation Stories (9):**
- [ ] Add-ons displayed in tickets
- [ ] Staff override duration in timer
- [ ] catalogSyncService created for Online Store
- [ ] Mock data replaced with real sync
- [ ] showPriceOnline respected
- [ ] Commission calculation implemented
- [ ] Rebook reminder service created

**Review Story (US-P5R):**
- [ ] Mock data completely removed from Online Store
- [ ] Commission calculation verified
- [ ] Document issues in 'Phase 5 Review Issues' section below

**Fix Story (US-P5F):**
- [ ] All Phase 5 Review Issues resolved

- Status: Not started

### Phase 6: Testing (US-073 to US-076 + US-P6R + US-P6F) - 6 stories
**Implementation Stories (4):**
- [ ] Adapter unit tests (90% coverage)
- [ ] Table operation tests (85% coverage)
- [ ] Integration tests for checkout flow
- [ ] E2E test for checkout flow

**Review Story (US-P6R) - FINAL REVIEW:**
- [ ] All tests pass
- [ ] Entire catalog module scanned for issues
- [ ] No TODO comments, console.log, or 'as any' casts
- [ ] Document issues in 'Phase 6 Review Issues' section below

**Fix Story (US-P6F) - FINAL FIX:**
- [ ] All Phase 6 Review Issues resolved
- [ ] CATALOG MODULE COMPLETE

- Status: Not started

---

## Phase Review Issues

### Phase 1 Review Issues
<!-- US-P1R will document issues here -->
<!-- US-P1F will mark issues as [RESOLVED] -->

### Phase 2 Review Issues
<!-- US-P2R will document issues here -->
<!-- US-P2F will mark issues as [RESOLVED] -->

### Phase 3 Review Issues
<!-- US-P3R will document issues here -->
<!-- US-P3F will mark issues as [RESOLVED] -->

### Phase 4 Review Issues
<!-- US-P4R will document issues here -->
<!-- US-P4F will mark issues as [RESOLVED] -->

### Phase 5 Review Issues
<!-- US-P5R will document issues here -->
<!-- US-P5F will mark issues as [RESOLVED] -->

### Phase 6 Review Issues
<!-- US-P6R will document issues here -->
<!-- US-P6F will mark issues as [RESOLVED] -->

---

## Iteration Log

## 2026-01-21 - US-001: Extend ServiceCategory with BaseSyncableEntity
Commit: 7c06f4b

**Why this story?** First story (priority 1), no dependencies, forms foundation for Phase 1 type system.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - ServiceCategory now extends BaseSyncableEntity (line 33)
   - Updated CreateCategoryInput to omit all BaseSyncableEntity fields (lines 53-73)

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Added import for createBaseSyncableDefaults from types/common
   - Updated serviceCategoriesDB.create() to use createBaseSyncableDefaults helper
   - Added tenantId and deviceId parameters to create function

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added createSeedSyncFields() helper function for seed data
   - Updated all 8 category definitions to spread syncFields
   - Updated migration function to include sync fields

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test` runs (pre-existing failures not related to catalog module)

**Learnings:**
- When extending types with BaseSyncableEntity, must update all code paths that create those entities
- Seed data uses 'synced' status since it doesn't need to sync upstream
- Migration data uses 'local' status since it needs to sync to Supabase
- Pre-existing TypeScript errors exist in portfolioAdapter.ts, portfolioTable.ts, portfolioSlice.ts (untracked files, not catalog module related)

**Next story suggestion:** US-002 (Extend MenuService with BaseSyncableEntity) - same file, same pattern, builds on this work

---

## 2026-01-21 - US-002: Extend MenuService with BaseSyncableEntity
Commit: 1e10dca

**Why this story?** Second story (priority 2), no dependencies, same file as US-001 (catalog.ts is fresh in context), builds directly on the type extension pattern.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - MenuService now extends BaseSyncableEntity (line 116)
   - Added variantCount: number field to track variant count
   - Removed duplicate sync fields (createdAt, updatedAt, syncStatus, createdBy, lastModifiedBy) that are now inherited from BaseSyncableEntity
   - Updated CreateMenuServiceInput to omit all BaseSyncableEntity fields
   - Status field already used ServiceStatus union type ('active' | 'inactive' | 'archived') - verified
   - archivedAt and archivedBy fields already present - verified

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Updated menuServicesDB.create() to use createBaseSyncableDefaults helper
   - Added tenantId and deviceId parameters to create function signature
   - Added variantCount defaulting to 0

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Updated all 11 MenuService seed definitions to spread syncFields
   - Added variantCount: N to all services (N = number of variants, or 0 for no variants)
   - Updated migration function MenuService creation to include migrationSyncFields and variantCount

**Verification:**
- `pnpm run typecheck` passes ✓
- Tests run with pre-existing failures not related to catalog module

**Learnings:**
- MenuService status field already used ServiceStatus union type - no change needed
- archivedAt and archivedBy fields were already present - no change needed
- When extending with BaseSyncableEntity, must remove duplicate fields that were previously inline
- Seed data with variants needs accurate variantCount (e.g., womensHaircut has 3 variants → variantCount: 3)

**Next story suggestion:** US-003 (Extend ServiceVariant and ServicePackage with sync fields) - same file, continues type extension pattern

---

## 2026-01-21 - US-003: Extend ServiceVariant and ServicePackage with sync fields
Commit: 3eb3323

**Why this story?** Highest priority story (priority 3) with passes: false. Same file as US-001/US-002, continues the type extension pattern with code fresh in context.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - ServiceVariant now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - ServicePackage now extends BaseSyncableEntity (removed duplicate fields including createdBy, lastModifiedBy)
   - Updated CreateVariantInput to omit all BaseSyncableEntity fields
   - Updated CreatePackageInput to omit all BaseSyncableEntity fields

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Updated serviceVariantsDB.create() to use createBaseSyncableDefaults with userId, deviceId, tenantId, storeId params
   - Updated serviceVariantsDB.update() to include userId for audit trail
   - Updated serviceVariantsDB.setDefault() to include userId for audit trail
   - Updated servicePackagesDB.create() to use createBaseSyncableDefaults

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added createSeedVariant() helper function with all sync fields
   - Added createSeedPackage() helper function with all sync fields
   - Updated all variant push statements to use createSeedVariant()
   - Updated all package definitions to use createSeedPackage()

4. `apps/store-app/src/hooks/useCatalog.ts`:
   - Updated serviceVariantsDB.create() calls to include userId parameter
   - Updated serviceVariantsDB.update() calls to include userId parameter

5. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Updated serviceVariantsService.create() to pass userId to Dexie API
   - Updated serviceVariantsService.update() to pass userId to Dexie API

6. `apps/store-app/src/store/slices/catalogSlice.ts`:
   - Updated createVariant thunk to include userId in parameters
   - Updated updateVariant thunk to include userId in parameters

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- When extending types with BaseSyncableEntity, must update ALL callers to include new required parameters (userId, tenantId, deviceId)
- Seed data helper functions make type-safe seeding much cleaner
- The serviceVariantsDB and servicePackagesDB create() functions now have consistent signatures with menuServicesDB

**Patterns to sync:**
- Pattern #1: Seed Helper Functions - Create helper functions for seeding entities with full sync fields instead of inline object literals

**Next story suggestion:** US-004 (Extend AddOnGroup and AddOnOption with sync fields) - same file, same pattern, continues type extension work

---

## 2026-01-21 - US-004: Extend AddOnGroup and AddOnOption with sync fields
Commit: 233ee98

**Why this story?** Highest priority story (priority 4) with passes: false. Same file as US-001-003, continues the type extension pattern with code fresh in context.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - AddOnGroup already extends BaseSyncableEntity (line 339) - verified
   - AddOnOption already extends BaseSyncableEntity (line 367) - verified
   - CreateAddOnGroupInput and CreateAddOnOptionInput already omit all BaseSyncableEntity fields - verified
   - Fixed fromServiceAddOn() function to return CreateAddOnGroupInput/CreateAddOnOptionInput types instead of incomplete partial types (lines 644-675)

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - addOnGroupsDB.create() already uses createBaseSyncableDefaults (line 459) - verified
   - addOnGroupsDB.update() already handles version/vectorClock sync fields (lines 484-492) - verified
   - addOnOptionsDB.create() already uses createBaseSyncableDefaults (line 538) - verified
   - addOnOptionsDB.update() already handles version/vectorClock sync fields (lines 564-571) - verified

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added createSeedAddOnGroup() helper function with all sync fields
   - Added createSeedAddOnOption() helper function with all sync fields
   - Updated add-on group and option seeding to use helper functions

4. `apps/store-app/src/hooks/useCatalog.ts`:
   - Updated addOnGroupsDB.create() call to include userId parameter (line 833)
   - Updated addOnGroupsDB.update() call to include userId parameter (line 844)
   - Updated addOnOptionsDB.create() call to include userId parameter (line 883)
   - Updated addOnOptionsDB.update() call to include userId parameter (line 894)

5. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Updated addOnGroupsService.create() to pass userId to Dexie API (line 315)
   - Updated addOnGroupsService.update() to pass userId to Dexie API (line 323)
   - Updated addOnOptionsService.create() to pass userId to Dexie API (line 357)
   - Updated addOnOptionsService.update() to pass userId to Dexie API (line 365)
   - Added import for AddOnGroup and AddOnOption types

6. `apps/store-app/src/store/slices/catalogSlice.ts`:
   - Updated createAddOnGroup thunk to include userId in parameters (line 267)
   - Updated updateAddOnGroup thunk to include userId in parameters (line 274)
   - Updated createAddOnOption thunk to include userId in parameters (line 290)
   - Updated updateAddOnOption thunk to include userId in parameters (line 297)

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- AddOnGroup and AddOnOption types were already extended with BaseSyncableEntity in previous iterations
- The main work was updating all callers to pass the required userId parameter
- The fromServiceAddOn function needed to be fixed to return input types (not full entity types) since sync fields are auto-generated during create()

**Patterns to sync:**
- Pattern #2: Input Types for Conversion Functions - When converting from legacy types, return CreateXxxInput types instead of partial entity types, since sync fields are auto-generated during create()

**Next story suggestion:** US-005 (Extend remaining catalog types with sync fields) - same file, completes type system foundation

---

## 2026-01-21 - US-005: Extend remaining catalog types with BaseSyncableEntity
Commit: 73642a5

**Why this story?** Highest priority story (priority 5) with passes: false. Continues type extension pattern from US-001-004, completing the type system foundation.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - StaffServiceAssignment now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - CatalogSettings now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - BookingSequence now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - GiftCardDenomination now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - GiftCardSettings now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - Updated CreateStaffAssignmentInput to omit all BaseSyncableEntity fields
   - Updated CreateBookingSequenceInput to omit all BaseSyncableEntity fields
   - Updated CreateGiftCardDenominationInput to omit all BaseSyncableEntity fields

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Updated staffServiceAssignmentsDB.create() with userId, deviceId, tenantId params
   - Updated staffServiceAssignmentsDB.update() with userId, deviceId params and version incrementing
   - Updated assignStaffToService() with userId, deviceId, tenantId params
   - Updated removeStaffFromService() with userId, deviceId params
   - Updated catalogSettingsDB.getOrCreate() with userId, deviceId, tenantId params
   - Updated catalogSettingsDB.update() with userId, deviceId params and version incrementing

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added DEFAULT_USER_ID constant
   - Updated CatalogSettings seeding to use createSeedSyncFields helper

4. `apps/store-app/src/hooks/useCatalog.ts`:
   - Updated catalogSettings initialization to pass all required params
   - Updated updateCatalogSettings with userId and deviceId
   - Updated createGiftCardDenomination with full sync fields
   - Updated updateGiftCardDenomination with version incrementing
   - Updated updateGiftCardSettings with full sync fields and version incrementing

5. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Updated staffServiceAssignmentsService.create() with new signature
   - Updated staffServiceAssignmentsService.update() with new signature
   - Updated catalogSettingsService.set() with new signature

6. `apps/store-app/src/store/slices/catalogSlice.ts`:
   - Updated fetchCatalogSettings thunk with userId, deviceId, tenantId params
   - Updated updateCatalogSettings thunk with userId, deviceId params

7. `apps/store-app/src/components/giftcards/GiftCardsPage.tsx`:
   - Updated createDenomination with full sync fields
   - Updated updateDenomination with version incrementing
   - Updated updateSettings with full sync fields and version incrementing

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- When extending types with BaseSyncableEntity, must update ALL callers across multiple files (hooks, services, slices, components)
- The ripple effect is significant - changing a function signature requires updating all call sites
- Using default values for deviceId/tenantId helps with backward compatibility during incremental migration
- GiftCard functionality was spread across multiple files (hook, page component) requiring consistent updates

**Patterns to sync:**
- Pattern #3: Cascading API Changes - When updating function signatures to require new params, provide sensible defaults to minimize breakage during migration

**Next story suggestion:** US-006 (Create Supabase migration for service_categories table) - Phase 1 types are complete, next step is database migration

---

## 2026-01-21 - US-006: Create Supabase migration for service_categories table
Commit: 168bdd2

**Why this story?** Highest priority incomplete story (priority 6) with no dependencies. Phase 1 type system is complete (US-001-005), now creating database tables to support Supabase sync.

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (NEW):
   - Created service_categories table with all fields from ServiceCategory type
   - Multi-tenant columns: tenant_id, store_id, location_id
   - Core business fields: name, description, color, icon, display_order, is_active
   - Hierarchy support: parent_category_id (self-referencing FK)
   - Online booking: show_online_booking
   - Sync metadata: sync_status, version, vector_clock (JSONB), last_synced_version
   - Timestamps: created_at, updated_at
   - Audit trail: created_by, created_by_device, last_modified_by, last_modified_by_device
   - Soft delete: is_deleted, deleted_at, deleted_by, deleted_by_device, tombstone_expires_at
   - RLS policies for store_id isolation (SELECT, INSERT, UPDATE, DELETE)
   - Indexes: store_id, store_active, display_order, parent, sync, updated
   - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` passes ✓
- Migration file follows existing pattern from 009_create_timesheets_table.sql and 013_create_staff_ratings_table.sql

**Learnings:**
- Supabase migrations use CHECK constraints for enum-like columns (sync_status)
- RLS policies use members table with store_ids array to enforce multi-tenant isolation
- Triggers can increment version automatically on update for optimistic concurrency
- Partial indexes (WHERE is_deleted = false) optimize common queries

**Patterns to sync:**
- Pattern #4: Catalog Migration Template - Use this migration as template for all catalog tables (sync metadata, RLS, triggers)

**Next story suggestion:** US-007 (Add menu_services and service_variants tables to migration) - Same file, continues the database migration work

---

## 2026-01-21 - US-007: Add menu_services and service_variants tables to migration
Commit: 42985d2

**Why this story?** Highest priority incomplete story (priority 7). Continues the database migration work from US-006, same file (migration file is fresh in context).

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql`:
   - Added menu_services table (lines 128-312):
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Foreign key: category_id → service_categories(id) ON DELETE CASCADE
     - Core fields: name, description, sku
     - Pricing: pricing_type (CHECK constraint), price, price_max, cost, taxable
     - Duration: duration, extra_time, extra_time_type (CHECK constraint)
     - Client care: aftercare_instructions, requires_patch_test
     - Variants: has_variants, variant_count
     - Staff: all_staff_can_perform
     - Booking: booking_availability (CHECK), online_booking_enabled, requires_deposit, deposit_amount/percentage
     - Online limits: online_booking_buffer_minutes, advance_booking_days_min/max
     - Additional: rebook_reminder_days, turn_weight, commission_rate, color, images[], tags[]
     - Status: status (CHECK), display_order, show_price_online, allow_custom_duration
     - Archive: archived_at, archived_by
     - Sync metadata, timestamps, audit trail, soft delete
     - 9 indexes for common query patterns
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

   - Added service_variants table (lines 314-437):
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Foreign key: service_id → menu_services(id) ON DELETE CASCADE
     - Core fields: name, duration, price
     - Extra time: extra_time, extra_time_type (CHECK constraint)
     - Status: is_default, display_order, is_active
     - Sync metadata, timestamps, audit trail, soft delete
     - 7 indexes including default variant lookup
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- Note: Monorepo-level typecheck has pre-existing TS6310 error in packages/types - unrelated to this change
- Migration follows established pattern from US-006

**Learnings:**
- CHECK constraints are powerful for enforcing enum values at database level
- CASCADE delete on foreign keys simplifies cleanup (deleting a service auto-deletes its variants)
- DECIMAL(10,2) is appropriate for currency/pricing fields
- TEXT[] for PostgreSQL arrays works well for tags and images
- Partial indexes (WHERE is_default = true) help with variant default lookups

**Patterns to sync:**
- Pattern #5: Foreign Key Cascade - Use ON DELETE CASCADE for child tables (variants → services, options → groups) to ensure referential integrity

**Next story suggestion:** US-008 (Add service_packages table to migration) - Same file, continues building out the catalog tables

---

## 2026-01-21 - US-008: Add service_packages table to migration
Commit: d4b0d4f

**Why this story?** Highest priority incomplete story (priority 8). Continues the database migration work from US-007, same file (migration file is fresh in context).

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (lines 439-586):
   - Added service_packages table with all ServicePackage type fields
   - Multi-tenant columns: tenant_id, store_id, location_id
   - Core fields: name, description
   - Services array stored as JSONB (PackageServiceItem[])
   - Pricing: original_price, package_price, discount_type (CHECK), discount_value
   - Booking mode: booking_mode (CHECK) - 'single-session' | 'multiple-visits'
   - Validity: validity_days, usage_limit
   - Booking settings: booking_availability (CHECK), online_booking_enabled
   - Staff restrictions: restricted_staff_ids (TEXT[])
   - Status: is_active, display_order
   - Visual: color, images[]
   - Sync metadata, timestamps, audit trail, soft delete
   - 6 indexes including booking availability filter
   - RLS policies for all CRUD operations
   - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- Migration follows established pattern from US-006, US-007

**Learnings:**
- JSONB is ideal for storing arrays of complex objects (PackageServiceItem[])
- No foreign keys to menu_services since services array is denormalized in JSONB
- Denormalization in JSONB trades referential integrity for simpler queries and offline support

**Next story suggestion:** US-009 (Add add_on_groups and add_on_options tables to migration) - Same file, continues building out catalog tables

---

## 2026-01-21 - US-009: Add add_on_groups and add_on_options tables to migration
Commit: 00bff2f

**Why this story?** Highest priority incomplete story (priority 9). Continues the database migration work from US-008, same file (migration file is fresh in context).

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (lines 589-827):
   - Added add_on_groups table:
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Core fields: name, description
     - Selection rules: selection_mode ('single'|'multiple'), min_selections, max_selections, is_required
     - Applicability: applicable_to_all (BOOLEAN), applicable_category_ids (TEXT[]), applicable_service_ids (TEXT[])
     - Status: is_active, display_order, online_booking_enabled
     - Sync metadata, timestamps, audit trail, soft delete
     - 6 indexes including applicability filter
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

   - Added add_on_options table:
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Foreign key: group_id → add_on_groups(id) ON DELETE CASCADE
     - Core fields: name, description
     - Pricing & Duration: price (DECIMAL), duration (INTEGER minutes)
     - Status: is_active, display_order
     - Sync metadata, timestamps, audit trail, soft delete
     - 6 indexes for common query patterns
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)
- Migration follows established pattern from US-006 through US-008

**Learnings:**
- TEXT[] is the correct type for storing UUID arrays in PostgreSQL (applicable_category_ids, applicable_service_ids)
- ON DELETE CASCADE on group_id ensures options are deleted when their parent group is deleted
- selection_mode uses CHECK constraint to enforce 'single' | 'multiple' enum values

**Next story suggestion:** US-010 (Add remaining catalog tables to migration) - Same file, completes the migration

---

## 2026-01-21 - US-010: Add remaining catalog tables to migration
Commit: 0cf38d4

**Why this story?** Highest priority incomplete story (priority 10). Continues the database migration work from US-009, completing all 12 catalog tables.

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (lines 833-1565):
   - Added staff_service_assignments table:
     - Links staff to services with custom price/duration/commission overrides
     - Unique constraint on (store_id, staff_id, service_id)
     - Foreign key to menu_services(id) ON DELETE CASCADE

   - Added catalog_settings table:
     - Per-store catalog configuration (one record per store via UNIQUE constraint)
     - Default duration, extra time, tax rate settings
     - Feature toggles: packages, add-ons, variants, custom pricing
     - Online booking defaults

   - Added booking_sequences table:
     - Defines service order for logical booking flow
     - service_order stored as JSONB array of service IDs
     - is_enabled flag for toggling

   - Added products table:
     - Retail and backbar products for inventory
     - SKU and barcode identifiers with indexes
     - Pricing (retail_price, cost_price, margin)
     - Inventory management (min_stock_level, reorder_quantity)
     - Supplier info (supplier_id, supplier_name)

   - Added gift_card_denominations table:
     - Preset gift card amounts for quick sale
     - amount (DECIMAL) and optional label
     - display_order for sorting

   - Added gift_card_settings table:
     - Per-store gift card configuration (one per store via UNIQUE constraint)
     - Custom amount limits (allow_custom_amount, min_amount, max_amount)
     - Expiration settings (default_expiration_days)
     - Online/email delivery settings

All 6 tables include:
- Multi-tenant isolation (tenant_id, store_id, location_id)
- Sync metadata (sync_status, version, vector_clock, last_synced_version)
- RLS policies for SELECT, INSERT, UPDATE, DELETE
- Auto-increment version trigger on updates
- Soft delete support (is_deleted, deleted_at, deleted_by, tombstone_expires_at)

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)
- All 12 tables verified: service_categories, menu_services, service_variants, service_packages, add_on_groups, add_on_options, staff_service_assignments, catalog_settings, booking_sequences, products, gift_card_denominations, gift_card_settings
- All 12 tables have RLS enabled

**Learnings:**
- UNIQUE constraints (CONSTRAINT xyz_store_unique UNIQUE (store_id)) enforce one-per-store for settings tables
- JSONB arrays are flexible for service_order in booking_sequences (avoids separate join table)
- Products table needs indexes on both SKU and barcode for efficient lookups
- Composite indexes help with multi-column filters (e.g., store_id + category)

**Next story suggestion:** US-011 (Add catalog table types to Supabase types.ts) - Next phase of backend foundation: TypeScript types for the new tables

---

## 2026-01-21 - US-011: Add catalog table types to Supabase types.ts
Commit: b5357cc

**Why this story?** Highest priority incomplete story (priority 11). Database migration (US-006-010) is complete, next logical step is TypeScript types for Supabase sync.

**Changes:**
1. `apps/store-app/src/services/supabase/types.ts`:
   - Added 12 new table type definitions to Database['public']['Tables'] interface:
     - service_categories (lines ~960-1040)
     - menu_services (lines ~1042-1180)
     - service_variants (lines ~1182-1260)
     - service_packages (lines ~1262-1365)
     - add_on_groups (lines ~1367-1465)
     - add_on_options (lines ~1467-1545)
     - staff_service_assignments (lines ~1547-1615)
     - catalog_settings (lines ~1617-1720)
     - booking_sequences (lines ~1722-1790)
     - catalog_products (lines ~1792-1920)
     - catalog_gift_card_denominations (lines ~1922-1995)
     - catalog_gift_card_settings (lines ~1997-2070)
   - Added 8 catalog module enums:
     - SyncStatus: 'local' | 'pending' | 'synced' | 'conflict' | 'error'
     - PricingType: 'fixed' | 'from' | 'free' | 'varies' | 'hourly'
     - ServiceStatus: 'active' | 'inactive' | 'archived'
     - BookingAvailability: 'online' | 'in-store' | 'both' | 'disabled'
     - ExtraTimeType: 'processing' | 'blocked' | 'finishing'
     - DiscountType: 'fixed' | 'percentage'
     - BookingMode: 'single-session' | 'multiple-visits'
     - SelectionMode: 'single' | 'multiple'
   - Added Row, Insert, Update helper type exports for all 12 tables

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Products table named `catalog_products` to avoid collision with existing `products` table concept
- Gift card tables prefixed with `catalog_` to disambiguate from existing gift_cards tables (migration 019)
- Every Row type includes full sync metadata: sync_status, version, vector_clock, last_synced_version
- Every Row type includes full audit trail: created_by, created_by_device, last_modified_by, last_modified_by_device
- Every Row type includes soft delete fields: is_deleted, deleted_at, deleted_by, deleted_by_device, tombstone_expires_at

**Patterns to sync:**
- Pattern #6: Supabase Type Convention - Use Row/Insert/Update triplet for every table. Row is complete, Insert has optional auto-generated fields, Update is Partial<Insert>

**Next story suggestion:** US-012 (Create serviceCategoryAdapter.ts) - Same file area, creates adapters to convert between Supabase and app types

---

## 2026-01-21 - US-012: Create serviceCategoryAdapter.ts
Commit: a1ca37d

**Why this story?** Highest priority incomplete story (priority 12). Database migration and types (US-006-011) complete, next logical step is adapters for type conversion.

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/serviceCategoryAdapter.ts` (NEW):
   - Created `toServiceCategory(row)`: Converts ServiceCategoryRow → ServiceCategory
   - Created `toServiceCategories(rows)`: Batch conversion
   - Created `toServiceCategoryInsert(category, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toServiceCategoryUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles snake_case ↔ camelCase conversion for all fields
   - Handles JSONB vectorClock parsing
   - Handles null → undefined for optional fields
   - Uses exported types from types.ts (ServiceCategoryRow, etc.)

2. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added CATALOG MODULE ADAPTERS section
   - Exported toServiceCategory, toServiceCategories, toServiceCategoryInsert, toServiceCategoryUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Supabase SyncStatus type differs from app SyncStatus ('syncing' is app-only, not stored in Supabase)
- Use types exported from types.ts (ServiceCategoryRow, etc.) rather than inline Database access
- When converting updates.syncStatus to Supabase, cast with `as SyncStatus` since app may have 'syncing' which is transient

**Patterns to sync:**
- Pattern #7: SyncStatus Type Mismatch - App SyncStatus has 'syncing' for transient state, Supabase SyncStatus does not. Cast when writing to Supabase.

**Next story suggestion:** US-013 (Create menuServiceAdapter.ts) - Same pattern, same folder, builds on this adapter work

---

## 2026-01-21 - US-013: Create menuServiceAdapter.ts
Commit: 6bf2561

**Why this story?** Highest priority incomplete story (priority 13). Continues the adapter pattern work from US-012, same folder (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/menuServiceAdapter.ts` (NEW):
   - Created `toMenuService(row)`: Converts MenuServiceRow → MenuService (40+ fields)
   - Created `toMenuServices(rows)`: Batch conversion
   - Created `toMenuServiceInsert(service, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toMenuServiceUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles all 40+ MenuService fields:
     - Core: name, description, sku
     - Pricing: pricingType, price, priceMax, cost, taxable
     - Duration: duration, extraTime, extraTimeType
     - Client care: aftercareInstructions, requiresPatchTest
     - Variants: hasVariants, variantCount
     - Staff: allStaffCanPerform
     - Booking: bookingAvailability, onlineBookingEnabled, requiresDeposit, depositAmount, depositPercentage
     - Online limits: onlineBookingBufferMinutes, advanceBookingDaysMin/Max
     - Additional: rebookReminderDays, turnWeight, commissionRate, color, images, tags
     - Status: status, displayOrder, showPriceOnline, allowCustomDuration
     - Archive: archivedAt, archivedBy
   - Handles snake_case ↔ camelCase conversion
   - Handles TEXT[] ↔ string[] for images and tags arrays
   - Handles null → undefined for optional fields

2. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added MenuService adapter exports: toMenuService, toMenuServices, toMenuServiceInsert, toMenuServiceUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- MenuService is the largest catalog type with ~40 fields - careful mapping required
- TEXT[] arrays in PostgreSQL map directly to string[] in TypeScript - no parsing needed
- turnWeight defaults to 1.0 when not provided (service.turnWeight ?? 1.0)
- requiresPatchTest defaults to false when not provided (service.requiresPatchTest ?? false)

**Next story suggestion:** US-014 (Create serviceVariantAdapter.ts and servicePackageAdapter.ts) - Same folder, continues adapter work

---

## 2026-01-21 - US-014: Create serviceVariantAdapter.ts and servicePackageAdapter.ts
Commit: e80c3a1

**Why this story?** Highest priority incomplete story (priority 14). Continues the adapter pattern work from US-012 and US-013, same folder (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/serviceVariantAdapter.ts` (NEW):
   - Created `toServiceVariant(row)`: Converts ServiceVariantRow → ServiceVariant
   - Created `toServiceVariants(rows)`: Batch conversion
   - Created `toServiceVariantInsert(variant, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toServiceVariantUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles snake_case ↔ camelCase conversion for all fields
   - Handles extraTime and extraTimeType optional fields

2. `apps/store-app/src/services/supabase/adapters/servicePackageAdapter.ts` (NEW):
   - Created `toServicePackage(row)`: Converts ServicePackageRow → ServicePackage
   - Created `toServicePackages(rows)`: Batch conversion
   - Created `toServicePackageInsert(pkg, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toServicePackageUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles JSONB → PackageServiceItem[] parsing for services array
   - Uses `as unknown as Json` cast for PackageServiceItem[] to satisfy Supabase Json type

3. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added ServiceVariant adapter exports: toServiceVariant, toServiceVariants, toServiceVariantInsert, toServiceVariantUpdate
   - Added ServicePackage adapter exports: toServicePackage, toServicePackages, toServicePackageInsert, toServicePackageUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- PackageServiceItem[] cannot be directly assigned to Supabase Json type due to index signature mismatch
- Use `as unknown as Json` double cast for complex objects going into JSONB columns
- ServiceVariant is simpler than MenuService - fewer fields to map

**Patterns to sync:**
- Pattern #8: JSONB Type Cast - When assigning TypeScript interfaces to Supabase Json fields, use `as unknown as Json` cast to bridge the type mismatch

**Next story suggestion:** US-015 (Create addOnGroupAdapter.ts and addOnOptionAdapter.ts) - Same folder, continues adapter work

---

## 2026-01-21 - US-015: Create addOnGroupAdapter.ts and addOnOptionAdapter.ts
Commit: f57fe8f

**Why this story?** Highest priority incomplete story (priority 15). Continues the adapter pattern work from US-012 through US-014, same folder (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/addOnGroupAdapter.ts` (NEW):
   - Created `toAddOnGroup(row)`: Converts AddOnGroupRow → AddOnGroup
   - Created `toAddOnGroups(rows)`: Batch conversion
   - Created `toAddOnGroupInsert(group, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toAddOnGroupUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles snake_case ↔ camelCase conversion for all fields
   - Handles TEXT[] → string[] for applicable_category_ids, applicable_service_ids (direct mapping)
   - Handles selection rules: selectionMode, minSelections, maxSelections, isRequired

2. `apps/store-app/src/services/supabase/adapters/addOnOptionAdapter.ts` (NEW):
   - Created `toAddOnOption(row)`: Converts AddOnOptionRow → AddOnOption
   - Created `toAddOnOptions(rows)`: Batch conversion
   - Created `toAddOnOptionInsert(option, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toAddOnOptionUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles foreign key: groupId ↔ group_id
   - Handles pricing and duration fields

3. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added AddOnGroup adapter exports: toAddOnGroup, toAddOnGroups, toAddOnGroupInsert, toAddOnGroupUpdate
   - Added AddOnOption adapter exports: toAddOnOption, toAddOnOptions, toAddOnOptionInsert, toAddOnOptionUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- TEXT[] in PostgreSQL maps directly to string[] in TypeScript - no special parsing needed
- Add-on types follow the same adapter pattern as other catalog types
- Both adapters handle the full sync metadata (vectorClock, version, etc.) consistently

**Next story suggestion:** US-016 (Create remaining catalog adapters) - Same folder, completes all adapter work for Phase 1

---

## 2026-01-21 - US-016: Create remaining catalog adapters
Commit: 77579fd

**Why this story?** Highest priority incomplete story (priority 16). Completes all adapter work for Phase 1, same folder as US-012-015 (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/staffServiceAssignmentAdapter.ts` (NEW):
   - Created `toStaffServiceAssignment(row)`: Converts StaffServiceAssignmentRow → StaffServiceAssignment
   - Created `toStaffServiceAssignments(rows)`: Batch conversion
   - Created `toStaffServiceAssignmentInsert(assignment, storeId, tenantId, userId?, deviceId?)`
   - Created `toStaffServiceAssignmentUpdate(updates, userId?, deviceId?)`
   - Handles customPrice, customDuration, customCommissionRate optional fields

2. `apps/store-app/src/services/supabase/adapters/catalogSettingsAdapter.ts` (NEW):
   - Created `toCatalogSettings(row)`: Converts CatalogSettingsRow → CatalogSettings
   - Created `toCatalogSettingsInsert(settings, storeId, tenantId, userId?, deviceId?)`
   - Created `toCatalogSettingsUpdate(updates, userId?, deviceId?)`
   - Handles all feature toggles (enablePackages, enableAddOns, enableVariants, etc.)
   - Handles ExtraTimeType enum conversion

3. `apps/store-app/src/services/supabase/adapters/bookingSequenceAdapter.ts` (NEW):
   - Created `toBookingSequence(row)`: Converts BookingSequenceRow → BookingSequence
   - Created `toBookingSequences(rows)`: Batch conversion
   - Created `toBookingSequenceInsert(sequence, storeId, tenantId, userId?, deviceId?)`
   - Created `toBookingSequenceUpdate(updates, userId?, deviceId?)`
   - Handles JSONB → string[] for serviceOrder array

4. `apps/store-app/src/services/supabase/adapters/productAdapter.ts` (NEW):
   - Created `toProduct(row)`: Converts CatalogProductRow → Product
   - Created `toProducts(rows)`: Batch conversion
   - Created `toProductInsert(product, storeId, tenantId, userId?, deviceId?)`
   - Created `toProductUpdate(updates, userId?, deviceId?)`
   - Handles all inventory fields (sku, barcode, pricing, stock levels, supplier info)

5. `apps/store-app/src/services/supabase/adapters/giftCardDenominationAdapter.ts` (NEW):
   - Created `toGiftCardDenomination(row)`: Converts CatalogGiftCardDenominationRow → GiftCardDenomination
   - Created `toGiftCardDenominations(rows)`: Batch conversion
   - Created `toGiftCardDenominationInsert(denomination, storeId, tenantId, userId?, deviceId?)`
   - Created `toGiftCardDenominationUpdate(updates, userId?, deviceId?)`
   - Handles simple fields: amount, label, isActive, displayOrder

6. `apps/store-app/src/services/supabase/adapters/giftCardSettingsAdapter.ts` (NEW):
   - Created `toGiftCardSettings(row)`: Converts CatalogGiftCardSettingsRow → GiftCardSettings
   - Created `toGiftCardSettingsInsert(settings, storeId, tenantId, userId?, deviceId?)`
   - Created `toGiftCardSettingsUpdate(updates, userId?, deviceId?)`
   - Handles custom amount limits, expiration, and online settings

7. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added StaffServiceAssignment adapter exports
   - Added CatalogSettings adapter exports
   - Added BookingSequence adapter exports
   - Added Product adapter exports
   - Added GiftCardDenomination adapter exports
   - Added GiftCardSettings adapter exports

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- All 6 adapters follow the same established pattern from US-012 through US-015
- Product type comes from @/types/inventory (not catalog.ts)
- GiftCard tables in Supabase are prefixed with `catalog_` to avoid collision with existing gift_cards tables
- BookingSequence serviceOrder uses JSONB array - cast to `unknown as Json` when inserting

**Patterns to sync:**
- None new - all adapters follow Pattern #6 (Supabase Type Convention) and Pattern #8 (JSONB Type Cast)

**Next story suggestion:** US-017 (Create serviceCategoriesTable.ts) - Next phase: Supabase CRUD operations for tables

---

## 2026-01-21 - US-017: Create serviceCategoriesTable.ts
Commit: bbc0869

**Why this story?** Highest priority incomplete story (priority 17) with no dependencies. Continues logical progression: types → migration → Supabase types → adapters → **table operations**.

**Changes:**
1. `apps/store-app/src/services/supabase/tables/serviceCategoriesTable.ts` (NEW):
   - Created `getByStoreId(storeId, includeInactive?)`: Get all categories for a store with optional inactive filter
   - Created `getById(id)`: Get single category with is_deleted check
   - Created `getByParentId(parentCategoryId)`: Get child categories of a parent
   - Created `getRootCategories(storeId)`: Get categories without a parent
   - Created `search(storeId, query)`: Search categories by name with sanitized input
   - Created `create(category)`: Insert new category
   - Created `update(id, updates)`: Update category with auto-updated timestamp
   - Created `delete(id, userId, deviceId)`: Soft delete with 30-day tombstone
   - Created `hardDelete(id)`: Permanent delete for cleanup
   - Created `getUpdatedSince(storeId, since)`: Get categories updated after timestamp for sync
   - Created `upsertMany(categories)`: Bulk upsert for sync
   - Created `updateDisplayOrder(updates)`: Batch reorder categories
   - Created `getOnlineBookingCategories(storeId)`: Get categories visible for online booking

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Supabase table operations follow consistent pattern from clientsTable.ts
- Soft delete pattern uses tombstone_expires_at (30 days) for eventual cleanup
- PostgREST error code PGRST116 indicates "no rows found" - handle gracefully in getById
- Query builder can be conditionally modified (`if (!includeInactive) query = query.eq(...)`)
- Batch updates in Supabase require Promise.all with individual update calls

**Patterns to sync:**
- Pattern #9: Soft Delete with Tombstone - Use is_deleted, deleted_at, deleted_by, deleted_by_device, tombstone_expires_at for audit trail and eventual cleanup

**Next story suggestion:** US-018 (Create menuServicesTable.ts) - Same folder, continues table operations work

---

## 2026-01-21 - US-018: Create menuServicesTable.ts
Commit: e2a8777

**Why this story?** Highest priority incomplete story (priority 18). Continues the table operations work from US-017, same folder (table operations are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/tables/menuServicesTable.ts` (NEW):
   - Created `getByStoreId(storeId, includeInactive?)`: Get all services for a store with optional inactive filter
   - Created `getById(id)`: Get single service with is_deleted check
   - Created `getByCategoryId(categoryId, includeInactive?)`: Get services by category
   - Created `create(service)`: Insert new service
   - Created `update(id, updates)`: Update service with auto-updated timestamp
   - Created `delete(id, userId, deviceId)`: Soft delete with 30-day tombstone
   - Created `archive(id, userId)`: Set status to 'archived' (recoverable soft delete)
   - Created `restore(id)`: Set status back to 'active' and clear archive fields
   - Created `search(storeId, query, limit)`: Search services by name with sanitized input
   - Created `getUpdatedSince(storeId, since)`: Get services updated after timestamp for sync
   - Created `upsertMany(services)`: Bulk upsert for sync
   - Created `updateDisplayOrder(updates)`: Batch reorder services
   - Created `getOnlineBookingServices(storeId)`: Get services available for online booking
   - Created `getServicesWithVariants(storeId)`: Get services that have variants
   - Created `getArchivedServices(storeId)`: Get archived services only
   - Created `hardDelete(id)`: Permanent delete for cleanup
   - Created `updateVariantCount(id, count)`: Update variant count when variants change

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- MenuServices table has archive/restore separate from soft delete - archive is recoverable, soft delete propagates through sync
- Archive sets status='archived', soft delete sets is_deleted=true
- Added helper methods like getServicesWithVariants and updateVariantCount for variant management
- Search uses sanitized query input to prevent SQL injection via PostgREST

**Patterns to sync:**
- Pattern #10: Archive vs Soft Delete - Archive (status='archived') is user-visible and recoverable. Soft delete (is_deleted=true) is for sync propagation and eventual cleanup.

**Next story suggestion:** US-019 (Create serviceVariantsTable.ts and servicePackagesTable.ts) - Same folder, continues table operations work

---

## 2026-01-21 - US-019: Create serviceVariantsTable.ts and servicePackagesTable.ts
Commit: cbdbcc3

**Why this story?** Highest priority incomplete story (priority 19). Continues the table operations work from US-017 and US-018, same folder (table operations are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/tables/serviceVariantsTable.ts` (NEW):
   - Created `getByStoreId(storeId, includeInactive?)`: Get all variants for a store
   - Created `getById(id)`: Get single variant with is_deleted check
   - Created `getByServiceId(serviceId, includeInactive?)`: Get variants by service (key for checkout/booking)
   - Created `getDefaultVariant(serviceId)`: Get the default variant for a service
   - Created `create(variant)`: Insert new variant
   - Created `update(id, updates)`: Update variant with auto-updated timestamp
   - Created `delete(id, userId, deviceId)`: Soft delete with 30-day tombstone
   - Created `setDefault(id, serviceId)`: Set a variant as default (clears default from others)
   - Created `getUpdatedSince(storeId, since)`: Get variants updated after timestamp for sync
   - Created `upsertMany(variants)`: Bulk upsert for sync
   - Created `updateDisplayOrder(updates)`: Batch reorder variants
   - Created `hardDelete(id)`: Permanent delete for cleanup
   - Created `deleteByServiceId(serviceId, userId, deviceId)`: Soft delete all variants for a service
   - Created `countByServiceId(serviceId)`: Count active variants (for updating service.variantCount)

2. `apps/store-app/src/services/supabase/tables/servicePackagesTable.ts` (NEW):
   - Created `getByStoreId(storeId, includeInactive?)`: Get all packages for a store
   - Created `getById(id)`: Get single package with is_deleted check
   - Created `create(pkg)`: Insert new package
   - Created `update(id, updates)`: Update package with auto-updated timestamp
   - Created `delete(id, userId, deviceId)`: Soft delete with 30-day tombstone
   - Created `search(storeId, query, limit)`: Search packages by name with sanitized input
   - Created `getUpdatedSince(storeId, since)`: Get packages updated after timestamp for sync
   - Created `upsertMany(packages)`: Bulk upsert for sync
   - Created `updateDisplayOrder(updates)`: Batch reorder packages
   - Created `getOnlineBookingPackages(storeId)`: Get packages available for online booking
   - Created `hardDelete(id)`: Permanent delete for cleanup
   - Created `activate(id)`: Activate a package
   - Created `deactivate(id)`: Deactivate a package
   - Created `getByBookingMode(storeId, mode)`: Get packages by booking mode (single-session/multiple-visits)

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test -- --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Variants have a unique setDefault method that clears default from other variants of the same service
- countByServiceId is useful for keeping service.variantCount in sync
- deleteByServiceId enables cascade-like behavior when a service is deleted
- Packages have activate/deactivate methods for simpler status toggling
- getByBookingMode helps filter packages by their usage pattern (single session vs multi-visit)

**Patterns to sync:**
- None new - all table operations follow established patterns from US-017 and US-018

**Next story suggestion:** US-020 (Create addOnGroupsTable.ts and addOnOptionsTable.ts) - Same folder, continues table operations work

---

## 2026-01-21 - US-020: Create addOnGroupsTable.ts and addOnOptionsTable.ts
Commit: 88a7ca1

**Why this story?** Highest priority incomplete story (priority 20). Continues the table operations work from US-019, same folder (table operations are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/tables/addOnGroupsTable.ts` (NEW):
   - Created `getByStoreId(storeId, includeInactive?)`: Get all add-on groups for a store
   - Created `getById(id)`: Get single group with is_deleted check
   - Created `getForService(storeId, serviceId?, categoryId?)`: KEY METHOD - filters by applicability:
     - Returns groups where applicable_to_all = true
     - OR serviceId is in applicable_service_ids
     - OR categoryId is in applicable_category_ids
   - Created `getOnlineBookingGroups(storeId)`: Get groups visible for online booking
   - Created `search(storeId, query, limit)`: Search groups by name with sanitized input
   - Created `create(group)`: Insert new group
   - Created `update(id, updates)`: Update group with auto-updated timestamp
   - Created `delete(id, userId, deviceId)`: Soft delete with 30-day tombstone
   - Created `hardDelete(id)`: Permanent delete for cleanup
   - Created `getUpdatedSince(storeId, since)`: Get groups updated after timestamp for sync
   - Created `upsertMany(groups)`: Bulk upsert for sync
   - Created `updateDisplayOrder(updates)`: Batch reorder groups
   - Created `activate(id)` / `deactivate(id)`: Status toggling
   - Created `getRequiredForService(storeId, serviceId?, categoryId?)`: Get required groups for checkout

2. `apps/store-app/src/services/supabase/tables/addOnOptionsTable.ts` (NEW):
   - Created `getByStoreId(storeId, includeInactive?)`: Get all add-on options for a store
   - Created `getById(id)`: Get single option with is_deleted check
   - Created `getByGroupId(groupId, includeInactive?)`: KEY METHOD - Get options for a specific group
   - Created `getByGroupIds(groupIds)`: Bulk load options for multiple groups
   - Created `search(storeId, query, limit)`: Search options by name
   - Created `create(option)`: Insert new option
   - Created `update(id, updates)`: Update option with auto-updated timestamp
   - Created `delete(id, userId, deviceId)`: Soft delete with 30-day tombstone
   - Created `deleteByGroupId(groupId, userId, deviceId)`: Cascade delete all options in a group
   - Created `hardDelete(id)`: Permanent delete for cleanup
   - Created `getUpdatedSince(storeId, since)`: Get options updated after timestamp for sync
   - Created `upsertMany(options)`: Bulk upsert for sync
   - Created `updateDisplayOrder(updates)`: Batch reorder options
   - Created `activate(id)` / `deactivate(id)`: Status toggling
   - Created `countByGroupId(groupId)`: Count active options in a group

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test -- --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- getForService uses JavaScript filtering because PostgREST array operations are limited for "contains" queries
- First fetch all groups, then filter by applicable_to_all OR serviceId in applicable_service_ids OR categoryId in applicable_category_ids
- deleteByGroupId enables cascade-like behavior when a group is deleted
- getByGroupIds enables efficient bulk loading for checkout/booking scenarios

**Patterns to sync:**
- Pattern #11: Array Contains Filtering - When filtering by array containment (e.g., serviceId in applicable_service_ids), fetch all rows and filter in JavaScript since PostgREST array operators are limited

**Next story suggestion:** US-021 (Create remaining catalog table operations) - Same folder, completes Phase 1 backend foundation

---

## 2026-01-21 - US-021: Create remaining catalog table operations
Commit: abfd3a6

**Why this story?** Highest priority story (priority 21) with passes: false. Completes Phase 1 backend foundation by creating the final 6 Supabase table operation files.

**Changes:**
1. `apps/store-app/src/services/supabase/tables/staffServiceAssignmentsTable.ts` (NEW):
   - CRUD operations for staff-service assignments
   - `getByStaffId(staffId)`: Get all services a staff can perform
   - `getByServiceId(serviceId)`: Get all staff who can perform a service
   - `getByStaffAndService(staffId, serviceId)`: Get specific assignment
   - `assignStaffToService(storeId, staffId, serviceId, assignment)`: Upsert assignment
   - `removeStaffFromService(staffId, serviceId, userId, deviceId)`: Soft delete
   - `deleteByStaffId/deleteByServiceId`: Cascade-style soft delete
   - `updateCustomPricing(id, price, duration, commission)`: Update overrides
   - `getStaffIdsForService/getServiceIdsForStaff`: ID-only lookups for performance

2. `apps/store-app/src/services/supabase/tables/catalogSettingsTable.ts` (NEW):
   - One-per-store settings table operations
   - `get(storeId)`: Get settings or null
   - `getOrCreate(storeId, tenantId, userId?, deviceId?)`: Get or create with defaults
   - `update(storeId, updates)`: Update by storeId
   - Feature toggle helpers: enablePackages, disablePackages, enableAddOns, etc.
   - `isFeatureEnabled(storeId, feature)`: Check if feature is enabled

3. `apps/store-app/src/services/supabase/tables/bookingSequencesTable.ts` (NEW):
   - CRUD operations for booking sequences
   - `getEnabled(storeId)`: Get only enabled sequences
   - `enable(id)` / `disable(id)`: Toggle status
   - `updateServiceOrder(id, serviceIds)`: Set service order array
   - `addService(id, serviceId, position?)`: Add service to sequence
   - `removeService(id, serviceId)`: Remove service from sequence
   - `reorderService(id, serviceId, newPosition)`: Move service within sequence

4. `apps/store-app/src/services/supabase/tables/productsTable.ts` (NEW):
   - Full CRUD with archive/restore for products
   - `getByBarcode(storeId, barcode)`: Lookup by barcode (multi-tenant isolated)
   - `getBySku(storeId, sku)`: Lookup by SKU (multi-tenant isolated)
   - `getByCategory/getByBrand`: Filter by category/brand
   - `getRetailProducts/getBackbarProducts`: Filter by product type
   - `getLowStockProducts(storeId)`: Get products with min_stock_level set
   - `search(storeId, query)`: Search by name, SKU, or barcode
   - `archive(id)` / `restore(id)`: Soft archive/restore
   - `updatePricing(id, retailPrice, costPrice)`: Update pricing with auto-margin calculation
   - `getCategories/getBrands`: Get distinct category/brand values

5. `apps/store-app/src/services/supabase/tables/giftCardDenominationsTable.ts` (NEW):
   - CRUD for gift card preset amounts
   - `getActiveDenominations(storeId)`: Get active denominations for sale display
   - `updateDisplayOrder(updates)`: Batch reorder denominations
   - `updateAmount(id, amount, label?)`: Update denomination value
   - `createStandardDenominations(storeId, tenantId)`: Create standard $25-$200 set

6. `apps/store-app/src/services/supabase/tables/giftCardSettingsTable.ts` (NEW):
   - One-per-store gift card settings
   - `getOrCreate(storeId, tenantId)`: Get or create with defaults (custom amounts, 365-day expiration)
   - Amount limit helpers: enableCustomAmount, updateAmountLimits
   - Online settings: enableOnlineSales, enableEmailDelivery
   - `validateAmount(storeId, amount)`: Validate custom amount against settings

7. `apps/store-app/src/services/supabase/tables/index.ts` (NEW):
   - Barrel export for all Supabase table operations
   - Organized by module: Core, Team, Gift Card, Catalog

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test -- --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Settings tables (catalogSettings, giftCardSettings) use getOrCreate pattern for default initialization
- Products table has archive (is_active=false) separate from soft delete (is_deleted=true)
- productsTable.updatePricing auto-calculates margin: (retailPrice - costPrice) / retailPrice * 100
- Multi-tenant isolation is critical for getByBarcode and getBySku - always filter by storeId
- BookingSequences service_order is stored as JSONB array, needs `as unknown as Json` cast

**Patterns to sync:**
- Pattern #12: Settings Table Pattern - Use getOrCreate with sensible defaults for one-per-store settings tables. Default to enabled/permissive values.

**PHASE 1 BACKEND FOUNDATION COMPLETE:**
- ✅ 5 type extensions (US-001 to US-005)
- ✅ 12 Supabase tables in migration (US-006 to US-010)
- ✅ 12 Supabase type definitions (US-011)
- ✅ 12 adapters (US-012 to US-016)
- ✅ 12 table operations (US-017 to US-021)

**Next story suggestion:** US-P1R (REVIEW: Phase 1 Backend Foundation) - Comprehensive review of all Phase 1 implementation before moving to Phase 2

---

## 2026-01-21 - US-P1R: REVIEW: Phase 1 Backend Foundation
Commit: N/A (Review story - no code changes)

**Why this story?** Highest priority incomplete story (priority 1001) with no dependencies. Phase 1 implementation is complete, review ensures quality before Phase 2.

**Review Methodology:**
- Launched Explore agents to analyze types, migration, Supabase types, adapters, and table operations
- Ran `pnpm run typecheck` to verify compilation

**Review Findings:**

### 1. Type Definitions (catalog.ts) - 2 Issues Found

**Issue 1: Missing CreateCatalogSettingsInput type**
- **Severity:** LOW
- **Location:** apps/store-app/src/types/catalog.ts:496-518
- **Description:** CatalogSettings extends BaseSyncableEntity but has no corresponding CreateCatalogSettingsInput type
- **Impact:** Developers may use Partial<CatalogSettings> or type assertions for creation
- **Recommendation:** Add CreateCatalogSettingsInput type omitting all BaseSyncableEntity fields

**Issue 2: Missing CreateGiftCardSettingsInput type**
- **Severity:** LOW
- **Location:** apps/store-app/src/types/catalog.ts:954-966
- **Description:** GiftCardSettings extends BaseSyncableEntity but has no corresponding CreateGiftCardSettingsInput type
- **Impact:** Same as Issue 1
- **Recommendation:** Add CreateGiftCardSettingsInput type omitting all BaseSyncableEntity fields

### 2. Supabase Migration (031_create_catalog_tables.sql) - 2 Issues Found

**Issue 3: Missing Foreign Key on staff_id in staff_service_assignments**
- **Severity:** MEDIUM
- **Location:** supabase/migrations/031_create_catalog_tables.sql:847
- **Description:** staff_id column has NO foreign key reference to staff table
- **Impact:** Orphaned assignments possible if staff deleted, no referential integrity
- **Recommendation:** Add `REFERENCES staff(id) ON DELETE CASCADE`

**Issue 4: Missing ON DELETE CASCADE on parent_category_id**
- **Severity:** LOW
- **Location:** supabase/migrations/031_create_catalog_tables.sql:27
- **Description:** parent_category_id FK does not have ON DELETE CASCADE
- **Impact:** Child categories become orphaned when parent deleted
- **Recommendation:** Add ON DELETE CASCADE to maintain hierarchy integrity

### 3. Supabase Types (types.ts) - PASS
- All 12 catalog tables have Row, Insert, Update variants
- All columns from migration represented with correct snake_case
- No TypeScript errors or 'as any' casts

### 4. Adapters - PASS
- All 12 adapters correctly convert snake_case ↔ camelCase
- Proper null → undefined handling
- Consistent JSONB parsing patterns
- No 'as any' type casts

### 5. Table Operations - PASS
- Multi-tenant isolation: ALL queries filter by store_id ✓
- Soft delete: queries filter is_deleted = false by default ✓
- Error handling: throws on error, graceful PGRST116 handling ✓
- Tombstone pattern: 30-day expiration correctly implemented ✓
- Version: NOT manually incremented (trigger handles it) ✓

### 6. TypeScript Compilation - PASS
- `pnpm run typecheck` passes with no errors

---

## Phase 1 Review Issues

<!-- US-P1R has documented the following issues for US-P1F to address -->

1. **[ISSUE-P1-001]** Missing CreateCatalogSettingsInput type
   - File: apps/store-app/src/types/catalog.ts
   - Status: ✅ RESOLVED (US-P1F) - Added type at line 524

2. **[ISSUE-P1-002]** Missing CreateGiftCardSettingsInput type
   - File: apps/store-app/src/types/catalog.ts
   - Status: ✅ RESOLVED (US-P1F) - Added type at line 998

3. **[ISSUE-P1-003]** Missing FK on staff_id → staff(id) in staff_service_assignments
   - File: supabase/migrations/032_fix_catalog_table_foreign_keys.sql
   - Status: ✅ RESOLVED (US-P1F) - Added FK with ON DELETE CASCADE

4. **[ISSUE-P1-004]** Missing ON DELETE CASCADE on parent_category_id
   - File: supabase/migrations/032_fix_catalog_table_foreign_keys.sql
   - Status: ✅ RESOLVED (US-P1F) - Re-created FK with ON DELETE CASCADE

---

**Overall Assessment:**
Phase 1 implementation is **HIGH QUALITY** with only **4 minor issues** found:
- 2 missing type definitions (low severity)
- 2 missing FK constraints (medium-low severity)

All core functionality (types, adapters, table operations) is production-ready. The issues are isolated to type completeness and database constraints.

**Learnings:**
- Settings tables (CatalogSettings, GiftCardSettings) were treated as special cases but should still have CreateInput types for consistency
- Foreign key constraints are easy to miss when table references aren't in the same migration
- Comprehensive review with multiple agents ensures thorough coverage

---

## 2026-01-21 - US-P1F: FIX - Address Phase 1 Review Issues
Commit: e6cad7b

**Why this story?** Final story in Phase 1. US-P1R (review) identified 4 issues that need fixing before Phase 1 is complete.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - Added CreateCatalogSettingsInput type (lines 524-542) - omits all BaseSyncableEntity fields
   - Added CreateGiftCardSettingsInput type (lines 998-1016) - omits all BaseSyncableEntity fields

2. `supabase/migrations/032_fix_catalog_table_foreign_keys.sql` (NEW):
   - Added FK on staff_service_assignments.staff_id → staff(id) ON DELETE CASCADE
   - Added index for FK (idx_staff_service_assignments_staff_fk)
   - Dropped and re-created service_categories.parent_category_id FK with ON DELETE CASCADE
   - Added documentation comments on both constraints

**Verification:**
- `pnpm run typecheck` passes for store-app ✓
- Pre-existing test failures in other packages (not from this change)
- Pre-existing lint errors in other packages (not from this change)

**Learnings:**
- Adding new migration files for FK fixes is cleaner than modifying existing migrations
- Comments on FK constraints help document the cascade behavior intention

**PHASE 1 COMPLETE** ✓ (23/23 stories pass)

**Next story suggestion:** US-022 (Phase 2 first story) or US-P2R (Phase 2 Review) depending on iteration

---

## 2026-01-21 - US-022: Add booking sequence CRUD to catalogDatabase.ts
Commit: aade17f

**Why this story?** First story in Phase 2 (priority 22), no dependencies. Starts the Data Layer phase.

**Changes:**
1. `apps/store-app/src/db/schema.ts`:
   - Added BookingSequence import from '../types'
   - Added bookingSequences table declaration: `Table<BookingSequence, string>`
   - Added version 17 with bookingSequences table and indexes: `id, storeId, isEnabled, syncStatus, [storeId+isEnabled]`
   - Added `await db.bookingSequences.clear()` to clearDatabase function

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Added BookingSequence and CreateBookingSequenceInput imports
   - Added bookingSequencesDB object with CRUD operations:
     - `getAll(storeId, includeDisabled?)`: Get all sequences with optional filter
     - `getById(id)`: Get single sequence
     - `create(input, userId, storeId, tenantId?, deviceId?)`: Create new sequence with sync defaults
     - `update(id, updates, userId, deviceId?)`: Update sequence with version incrementing
     - `delete(id)`: Hard delete
     - `enable(id, userId, deviceId?)`: Enable a sequence
     - `disable(id, userId, deviceId?)`: Disable a sequence
     - `updateServiceOrder(id, serviceOrder, userId, deviceId?)`: Update service order array

**Verification:**
- `pnpm run typecheck` passes for store-app ✓
- Pre-existing test failures in other packages (not from this change)
- Pre-existing lint errors in other packages (not from this change)

**Learnings:**
- BookingSequence is a simple type with serviceOrder (string[]) and isEnabled (boolean)
- Adding a new IndexedDB table requires a new schema version
- Follows same pattern as other catalog DB objects (createBaseSyncableDefaults, version incrementing)

**Next story suggestion:** US-023 (Add product restore method to catalogDatabase.ts) - Same file, continues Data Layer work

---

## 2026-01-21 - US-023: Add product restore method to catalogDatabase.ts
Commit: dce5500

**Why this story?** Highest priority incomplete story (priority 23) in Phase 2. Same file as US-022 (catalogDatabase.ts is fresh in context), continues Data Layer work.

**Changes:**
1. `apps/store-app/src/db/catalogDatabase.ts`:
   - Added `restore(id, userId, deviceId)` method to productsDB (lines 953-981)
   - Method retrieves product by ID, validates existence
   - Sets isActive=true, isDeleted=false (reverses archive/soft delete)
   - Increments version (product.version + 1)
   - Updates vectorClock with new version keyed by deviceId
   - Sets syncStatus to 'local' for sync propagation
   - Includes full audit trail: lastModifiedBy, lastModifiedByDevice, updatedAt

**Verification:**
- `pnpm run typecheck` passes for store-app ✓
- Pre-existing test failures in other packages (not from this change)

**Learnings:**
- productsDB already had archive() that sets isActive=false, but no restore()
- Following the pattern from menuServicesDB.restore() which clears archivedAt/archivedBy
- Product restore is simpler since products use isActive flag rather than status enum

**Next story suggestion:** US-024 (Fix getByBarcode multi-tenant isolation in catalogDataService.ts) - Same module, security-critical fix

---

## 2026-01-21 - US-024: Fix getByBarcode multi-tenant isolation in catalogDataService.ts
Commit: 8194282

**Why this story?** Highest priority incomplete story (priority 24) in Phase 2. CRITICAL security fix for multi-tenant isolation - without storeId filter, barcode lookup could return products from other stores.

**Changes:**
1. `packages/sqlite-adapter/src/services/catalogServices.ts` (line 1339):
   - ProductSQLiteService.getByBarcode: Added storeId parameter
   - SQL query now includes `store_id = ?` filter for multi-tenant isolation

2. `apps/store-app/src/services/sqliteServices.ts` (line 1879):
   - sqliteProductsDB.getByBarcode: Updated wrapper signature to accept storeId
   - Pass storeId to ProductSQLiteService.getByBarcode

3. `apps/store-app/src/services/domain/catalogDataService.ts` (line 513):
   - productsService.getByBarcode: Updated SQLite path to pass storeId
   - Both SQLite and Dexie paths now consistently require storeId

**Acceptance Criteria Verification:**
- ✅ productsService.getByBarcode(storeId, barcode) signature already correct
- ✅ SQLite path: added storeId filter to query
- ✅ Supabase path: already had storeId filter (verified in productsTable.ts:71-82)
- ✅ All callers already pass storeId (catalogDataService API unchanged)
- ✅ No products returned from other stores (query filters by store_id)
- ✅ pnpm run typecheck passes for store-app and sqlite-adapter

**Learnings:**
- Multi-tenant isolation is CRITICAL for all data access methods
- The Supabase productsTable.getByBarcode was already correctly implementing storeId filter
- The SQLite path was the security gap - it was only filtering by barcode
- Always verify all data paths (SQLite, Dexie, Supabase) enforce tenant isolation

**Patterns to sync:**
- Pattern #13: Multi-Tenant Data Access Audit - When adding barcode/SKU/ID lookup methods, verify ALL data paths (SQLite, IndexedDB, Supabase) include storeId/tenantId filter

**Next story suggestion:** US-025 (Add Supabase routing to catalogDataService.ts) - Continues Phase 2 data layer work

---

## 2026-01-22 - US-025: Add Supabase routing to catalogDataService.ts (categories)
Commit: 8c3f3c7

**Why this story?** Highest priority incomplete story (priority 25) in Phase 2 with no dependencies. Continues the data layer work from US-024 by adding Supabase routing for categories.

**Changes:**
1. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Added `shouldUseSupabase()` function (lines 69-92):
     - Returns false if SQLite is enabled (Electron)
     - Returns false if VITE_USE_SUPABASE !== 'true' (opt-in flag)
     - Returns false if navigator.onLine is false (offline)
     - Returns true otherwise
   - Added `USE_SUPABASE` constant (line 94)
   - Added helper functions:
     - `getTenantId()`: Gets tenant ID from auth.store.tenantId or storeId fallback
     - `getUserId()`: Gets user ID from auth.user.id or member.memberId fallback
     - `getDeviceId()`: Gets or generates device ID from localStorage
   - Imported serviceCategoriesTable and adapter functions (lines 22-29)
   - Imported ServiceCategory, CreateCategoryInput types (line 54)
   - Updated `serviceCategoriesService` with Supabase routing (lines 201-346):
     - `getAll()`: Supabase → serviceCategoriesTable.getByStoreId + toServiceCategories
     - `getById()`: Supabase → serviceCategoriesTable.getById + toServiceCategory
     - `create()`: Supabase → toServiceCategoryInsert + serviceCategoriesTable.create + toServiceCategory
     - `update()`: Supabase → toServiceCategoryUpdate + serviceCategoriesTable.update + toServiceCategory
     - `delete()`: Supabase → serviceCategoriesTable.delete (soft delete with tombstone)
     - Added new `search()` method with Supabase path
     - Added new `getOnlineBookingCategories()` method
     - Added new `getUpdatedSince()` method for sync
   - Added type assertions for SQLite returns (which use `unknown` types)

**Routing Priority (documented in JSDoc):**
1. SQLite (if USE_SQLITE=true, Electron only)
2. Supabase (if USE_SUPABASE=true and online)
3. Dexie/IndexedDB (default local-first storage)

**Verification:**
- `pnpm run typecheck` passes for store-app ✓
- Tests: 3205 passed, 13 failed (all pre-existing MQTT/Pad failures unrelated to this change)

**Learnings:**
- Auth state structure: storeId at root level, tenantId inside store object, userId requires checking user.id or member.memberId
- SQLite service wrappers intentionally return `unknown` types (documented in file header) - need explicit type assertions
- Supabase routing is opt-in via VITE_USE_SUPABASE=true to maintain local-first default behavior
- The pattern for Supabase methods: `const rows = await table.method(); return toAppTypes(rows);`

**Patterns to sync:**
- Pattern #14: Supabase Routing in DataService - When adding Supabase path to data services, use opt-in flag (VITE_USE_SUPABASE), check online status, and apply type adapters to convert rows to app types

**Next story suggestion:** US-026 (Add Supabase routing for menu services) - Same file, continues Phase 2 data layer work

---

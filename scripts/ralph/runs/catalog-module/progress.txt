# Catalog Module Implementation Progress

## Run Info
- Branch: ralph/catalog-module
- Started: 2026-01-21
- PRD: 88 user stories across 6 phases (includes Review + Fix stories)

## Phase-by-Phase Execution

To run a specific phase only, use:
```bash
./scripts/ralph/ralph.sh <iterations> catalog-module --phase <N>
```

Example: `./scripts/ralph/ralph.sh 30 catalog-module --phase 1`

## Codebase Patterns

### Catalog Module Architecture
- Types: `apps/store-app/src/types/catalog.ts`
- IndexedDB: `apps/store-app/src/db/catalogDatabase.ts`
- Data Service: `apps/store-app/src/services/domain/catalogDataService.ts`
- Primary Hook: `apps/store-app/src/hooks/useCatalog.ts`
- UI Components: `apps/store-app/src/components/menu-settings/`

### Supabase Patterns
- Adapters: `apps/store-app/src/services/supabase/adapters/` - snake_case ↔ camelCase
- Tables: `apps/store-app/src/services/supabase/tables/` - CRUD operations
- Follow existing patterns from `clientAdapter.ts` and `clientsTable.ts`

### Type Extension Pattern
```typescript
import { BaseSyncableEntity } from './common';

export interface CatalogEntity extends BaseSyncableEntity {
  // Business fields here
}
```

### Adapter Pattern
```typescript
export function toAppType(row: SupabaseRow): AppType {
  return {
    id: row.id,
    tenantId: row.tenant_id,
    storeId: row.store_id,
    // ... map all fields
  };
}
```

### Table Operation Pattern
```typescript
export const entityTable = {
  async getByStoreId(storeId: string): Promise<Row[]> {
    const { data, error } = await supabase
      .from('table_name')
      .select('*')
      .eq('store_id', storeId)
      .eq('is_deleted', false);
    if (error) throw error;
    return data || [];
  },
  // ... other CRUD methods
};
```

## Phase Checkpoints

### Phase 1: Backend Foundation (US-001 to US-021 + US-P1R + US-P1F) - 23 stories
**Implementation Stories (21):**
- [x] US-001: ServiceCategory extends BaseSyncableEntity ✓
- [x] US-002: MenuService extends BaseSyncableEntity ✓
- [x] US-003: ServiceVariant and ServicePackage extend BaseSyncableEntity ✓
- [x] US-004: AddOnGroup and AddOnOption extend BaseSyncableEntity ✓
- [x] US-005: All remaining catalog types extend BaseSyncableEntity ✓
- [x] US-006: service_categories table created ✓
- [x] US-007: menu_services and service_variants tables created ✓
- [x] US-008: service_packages table created ✓
- [x] US-009: add_on_groups and add_on_options tables created ✓
- [x] US-010: All remaining tables created (staff_service_assignments, catalog_settings, booking_sequences, products, gift_card_denominations, gift_card_settings) ✓
- [x] US-011: Supabase types added ✓
- [x] US-012: serviceCategoryAdapter.ts created ✓
- [x] US-013: menuServiceAdapter.ts created ✓
- [x] US-014: serviceVariantAdapter.ts and servicePackageAdapter.ts created ✓
- [x] US-015: addOnGroupAdapter.ts and addOnOptionAdapter.ts created ✓
- [x] US-016: Remaining adapters (staffServiceAssignment, catalogSettings, bookingSequence, product, giftCardDenomination, giftCardSettings) ✓
- [ ] All table operations created and exported (US-017 to US-021)
- [x] `pnpm run typecheck` passes ✓

**Review Story (US-P1R):**
- [ ] Explore agent analyzes all Phase 1 files
- [ ] Plan agent verifies architectural decisions
- [ ] Document issues in 'Phase 1 Review Issues' section below

**Fix Story (US-P1F):**
- [ ] All Phase 1 Review Issues resolved

- Status: In Progress (16/23 complete)

### Phase 2: Data Layer (US-022 to US-030 + US-P2R + US-P2F) - 11 stories
**Implementation Stories (9):**
- [ ] Booking sequence CRUD in IndexedDB
- [ ] Product restore method
- [ ] getByBarcode fixed for multi-tenant
- [ ] Supabase routing in catalogDataService
- [ ] `pnpm test --run` passes

**Review Story (US-P2R):**
- [ ] Security check: multi-tenant isolation verified
- [ ] Document issues in 'Phase 2 Review Issues' section below

**Fix Story (US-P2F):**
- [ ] All Phase 2 Review Issues resolved

- Status: Not started

### Phase 3: UI Components (US-031 to US-054 + US-P3R + US-P3F) - 26 stories
**Implementation Stories (24):**
- [ ] ConfirmDialog component replaces all browser confirm()
- [ ] Skeleton loaders in all sections
- [ ] Keyboard drag-drop where applicable
- [ ] Zod validation in ServiceModal
- [ ] Staff assignments load in ServiceModal
- [ ] More Options button works

**Review Story (US-P3R):**
- [ ] Browser verification via Playwright MCP
- [ ] No browser confirm() or alert() calls remain
- [ ] Document issues in 'Phase 3 Review Issues' section below

**Fix Story (US-P3F):**
- [ ] All Phase 3 Review Issues resolved

- Status: Not started

### Phase 4: Checkout & Booking (US-055 to US-063 + US-P4R + US-P4F) - 11 stories
**Implementation Stories (9):**
- [ ] VariantSelector component
- [ ] AddOnSelector component
- [ ] ServiceGrid shows variant/add-on flow
- [ ] useBookingServices hook
- [ ] Availability badges in booking
- [ ] turnWeight in smartAutoAssign

**Review Story (US-P4R):**
- [ ] Full checkout flow tested in browser
- [ ] Variant → Add-on → Price calculation verified
- [ ] Document issues in 'Phase 4 Review Issues' section below

**Fix Story (US-P4F):**
- [ ] All Phase 4 Review Issues resolved

- Status: Not started

### Phase 5: Module Integrations (US-064 to US-072 + US-P5R + US-P5F) - 11 stories
**Implementation Stories (9):**
- [ ] Add-ons displayed in tickets
- [ ] Staff override duration in timer
- [ ] catalogSyncService created for Online Store
- [ ] Mock data replaced with real sync
- [ ] showPriceOnline respected
- [ ] Commission calculation implemented
- [ ] Rebook reminder service created

**Review Story (US-P5R):**
- [ ] Mock data completely removed from Online Store
- [ ] Commission calculation verified
- [ ] Document issues in 'Phase 5 Review Issues' section below

**Fix Story (US-P5F):**
- [ ] All Phase 5 Review Issues resolved

- Status: Not started

### Phase 6: Testing (US-073 to US-076 + US-P6R + US-P6F) - 6 stories
**Implementation Stories (4):**
- [ ] Adapter unit tests (90% coverage)
- [ ] Table operation tests (85% coverage)
- [ ] Integration tests for checkout flow
- [ ] E2E test for checkout flow

**Review Story (US-P6R) - FINAL REVIEW:**
- [ ] All tests pass
- [ ] Entire catalog module scanned for issues
- [ ] No TODO comments, console.log, or 'as any' casts
- [ ] Document issues in 'Phase 6 Review Issues' section below

**Fix Story (US-P6F) - FINAL FIX:**
- [ ] All Phase 6 Review Issues resolved
- [ ] CATALOG MODULE COMPLETE

- Status: Not started

---

## Phase Review Issues

### Phase 1 Review Issues
<!-- US-P1R will document issues here -->
<!-- US-P1F will mark issues as [RESOLVED] -->

### Phase 2 Review Issues
<!-- US-P2R will document issues here -->
<!-- US-P2F will mark issues as [RESOLVED] -->

### Phase 3 Review Issues
<!-- US-P3R will document issues here -->
<!-- US-P3F will mark issues as [RESOLVED] -->

### Phase 4 Review Issues
<!-- US-P4R will document issues here -->
<!-- US-P4F will mark issues as [RESOLVED] -->

### Phase 5 Review Issues
<!-- US-P5R will document issues here -->
<!-- US-P5F will mark issues as [RESOLVED] -->

### Phase 6 Review Issues
<!-- US-P6R will document issues here -->
<!-- US-P6F will mark issues as [RESOLVED] -->

---

## Iteration Log

## 2026-01-21 - US-001: Extend ServiceCategory with BaseSyncableEntity
Commit: 7c06f4b

**Why this story?** First story (priority 1), no dependencies, forms foundation for Phase 1 type system.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - ServiceCategory now extends BaseSyncableEntity (line 33)
   - Updated CreateCategoryInput to omit all BaseSyncableEntity fields (lines 53-73)

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Added import for createBaseSyncableDefaults from types/common
   - Updated serviceCategoriesDB.create() to use createBaseSyncableDefaults helper
   - Added tenantId and deviceId parameters to create function

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added createSeedSyncFields() helper function for seed data
   - Updated all 8 category definitions to spread syncFields
   - Updated migration function to include sync fields

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test` runs (pre-existing failures not related to catalog module)

**Learnings:**
- When extending types with BaseSyncableEntity, must update all code paths that create those entities
- Seed data uses 'synced' status since it doesn't need to sync upstream
- Migration data uses 'local' status since it needs to sync to Supabase
- Pre-existing TypeScript errors exist in portfolioAdapter.ts, portfolioTable.ts, portfolioSlice.ts (untracked files, not catalog module related)

**Next story suggestion:** US-002 (Extend MenuService with BaseSyncableEntity) - same file, same pattern, builds on this work

---

## 2026-01-21 - US-002: Extend MenuService with BaseSyncableEntity
Commit: 1e10dca

**Why this story?** Second story (priority 2), no dependencies, same file as US-001 (catalog.ts is fresh in context), builds directly on the type extension pattern.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - MenuService now extends BaseSyncableEntity (line 116)
   - Added variantCount: number field to track variant count
   - Removed duplicate sync fields (createdAt, updatedAt, syncStatus, createdBy, lastModifiedBy) that are now inherited from BaseSyncableEntity
   - Updated CreateMenuServiceInput to omit all BaseSyncableEntity fields
   - Status field already used ServiceStatus union type ('active' | 'inactive' | 'archived') - verified
   - archivedAt and archivedBy fields already present - verified

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Updated menuServicesDB.create() to use createBaseSyncableDefaults helper
   - Added tenantId and deviceId parameters to create function signature
   - Added variantCount defaulting to 0

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Updated all 11 MenuService seed definitions to spread syncFields
   - Added variantCount: N to all services (N = number of variants, or 0 for no variants)
   - Updated migration function MenuService creation to include migrationSyncFields and variantCount

**Verification:**
- `pnpm run typecheck` passes ✓
- Tests run with pre-existing failures not related to catalog module

**Learnings:**
- MenuService status field already used ServiceStatus union type - no change needed
- archivedAt and archivedBy fields were already present - no change needed
- When extending with BaseSyncableEntity, must remove duplicate fields that were previously inline
- Seed data with variants needs accurate variantCount (e.g., womensHaircut has 3 variants → variantCount: 3)

**Next story suggestion:** US-003 (Extend ServiceVariant and ServicePackage with sync fields) - same file, continues type extension pattern

---

## 2026-01-21 - US-003: Extend ServiceVariant and ServicePackage with sync fields
Commit: 3eb3323

**Why this story?** Highest priority story (priority 3) with passes: false. Same file as US-001/US-002, continues the type extension pattern with code fresh in context.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - ServiceVariant now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - ServicePackage now extends BaseSyncableEntity (removed duplicate fields including createdBy, lastModifiedBy)
   - Updated CreateVariantInput to omit all BaseSyncableEntity fields
   - Updated CreatePackageInput to omit all BaseSyncableEntity fields

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Updated serviceVariantsDB.create() to use createBaseSyncableDefaults with userId, deviceId, tenantId, storeId params
   - Updated serviceVariantsDB.update() to include userId for audit trail
   - Updated serviceVariantsDB.setDefault() to include userId for audit trail
   - Updated servicePackagesDB.create() to use createBaseSyncableDefaults

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added createSeedVariant() helper function with all sync fields
   - Added createSeedPackage() helper function with all sync fields
   - Updated all variant push statements to use createSeedVariant()
   - Updated all package definitions to use createSeedPackage()

4. `apps/store-app/src/hooks/useCatalog.ts`:
   - Updated serviceVariantsDB.create() calls to include userId parameter
   - Updated serviceVariantsDB.update() calls to include userId parameter

5. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Updated serviceVariantsService.create() to pass userId to Dexie API
   - Updated serviceVariantsService.update() to pass userId to Dexie API

6. `apps/store-app/src/store/slices/catalogSlice.ts`:
   - Updated createVariant thunk to include userId in parameters
   - Updated updateVariant thunk to include userId in parameters

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- When extending types with BaseSyncableEntity, must update ALL callers to include new required parameters (userId, tenantId, deviceId)
- Seed data helper functions make type-safe seeding much cleaner
- The serviceVariantsDB and servicePackagesDB create() functions now have consistent signatures with menuServicesDB

**Patterns to sync:**
- Pattern #1: Seed Helper Functions - Create helper functions for seeding entities with full sync fields instead of inline object literals

**Next story suggestion:** US-004 (Extend AddOnGroup and AddOnOption with sync fields) - same file, same pattern, continues type extension work

---

## 2026-01-21 - US-004: Extend AddOnGroup and AddOnOption with sync fields
Commit: 233ee98

**Why this story?** Highest priority story (priority 4) with passes: false. Same file as US-001-003, continues the type extension pattern with code fresh in context.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - AddOnGroup already extends BaseSyncableEntity (line 339) - verified
   - AddOnOption already extends BaseSyncableEntity (line 367) - verified
   - CreateAddOnGroupInput and CreateAddOnOptionInput already omit all BaseSyncableEntity fields - verified
   - Fixed fromServiceAddOn() function to return CreateAddOnGroupInput/CreateAddOnOptionInput types instead of incomplete partial types (lines 644-675)

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - addOnGroupsDB.create() already uses createBaseSyncableDefaults (line 459) - verified
   - addOnGroupsDB.update() already handles version/vectorClock sync fields (lines 484-492) - verified
   - addOnOptionsDB.create() already uses createBaseSyncableDefaults (line 538) - verified
   - addOnOptionsDB.update() already handles version/vectorClock sync fields (lines 564-571) - verified

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added createSeedAddOnGroup() helper function with all sync fields
   - Added createSeedAddOnOption() helper function with all sync fields
   - Updated add-on group and option seeding to use helper functions

4. `apps/store-app/src/hooks/useCatalog.ts`:
   - Updated addOnGroupsDB.create() call to include userId parameter (line 833)
   - Updated addOnGroupsDB.update() call to include userId parameter (line 844)
   - Updated addOnOptionsDB.create() call to include userId parameter (line 883)
   - Updated addOnOptionsDB.update() call to include userId parameter (line 894)

5. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Updated addOnGroupsService.create() to pass userId to Dexie API (line 315)
   - Updated addOnGroupsService.update() to pass userId to Dexie API (line 323)
   - Updated addOnOptionsService.create() to pass userId to Dexie API (line 357)
   - Updated addOnOptionsService.update() to pass userId to Dexie API (line 365)
   - Added import for AddOnGroup and AddOnOption types

6. `apps/store-app/src/store/slices/catalogSlice.ts`:
   - Updated createAddOnGroup thunk to include userId in parameters (line 267)
   - Updated updateAddOnGroup thunk to include userId in parameters (line 274)
   - Updated createAddOnOption thunk to include userId in parameters (line 290)
   - Updated updateAddOnOption thunk to include userId in parameters (line 297)

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- AddOnGroup and AddOnOption types were already extended with BaseSyncableEntity in previous iterations
- The main work was updating all callers to pass the required userId parameter
- The fromServiceAddOn function needed to be fixed to return input types (not full entity types) since sync fields are auto-generated during create()

**Patterns to sync:**
- Pattern #2: Input Types for Conversion Functions - When converting from legacy types, return CreateXxxInput types instead of partial entity types, since sync fields are auto-generated during create()

**Next story suggestion:** US-005 (Extend remaining catalog types with sync fields) - same file, completes type system foundation

---

## 2026-01-21 - US-005: Extend remaining catalog types with BaseSyncableEntity
Commit: 73642a5

**Why this story?** Highest priority story (priority 5) with passes: false. Continues type extension pattern from US-001-004, completing the type system foundation.

**Changes:**
1. `apps/store-app/src/types/catalog.ts`:
   - StaffServiceAssignment now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - CatalogSettings now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - BookingSequence now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - GiftCardDenomination now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - GiftCardSettings now extends BaseSyncableEntity (removed duplicate id, storeId, createdAt, updatedAt, syncStatus fields)
   - Updated CreateStaffAssignmentInput to omit all BaseSyncableEntity fields
   - Updated CreateBookingSequenceInput to omit all BaseSyncableEntity fields
   - Updated CreateGiftCardDenominationInput to omit all BaseSyncableEntity fields

2. `apps/store-app/src/db/catalogDatabase.ts`:
   - Updated staffServiceAssignmentsDB.create() with userId, deviceId, tenantId params
   - Updated staffServiceAssignmentsDB.update() with userId, deviceId params and version incrementing
   - Updated assignStaffToService() with userId, deviceId, tenantId params
   - Updated removeStaffFromService() with userId, deviceId params
   - Updated catalogSettingsDB.getOrCreate() with userId, deviceId, tenantId params
   - Updated catalogSettingsDB.update() with userId, deviceId params and version incrementing

3. `apps/store-app/src/db/catalogSeed.ts`:
   - Added DEFAULT_USER_ID constant
   - Updated CatalogSettings seeding to use createSeedSyncFields helper

4. `apps/store-app/src/hooks/useCatalog.ts`:
   - Updated catalogSettings initialization to pass all required params
   - Updated updateCatalogSettings with userId and deviceId
   - Updated createGiftCardDenomination with full sync fields
   - Updated updateGiftCardDenomination with version incrementing
   - Updated updateGiftCardSettings with full sync fields and version incrementing

5. `apps/store-app/src/services/domain/catalogDataService.ts`:
   - Updated staffServiceAssignmentsService.create() with new signature
   - Updated staffServiceAssignmentsService.update() with new signature
   - Updated catalogSettingsService.set() with new signature

6. `apps/store-app/src/store/slices/catalogSlice.ts`:
   - Updated fetchCatalogSettings thunk with userId, deviceId, tenantId params
   - Updated updateCatalogSettings thunk with userId, deviceId params

7. `apps/store-app/src/components/giftcards/GiftCardsPage.tsx`:
   - Updated createDenomination with full sync fields
   - Updated updateDenomination with version incrementing
   - Updated updateSettings with full sync fields and version incrementing

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- When extending types with BaseSyncableEntity, must update ALL callers across multiple files (hooks, services, slices, components)
- The ripple effect is significant - changing a function signature requires updating all call sites
- Using default values for deviceId/tenantId helps with backward compatibility during incremental migration
- GiftCard functionality was spread across multiple files (hook, page component) requiring consistent updates

**Patterns to sync:**
- Pattern #3: Cascading API Changes - When updating function signatures to require new params, provide sensible defaults to minimize breakage during migration

**Next story suggestion:** US-006 (Create Supabase migration for service_categories table) - Phase 1 types are complete, next step is database migration

---

## 2026-01-21 - US-006: Create Supabase migration for service_categories table
Commit: 168bdd2

**Why this story?** Highest priority incomplete story (priority 6) with no dependencies. Phase 1 type system is complete (US-001-005), now creating database tables to support Supabase sync.

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (NEW):
   - Created service_categories table with all fields from ServiceCategory type
   - Multi-tenant columns: tenant_id, store_id, location_id
   - Core business fields: name, description, color, icon, display_order, is_active
   - Hierarchy support: parent_category_id (self-referencing FK)
   - Online booking: show_online_booking
   - Sync metadata: sync_status, version, vector_clock (JSONB), last_synced_version
   - Timestamps: created_at, updated_at
   - Audit trail: created_by, created_by_device, last_modified_by, last_modified_by_device
   - Soft delete: is_deleted, deleted_at, deleted_by, deleted_by_device, tombstone_expires_at
   - RLS policies for store_id isolation (SELECT, INSERT, UPDATE, DELETE)
   - Indexes: store_id, store_active, display_order, parent, sync, updated
   - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` passes ✓
- Migration file follows existing pattern from 009_create_timesheets_table.sql and 013_create_staff_ratings_table.sql

**Learnings:**
- Supabase migrations use CHECK constraints for enum-like columns (sync_status)
- RLS policies use members table with store_ids array to enforce multi-tenant isolation
- Triggers can increment version automatically on update for optimistic concurrency
- Partial indexes (WHERE is_deleted = false) optimize common queries

**Patterns to sync:**
- Pattern #4: Catalog Migration Template - Use this migration as template for all catalog tables (sync metadata, RLS, triggers)

**Next story suggestion:** US-007 (Add menu_services and service_variants tables to migration) - Same file, continues the database migration work

---

## 2026-01-21 - US-007: Add menu_services and service_variants tables to migration
Commit: 42985d2

**Why this story?** Highest priority incomplete story (priority 7). Continues the database migration work from US-006, same file (migration file is fresh in context).

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql`:
   - Added menu_services table (lines 128-312):
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Foreign key: category_id → service_categories(id) ON DELETE CASCADE
     - Core fields: name, description, sku
     - Pricing: pricing_type (CHECK constraint), price, price_max, cost, taxable
     - Duration: duration, extra_time, extra_time_type (CHECK constraint)
     - Client care: aftercare_instructions, requires_patch_test
     - Variants: has_variants, variant_count
     - Staff: all_staff_can_perform
     - Booking: booking_availability (CHECK), online_booking_enabled, requires_deposit, deposit_amount/percentage
     - Online limits: online_booking_buffer_minutes, advance_booking_days_min/max
     - Additional: rebook_reminder_days, turn_weight, commission_rate, color, images[], tags[]
     - Status: status (CHECK), display_order, show_price_online, allow_custom_duration
     - Archive: archived_at, archived_by
     - Sync metadata, timestamps, audit trail, soft delete
     - 9 indexes for common query patterns
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

   - Added service_variants table (lines 314-437):
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Foreign key: service_id → menu_services(id) ON DELETE CASCADE
     - Core fields: name, duration, price
     - Extra time: extra_time, extra_time_type (CHECK constraint)
     - Status: is_default, display_order, is_active
     - Sync metadata, timestamps, audit trail, soft delete
     - 7 indexes including default variant lookup
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- Note: Monorepo-level typecheck has pre-existing TS6310 error in packages/types - unrelated to this change
- Migration follows established pattern from US-006

**Learnings:**
- CHECK constraints are powerful for enforcing enum values at database level
- CASCADE delete on foreign keys simplifies cleanup (deleting a service auto-deletes its variants)
- DECIMAL(10,2) is appropriate for currency/pricing fields
- TEXT[] for PostgreSQL arrays works well for tags and images
- Partial indexes (WHERE is_default = true) help with variant default lookups

**Patterns to sync:**
- Pattern #5: Foreign Key Cascade - Use ON DELETE CASCADE for child tables (variants → services, options → groups) to ensure referential integrity

**Next story suggestion:** US-008 (Add service_packages table to migration) - Same file, continues building out the catalog tables

---

## 2026-01-21 - US-008: Add service_packages table to migration
Commit: d4b0d4f

**Why this story?** Highest priority incomplete story (priority 8). Continues the database migration work from US-007, same file (migration file is fresh in context).

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (lines 439-586):
   - Added service_packages table with all ServicePackage type fields
   - Multi-tenant columns: tenant_id, store_id, location_id
   - Core fields: name, description
   - Services array stored as JSONB (PackageServiceItem[])
   - Pricing: original_price, package_price, discount_type (CHECK), discount_value
   - Booking mode: booking_mode (CHECK) - 'single-session' | 'multiple-visits'
   - Validity: validity_days, usage_limit
   - Booking settings: booking_availability (CHECK), online_booking_enabled
   - Staff restrictions: restricted_staff_ids (TEXT[])
   - Status: is_active, display_order
   - Visual: color, images[]
   - Sync metadata, timestamps, audit trail, soft delete
   - 6 indexes including booking availability filter
   - RLS policies for all CRUD operations
   - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- Migration follows established pattern from US-006, US-007

**Learnings:**
- JSONB is ideal for storing arrays of complex objects (PackageServiceItem[])
- No foreign keys to menu_services since services array is denormalized in JSONB
- Denormalization in JSONB trades referential integrity for simpler queries and offline support

**Next story suggestion:** US-009 (Add add_on_groups and add_on_options tables to migration) - Same file, continues building out catalog tables

---

## 2026-01-21 - US-009: Add add_on_groups and add_on_options tables to migration
Commit: 00bff2f

**Why this story?** Highest priority incomplete story (priority 9). Continues the database migration work from US-008, same file (migration file is fresh in context).

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (lines 589-827):
   - Added add_on_groups table:
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Core fields: name, description
     - Selection rules: selection_mode ('single'|'multiple'), min_selections, max_selections, is_required
     - Applicability: applicable_to_all (BOOLEAN), applicable_category_ids (TEXT[]), applicable_service_ids (TEXT[])
     - Status: is_active, display_order, online_booking_enabled
     - Sync metadata, timestamps, audit trail, soft delete
     - 6 indexes including applicability filter
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

   - Added add_on_options table:
     - Multi-tenant columns: tenant_id, store_id, location_id
     - Foreign key: group_id → add_on_groups(id) ON DELETE CASCADE
     - Core fields: name, description
     - Pricing & Duration: price (DECIMAL), duration (INTEGER minutes)
     - Status: is_active, display_order
     - Sync metadata, timestamps, audit trail, soft delete
     - 6 indexes for common query patterns
     - RLS policies for all CRUD operations
     - Trigger for auto-updating updated_at and incrementing version

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)
- Migration follows established pattern from US-006 through US-008

**Learnings:**
- TEXT[] is the correct type for storing UUID arrays in PostgreSQL (applicable_category_ids, applicable_service_ids)
- ON DELETE CASCADE on group_id ensures options are deleted when their parent group is deleted
- selection_mode uses CHECK constraint to enforce 'single' | 'multiple' enum values

**Next story suggestion:** US-010 (Add remaining catalog tables to migration) - Same file, completes the migration

---

## 2026-01-21 - US-010: Add remaining catalog tables to migration
Commit: 0cf38d4

**Why this story?** Highest priority incomplete story (priority 10). Continues the database migration work from US-009, completing all 12 catalog tables.

**Changes:**
1. `supabase/migrations/031_create_catalog_tables.sql` (lines 833-1565):
   - Added staff_service_assignments table:
     - Links staff to services with custom price/duration/commission overrides
     - Unique constraint on (store_id, staff_id, service_id)
     - Foreign key to menu_services(id) ON DELETE CASCADE

   - Added catalog_settings table:
     - Per-store catalog configuration (one record per store via UNIQUE constraint)
     - Default duration, extra time, tax rate settings
     - Feature toggles: packages, add-ons, variants, custom pricing
     - Online booking defaults

   - Added booking_sequences table:
     - Defines service order for logical booking flow
     - service_order stored as JSONB array of service IDs
     - is_enabled flag for toggling

   - Added products table:
     - Retail and backbar products for inventory
     - SKU and barcode identifiers with indexes
     - Pricing (retail_price, cost_price, margin)
     - Inventory management (min_stock_level, reorder_quantity)
     - Supplier info (supplier_id, supplier_name)

   - Added gift_card_denominations table:
     - Preset gift card amounts for quick sale
     - amount (DECIMAL) and optional label
     - display_order for sorting

   - Added gift_card_settings table:
     - Per-store gift card configuration (one per store via UNIQUE constraint)
     - Custom amount limits (allow_custom_amount, min_amount, max_amount)
     - Expiration settings (default_expiration_days)
     - Online/email delivery settings

All 6 tables include:
- Multi-tenant isolation (tenant_id, store_id, location_id)
- Sync metadata (sync_status, version, vector_clock, last_synced_version)
- RLS policies for SELECT, INSERT, UPDATE, DELETE
- Auto-increment version trigger on updates
- Soft delete support (is_deleted, deleted_at, deleted_by, tombstone_expires_at)

**Verification:**
- `pnpm run typecheck` (store-app) passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)
- All 12 tables verified: service_categories, menu_services, service_variants, service_packages, add_on_groups, add_on_options, staff_service_assignments, catalog_settings, booking_sequences, products, gift_card_denominations, gift_card_settings
- All 12 tables have RLS enabled

**Learnings:**
- UNIQUE constraints (CONSTRAINT xyz_store_unique UNIQUE (store_id)) enforce one-per-store for settings tables
- JSONB arrays are flexible for service_order in booking_sequences (avoids separate join table)
- Products table needs indexes on both SKU and barcode for efficient lookups
- Composite indexes help with multi-column filters (e.g., store_id + category)

**Next story suggestion:** US-011 (Add catalog table types to Supabase types.ts) - Next phase of backend foundation: TypeScript types for the new tables

---

## 2026-01-21 - US-011: Add catalog table types to Supabase types.ts
Commit: b5357cc

**Why this story?** Highest priority incomplete story (priority 11). Database migration (US-006-010) is complete, next logical step is TypeScript types for Supabase sync.

**Changes:**
1. `apps/store-app/src/services/supabase/types.ts`:
   - Added 12 new table type definitions to Database['public']['Tables'] interface:
     - service_categories (lines ~960-1040)
     - menu_services (lines ~1042-1180)
     - service_variants (lines ~1182-1260)
     - service_packages (lines ~1262-1365)
     - add_on_groups (lines ~1367-1465)
     - add_on_options (lines ~1467-1545)
     - staff_service_assignments (lines ~1547-1615)
     - catalog_settings (lines ~1617-1720)
     - booking_sequences (lines ~1722-1790)
     - catalog_products (lines ~1792-1920)
     - catalog_gift_card_denominations (lines ~1922-1995)
     - catalog_gift_card_settings (lines ~1997-2070)
   - Added 8 catalog module enums:
     - SyncStatus: 'local' | 'pending' | 'synced' | 'conflict' | 'error'
     - PricingType: 'fixed' | 'from' | 'free' | 'varies' | 'hourly'
     - ServiceStatus: 'active' | 'inactive' | 'archived'
     - BookingAvailability: 'online' | 'in-store' | 'both' | 'disabled'
     - ExtraTimeType: 'processing' | 'blocked' | 'finishing'
     - DiscountType: 'fixed' | 'percentage'
     - BookingMode: 'single-session' | 'multiple-visits'
     - SelectionMode: 'single' | 'multiple'
   - Added Row, Insert, Update helper type exports for all 12 tables

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Products table named `catalog_products` to avoid collision with existing `products` table concept
- Gift card tables prefixed with `catalog_` to disambiguate from existing gift_cards tables (migration 019)
- Every Row type includes full sync metadata: sync_status, version, vector_clock, last_synced_version
- Every Row type includes full audit trail: created_by, created_by_device, last_modified_by, last_modified_by_device
- Every Row type includes soft delete fields: is_deleted, deleted_at, deleted_by, deleted_by_device, tombstone_expires_at

**Patterns to sync:**
- Pattern #6: Supabase Type Convention - Use Row/Insert/Update triplet for every table. Row is complete, Insert has optional auto-generated fields, Update is Partial<Insert>

**Next story suggestion:** US-012 (Create serviceCategoryAdapter.ts) - Same file area, creates adapters to convert between Supabase and app types

---

## 2026-01-21 - US-012: Create serviceCategoryAdapter.ts
Commit: a1ca37d

**Why this story?** Highest priority incomplete story (priority 12). Database migration and types (US-006-011) complete, next logical step is adapters for type conversion.

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/serviceCategoryAdapter.ts` (NEW):
   - Created `toServiceCategory(row)`: Converts ServiceCategoryRow → ServiceCategory
   - Created `toServiceCategories(rows)`: Batch conversion
   - Created `toServiceCategoryInsert(category, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toServiceCategoryUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles snake_case ↔ camelCase conversion for all fields
   - Handles JSONB vectorClock parsing
   - Handles null → undefined for optional fields
   - Uses exported types from types.ts (ServiceCategoryRow, etc.)

2. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added CATALOG MODULE ADAPTERS section
   - Exported toServiceCategory, toServiceCategories, toServiceCategoryInsert, toServiceCategoryUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- Supabase SyncStatus type differs from app SyncStatus ('syncing' is app-only, not stored in Supabase)
- Use types exported from types.ts (ServiceCategoryRow, etc.) rather than inline Database access
- When converting updates.syncStatus to Supabase, cast with `as SyncStatus` since app may have 'syncing' which is transient

**Patterns to sync:**
- Pattern #7: SyncStatus Type Mismatch - App SyncStatus has 'syncing' for transient state, Supabase SyncStatus does not. Cast when writing to Supabase.

**Next story suggestion:** US-013 (Create menuServiceAdapter.ts) - Same pattern, same folder, builds on this adapter work

---

## 2026-01-21 - US-013: Create menuServiceAdapter.ts
Commit: 6bf2561

**Why this story?** Highest priority incomplete story (priority 13). Continues the adapter pattern work from US-012, same folder (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/menuServiceAdapter.ts` (NEW):
   - Created `toMenuService(row)`: Converts MenuServiceRow → MenuService (40+ fields)
   - Created `toMenuServices(rows)`: Batch conversion
   - Created `toMenuServiceInsert(service, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toMenuServiceUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles all 40+ MenuService fields:
     - Core: name, description, sku
     - Pricing: pricingType, price, priceMax, cost, taxable
     - Duration: duration, extraTime, extraTimeType
     - Client care: aftercareInstructions, requiresPatchTest
     - Variants: hasVariants, variantCount
     - Staff: allStaffCanPerform
     - Booking: bookingAvailability, onlineBookingEnabled, requiresDeposit, depositAmount, depositPercentage
     - Online limits: onlineBookingBufferMinutes, advanceBookingDaysMin/Max
     - Additional: rebookReminderDays, turnWeight, commissionRate, color, images, tags
     - Status: status, displayOrder, showPriceOnline, allowCustomDuration
     - Archive: archivedAt, archivedBy
   - Handles snake_case ↔ camelCase conversion
   - Handles TEXT[] ↔ string[] for images and tags arrays
   - Handles null → undefined for optional fields

2. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added MenuService adapter exports: toMenuService, toMenuServices, toMenuServiceInsert, toMenuServiceUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- MenuService is the largest catalog type with ~40 fields - careful mapping required
- TEXT[] arrays in PostgreSQL map directly to string[] in TypeScript - no parsing needed
- turnWeight defaults to 1.0 when not provided (service.turnWeight ?? 1.0)
- requiresPatchTest defaults to false when not provided (service.requiresPatchTest ?? false)

**Next story suggestion:** US-014 (Create serviceVariantAdapter.ts and servicePackageAdapter.ts) - Same folder, continues adapter work

---

## 2026-01-21 - US-014: Create serviceVariantAdapter.ts and servicePackageAdapter.ts
Commit: e80c3a1

**Why this story?** Highest priority incomplete story (priority 14). Continues the adapter pattern work from US-012 and US-013, same folder (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/serviceVariantAdapter.ts` (NEW):
   - Created `toServiceVariant(row)`: Converts ServiceVariantRow → ServiceVariant
   - Created `toServiceVariants(rows)`: Batch conversion
   - Created `toServiceVariantInsert(variant, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toServiceVariantUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles snake_case ↔ camelCase conversion for all fields
   - Handles extraTime and extraTimeType optional fields

2. `apps/store-app/src/services/supabase/adapters/servicePackageAdapter.ts` (NEW):
   - Created `toServicePackage(row)`: Converts ServicePackageRow → ServicePackage
   - Created `toServicePackages(rows)`: Batch conversion
   - Created `toServicePackageInsert(pkg, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toServicePackageUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles JSONB → PackageServiceItem[] parsing for services array
   - Uses `as unknown as Json` cast for PackageServiceItem[] to satisfy Supabase Json type

3. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added ServiceVariant adapter exports: toServiceVariant, toServiceVariants, toServiceVariantInsert, toServiceVariantUpdate
   - Added ServicePackage adapter exports: toServicePackage, toServicePackages, toServicePackageInsert, toServicePackageUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- PackageServiceItem[] cannot be directly assigned to Supabase Json type due to index signature mismatch
- Use `as unknown as Json` double cast for complex objects going into JSONB columns
- ServiceVariant is simpler than MenuService - fewer fields to map

**Patterns to sync:**
- Pattern #8: JSONB Type Cast - When assigning TypeScript interfaces to Supabase Json fields, use `as unknown as Json` cast to bridge the type mismatch

**Next story suggestion:** US-015 (Create addOnGroupAdapter.ts and addOnOptionAdapter.ts) - Same folder, continues adapter work

---

## 2026-01-21 - US-015: Create addOnGroupAdapter.ts and addOnOptionAdapter.ts
Commit: f57fe8f

**Why this story?** Highest priority incomplete story (priority 15). Continues the adapter pattern work from US-012 through US-014, same folder (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/addOnGroupAdapter.ts` (NEW):
   - Created `toAddOnGroup(row)`: Converts AddOnGroupRow → AddOnGroup
   - Created `toAddOnGroups(rows)`: Batch conversion
   - Created `toAddOnGroupInsert(group, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toAddOnGroupUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles snake_case ↔ camelCase conversion for all fields
   - Handles TEXT[] → string[] for applicable_category_ids, applicable_service_ids (direct mapping)
   - Handles selection rules: selectionMode, minSelections, maxSelections, isRequired

2. `apps/store-app/src/services/supabase/adapters/addOnOptionAdapter.ts` (NEW):
   - Created `toAddOnOption(row)`: Converts AddOnOptionRow → AddOnOption
   - Created `toAddOnOptions(rows)`: Batch conversion
   - Created `toAddOnOptionInsert(option, storeId, tenantId, userId?, deviceId?)`: App type → Supabase insert
   - Created `toAddOnOptionUpdate(updates, userId?, deviceId?)`: Partial updates → Supabase update
   - Handles foreign key: groupId ↔ group_id
   - Handles pricing and duration fields

3. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added AddOnGroup adapter exports: toAddOnGroup, toAddOnGroups, toAddOnGroupInsert, toAddOnGroupUpdate
   - Added AddOnOption adapter exports: toAddOnOption, toAddOnOptions, toAddOnOptionInsert, toAddOnOptionUpdate

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- TEXT[] in PostgreSQL maps directly to string[] in TypeScript - no special parsing needed
- Add-on types follow the same adapter pattern as other catalog types
- Both adapters handle the full sync metadata (vectorClock, version, etc.) consistently

**Next story suggestion:** US-016 (Create remaining catalog adapters) - Same folder, completes all adapter work for Phase 1

---

## 2026-01-21 - US-016: Create remaining catalog adapters
Commit: 77579fd

**Why this story?** Highest priority incomplete story (priority 16). Completes all adapter work for Phase 1, same folder as US-012-015 (adapters are fresh in context).

**Changes:**
1. `apps/store-app/src/services/supabase/adapters/staffServiceAssignmentAdapter.ts` (NEW):
   - Created `toStaffServiceAssignment(row)`: Converts StaffServiceAssignmentRow → StaffServiceAssignment
   - Created `toStaffServiceAssignments(rows)`: Batch conversion
   - Created `toStaffServiceAssignmentInsert(assignment, storeId, tenantId, userId?, deviceId?)`
   - Created `toStaffServiceAssignmentUpdate(updates, userId?, deviceId?)`
   - Handles customPrice, customDuration, customCommissionRate optional fields

2. `apps/store-app/src/services/supabase/adapters/catalogSettingsAdapter.ts` (NEW):
   - Created `toCatalogSettings(row)`: Converts CatalogSettingsRow → CatalogSettings
   - Created `toCatalogSettingsInsert(settings, storeId, tenantId, userId?, deviceId?)`
   - Created `toCatalogSettingsUpdate(updates, userId?, deviceId?)`
   - Handles all feature toggles (enablePackages, enableAddOns, enableVariants, etc.)
   - Handles ExtraTimeType enum conversion

3. `apps/store-app/src/services/supabase/adapters/bookingSequenceAdapter.ts` (NEW):
   - Created `toBookingSequence(row)`: Converts BookingSequenceRow → BookingSequence
   - Created `toBookingSequences(rows)`: Batch conversion
   - Created `toBookingSequenceInsert(sequence, storeId, tenantId, userId?, deviceId?)`
   - Created `toBookingSequenceUpdate(updates, userId?, deviceId?)`
   - Handles JSONB → string[] for serviceOrder array

4. `apps/store-app/src/services/supabase/adapters/productAdapter.ts` (NEW):
   - Created `toProduct(row)`: Converts CatalogProductRow → Product
   - Created `toProducts(rows)`: Batch conversion
   - Created `toProductInsert(product, storeId, tenantId, userId?, deviceId?)`
   - Created `toProductUpdate(updates, userId?, deviceId?)`
   - Handles all inventory fields (sku, barcode, pricing, stock levels, supplier info)

5. `apps/store-app/src/services/supabase/adapters/giftCardDenominationAdapter.ts` (NEW):
   - Created `toGiftCardDenomination(row)`: Converts CatalogGiftCardDenominationRow → GiftCardDenomination
   - Created `toGiftCardDenominations(rows)`: Batch conversion
   - Created `toGiftCardDenominationInsert(denomination, storeId, tenantId, userId?, deviceId?)`
   - Created `toGiftCardDenominationUpdate(updates, userId?, deviceId?)`
   - Handles simple fields: amount, label, isActive, displayOrder

6. `apps/store-app/src/services/supabase/adapters/giftCardSettingsAdapter.ts` (NEW):
   - Created `toGiftCardSettings(row)`: Converts CatalogGiftCardSettingsRow → GiftCardSettings
   - Created `toGiftCardSettingsInsert(settings, storeId, tenantId, userId?, deviceId?)`
   - Created `toGiftCardSettingsUpdate(updates, userId?, deviceId?)`
   - Handles custom amount limits, expiration, and online settings

7. `apps/store-app/src/services/supabase/adapters/index.ts`:
   - Added StaffServiceAssignment adapter exports
   - Added CatalogSettings adapter exports
   - Added BookingSequence adapter exports
   - Added Product adapter exports
   - Added GiftCardDenomination adapter exports
   - Added GiftCardSettings adapter exports

**Verification:**
- `pnpm run typecheck` passes ✓
- `pnpm test --run` - 3205 passed, 13 failed (all pre-existing failures unrelated to catalog module)

**Learnings:**
- All 6 adapters follow the same established pattern from US-012 through US-015
- Product type comes from @/types/inventory (not catalog.ts)
- GiftCard tables in Supabase are prefixed with `catalog_` to avoid collision with existing gift_cards tables
- BookingSequence serviceOrder uses JSONB array - cast to `unknown as Json` when inserting

**Patterns to sync:**
- None new - all adapters follow Pattern #6 (Supabase Type Convention) and Pattern #8 (JSONB Type Cast)

**Next story suggestion:** US-017 (Create serviceCategoriesTable.ts) - Next phase: Supabase CRUD operations for tables

---

# Ralph Progress Log: price-change-fixes
# Started: 2026-01-19
# Branch: ralph/price-change-fixes

## Codebase Patterns
<!-- Accumulated patterns and learnings across iterations -->

### Service Archive Pattern
- Services are archived (not deleted) - industry best practice (Fresha/Boulevard/Vagaro)
- Archive fields: status, archivedAt, archivedBy
- Supabase uses snake_case: status, archived_at, archived_by
- App uses camelCase: status, archivedAt, archivedBy
- Type adapters convert between formats

### Design System Colors
- Import from @/design-system
- Use semantic colors: colors.warning, colors.success, colors.error
- Never hardcode Tailwind colors like text-amber-600

### Component Size Guidelines
- Target: <300 lines per component
- Max: 500 lines
- If exceeding, split into module structure:
  ComponentName/
  ├── index.ts
  ├── ComponentName.tsx
  ├── SubComponent.tsx
  └── types.ts

### Testing Patterns
- Use @testing-library/react for component tests
- Mock Redux store with configureStore
- Test both happy path and edge cases
- Follow pattern from existing tests in __tests__ directories

---

## Progress Log

<!-- Iteration logs will be appended below -->

## 2026-01-19 - US-001: Add archive fields to Supabase ServiceRow type
Commit: 1592958

**Why this story?** US-001 is the foundational story that all archive-related stories (US-002, US-003, US-004, US-005, US-006) depend on. It has priority 1 and no dependencies.

**Changes:**
- apps/store-app/src/services/supabase/types.ts:301-306 (Row): Added `status: 'active' | 'archived'`, `archived_at: string | null`, `archived_by: string | null` with JSDoc comments
- apps/store-app/src/services/supabase/types.ts:320-325 (Insert): Added same fields as optional with JSDoc comments

**Learnings:**
- The file has many pre-existing TypeScript errors in test files (AgendaView.test.tsx, AppointmentCard.test.tsx, MonthView.test.tsx, SmartBookingPanel.test.tsx) and other unrelated files (ServiceSection.tsx, mqttBridge.ts) - these are not caused by this change
- Supabase types use snake_case consistently across all table definitions

**Next story suggestion:** US-002 (Update serviceAdapter to map archive fields) - it directly depends on US-001 since it needs to map the new fields from Supabase to app types

---

## 2026-01-19 - US-002: Update serviceAdapter to map archive fields
Commit: 077830e

**Why this story?** US-002 directly builds on US-001 (just completed) - it's the next logical step in the service archive pipeline. The adapter must map the new Supabase fields before table methods (US-003) or UI components (US-004+) can work.

**Changes:**
- apps/store-app/src/services/supabase/adapters/serviceAdapter.ts:27-30 (toService): Added mapping for status, archived_at → archivedAt, archived_by → archivedBy with default to 'active' for backwards compatibility
- apps/store-app/src/services/supabase/adapters/serviceAdapter.ts:50-53 (toServiceInsert): Added mapping for status, archivedAt → archived_at, archivedBy → archived_by with default to 'active' for new services
- apps/store-app/src/services/supabase/adapters/serviceAdapter.ts:81-90 (toServiceUpdate): Added conditional mapping for archive fields when updating services

**Learnings:**
- Pre-existing TypeScript errors in test files continue (AgendaView.test.tsx, etc.) - not caused by this change
- Adapter pattern uses `|| undefined` for toService (app type uses optional fields) and `|| null` for toServiceInsert/toServiceUpdate (Supabase fields are nullable)
- toServiceUpdate uses conditional checks (if !== undefined) to only include fields that are being updated

**Next story suggestion:** US-003 (Add archive/restore methods to servicesTable) - it needs the adapter mappings from US-002 and provides the Supabase CRUD operations needed by the UI stories (US-004, US-005, US-006)

---

## 2026-01-19 - US-003: Add archive/restore methods to servicesTable
Commit: 087a3cd

**Why this story?** US-003 completes the backend service archive pipeline. It was explicitly recommended by the previous iteration (US-002) and provides the Supabase CRUD operations that UI components (US-004, US-005, US-006) will use.

**Changes:**
- apps/store-app/src/services/supabase/tables/servicesTable.ts:158-176: Added `archiveService(id, userId)` method that sets status='archived', archived_at=now(), archived_by=userId
- apps/store-app/src/services/supabase/tables/servicesTable.ts:178-196: Added `restoreService(id)` method that sets status='active', archived_at=null, archived_by=null

**Learnings:**
- Pre-existing TypeScript errors in test files continue (same as US-001, US-002)
- Pre-existing test failures (CreateTicketButton.test.tsx missing Redux provider, padCheckoutFlow.test.ts assertion) - not caused by this change
- The restoreService method doesn't need userId param since the operation just clears the archive metadata

**Next story suggestion:** US-004 (Create ArchivedServicesTab component) - it's the first UI story that uses the archive infrastructure we built in US-001, US-002, US-003. It's a frontend component so will require browser verification.

---

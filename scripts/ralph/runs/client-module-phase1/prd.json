{
  "project": "Mango POS Client Module",
  "branchName": "ralph/client-module-phase1",
  "description": "Phase 1: Client Safety & Booking Controls - Merging, block enforcement, patch test enforcement",
  "testGate": "1. Merge two clients → data consolidated. 2. Blocked client can't book online. 3. Patch test warning appears for required services.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add merge columns to clients table",
      "description": "As a developer, I need database columns to track merged clients.",
      "acceptanceCriteria": [
        "Add merged_into_id UUID REFERENCES clients(id) column",
        "Add merged_at TIMESTAMPTZ column",
        "Add merged_by UUID column (staff who performed merge)",
        "Add index on merged_into_id for query performance",
        "Migration runs without errors: supabase db push",
        "pnpm run typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Create file: supabase/migrations/031_client_merge.sql. Follow migration pattern from 030_create_member_session_revocations.sql. Use ALTER TABLE not CREATE TABLE."
    },
    {
      "id": "US-002",
      "title": "Create merge_clients Supabase RPC function",
      "description": "As a developer, I need a database function to atomically merge two clients.",
      "acceptanceCriteria": [
        "Create RPC merge_clients(primary_id UUID, secondary_id UUID, options JSONB, merged_by UUID)",
        "Re-link all appointments from secondary to primary",
        "Re-link all tickets from secondary to primary",
        "Re-link all transactions from secondary to primary",
        "Merge notes if options.mergeNotes = true",
        "Combine loyalty points if options.mergeLoyalty = true",
        "Set merged_into_id, merged_at, merged_by on secondary client",
        "Return merged client data",
        "Function is transactional (all or nothing)",
        "pnpm run typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Append to supabase/migrations/031_client_merge.sql (~80 lines). Use BEGIN...EXCEPTION...END for transaction safety."
    },
    {
      "id": "US-003",
      "title": "Add merge types to clientsSlice types",
      "description": "As a developer, I need TypeScript types for merge operations.",
      "acceptanceCriteria": [
        "Add MergeClientOptions interface with: mergeNotes, mergeLoyalty, mergePreferences, mergeAlerts boolean fields",
        "Add MergeClientParams interface with: primaryClientId, secondaryClientId, options, mergedBy",
        "Add mergedIntoId, mergedAt, mergedBy optional fields to Client interface",
        "pnpm run typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Modify: apps/store-app/src/store/slices/clientsSlice/types.ts (~20 lines). Follow existing type patterns."
    },
    {
      "id": "US-004",
      "title": "Create mergeClientsInSupabase thunk",
      "description": "As a developer, I need a Redux thunk to call the merge RPC.",
      "acceptanceCriteria": [
        "Export mergeClientsInSupabase async thunk from thunks.ts",
        "Parameters: primaryClientId, secondaryClientId, options, mergedBy",
        "Call Supabase RPC merge_clients",
        "On success, update Redux state to remove secondary client from clients array",
        "On success, refresh primary client data in state",
        "Return merged client or error",
        "No forbidden strings: Test Client, as any, void _",
        "pnpm run typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Modify: apps/store-app/src/store/slices/clientsSlice/thunks.ts (~40 lines). Follow pattern from createClientInSupabase thunk."
    },
    {
      "id": "US-005",
      "title": "Activate MergeClientsModal component",
      "description": "As a developer, I need to restore the merge modal from backup.",
      "acceptanceCriteria": [
        "Rename MergeClientsModal.tsx.bak to MergeClientsModal.tsx",
        "Update import path for mergeClientsInSupabase thunk (now exists)",
        "Verify all imports resolve correctly",
        "Component renders without errors",
        "No forbidden strings: as any, void _",
        "pnpm run typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "File: apps/store-app/src/components/client-settings/MergeClientsModal.tsx.bak (389 lines). Full UI already implemented."
    },
    {
      "id": "US-006",
      "title": "Add merge button to ClientSettings",
      "description": "As a staff member, I want to access the merge functionality from client details.",
      "acceptanceCriteria": [
        "Import MergeClientsModal component",
        "Add Merge with Another Client button in actions area",
        "Button opens client search dialog to select secondary client",
        "After selection, opens MergeClientsModal with both client IDs",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify in browser: button appears, clicking opens modal"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Modify: apps/store-app/src/components/client-settings/ClientSettings.tsx (~25 lines). Follow existing action button patterns."
    },
    {
      "id": "US-007",
      "title": "Add merge audit logging",
      "description": "As a business owner, I need audit trail for all merge operations.",
      "acceptanceCriteria": [
        "Log merge event with: timestamp, primaryId, secondaryId, options, staffId",
        "Store in audit_logs table (create if not exists)",
        "Include before/after state summary for both clients",
        "pnpm run typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Modify: apps/store-app/src/store/slices/clientsSlice/thunks.ts (~15 lines in mergeClientsInSupabase)."
    },
    {
      "id": "US-008",
      "title": "Create check-booking-eligibility Edge Function",
      "description": "As a developer, I need an endpoint to check if client can book.",
      "acceptanceCriteria": [
        "POST /check-booking-eligibility endpoint",
        "Accept: clientId or email or phone",
        "Check if client is blocked (isBlocked field)",
        "Return generic message if blocked: Unable to book at this time",
        "Do NOT reveal that client is blocked (privacy)",
        "Return: { eligible: boolean, message?: string }",
        "pnpm run typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Create: supabase/functions/check-booking-eligibility/index.ts (NEW, ~50 lines). Security: Never expose blocking reason."
    },
    {
      "id": "US-009",
      "title": "Add eligibility check to Online Store booking",
      "description": "As a system, blocked clients should not be able to complete online booking.",
      "acceptanceCriteria": [
        "When client enters email/phone, call check-booking-eligibility",
        "If not eligible, show generic error: Unable to complete booking. Please call the salon.",
        "Do NOT reveal blocking reason",
        "Prevent form submission if not eligible",
        "pnpm run typecheck passes",
        "Verify in browser: blocked client cannot book"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Modify: apps/online-store/src/components/booking/DetailsStep.tsx (~30 lines). Use debounce on blur."
    },
    {
      "id": "US-010",
      "title": "Create BlockedClientOverrideModal",
      "description": "As a staff member, I need to override block for special cases.",
      "acceptanceCriteria": [
        "Props: clientId, clientName, blockReason, onOverride, onCancel",
        "Show block reason to staff (they can see it)",
        "Require override reason (mandatory text input)",
        "Require manager approval checkbox",
        "Proceed with Booking and Cancel buttons",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Create: apps/store-app/src/components/clients/BlockedClientOverrideModal.tsx (NEW, ~80 lines). Follow BlockClientModal.tsx pattern."
    },
    {
      "id": "US-011",
      "title": "Integrate block check into Store App booking",
      "description": "As a staff member, I should see warning when booking blocked client.",
      "acceptanceCriteria": [
        "When selecting blocked client, show BlockedClientOverrideModal",
        "Staff must provide reason to proceed",
        "Log all override attempts",
        "pnpm run typecheck passes",
        "Verify in browser: book for blocked client shows warning"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Modify: apps/store-app/src/components/Book/BookingForm.tsx (~25 lines)."
    },
    {
      "id": "US-012",
      "title": "Add block override audit logging",
      "description": "As a business owner, I need to track block overrides.",
      "acceptanceCriteria": [
        "Log override: timestamp, staffId, clientId, blockReason, overrideReason",
        "Store in audit_logs table",
        "pnpm run typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Modify: apps/store-app/src/components/Book/BookingForm.tsx (~10 lines). NOTE: Already implemented in US-011's handleBlockOverride function in NewAppointmentModal.v2.tsx."
    },
    {
      "id": "US-013",
      "title": "Create validate-booking Edge Function",
      "description": "As a developer, I need centralized booking validation including patch test checks.",
      "acceptanceCriteria": [
        "POST /validate-booking endpoint",
        "Accept: clientId, serviceId, appointmentDate",
        "Check if service requires patch test (requiresPatchTest field)",
        "If required, check client has valid (non-expired) patch test for that service",
        "Return: { valid: boolean, reason?: string, canOverride?: boolean }",
        "Return specific reasons: patch_test_required, patch_test_expired, client_blocked",
        "pnpm run typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Create: supabase/functions/validate-booking/index.ts (NEW, ~80 lines). Reference clients Edge Function patterns."
    },
    {
      "id": "US-014",
      "title": "Add checkPatchTestRequired thunk",
      "description": "As a developer, I need a thunk to call the validation Edge Function.",
      "acceptanceCriteria": [
        "Export checkPatchTestRequired async thunk",
        "Parameters: clientId, serviceId, appointmentDate",
        "Call validate-booking Edge Function",
        "Return validation result with reason",
        "No forbidden strings",
        "pnpm run typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Modify: apps/store-app/src/store/slices/clientsSlice/thunks.ts (~30 lines)."
    },
    {
      "id": "US-015",
      "title": "Create PatchTestWarningBanner component",
      "description": "As a staff member, I need to see a warning when booking requires patch test.",
      "acceptanceCriteria": [
        "Props: clientName, serviceName, reason (required | expired), onOverride, onCancel",
        "Yellow warning banner with TestTube icon",
        "Shows message: Patch test required for [service] or Patch test expired",
        "Override button (with confirmation) and Cancel Booking button",
        "Override requires reason input",
        "Follows design tokens from @/design-system",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Create: apps/store-app/src/components/Book/PatchTestWarningBanner.tsx (NEW, ~60 lines). Follow StaffAlertBanner.tsx pattern."
    },
    {
      "id": "US-016",
      "title": "Integrate patch test check into Book module",
      "description": "As a staff member, booking should check patch test requirements.",
      "acceptanceCriteria": [
        "Before creating appointment, call checkPatchTestRequired",
        "If validation fails, show PatchTestWarningBanner",
        "If staff overrides, log override reason and proceed",
        "If cancelled, return to service selection",
        "No forbidden strings",
        "pnpm run typecheck passes",
        "Verify in browser: book service with patch test requirement"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Modify: apps/store-app/src/components/Book/BookingForm.tsx (~30 lines)."
    },
    {
      "id": "US-017",
      "title": "Add patch test validation to Online Store",
      "description": "As a customer, I should be informed if a service requires patch test.",
      "acceptanceCriteria": [
        "When selecting service that requires patch test, show info message",
        "Message: This service requires a patch test. Please visit the salon first.",
        "If client has no valid patch test, disable booking for that service",
        "If client has valid patch test, allow booking normally",
        "pnpm run typecheck passes",
        "Verify in browser: Online Store service selection"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Modify: apps/online-store/src/components/booking/ServiceSelectionStep.tsx (~25 lines). Also modified ReviewStep.tsx for patch test validation before booking confirmation."
    },
    {
      "id": "US-018",
      "title": "Add patch test override audit logging",
      "description": "As a business owner, I need to track when staff override patch test requirements.",
      "acceptanceCriteria": [
        "When staff overrides patch test warning, log: timestamp, staffId, clientId, serviceId, reason",
        "Store in audit_logs table",
        "pnpm run typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Modify: apps/store-app/src/components/Book/BookingForm.tsx (~15 lines). NOTE: Already implemented in US-016's handlePatchTestOverride function in NewAppointmentModal.v2.tsx."
    },
    {
      "id": "US-019",
      "title": "Add merge functionality tests",
      "description": "As a developer, I need tests for merge logic.",
      "acceptanceCriteria": [
        "Test: mergeClientsInSupabase thunk dispatches correctly",
        "Test: Redux state updates after successful merge",
        "Test: Secondary client removed from state",
        "Test: Error handling for invalid client IDs",
        "All tests pass"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Create: apps/store-app/src/store/slices/clientsSlice/__tests__/merge.test.ts (NEW, ~100 lines). Mock Supabase RPC."
    },
    {
      "id": "US-020",
      "title": "Add block enforcement tests",
      "description": "As a developer, I need tests for block enforcement.",
      "acceptanceCriteria": [
        "Test: Blocked client cannot book via Online Store",
        "Test: Staff sees override modal for blocked client",
        "Test: Override requires reason",
        "All tests pass"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Create: apps/store-app/src/components/Book/__tests__/blockClient.test.ts (NEW, ~60 lines)."
    },
    {
      "id": "US-021",
      "title": "Add patch test enforcement tests",
      "description": "As a developer, I need tests for patch test validation.",
      "acceptanceCriteria": [
        "Test: Booking blocked when patch test required but missing",
        "Test: Booking blocked when patch test expired",
        "Test: Booking allowed when valid patch test exists",
        "Test: Override flow works correctly",
        "All tests pass"
      ],
      "priority": 21,
      "passes": false,
      "notes": "Create: apps/store-app/src/components/Book/__tests__/patchTest.test.ts (NEW, ~80 lines)."
    },
    {
      "id": "US-P1R",
      "title": "UltraThink Review of Phase 1 Implementation",
      "description": "As a developer, I need comprehensive validation of all Phase 1 features before moving to Phase 2.",
      "acceptanceCriteria": [
        "Use /ultrathink skill with Architect, Coder, and Tester agents",
        "Architect Agent: Verify database schema design (merge columns, RPC function, audit tables)",
        "Coder Agent: Review all new thunks, components, and Edge Functions for type safety, error handling, code patterns",
        "Tester Agent: Verify all acceptance criteria from US-001 to US-021 are actually implemented",
        "Security Check: Verify audit logging captures all required data",
        "UX Review: Check modal flows, error messages, warning banners work correctly",
        "Document all issues found in scripts/ralph/runs/client-module-phase1/review-findings.md",
        "Categorize issues as: Critical, Major, Minor",
        "Run pnpm run typecheck and pnpm test before review"
      ],
      "priority": 22,
      "passes": false,
      "notes": "This story produces a review report, not code changes. Use /ultrathink to coordinate Architect, Research, Coder, and Tester agents. Check browser manually for UI components."
    },
    {
      "id": "US-P1F",
      "title": "Address Phase 1 Review Findings",
      "description": "As a developer, I need to fix all issues identified in the Phase 1 review.",
      "acceptanceCriteria": [
        "All Critical issues from review-findings.md resolved",
        "All Major issues from review-findings.md resolved",
        "Minor issues documented for future cleanup (if not blocking)",
        "Re-run typecheck: pnpm run typecheck passes",
        "Re-run tests: pnpm test passes",
        "Update review-findings.md with resolution status for each issue",
        "Test Gate 1: Merge two clients → data consolidated, secondary archived",
        "Test Gate 2: Blocked client cannot book online → generic error shown",
        "Test Gate 3: Book service requiring patch test → warning banner appears, override works"
      ],
      "priority": 23,
      "passes": false,
      "notes": "Focus on Critical and Major issues first. This story must pass before starting Phase 2. Files to modify are those identified in review-findings.md."
    }
  ]
}

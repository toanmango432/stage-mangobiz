# Connect Integration - Ralph Progress Log

> Auto-updated by Ralph agent. Do not manually edit.
> PRD: scripts/ralph/runs/connect-integration/prd.json
> Branch: ralph/connect-integration

---

## Codebase Patterns

> Patterns discovered during this run. Add new patterns at the end.

(No patterns discovered yet)

---

## Progress Log

## 2026-01-21 - US-003: Create useConnectConfig hook
Commit: 2001546869307a9a24d59190fcfd39ebd268257d

**Why this story?** US-003 has the lowest priority among unblocked stories (priority 3 vs US-004's priority 4), and its dependencies (US-001, US-002) were completed in previous iterations. Completing US-003 unblocks both US-005 and US-006.

**Changes:**
- apps/store-app/src/hooks/useConnectConfig.ts:1-108 (NEW): Created hook with config, loading, error, updateConfig, refresh

**Learnings:**
- Used selectStoreId from authSlice to get storeId (consistent with pattern in useTicketsCompat.ts, BookPage.tsx, etc.)
- Followed useSystemConfig.ts pattern for hook structure with useCallback for stable references
- Returns DEFAULT_CONNECT_CONFIG while loading (not null) to avoid null checks in consumers
- Used storeService.patchConnectConfig for partial updates which handles merging

**Pre-existing test failures documented:**
- 21 test files failed (14 individual tests) - all MQTT/integration related, not from this change

**Next story suggestion:** US-004 (JWT Edge Function) because it has no explicit dependencies and is needed by US-005 along with the just-completed US-003.

---

## 2026-01-21 - US-004: Create JWT token generator Edge Function
Commit: 7be2e2844b5c3e73a6d7bdf8cec0a58c75e3d0c3

**Why this story?** US-004 was the only unblocked story - it has no dependencies and US-005 depends on it. This follows the previous iteration's suggestion.

**Changes:**
- supabase/functions/generate-connect-token/index.ts:1-237 (NEW): Created Edge Function for JWT generation

**Implementation Details:**
- CORS headers follow exact pattern from auth/index.ts (lines 87-91)
- POST-only endpoint, returns 405 for other methods
- Validates Authorization header by verifying Supabase user JWT via supabase.auth.getUser()
- Extracts: storeId, tenantId, memberId, memberEmail, memberName, role, permissions
- Generates JWT with HMAC-SHA256 using MANGO_CONNECT_JWT_SECRET env var
- Token expires in 1 hour (3600 seconds)
- Returns { token: string, expiresAt: number }
- Error responses use jsonResponse({ error: message }, statusCode) pattern
- Logs errors with prefix [generate-connect-token]

**Learnings:**
- Used crypto.subtle.importKey and crypto.subtle.sign for HMAC-SHA256 (Web Crypto API)
- Base64url encoding requires removing padding and replacing +/ with -_
- Supabase Edge Functions run on Deno, use Deno.env.get() for env vars
- Token payload includes standard JWT claims (iss, aud, sub, iat, exp) plus custom fields

**Pre-existing issues documented:**
- TypeScript monorepo typecheck has TS6310 errors (project reference configuration)
- eslint command not found in some packages
- Tests have MQTT/integration failures (same as previous iteration)

**Next story suggestion:** US-005 (useConnectToken hook) because US-004 is now complete and US-005 depends on both US-003 ✅ and US-004 ✅, making it the next unblocked story in the dependency chain.

---

## 2026-01-21 - US-005: Create useConnectToken hook
Commit: b44523f66e86923c53f7651dc0474ad5784a809e

**Why this story?** US-005 was the only unblocked story with low priority (5). US-003 and US-004 were completed in previous iterations, unblocking this story. Completing US-005 unblocks US-006 (ConnectSDKProvider).

**Changes:**
- apps/store-app/src/hooks/useConnectToken.ts:1-170 (NEW): Created hook with token, loading, error, refresh, isExpired

**Implementation Details:**
- useConnectToken() returns { token, loading, error, refresh, isExpired }
- Fetches token from generate-connect-token Edge Function on mount (if Connect enabled)
- Uses supabase.functions.invoke('generate-connect-token', { body: {...} }) for API call
- Caches token in state with expiresAt timestamp
- Auto-refresh when token is 5 minutes from expiry (REFRESH_BUFFER_SECONDS = 300)
- isExpired computed from expiresAt - returns true if within refresh buffer
- Returns null token if Connect not enabled (checked via useConnectConfig())
- Gets user data from Redux auth slice selectors (selectMember, selectStoreId, etc.)
- Builds permissions array from member.permissions object (filters truthy values)

**Learnings:**
- Used existing ConnectTokenResponse type from connectIntegration.ts for Edge Function response
- Followed useCallback pattern for stable function references (consistent with useSystemConfig.ts)
- Auto-refresh scheduling uses setTimeout with cleanup in useEffect
- Token expiry check uses 5-minute buffer to prevent race conditions with SDK calls

**Pre-existing test failures documented:**
- 21 test files failed (14 individual tests) - MQTT/integration related, not from this change (same as previous iterations)

**Next story suggestion:** US-006 (ConnectSDKProvider) because it depends on US-003 ✅ and US-005 ✅, both now complete. This is the next story in the dependency chain that unblocks US-007, US-008.

---

## 2026-01-21 - US-006: Create ConnectSDKProvider component
Commit: 6cd3f4cdea3fdde6aff767ff922319ced2c2b696

**Why this story?** US-006 depends on US-003 ✅ and US-005 ✅, both completed in previous iterations. Completing US-006 unblocks US-007 (add to AppShell) and US-008 (useConnectSDK hook).

**Changes:**
- apps/store-app/src/providers/ConnectSDKProvider.tsx:1-267 (NEW): Created provider that loads Connect SDK globally

**Implementation Details:**
- Provides context: { sdk, loading, error, unreadCount, retry }
- Loads SDK script from import.meta.env.VITE_MANGO_CONNECT_SDK_URL (default: https://connect.mango.ai/sdk/v1/mango-connect-sdk.js)
- Uses useConnectConfig() to check if Connect is enabled
- Uses useConnectToken() to get auth token
- Initializes SDK with: authToken, bizSupabaseUrl, bizSupabaseKey (from supabaseConfig)
- Handles onTokenRefresh, onUnreadCountChange, onError callbacks from SDK
- Children always render (SDK loads in background)
- retry() function to reload SDK after error
- Cleanup on unmount calls sdk.destroy()
- Exported useConnectSDKContext() hook for context access

**Learnings:**
- Used declare global { interface Window { MangoConnectSDK?: ... } } for TypeScript SDK type
- Script loading uses Promise wrapper with onload/onerror for clean async flow
- supabaseConfig exported from client.ts provides url and anonKey for SDK init
- Followed ModeContext.tsx pattern for provider structure with useMemo for context value

**Pre-existing test failures documented:**
- 21 test files failed (14 individual tests) - MQTT/integration related, not from this change (same as previous iterations)

**Next story suggestion:** US-007 (Add ConnectSDKProvider to AppShell) or US-008 (useConnectSDK hook) - both are now unblocked. US-007 adds the provider to the app, US-008 creates the consumer hook. US-007 should come first as it needs the provider in place for the hook to be testable.

---

## 2026-01-21 - US-007: Add ConnectSDKProvider to AppShell
Commit: b6e5c67

**Why this story?** US-007 depends only on US-006 ✅ which was completed in the previous iteration. US-008 also depends on US-006, but US-007 should come first as the provider needs to be in AppShell before consumer hooks can be properly used in the app. Both have similar priority (7 vs 8).

**Changes:**
- apps/store-app/src/components/layout/AppShell.tsx:7: Added import for ConnectSDKProvider
- apps/store-app/src/components/layout/AppShell.tsx:68-75: Wrapped AppShellContent with ConnectSDKProvider inside TicketPanelProvider

**Implementation Details:**
- Import uses relative path: `../../providers/ConnectSDKProvider`
- Provider is nested inside TicketPanelProvider, wrapping AppShellContent
- This placement ensures ConnectSDKProvider is outside Suspense boundaries (children render regardless)
- Auth context is available via Redux selectors inside useConnectConfig and useConnectToken hooks (used by ConnectSDKProvider)

**Learnings:**
- AppShell uses composition pattern: outer AppShell function wraps with providers, inner AppShellContent handles the logic
- Provider nesting order: TicketPanelProvider → ConnectSDKProvider → AppShellContent
- ConnectSDKProvider doesn't need explicit auth provider wrapper since it uses Redux selectors for auth state

**Pre-existing test failures documented:**
- 21 test files failed (14 individual tests) - MQTT/integration related, not from this change (same as previous iterations)

**Next story suggestion:** US-008 (useConnectSDK hook) because it depends only on US-006 ✅ which was already completed. US-008 creates the consumer hook that other components (US-009, US-010, US-011, US-013) depend on. Completing US-008 unblocks multiple stories.

---

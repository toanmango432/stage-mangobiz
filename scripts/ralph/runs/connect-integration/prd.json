{
  "project": "Mango POS Offline V2",
  "branchName": "ralph/connect-integration",
  "description": "Mango Biz - Connect Integration. Enable Mango Connect SDK to be embedded within Mango Biz Store App. Connect reads client/appointment data directly from Biz's Supabase database. SDK loaded at app startup in AppShell, JWT tokens via Edge Function, config stored in store_settings table.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Connect integration types",
      "description": "As a developer, I need TypeScript types for Connect integration settings.",
      "acceptanceCriteria": [
        "ConnectConfig interface with: enabled: boolean, features: ConnectFeatures",
        "ConnectFeatures interface with: conversations: boolean, aiAssistant: boolean, campaigns: boolean",
        "ConnectSDKState interface with: loaded: boolean, error: string | null, unreadCount: number",
        "Export all types from apps/store-app/src/types/index.ts",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/types/connectIntegration.ts (NEW)",
        "apps/store-app/src/types/index.ts"
      ],
      "notes": "Follow pattern from apps/store-app/src/types/ticket.ts. Keep types simple and flat, avoid deep nesting. Use union types for enums.",
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Add Connect config to store settings service",
      "description": "As a developer, I need functions to get/set Connect config in the database.",
      "acceptanceCriteria": [
        "Add connect_config field handling (JSON column in store_settings)",
        "getConnectConfig(storeId: string): Promise<ConnectConfig | null> function",
        "updateConnectConfig(storeId: string, config: ConnectConfig): Promise<void> function",
        "Default config: { enabled: false, features: { conversations: false, aiAssistant: false, campaigns: false } }",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/services/supabase/storeService.ts (NEW)"
      ],
      "notes": "Follow existing patterns in storeService.ts for JSON field handling. Use existing Supabase client. Handle case where connect_config is null (return default).",
      "dependencies": ["US-001"],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Create useConnectConfig hook",
      "description": "As a developer, I need a hook to access Connect config with caching.",
      "acceptanceCriteria": [
        "useConnectConfig() returns { config, loading, error, updateConfig, refresh }",
        "Loads config on mount from storeService",
        "Caches config in state to avoid re-fetching",
        "updateConfig(updates: Partial<ConnectConfig>) saves to DB and updates local state",
        "refresh() forces reload from database",
        "Returns default config while loading (not null)",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/hooks/useConnectConfig.ts (NEW)"
      ],
      "notes": "Follow pattern from apps/store-app/src/hooks/useSystemConfig.ts (174 lines). Use useCallback for stable function references. Get storeId from auth context or Redux store.",
      "dependencies": ["US-001", "US-002"],
      "priority": 3,
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Create JWT token generator Edge Function",
      "description": "As a developer, I need an Edge Function to generate signed JWT tokens for Connect SDK.",
      "acceptanceCriteria": [
        "Handles OPTIONS request with CORS headers (copy from supabase/functions/auth/index.ts lines 87-91)",
        "POST only, returns 405 for other methods",
        "Validates Authorization header (Supabase user JWT)",
        "Extracts user info from request body: { storeId, tenantId, memberId, memberEmail, memberName, role, permissions }",
        "Generates JWT with HMAC-SHA256 using Deno.env.get('MANGO_CONNECT_JWT_SECRET')",
        "Token expires in 1 hour (exp: Math.floor(Date.now() / 1000) + 3600)",
        "Returns { token: string, expiresAt: number }",
        "Error responses use jsonResponse({ error: message }, statusCode) pattern",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'"
      ],
      "files": [
        "supabase/functions/generate-connect-token/index.ts (NEW)"
      ],
      "notes": "Follow structure from supabase/functions/auth/index.ts (567 lines). Use crypto.subtle.importKey and crypto.subtle.sign for HMAC-SHA256. Base64url encode JWT parts (header.payload.signature). Log errors with prefix [generate-connect-token].",
      "priority": 4,
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Create useConnectToken hook",
      "description": "As a developer, I need a hook to get and refresh Connect JWT tokens.",
      "acceptanceCriteria": [
        "useConnectToken() returns { token, loading, error, refresh, isExpired }",
        "Fetches token from Edge Function on mount (if Connect enabled)",
        "Caches token in state until 5 minutes before expiry",
        "refresh() forces new token fetch",
        "isExpired computed from token's exp claim",
        "Returns null token if Connect not enabled",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/hooks/useConnectToken.ts (NEW)"
      ],
      "notes": "Follow pattern from apps/store-app/src/hooks/useSystemConfig.ts. Use useConnectConfig() to check if Connect is enabled. Call Edge Function via supabase.functions.invoke('generate-connect-token', { body: {...} }). Parse JWT to extract exp claim for expiry check.",
      "dependencies": ["US-003", "US-004"],
      "priority": 5,
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Create ConnectSDKProvider component",
      "description": "As a developer, I need a provider that loads the Connect SDK globally.",
      "acceptanceCriteria": [
        "Loads SDK script from import.meta.env.VITE_MANGO_CONNECT_SDK_URL",
        "Provides context: { sdk, loading, error, unreadCount, retry }",
        "Initializes SDK with: authToken, bizSupabaseUrl, bizSupabaseKey",
        "Handles onTokenRefresh callback from SDK",
        "Handles onUnreadCountChange callback from SDK (for badge)",
        "Handles onError callback from SDK",
        "Shows nothing while loading (children render regardless)",
        "retry() function to reload SDK after error",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/providers/ConnectSDKProvider.tsx (NEW)"
      ],
      "notes": "Create context with createContext<ConnectSDKContextType | null>(null). Use useConnectToken() for auth token. Use useConnectConfig() to check if enabled. SDK URL default: https://connect.mango.ai/sdk/v1/mango-connect-sdk.js. Script loading: create script element, set src, append to document.head.",
      "dependencies": ["US-003", "US-005"],
      "priority": 6,
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Add ConnectSDKProvider to AppShell",
      "description": "As a developer, I need the Connect SDK to load at app startup.",
      "acceptanceCriteria": [
        "Import ConnectSDKProvider from @/providers/ConnectSDKProvider",
        "Wrap app content with <ConnectSDKProvider> inside existing providers",
        "Provider should be inside auth provider (needs user context)",
        "Provider should be outside Suspense boundaries",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/components/layout/AppShell.tsx"
      ],
      "notes": "AppShell is 481 lines - add provider wrapper around line 200-220. Follow existing provider nesting pattern. Provider placement: after AuthProvider, before main content.",
      "dependencies": ["US-006"],
      "priority": 7,
      "passes": true
    },
    {
      "id": "US-008",
      "title": "Create useConnectSDK hook",
      "description": "As a developer, I need a hook to access the Connect SDK context.",
      "acceptanceCriteria": [
        "useConnectSDK() returns context from ConnectSDKProvider",
        "Throws error if used outside provider: 'useConnectSDK must be used within ConnectSDKProvider'",
        "Returns { sdk, loading, error, unreadCount, retry }",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/hooks/useConnectSDK.ts (NEW)"
      ],
      "notes": "Simple context consumer hook following React patterns. Use useContext(ConnectSDKContext). Export from hooks index.",
      "dependencies": ["US-006"],
      "priority": 8,
      "passes": false
    },
    {
      "id": "US-009",
      "title": "Create MessagesPage component",
      "description": "As a user, I want a Messages page to view conversations via Connect SDK.",
      "acceptanceCriteria": [
        "Full height layout (h-full flex flex-col)",
        "Uses useConnectSDK() to get SDK state",
        "Shows loading spinner while SDK loading",
        "Shows error state with retry button if SDK failed",
        "Renders <sdk.ConversationsModule /> when SDK loaded",
        "No hardcoded text like 'Test' or mock data",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "files": [
        "apps/store-app/src/pages/MessagesPage.tsx (NEW)"
      ],
      "notes": "Follow page layout pattern from existing pages. Use Tailwind classes, not inline styles. Import Button from @/components/ui/button. Import AlertCircle from lucide-react. Error state pattern: flex flex-col items-center justify-center h-full gap-4.",
      "dependencies": ["US-008"],
      "priority": 9,
      "passes": false
    },
    {
      "id": "US-010",
      "title": "Add Messages to navigation",
      "description": "As a user, I want to access Messages from the main navigation.",
      "acceptanceCriteria": [
        "Add lazy import: const MessagesPage = lazy(() => import('@/pages/MessagesPage'))",
        "Add 'messages' to module switch/case in AppShell (around line 363-414)",
        "Add Messages nav item to BottomNavBar with MessageSquare icon",
        "Nav item only visible if connectConfig.enabled && connectConfig.features.conversations",
        "Badge shows unread count from useConnectSDK().unreadCount (if > 0)",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "files": [
        "apps/store-app/src/components/layout/AppShell.tsx",
        "apps/store-app/src/components/layout/BottomNavBar.tsx"
      ],
      "notes": "Follow existing module lazy loading pattern in AppShell (lines 8-34). Follow nav item pattern in BottomNavBar (146 lines). Import MessageSquare from lucide-react. Use useConnectConfig() for feature check.",
      "dependencies": ["US-003", "US-008", "US-009"],
      "priority": 10,
      "passes": false
    },
    {
      "id": "US-011",
      "title": "Create AIAssistantPanel component",
      "description": "As a user, I want a floating AI Assistant button that opens a chat panel.",
      "acceptanceCriteria": [
        "Floating button in bottom-right corner (fixed bottom-4 right-4)",
        "Button shows Bot icon from lucide-react",
        "Click toggles panel open/closed",
        "Panel is 400px wide, 500px tall, positioned above button",
        "Panel renders <sdk.AIAssistantModule /> when SDK loaded",
        "Shows loading state while SDK loading",
        "Shows error state with retry if SDK failed",
        "Close button (X) in panel header",
        "Only renders if connectConfig.features.aiAssistant is true",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "files": [
        "apps/store-app/src/components/integrations/AIAssistantPanel.tsx (NEW)"
      ],
      "notes": "Use useState for open/closed state. Use useConnectSDK() for SDK access. Use useConnectConfig() for feature check. Panel styling: bg-background border rounded-lg shadow-lg. Use z-index 50 to appear above other content.",
      "dependencies": ["US-003", "US-008"],
      "priority": 11,
      "passes": false
    },
    {
      "id": "US-012",
      "title": "Add AIAssistantPanel to AppShell",
      "description": "As a developer, I need the AI Assistant panel available globally.",
      "acceptanceCriteria": [
        "Import AIAssistantPanel from @/components/integrations/AIAssistantPanel",
        "Render <AIAssistantPanel /> at the end of AppShell (before closing tags)",
        "Component handles its own visibility based on feature flag",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "files": [
        "apps/store-app/src/components/layout/AppShell.tsx"
      ],
      "notes": "Add after main content area, before provider closing tags. AIAssistantPanel self-manages visibility via useConnectConfig.",
      "dependencies": ["US-011"],
      "priority": 12,
      "passes": false
    },
    {
      "id": "US-013",
      "title": "Create ConnectSettings component",
      "description": "As a user, I want to enable/disable Connect features in Settings.",
      "acceptanceCriteria": [
        "Section header: 'Mango Connect' with connection status badge",
        "Master toggle: 'Enable Mango Connect' (enables/disables entire integration)",
        "Feature toggles (only enabled if master toggle on): Conversations, AI Assistant, Campaigns",
        "Status badge: 'Connected' (green) / 'Disconnected' (gray) / 'Error' (red)",
        "Save changes via useConnectConfig().updateConfig()",
        "Show toast on save success/failure",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "files": [
        "apps/store-app/src/components/modules/settings/categories/ConnectSettings.tsx (NEW)"
      ],
      "notes": "Follow pattern from categories/IntegrationsSettings.tsx (487 lines). Use Switch component from @/components/ui/switch. Use existing SettingsSection wrapper pattern. Get SDK status from useConnectSDK() for connection badge.",
      "dependencies": ["US-003", "US-008"],
      "priority": 13,
      "passes": false
    },
    {
      "id": "US-014",
      "title": "Add Connect to Settings navigation",
      "description": "As a developer, I need Connect settings accessible from Settings page.",
      "acceptanceCriteria": [
        "Add 'connect' to settings categories type",
        "Add 'Mango Connect' item to settings navigation sidebar",
        "Icon: Plug or Link2 from lucide-react",
        "Add case 'connect' to renderCategoryContent switch",
        "Render <ConnectSettings /> for connect category",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser using Playwright MCP"
      ],
      "files": [
        "apps/store-app/src/components/modules/settings/SettingsPage.tsx",
        "apps/store-app/src/components/modules/settings/SettingsNavigation.tsx"
      ],
      "notes": "Follow existing category pattern in SettingsPage.tsx (187 lines). Add after 'integrations' category in navigation order. Lazy load ConnectSettings if file is large.",
      "dependencies": ["US-013"],
      "priority": 14,
      "passes": false
    },
    {
      "id": "US-015",
      "title": "Add environment variables documentation",
      "description": "As a developer, I need documentation for required environment variables.",
      "acceptanceCriteria": [
        "Add VITE_MANGO_CONNECT_SDK_URL with comment and example",
        "Add MANGO_CONNECT_JWT_SECRET note (Edge Function only, not VITE_)",
        "Comments explain what each variable does",
        "No forbidden strings: 'Test', 'Mock', 'as any', 'void _'"
      ],
      "files": [
        "apps/store-app/.env.example"
      ],
      "notes": "Follow existing .env.example format. Only VITE_ prefixed vars are exposed to frontend. Example: VITE_MANGO_CONNECT_SDK_URL=https://connect.mango.ai/sdk/v1/mango-connect-sdk.js",
      "priority": 15,
      "passes": false
    },
    {
      "id": "US-016",
      "title": "Ultra Thinking review of all implementations",
      "description": "As a developer, I need a comprehensive review of all Connect integration code using Ultra Thinking mode with specialist agents.",
      "acceptanceCriteria": [
        "Review all new files created in this integration",
        "Check for security vulnerabilities (JWT handling, token storage)",
        "Verify TypeScript types are correct and complete",
        "Check for potential memory leaks in hooks and providers",
        "Verify error handling is comprehensive",
        "Check for accessibility issues in UI components",
        "Verify coding patterns match existing codebase conventions",
        "Document any issues found in progress.txt"
      ],
      "files": [
        "apps/store-app/src/types/connectIntegration.ts",
        "apps/store-app/src/services/supabase/storeService.ts",
        "apps/store-app/src/hooks/useConnectConfig.ts",
        "apps/store-app/src/hooks/useConnectToken.ts",
        "apps/store-app/src/hooks/useConnectSDK.ts",
        "apps/store-app/src/providers/ConnectSDKProvider.tsx",
        "apps/store-app/src/pages/MessagesPage.tsx",
        "apps/store-app/src/components/integrations/AIAssistantPanel.tsx",
        "apps/store-app/src/components/modules/settings/categories/ConnectSettings.tsx",
        "supabase/functions/generate-connect-token/index.ts"
      ],
      "notes": "Use /ultrathink skill to spawn specialist agents (Architect, Research, Coder, Tester) for comprehensive review. Focus on security, performance, and code quality. This is a review-only story - do not make changes, only document issues.",
      "dependencies": ["US-001", "US-002", "US-003", "US-004", "US-005", "US-006", "US-007", "US-008", "US-009", "US-010", "US-011", "US-012", "US-013", "US-014", "US-015"],
      "priority": 16,
      "passes": false
    },
    {
      "id": "US-017",
      "title": "Fix issues found in Ultra Thinking review",
      "description": "As a developer, I need to fix any issues discovered during the Ultra Thinking review.",
      "acceptanceCriteria": [
        "Address all security issues identified in US-016",
        "Fix all TypeScript errors or type improvements",
        "Resolve any memory leak concerns",
        "Improve error handling where needed",
        "Fix accessibility issues",
        "Align code with codebase conventions",
        "pnpm run typecheck passes",
        "pnpm run lint passes (if available)"
      ],
      "files": [],
      "notes": "Files to modify will be determined by US-016 review findings. This story should be updated with specific files after US-016 completes. May result in no changes if review finds no issues.",
      "dependencies": ["US-016"],
      "priority": 17,
      "passes": false
    }
  ]
}

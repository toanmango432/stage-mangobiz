{
  "project": "Mango POS",
  "branchName": "main",
  "description": "Device Indicator Technical Debt Cleanup - Address code quality issues, split large components, add memoization, improve accessibility, and add test coverage identified in comprehensive code review.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Remove dead tick state code from DeviceConnectionIndicator",
      "description": "As a developer, I want to remove unused code that causes unnecessary re-renders so that the component is cleaner and more performant.",
      "category": "frontend",
      "complexity": 1,
      "priority": 1,
      "passes": false,
      "dependencies": [],
      "files": [
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.tsx"
      ],
      "acceptanceCriteria": [
        "Remove the unused `setTick` state and associated useEffect interval (lines 71-76)",
        "Component still renders correctly without the tick-based re-render",
        "No forbidden strings: 'as any', 'void _', '// TODO:'",
        "pnpm run typecheck passes"
      ],
      "notes": "The setTick pattern forces re-renders every 10 seconds but isn't used for anything. Real-time updates come from Redux selectors watching MQTT heartbeats. Simply delete the useState and useEffect block."
    },
    {
      "id": "US-002",
      "title": "Extract shared device status helper functions",
      "description": "As a developer, I want shared utilities for device status mapping so that code isn't duplicated across components.",
      "category": "frontend",
      "complexity": 2,
      "priority": 2,
      "passes": false,
      "dependencies": ["US-001"],
      "files": [
        "apps/store-app/src/components/layout/utils/deviceStatusHelpers.ts (NEW)",
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.tsx",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Create new file `utils/deviceStatusHelpers.ts` with exported functions",
        "Export `getPadStatus(status: 'online' | 'offline'): DeviceStatusRowStatus`",
        "Export `getDeviceStatus(connectionStatus: string): DeviceStatusRowStatus`",
        "Export `sortByStatus<T>(devices: T[], getStatus: (d: T) => DeviceStatusRowStatus): T[]`",
        "Update DeviceConnectionIndicator to import from shared utility",
        "Update QuickDeviceSetupModal to import from shared utility",
        "Remove duplicate function definitions from both components",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "notes": "getPadStatus and getDeviceStatus are identical in both files. sortByStatus is only in QuickDeviceSetupModal but is a generic utility. Export DeviceStatusRowStatus type from DeviceStatusRow.tsx if not already exported."
    },
    {
      "id": "US-003",
      "title": "Add memoization to device selectors in settingsSlice",
      "description": "As a developer, I want memoized selectors so that filtering operations don't recalculate on every state access.",
      "category": "backend",
      "complexity": 2,
      "priority": 3,
      "passes": false,
      "dependencies": [],
      "files": [
        "apps/store-app/src/store/slices/settingsSlice.ts"
      ],
      "acceptanceCriteria": [
        "Import `createSelector` from '@reduxjs/toolkit'",
        "Convert `selectConnectedHardwareDevices` to use createSelector",
        "Convert `selectConnectedPaymentTerminals` to use createSelector",
        "Convert `selectHardwareDevicesWithErrors` to use createSelector",
        "Convert `selectPaymentTerminalsWithErrors` to use createSelector",
        "All selectors remain exported with same names (no breaking changes)",
        "No forbidden strings: 'as any'",
        "pnpm run typecheck passes"
      ],
      "notes": "Use createSelector pattern: createSelector([selectHardwareDevices], (devices) => devices.filter(...)). The base selector selectHardwareDevices already exists."
    },
    {
      "id": "US-004",
      "title": "Rename getConnectedPads to selectConnectedPads for consistency",
      "description": "As a developer, I want consistent selector naming so that the codebase follows established patterns.",
      "category": "backend",
      "complexity": 1,
      "priority": 4,
      "passes": false,
      "dependencies": ["US-003"],
      "files": [
        "apps/store-app/src/store/slices/padDevicesSlice.ts",
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.tsx",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Rename `getConnectedPads` to `selectConnectedPads` in padDevicesSlice.ts",
        "Convert to use createSelector for memoization",
        "Update all imports in DeviceConnectionIndicator.tsx",
        "Update all imports in QuickDeviceSetupModal.tsx",
        "No forbidden strings: 'as any'",
        "pnpm run typecheck passes"
      ],
      "notes": "Per docs/PATTERNS.md, selectors should use 'select' prefix. Also add memoization while renaming."
    },
    {
      "id": "US-005",
      "title": "Add useMemo for computed values in DeviceConnectionIndicator",
      "description": "As a developer, I want memoized computed values so that expensive calculations don't run on every render.",
      "category": "frontend",
      "complexity": 2,
      "priority": 5,
      "passes": false,
      "dependencies": ["US-002", "US-004"],
      "files": [
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.tsx"
      ],
      "acceptanceCriteria": [
        "Wrap totalConnected, totalErrors, hasErrors, hasAnyDevice, hasAnyConnected in useMemo",
        "Include correct dependencies array for useMemo",
        "Wrap getButtonStyles result in useMemo if called with derived values",
        "Wrap getTooltip result in useMemo if called with derived values",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "notes": "Lines 63-67 compute aggregated values on every render. Wrap in single useMemo returning object with all values. Dependencies should include all the selector results used in computation."
    },
    {
      "id": "US-006",
      "title": "Extract device options constants from QuickDeviceSetupModal",
      "description": "As a developer, I want device options in a constants file so that the modal component is smaller and options are reusable.",
      "category": "frontend",
      "complexity": 1,
      "priority": 6,
      "passes": false,
      "dependencies": [],
      "files": [
        "apps/store-app/src/components/layout/constants/deviceOptions.ts (NEW)",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Create new file `constants/deviceOptions.ts`",
        "Move hardwareTypeOptions array to constants file",
        "Move connectionTypeOptions array to constants file",
        "Move terminalTypeOptions array to constants file",
        "Export all arrays with proper TypeScript types",
        "Update QuickDeviceSetupModal to import from constants",
        "Remove inline array definitions from modal",
        "pnpm run typecheck passes"
      ],
      "notes": "These option arrays are defined inline around lines 270-289. Extract them to reduce modal file size and improve reusability."
    },
    {
      "id": "US-007",
      "title": "Extract StatusTab component from QuickDeviceSetupModal",
      "description": "As a developer, I want the Status tab in its own component so that QuickDeviceSetupModal is smaller and more maintainable.",
      "category": "frontend",
      "complexity": 3,
      "priority": 7,
      "passes": false,
      "dependencies": ["US-002", "US-006"],
      "files": [
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/StatusTab.tsx (NEW)",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Create StatusTab.tsx component (~150-200 lines)",
        "Move all Status tab content from QuickDeviceSetupModal to StatusTab",
        "StatusTab receives props: devices data, onRetry callback, onUnpair callback",
        "StatusTab renders device sections for Pad, Hardware, and Terminals",
        "StatusTab uses DeviceStatusRow for device display",
        "Update QuickDeviceSetupModal to render <StatusTab /> in status tab",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser: Status tab still works correctly"
      ],
      "notes": "This is part of splitting the 792-line modal. StatusTab handles lines ~350-500 approximately. Pass callbacks for retry/unpair actions as props."
    },
    {
      "id": "US-008",
      "title": "Extract AddDeviceTab component from QuickDeviceSetupModal",
      "description": "As a developer, I want the Add Device tab in its own component so that QuickDeviceSetupModal is smaller and more maintainable.",
      "category": "frontend",
      "complexity": 3,
      "priority": 8,
      "passes": false,
      "dependencies": ["US-006", "US-007"],
      "files": [
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/AddDeviceTab.tsx (NEW)",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Create AddDeviceTab.tsx component (~200-250 lines)",
        "Move all Add Device tab content from QuickDeviceSetupModal",
        "AddDeviceTab receives props: onDeviceAdded callback, onTabChange callback",
        "AddDeviceTab manages its own form state (hardwareForm, terminalForm, padPairingCode)",
        "AddDeviceTab handles add device dispatch and toast notifications",
        "Update QuickDeviceSetupModal to render <AddDeviceTab />",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser: Add Device tab forms still work"
      ],
      "notes": "This completes the modal split. AddDeviceTab handles the three form sections. Import constants from deviceOptions.ts."
    },
    {
      "id": "US-009",
      "title": "Extract useDeviceActions hook from QuickDeviceSetupModal",
      "description": "As a developer, I want device action handlers in a custom hook so that logic is separated from presentation.",
      "category": "frontend",
      "complexity": 2,
      "priority": 9,
      "passes": false,
      "dependencies": ["US-007", "US-008"],
      "files": [
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/hooks/useDeviceActions.ts (NEW)",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/StatusTab.tsx"
      ],
      "acceptanceCriteria": [
        "Create useDeviceActions.ts hook",
        "Move handleRetryConnection to hook",
        "Move handleUnpairDevice to hook",
        "Move confirmUnpair and deviceToUnpair state to hook",
        "Hook returns: { handleRetryConnection, handleUnpairDevice, confirmUnpair, deviceToUnpair, setDeviceToUnpair, isRetrying }",
        "Update StatusTab to use useDeviceActions hook",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "notes": "Extract action handlers to custom hook. This separates business logic from UI rendering in StatusTab."
    },
    {
      "id": "US-010",
      "title": "Create QuickDeviceSetupModal module index and types",
      "description": "As a developer, I want proper module structure with barrel exports so that imports are clean.",
      "category": "frontend",
      "complexity": 1,
      "priority": 10,
      "passes": false,
      "dependencies": ["US-008", "US-009"],
      "files": [
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/index.ts (NEW)",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/types.ts (NEW)",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Create types.ts with shared interfaces (QuickDeviceSetupModalProps, DeviceToUnpair, etc.)",
        "Create index.ts barrel export for QuickDeviceSetupModal",
        "Move QuickDeviceSetupModal.tsx into QuickDeviceSetupModal/ folder",
        "Rename to QuickDeviceSetupModal/QuickDeviceSetupModal.tsx",
        "Update all imports that reference the old path",
        "QuickDeviceSetupModal.tsx should now be <300 lines",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes"
      ],
      "notes": "Final step of modal refactor. Main component should only have modal shell, tab navigation, and child component rendering. Verify file is under 300 lines after extraction."
    },
    {
      "id": "US-011",
      "title": "Add accessibility attributes to DeviceConnectionIndicator",
      "description": "As a user with accessibility needs, I want proper ARIA attributes so that screen readers can interpret the device status.",
      "category": "frontend",
      "complexity": 2,
      "priority": 11,
      "passes": false,
      "dependencies": ["US-005"],
      "files": [
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.tsx",
        "apps/store-app/src/components/layout/DeviceStatusRow.tsx"
      ],
      "acceptanceCriteria": [
        "Add aria-label to status indicator button (dynamic based on status)",
        "Add aria-expanded={isOpen} to popover trigger button",
        "Add role='status' and aria-live='polite' for real-time device status updates",
        "Add aria-label to DeviceStatusRow for screen reader context",
        "Add role='list' to device section containers",
        "Add role='listitem' to each DeviceStatusRow wrapper",
        "No forbidden strings: 'as any', 'void _'",
        "pnpm run typecheck passes",
        "Verify in browser: component still renders correctly"
      ],
      "notes": "Accessibility is a legal/compliance requirement. Focus on the status indicator button and device list semantics."
    },
    {
      "id": "US-012",
      "title": "Add accessibility to QuickDeviceSetupModal tabs",
      "description": "As a user with accessibility needs, I want keyboard navigation and ARIA attributes on modal tabs.",
      "category": "frontend",
      "complexity": 2,
      "priority": 12,
      "passes": false,
      "dependencies": ["US-010"],
      "files": [
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/QuickDeviceSetupModal.tsx",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/StatusTab.tsx",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/AddDeviceTab.tsx"
      ],
      "acceptanceCriteria": [
        "Verify Radix Tabs have proper aria-selected on active tab",
        "Add aria-label to modal Dialog for screen readers",
        "Ensure tab panels have aria-labelledby pointing to tab triggers",
        "Add descriptive aria-label to action buttons (Retry, Remove, Add)",
        "Ensure focus trap works within modal",
        "No forbidden strings: 'as any'",
        "pnpm run typecheck passes"
      ],
      "notes": "Radix Tabs should handle most accessibility. Verify and add any missing attributes. Focus on action buttons and form fields."
    },
    {
      "id": "US-013",
      "title": "Add unit tests for device status helper utilities",
      "description": "As a developer, I want unit tests for shared utilities so that I can refactor with confidence.",
      "category": "test",
      "complexity": 2,
      "priority": 13,
      "passes": false,
      "dependencies": ["US-002"],
      "files": [
        "apps/store-app/src/components/layout/utils/deviceStatusHelpers.test.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Create test file for deviceStatusHelpers",
        "Test getPadStatus with 'online' returns 'connected'",
        "Test getPadStatus with 'offline' returns 'disconnected'",
        "Test getDeviceStatus with 'connected', 'disconnected', 'error' inputs",
        "Test sortByStatus correctly orders devices (error first, disconnected, connected)",
        "All tests pass with `pnpm test`",
        "No forbidden strings: 'as any'"
      ],
      "notes": "Use Vitest for testing. Follow existing test patterns in the codebase. Test edge cases like empty arrays for sortByStatus."
    },
    {
      "id": "US-014",
      "title": "Add unit tests for device selectors in Redux slices",
      "description": "As a developer, I want unit tests for device selectors so that state selection logic is verified.",
      "category": "test",
      "complexity": 3,
      "priority": 14,
      "passes": false,
      "dependencies": ["US-003", "US-004"],
      "files": [
        "apps/store-app/src/store/slices/__tests__/deviceSelectors.test.ts (NEW)"
      ],
      "acceptanceCriteria": [
        "Create test file for device selectors",
        "Test selectConnectedPads returns only online devices",
        "Test selectOfflinePads returns only offline devices",
        "Test selectConnectedHardwareDevices filters by connectionStatus",
        "Test selectConnectedPaymentTerminals filters correctly",
        "Test selectHardwareDevicesWithErrors includes error and disconnected",
        "Test memoization works (same input returns same reference)",
        "All tests pass with `pnpm test`"
      ],
      "notes": "Create mock RootState with test devices. Verify selectors return correct filtered results. Test memoization by calling twice with same state."
    },
    {
      "id": "US-015",
      "title": "Add component tests for DeviceStatusRow",
      "description": "As a developer, I want component tests for DeviceStatusRow so that UI rendering is verified.",
      "category": "test",
      "complexity": 2,
      "priority": 15,
      "passes": false,
      "dependencies": [],
      "files": [
        "apps/store-app/src/components/layout/DeviceStatusRow.test.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Create test file for DeviceStatusRow",
        "Test renders device name correctly",
        "Test renders correct icon for each device type (pad, printer, scanner, cash_drawer, terminal)",
        "Test renders correct status styling for connected/disconnected/error",
        "Test formats lastSeen date correctly",
        "Test handles missing lastSeen gracefully",
        "All tests pass with `pnpm test`"
      ],
      "notes": "Use @testing-library/react for rendering tests. Mock date-fns formatDistanceToNow if needed. Test all device types and status combinations."
    },
    {
      "id": "US-016",
      "title": "Add component tests for DeviceConnectionIndicator",
      "description": "As a developer, I want component tests for the main indicator so that user interactions are verified.",
      "category": "test",
      "complexity": 3,
      "priority": 16,
      "passes": false,
      "dependencies": ["US-011", "US-015"],
      "files": [
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.test.tsx (NEW)"
      ],
      "acceptanceCriteria": [
        "Create test file with Redux Provider wrapper",
        "Test renders 'Devices' button when no errors",
        "Test renders 'X Issues' button when errors exist",
        "Test button color changes based on status (green/amber/gray)",
        "Test popover opens on button click",
        "Test device sections render in popover",
        "Test Quick Setup button opens modal",
        "All tests pass with `pnpm test`"
      ],
      "notes": "Need to wrap component with Redux Provider. Mock the Redux state with different device configurations. Use userEvent for click interactions."
    },
    {
      "id": "US-017",
      "title": "Add input validation to Redux slice reducers",
      "description": "As a developer, I want input validation in reducers so that invalid data doesn't corrupt state.",
      "category": "backend",
      "complexity": 2,
      "priority": 17,
      "passes": false,
      "dependencies": [],
      "files": [
        "apps/store-app/src/store/slices/padDevicesSlice.ts"
      ],
      "acceptanceCriteria": [
        "Add validation in updateDeviceStatus reducer to check device exists",
        "Add validation that status is valid ('online' or 'offline')",
        "Add try/catch in checkOfflineDevices for invalid date parsing",
        "Add validation in handleHeartbeat for required fields",
        "Invalid inputs should be silently ignored (no state change)",
        "No forbidden strings: 'as any'",
        "pnpm run typecheck passes"
      ],
      "notes": "Defensive programming to prevent invalid data from corrupting state. Don't throw errors - just return early if validation fails."
    },
    {
      "id": "US-018",
      "title": "Fix navigation event format inconsistency",
      "description": "As a developer, I want consistent navigation event format so that settings navigation works correctly.",
      "category": "frontend",
      "complexity": 2,
      "priority": 18,
      "passes": false,
      "dependencies": ["US-010"],
      "files": [
        "apps/store-app/src/components/layout/DeviceConnectionIndicator.tsx",
        "apps/store-app/src/components/layout/QuickDeviceSetupModal/QuickDeviceSetupModal.tsx"
      ],
      "acceptanceCriteria": [
        "Check how AppShell.tsx handles navigate-to-module event detail",
        "Update DeviceConnectionIndicator to dispatch format matching AppShell expectation",
        "If AppShell expects string, change to: detail: 'settings'",
        "If AppShell can handle object, ensure it reads detail.module",
        "Test navigation actually works in browser",
        "No forbidden strings: 'as any'",
        "pnpm run typecheck passes",
        "Verify in browser: More Settings link navigates to settings page"
      ],
      "notes": "The current code dispatches { module: 'settings', category: 'devices' } but AppShell may expect just a string. Check AppShell.tsx event handler first."
    }
  ]
}

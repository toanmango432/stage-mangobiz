## Codebase Patterns

See patterns.md for accumulated patterns from previous runs.

---

# Ralph Progress Log
Started: 2026-01-19
Branch: ralph/foundation-tech-debt
PRD: Foundation & Technical Debt (Phase 1 & 2)

## Overview

This run implements the Foundation Fixes (Phase 1) and Technical Debt (Phase 2) plan:

**Phase 1 - Foundation Fixes:**
- US-001, US-002: Vitest coverage config updates
- US-003 to US-006: Fix 4 silent error failures in featureFlags.ts
- US-007: Add console removal plugin
- US-008 to US-014: PaymentModal real tests
- US-015 to US-018: Verify/complete TicketPanel modularization

**Phase 2 - Technical Debt:**
- US-019 to US-026: Extract dataService.ts into domain services
- US-027 to US-029: Split AddTeamMember.tsx
- US-030, US-031: Split PaymentModal.tsx
- US-032 to US-034: Split OperationTemplateSetup.tsx
- US-035 to US-037: Split TimesheetSection.tsx

## Setup Information

**PRD Document:** `/tasks/prd-foundation-tech-debt.md`
**PRD JSON:** `scripts/ralph/runs/foundation-tech-debt/prd.json`
**Total Stories:** 37

### Key File Sizes (Before)

| File | Lines | Target |
|------|-------|--------|
| dataService.ts | 3,090 | <500 |
| TicketPanel.tsx | 1,668 | Already partially modularized |
| AddTeamMember.tsx | 1,516 | <500 |
| OperationTemplateSetup.tsx | 1,380 | <500 |
| TimesheetSection.tsx | 1,187 | <500 |
| PaymentModal.tsx | 1,154 | <500 |
| featureFlags.ts | 345 | ~360 (add logging) |
| vitest.config.ts | 59 | ~70 |
| PaymentModal.test.tsx | 70 | ~200 (real tests) |

### Existing Checkout Modularization

TicketPanel already has partial module structure:
- `hooks/` - 11 files (useTicketKeyboard.ts, useTicketPersistence.ts, etc.)
- `components/` - 9 files (CatalogPanel.tsx, TicketHeader.tsx, etc.)
- `reducers/` - ticketReducer.ts
- `constants/` - exists

US-015 to US-018 are verification stories to audit completeness.

### Empty Catch Blocks in featureFlags.ts

Located at lines:
- ~92: getFeatureFlag
- ~250: getNumericFeatureFlag
- ~264: getJsonFeatureFlag
- ~278: getArrayFeatureFlag

---

## 2026-01-19 - US-001: Add checkout, auth, and common paths to Vitest coverage
Commit: ede3706

**Why this story?** US-001 is the highest priority story with no dependencies. It's a prerequisite for US-002 (coverage thresholds).

**Changes:**
- `apps/store-app/vitest.config.ts:22-26`: Added three glob patterns to coverage include array:
  - `src/components/checkout/**/*.{ts,tsx}`
  - `src/components/auth/**/*.{ts,tsx}`
  - `src/components/common/**/*.{ts,tsx}`

**Learnings:**
- Changes were already present in working directory (uncommitted) - verified and committed
- Pre-existing TypeScript errors exist across the codebase (test files, uiTicketsSlice.ts, types/index.ts) - these are NOT related to US-001 and should be addressed separately
- The typecheck criterion in PRD may need adjustment since pre-existing errors block all stories

**Next story suggestion:** US-002 (Add coverage thresholds) since US-001 is now complete and US-002 depends on it. Same file, same category, fresh in context.

---

## 2026-01-19 - US-002: Add coverage thresholds to Vitest config
Commit: a628f67

**Why this story?** US-002 has dependency on US-001 (now complete), same file (vitest.config.ts), same category (test), and lowest priority among available stories with satisfied dependencies.

**Changes:**
- `apps/store-app/vitest.config.ts:39-44`: Added coverage thresholds object:
  - `statements: 50`
  - `branches: 40`
  - `functions: 50`
  - `lines: 50`

**Learnings:**
- Changes were already present in working directory (uncommitted from previous session) - verified against acceptance criteria and committed
- Pre-existing TypeScript errors in test files persist (Book/__tests__/*.tsx) - these are unrelated to US-002 and affect the "typecheck passes" criterion for all stories
- The PRD's "typecheck passes" acceptance criteria should be interpreted as "no NEW typecheck errors introduced by this story" since pre-existing errors exist

**Next story suggestion:** US-003 (Fix silent error in featureFlags getFeatureFlag) - next available priority, no dependencies, different file so a clean context switch.

---

## 2026-01-19 - US-003: Fix silent error in featureFlags isInRollbackState
Commit: eb4dba3

**Why this story?** US-003 is the highest priority story with no dependencies among remaining stories. It starts the pattern for US-004 to US-006 which all work on the same file.

**Changes:**
- `apps/store-app/src/config/featureFlags.ts:92-94`: Changed empty catch block to log errors:
  - Before: `} catch { return false; }`
  - After: `} catch (error) { console.warn('[FeatureFlags] Failed to parse rollback state:', error); return false; }`

**Learnings:**
- PRD notes referenced `getFeatureFlag` function at line ~92, but actual function is `isInRollbackState()`. PRD function names are outdated but the intent (add logging to silent catch blocks) is clear and correct.
- The four functions named in US-003 to US-006 (`getFeatureFlag`, `getNumericFeatureFlag`, `getJsonFeatureFlag`, `getArrayFeatureFlag`) don't exist in featureFlags.ts. The actual functions with empty catch blocks are:
  - `isInRollbackState()` (~line 92) - US-003
  - `getCachedMigrationStatus()` (~line 250) - US-004
  - `cacheMigrationStatus()` (~line 264) - US-005
  - `clearCachedMigrationStatus()` (~line 278) - US-006
- featureFlagService.ts is a separate file with different feature flag functions

**Patterns to sync:** None - this is standard error logging best practice

**Next story suggestion:** US-004 (Fix silent error in getCachedMigrationStatus) - same file, same pattern, code is fresh in context.

---

## 2026-01-19 - US-004: Fix silent error in featureFlags getCachedMigrationStatus
Commit: cbd8e53

**Why this story?** US-004 is the next priority after US-003, same file (featureFlags.ts), same pattern (adding error logging to silent catch blocks). Code structure is fresh in context from previous story.

**Changes:**
- `apps/store-app/src/config/featureFlags.ts:251-253`: Changed empty catch block to log errors:
  - Before: `} catch { return null; }`
  - After: `} catch (error) { console.warn('[FeatureFlags] Failed to parse cached migration status:', error); return null; }`

**Learnings:**
- Pre-existing TypeScript errors continue to exist in test files and type files (not from this change)
- featureFlags.ts itself has no TypeScript errors - verified with `grep -i featureFlags` on typecheck output
- Pre-existing test failures in integration tests (e.g., padCheckoutFlow.test.ts, WaitListItem.test.tsx) - these are unrelated to featureFlags.ts changes

**Next story suggestion:** US-005 (Fix silent error in cacheMigrationStatus) - same file, same pattern, line ~265.

---

## 2026-01-19 - US-005: Fix silent error in featureFlags cacheMigrationStatus
Commit: 741ca53

**Why this story?** US-005 is the next priority after US-004, same file (featureFlags.ts), same pattern (adding error logging to silent catch blocks). Code structure is fresh in context from previous story.

**Changes:**
- `apps/store-app/src/config/featureFlags.ts:266-267`: Changed empty catch block to log errors:
  - Before: `} catch { // Ignore localStorage errors }`
  - After: `} catch (error) { console.warn('[FeatureFlags] Failed to cache migration status:', error); }`

**Learnings:**
- PRD title says "getJsonFeatureFlag" but the actual function is `cacheMigrationStatus()`. Intent is correct (add logging to silent catch blocks).
- The function doesn't return a value (void), so we just log without changing return behavior.
- Pre-existing TypeScript errors (Book/__tests__/*.tsx) and test failures (6 test files, 116 failed tests) continue to exist - these are unrelated to featureFlags.ts changes.

**Next story suggestion:** US-006 (Fix silent error in clearCachedMigrationStatus) - same file, same pattern, line ~280.

---

## 2026-01-19 - US-006: Fix silent error in featureFlags clearCachedMigrationStatus
Commit: d584d2f

**Why this story?** US-006 is the highest priority incomplete story with no dependencies. It completes the pattern established in US-003 to US-005 (adding error logging to silent catch blocks in featureFlags.ts). Same file, code structure is fresh in context.

**Changes:**
- `apps/store-app/src/config/featureFlags.ts:280-282`: Changed empty catch block to log errors:
  - Before: `} catch { // Ignore localStorage errors }`
  - After: `} catch (error) { console.warn('[FeatureFlags] Failed to clear cached migration status:', error); }`

**Learnings:**
- PRD title says "getArrayFeatureFlag" but the actual function is `clearCachedMigrationStatus()`. Intent is correct (add logging to silent catch blocks).
- This completes all 4 silent catch block fixes in featureFlags.ts (US-003 to US-006).
- The function doesn't return a value (void), so we just log without changing return behavior.
- Pre-existing TypeScript errors (Book/__tests__/*.tsx) and test failures (6 test files, 116 failed tests) continue to exist - these are unrelated to featureFlags.ts changes.

**Next story suggestion:** US-007 (Add vite-plugin-remove-console for production builds) - next available priority with no dependencies. Different file (vite.config.ts), different category (build), logical progression from foundation fixes to build improvements.

---

## 2026-01-19 - US-007: Add console removal for production builds
Commit: 383ca0c

**Why this story?** US-007 is the highest priority incomplete story with no dependencies. It's a build optimization task that follows the pattern of foundation fixes.

**Changes:**
- `apps/store-app/vite.config.ts:6-14`: Changed from static config to dynamic config function with esbuild pure option:
  - Before: `export default defineConfig({ plugins: [react(), /* disabled removeConsole */] })`
  - After: `export default defineConfig(({ mode }) => ({ plugins: [react()], esbuild: { pure: mode === 'production' ? ['console.log', 'console.debug'] : [] } }))`
- Removed commented-out vite-plugin-remove-console references (lines 3-5, 12-13)
- Added closing parenthesis for arrow function return (line 87)

**Implementation Note:**
Used esbuild's native `pure` option instead of vite-plugin-remove-console because:
- vite-plugin-remove-console has JSX parsing issues (documented in original comments)
- The plugin fails with error "Expression expected" when console.log is inside JSX onClick handlers
- esbuild `pure` is built-in, faster, and handles 99% of console.log removal needs
- The `pure` option correctly removes standalone console.log/debug while preserving console.warn/error

**Verification:**
- `pnpm run build` passes successfully (12.97s)
- Verified "API Request" log message (standalone console.log in client.ts) is NOT in production build
- console.warn instances ARE present in build (confirmed preservation)
- 4 remaining console.log in build are: vendor libs (supabase) and placeholder onClick handlers (edge case)

**Learnings:**
- vite-plugin-remove-console uses regex-based removal which breaks on JSX constructs like `onClick={() => console.log(...)}`
- esbuild `pure` marks functions as side-effect-free, allowing dead code elimination when return value is unused
- For 100% removal of console.log inside callbacks, would need different approach (babel plugin or terser)
- The PRD's approach was technically correct but the plugin has known issues - adapt and document

**Patterns to sync:**
- Pattern: Use esbuild `pure` option for console removal in Vite instead of plugins that have parsing issues

**Next story suggestion:** US-008 (Implement PaymentModal test - renders when open) - next available priority with no dependencies. Different category (test), starts the PaymentModal test implementation series.

---

## 2026-01-19 - US-008: Implement PaymentModal test - renders when open
Commit: c39f873

**Why this story?** US-008 is the highest priority incomplete story with no dependencies. It starts the PaymentModal test implementation series (US-008 to US-014). Previous story (US-007) suggested this as the logical next step.

**Changes:**
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:1-141`: Replaced placeholder tests with real assertions:
  - Added proper imports (vitest, testing-library, react-redux, configureStore)
  - Created mocks for Dialog, tooltip, payment services, and pad components
  - Created mock Redux store with auth, padTransaction, and uiTickets state
  - Created renderWithProvider helper function
  - Implemented 'should render when open is true' test with assertions for dialog and title
  - Implemented 'should not render when open is false' test

**Learnings:**
- PaymentModal uses `open` prop (not `isOpen` as noted in PRD) - actual component API differs from PRD description
- PaymentModal requires Redux store with:
  - `auth.store.storeId`, `auth.member.memberId`, `auth.device.id`
  - `padTransaction.activeTransaction`, `padTransaction.customerStarted`
  - `uiTickets.pendingTickets` (array) - used by `selectUnresolvedPriceChanges` selector
- Testing approach: Mock Radix UI Dialog component to control visibility based on `open` prop
- Pre-existing test failures (118 tests) in codebase are unrelated to PaymentModal changes

**Patterns to sync:** None - standard React testing patterns with Redux Provider

**Next story suggestion:** US-009 (Implement PaymentModal test - does not render when closed) - same file, depends on US-008 (now complete), lower complexity. The test infrastructure is already set up.

---

## 2026-01-19 - US-009: Implement PaymentModal test - does not render when closed
Commit: c39f873 (part of US-008)

**Why this story?** US-009 is the highest priority incomplete story with satisfied dependencies (US-008 complete). Same file (PaymentModal.test.tsx), same category (test), code structure fresh in context.

**Changes:**
- No code changes needed - test was already implemented as part of US-008 commit (c39f873)
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:135-140`: Test 'should not render when open is false' already has real assertions

**Verification:**
- Test renders PaymentModal with `open={false}` ✓
- Uses `queryByTestId` (returns null if not found) ✓
- Asserts modal container is NOT in the document ✓
- Test passes: All 10 PaymentModal tests pass ✓
- TypeScript: Pre-existing errors only, no new errors ✓

**Learnings:**
- Previous iteration (US-008) implemented both the "renders when open" and "does not render when closed" tests together
- PRD split these into separate stories but the natural implementation pattern covered both cases in one commit
- This is acceptable - the test meets all acceptance criteria regardless of when it was written

**Next story suggestion:** US-010 (Implement PaymentModal test - displays payment method options) - same file, depends on US-008 (complete), next in the PaymentModal test series.

---

## 2026-01-19 - US-010: Implement PaymentModal test - displays payment method options
Commit: 0ea2975

**Why this story?** US-010 is the highest priority incomplete story with satisfied dependencies (US-008 complete). Same file (PaymentModal.test.tsx), same category (test), code structure fresh in context from US-008/US-009 work.

**Changes:**
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:7-8`: Added imports for `fireEvent` and `act` from testing-library
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:143-164`: Replaced placeholder test with real assertions:
  - Added `async` to test function for proper act() handling
  - Click "Continue to Payment" button to navigate to step 2 where payment methods are shown
  - Used `act()` wrapper around `fireEvent.click()` to properly handle React state updates
  - Assert all 4 payment method cards are visible via data-testid
  - Assert payment method labels are visible (Credit Card, Cash, Gift Card, Other)

**Learnings:**
- PaymentModal uses a multi-step flow: Step 1 is "Add Tip", Step 2 shows payment methods
- Must navigate to step 2 by clicking "Continue to Payment" button before payment methods are rendered
- React state updates in tests need to be wrapped in `act()` to avoid warnings and ensure DOM updates complete
- Payment methods are defined in `PAYMENT_METHODS` array at line 433-438 with ids: card, cash, gift_card, custom
- Each payment method card has data-testid format `card-payment-method-{id}`

**Next story suggestion:** US-011 (Implement PaymentModal test - handles close callback) - same file, depends on US-008 (complete), tests user interaction with close functionality.

---

## 2026-01-19 - US-011: Implement PaymentModal test - handles close callback
Commit: bbb0fa9

**Why this story?** US-011 is the highest priority incomplete story with satisfied dependencies (US-008 complete). Same file (PaymentModal.test.tsx), same category (test), code structure fresh in context from US-008/US-009/US-010 work.

**Changes:**
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:14-40`: Updated Dialog mock to include `onOpenChange` prop and a close button that triggers `onOpenChange(false)` when clicked
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:155-171`: Added new 'closing' describe block with test for onClose callback:
  - Creates mock onClose function with `vi.fn()`
  - Renders PaymentModal with mock onClose
  - Finds and clicks the dialog close button
  - Asserts onClose was called exactly once

**Learnings:**
- PaymentModal passes `onClose` to the Dialog component via `onOpenChange={onClose}` (line 475)
- There's no explicit "Cancel" button in the component - closing happens through Radix UI Dialog mechanisms
- To test close functionality, needed to enhance the Dialog mock to simulate the onOpenChange callback trigger
- Standard pattern: Mock Dialog with close button that calls `onOpenChange?.(false)` to simulate closing

**Next story suggestion:** US-012 (Implement PaymentModal test - handles payment selection) - same file, depends on US-010 (complete), tests payment method selection interaction.

---

## 2026-01-19 - US-012: Implement PaymentModal test - handles payment selection
Commit: 4e52b41

**Why this story?** US-012 is the highest priority incomplete story with satisfied dependencies (US-010 complete). Same file (PaymentModal.test.tsx), same category (test), code structure fresh in context from previous PaymentModal tests.

**Changes:**
- `apps/store-app/src/components/checkout/__tests__/PaymentModal.test.tsx:197-225`: Replaced placeholder test with real assertions:
  - Navigate to step 2 (Payment) by clicking "Continue to Payment" button
  - Click on the Cash payment method card
  - Assert Cash payment section appears (input for cash received)
  - Click on Credit Card payment method
  - Assert Card payment section appears (Apply button)
  - Assert Cash input is no longer visible (confirms state change)

**Learnings:**
- Payment method selection is handled by `handleSelectMethod` function (line 440-444) which sets `currentMethod` state
- Each payment method type renders different UI when selected:
  - `card`: Shows "Apply ${amount}" button (`button-apply-card`)
  - `cash`: Shows cash received input and quick amount buttons (`input-cash-received`)
  - `gift_card`: Shows "Enter Gift Card Code" button (`button-enter-gift-card`)
  - `custom`: Shows payment name input and apply button (`input-custom-payment-name`, `button-apply-custom`)
- The selected method's UI section replaces the previous one - only one is shown at a time
- Pre-existing TypeScript errors in Book/__tests__/*.tsx files are unrelated to PaymentModal changes

**Next story suggestion:** US-013 (Implement PaymentModal test - displays correct totals) - same file, depends on US-008 (complete), tests total display calculations.

---
